var e=require("https://unpkg.com/idb@5.0.8/build/esm/index.js"),n=require("https://unpkg.com/@zedvision/diff@10.12.3/dist/diff.min.js");function t(e,n){try{var t=e()}catch(e){return n(e)}return t&&t.then?t.then(void 0,n):t}exports.getDB=function(){return function(e,r){void 0===r&&(r=!1);var o={get:function(i,u){void 0===u&&(u="string");try{var c,f,s=function(e){return c?e:"json"===u?JSON.parse(f):Promise.resolve(f).then(function(e){var t,r=function(){if("string"===u){var r=function(n){return t?n:(t=1,(new TextDecoder).decode(e))},i=function(){if("string"==typeof e&&"string"===u){var r=function(n){return t?n:(t=1,e)},i=e,c=function(){if(n.isDiff(i)){var e=i.slice(0,8),r=i.slice(8);return Promise.resolve(o.get(e)).then(function(e){return t=1,n.assemble(e,r)})}}();return c&&c.then?c.then(r):r(c)}}();return i&&i.then?i.then(r):r(i)}}();return r&&r.then?r.then(function(e){return t?e:f}):t?r:f})},h=t(function(){function n(){if(!f)return c=1,null}var t=r?Promise.resolve(e).then(function(e){return Promise.resolve(e.get("codeStore",i)).then(function(e){f=e})}):Promise.resolve(e.get(i)).then(function(e){f=e});return t&&t.then?t.then(n):n()},function(){return c=1,null});return Promise.resolve(h&&h.then?h.then(s):s(h))}catch(e){return Promise.reject(e)}},put:function(i,u){try{var c,f=function(){return""!==c&&u===c?u:(n="string"!=typeof u?(new TextDecoder).decode(u):u,r?Promise.resolve(e).then(function(e){return e.put("codeStore",n,i)}):Promise.resolve(e.put(i,n)));var n},s=t(function(){return Promise.resolve(o.get(i)).then(function(e){var t=function(){if("string"==typeof e&&"string"==typeof u&&8===e.length&&e!==u)return Promise.resolve(o.get(u)).then(function(t){return Promise.resolve(o.get(e)).then(function(r){var i=function(){if("string"==typeof r)return Promise.resolve(function(e){try{return Promise.resolve(crypto.subtle.digest("SHA-256","string"==typeof e?(new TextEncoder).encode(e):e)).then(function(e){return Array.from(new Uint8Array(e).slice(0,4)).map(function(e){return("00"+e.toString(16)).slice(-2)}).join("")})}catch(e){return Promise.reject(e)}}(r)).then(function(i){var u=function(){if(i===e)return Promise.resolve(n.diff(t,r)).then(function(e){var n=e.b+JSON.stringify(e.c);o.put(i,n)})}();if(u&&u.then)return u.then(function(){})})}();if(i&&i.then)return i.then(function(){})})})}();if(t&&t.then)return t.then(function(){})})},function(){c=""});return Promise.resolve(s&&s.then?s.then(f):f())}catch(e){return Promise.reject(e)}},delete:function(n){try{return Promise.resolve(e).then(function(e){return e.delete("codeStore",n)})}catch(e){return Promise.reject(e)}},clear:function(){try{return Promise.resolve(e).then(function(e){return e.clear("codeStore")})}catch(e){return Promise.reject(e)}},keys:function(){try{return Promise.resolve(e).then(function(e){return e.getAllKeys("codeStore")})}catch(e){return Promise.reject(e)}}};return o}(e.openDB("localZedCodeStore",1,{upgrade:function(e){e.createObjectStore("codeStore")},blocked:function(){},blocking:function(){},terminated:function(){}}),!0)};
//# sourceMappingURL=shadb.js.map
