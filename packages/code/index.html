<!DOCTYPE html>
<html>

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1">
  <meta content="utf-8" http-equiv="encoding">

  <script crossorigin src="https://unpkg.com/react@17.0.1/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@emotion/react@11.0.0/dist/emotion-react.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/@emotion/styled@11.0.0/dist/emotion-styled.umd.min.js"></script>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>

  <style>
    #container {
      background-color: #1e1e1e;
      width: 100vw;
      height: 100vh;
    }


    #error {
      display: none;
      background-color: red;
      opacity: 0.7;
    }


    #ace {
      display: none;
    }


  

    #ace {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }


    .almosthidden {
      opacity: 0.5;
    }

    button {
      font-size: large;
    }
  </style>
</head>

<body>
  <div id="error" class="draggable"></div>
  <div id="root"></div>
  
  <div id="container"></div>

  <div id="ace"></div>

  <script type="module">
  import * as Comlink from "https://unpkg.com/comlink@4.3.0/dist/esm/comlink.mjs";

  const SHATEST = {};


  async function initComlink() {
    const { port1, port2 } = new MessageChannel();
    const msg = {
      comlinkInit: true,
      port: port1,
    };
    navigator.serviceWorker.controller.postMessage(msg, [port1]);

    const swProxy = Comlink.wrap(port2);
    console.log(await swProxy.counter);
      
    SHATEST.get = async (key) => await swProxy.get(key);
    SHATEST.put = async (key, value) => await swProxy.put(key, value);

    await swProxy.inc();
    console.log(await swProxy.counter);
  }

  navigator.serviceWorker.addEventListener("controllerchange", initComlink);

if (navigator.serviceWorker) {
  navigator.serviceWorker.register("sw.js");
  initComlink()
}


navigator.serviceWorker.ready.then(registration => {
  registration.active.postMessage('ping');
});
// navigator.serviceWorker.getRegistrations().then(function (registrations) {
//     for (let registration of registrations) {
//       registration.unregister();
//     }
//   });

</script>

  <script type="module">
    // window["motion"] = window["Motion"].motion;
    window["css"] = window["emotionReact"].css;
    window["jsx"] = window["emotionReact"].jsx;

    window["styled"] = window["emotionStyled"];

    //inject

   // bling.js
const $ = window.$ = document.querySelector.bind(document);
const $$ = window.$$ = document.querySelectorAll.bind(document);
Node.prototype.on = window.on = function (name, fn) {
  this.addEventListener(name, fn);
};
NodeList.prototype.__proto__ = Array.prototype;
NodeList.prototype.on = NodeList.prototype.addEventListener =
  (function (name, fn) {
    this.forEach(function (elem) {
      elem.on(name, fn);
    });
  });


    //inject

    async function restartCode(transpileCode) {

    const regex2 = /styled.div/gi;

    const replaced = transpileCode.replaceAll(regex2, "styled(motion.div)");
  //  console.log(replaced);
    const restart = new Function(
      "replaced",
      `return function() {  
        !!!{replaced}
      }`,
    )()
    restart();
  }

    

  </script>

  <script type="module">

    const runner = async () => {
      const version = "latest";
      const cdnAddress = "https://unpkg.com/@zedvision/code@";
      const script = "/dist/_cBundle.js.min.js";


      if (window.location.href.includes("0.0.0.0") || window.location.href.includes("localhost")) {
        const { run } = await import("./dist/_cBundle.js")
        run();
      } else {
        const { run } = await import(cdnAddress + version + script)
         run();
      }


    }


    runner();
  </script>
</body>

</html>