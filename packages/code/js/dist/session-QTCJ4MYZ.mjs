import{Record as n}from"https://ga.jspm.io/npm:immutable@4.0.0/dist/immutable.es.js";import c from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-create.mjs";import l from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-patch.mjs";function p(s,t){return n({...t,room:s,state:n(t.state)()})}var u=class{session;hashCodeSession;room="";created=new Date().toISOString();constructor(s,t){let e=null;this.room=s,this.session=p(s,{...t,state:e||t.state,capabilities:{...t.capabilities,sessionStorage:g("sessionStorage")}})(),this.hashCodeSession=this.session.get("state").hashCode()}addEvent(s){this.session.get("events").push({...s}),setTimeout(()=>this.processEvents)}hashCode(){return this.session.get("state").hashCode()}processEvents(){let s=this.session.get("events"),t=s.shift();if(t)switch(t.type){case"code-init":let{code:e,transpiled:o,i,css:r,errorDiff:a,html:h}=t,d={code:e,transpiled:o,i,css:r,errorDiff:a,html:h};this.session.set("events",s),this.session.set("state",n(d)())}}updateState(s){let t=JSON.stringify(this.session.get("state").toJS()),e=this.session.get("state").hashCode();this.session=this.session.set("state",n(s)());let o=JSON.stringify(this.session.get("state").toJS()),i=this.session.get("state").hashCode(),r=S(t,o);return{oldHash:e,newHash:i,patch:r}}applyPatch({oldHash:s,newHash:t,patch:e}){if(this.session.get("state").hashCode()!==s){console.error("Cant update");return}let o=JSON.stringify(this.session.get("state").toJS()),i=JSON.parse(l(o,JSON.parse(e)));if(this.session=this.session.set("state",n(i)()),this.session.get("state").hashCode()!==t){console.error("WRONG update");return}}json(){let s=this.session.toJSON(),t=s.state.toJSON();return{...s,state:t}}setRoom(s){let t=this.session.set("room",s);this.session=t}},f=null,J=(s,t)=>f||new u(s,t);function g(s){try{if(window.hasOwnProperty(s)===!1)return;var t=window[s],e="__storage_test__";return t.setItem(e,e),t.removeItem(e),!0}catch{return!1}}function S(s,t){return JSON.stringify(c(s,t))}export{u as CodeSession,J as default};
//# sourceMappingURL=session-QTCJ4MYZ.mjs.map
