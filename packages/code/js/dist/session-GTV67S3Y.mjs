import{Record as a}from"https://ga.jspm.io/npm:immutable@4.0.0/dist/immutable.es.js";function m(s,t){return a({...t,room:s,state:a(t.state)()})}var S=class{session;hashCodeSession;room="";created=new Date().toISOString();constructor(s,t){let e=null;if(this.room=s,t.state.code===""&&s){let i=`state-${s}`;if(r("localStorage")){let n=localStorage.getItem(i);n?e=JSON.parse(n):fetch(`https://code.spike.land/api/room/${s}/mySession`).then(o=>o.json()).then(o=>{localStorage.setItem(i,JSON.stringify(o.state)),this.session.set("state",a(o.state)())})}}this.session=m(s,{...t,state:e||t.state,capabilities:{...t.capabilities,sessionStorage:r("sessionStorage")}})(),this.hashCodeSession=this.session.get("state").hashCode()}addEvent(s){this.session.get("events").push({...s}),setTimeout(()=>this.processEvents)}hashCode(){return this.session.get("state").hashCode()}processEvents(){let s=this.session.get("events"),t=s.shift();if(t)switch(t.type){case"code-init":let{code:e,transpiled:i,i:n,css:o,errorDiff:l,html:c}=t,h={code:e,transpiled:i,i:n,css:o,errorDiff:l,html:c};this.session.set("events",s),this.session.set("state",a(h)());let d=`state-${this.room}`;r("localStorage")&&localStorage.setItem(d,JSON.stringify(h)),this.session.set("events",s)}}json(){let s=this.session.toJSON(),t=s.state.toJSON();return{...s,state:t}}setRoom(s){let t=this.session.set("room",s);this.session=t}},f=null,p=(s,t)=>f||new S(s,t);function r(s){try{if(window.hasOwnProperty(s)===!1)return;var t=window[s],e="__storage_test__";return t.setItem(e,e),t.removeItem(e),!0}catch{return!1}}export{S as CodeSession,p as default};
//# sourceMappingURL=session-GTV67S3Y.mjs.map
