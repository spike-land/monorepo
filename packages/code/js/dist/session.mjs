import{a as F,b as W}from"./chunk-K6YBXHXL.mjs";var V=F((le,z)=>{var R=-1,f=1,O=0;function M(e,r,n,i){if(e===r)return e?[[O,e]]:[];if(n!=null){var a=se(e,r,n);if(a)return a}var s=A(e,r),t=e.substring(0,s);e=e.substring(s),r=r.substring(s),s=H(e,r);var o=e.substring(e.length-s);e=e.substring(0,e.length-s),r=r.substring(0,r.length-s);var l=x(e,r);return t&&l.unshift([O,t]),o&&l.push([O,o]),y(l,i),l}function x(e,r){var n;if(!e)return[[f,r]];if(!r)return[[R,e]];var i=e.length>r.length?e:r,a=e.length>r.length?r:e,s=i.indexOf(a);if(s!==-1)return n=[[f,i.substring(0,s)],[O,a],[f,i.substring(s+a.length)]],e.length>r.length&&(n[0][0]=n[2][0]=R),n;if(a.length===1)return[[R,e],[f,r]];var t=ne(e,r);if(t){var o=t[0],l=t[1],h=t[2],g=t[3],c=t[4],_=M(o,h),d=M(l,g);return _.concat([[O,c]],d)}return ee(e,r)}function ee(e,r){for(var n=e.length,i=r.length,a=Math.ceil((n+i)/2),s=a,t=2*a,o=new Array(t),l=new Array(t),h=0;h<t;h++)o[h]=-1,l[h]=-1;o[s+1]=0,l[s+1]=0;for(var g=n-i,c=g%2!==0,_=0,d=0,m=0,C=0,w=0;w<a;w++){for(var v=-w+_;v<=w-d;v+=2){var u=s+v,b;v===-w||v!==w&&o[u-1]<o[u+1]?b=o[u+1]:b=o[u-1]+1;for(var p=b-v;b<n&&p<i&&e.charAt(b)===r.charAt(p);)b++,p++;if(o[u]=b,b>n)d+=2;else if(p>i)_+=2;else if(c){var S=s+g-v;if(S>=0&&S<t&&l[S]!==-1){var I=n-l[S];if(b>=I)return j(e,r,b,p)}}}for(var E=-w+m;E<=w-C;E+=2){var S=s+E,I;E===-w||E!==w&&l[S-1]<l[S+1]?I=l[S+1]:I=l[S-1]+1;for(var N=I-E;I<n&&N<i&&e.charAt(n-I-1)===r.charAt(i-N-1);)I++,N++;if(l[S]=I,I>n)C+=2;else if(N>i)m+=2;else if(!c){var u=s+g-E;if(u>=0&&u<t&&o[u]!==-1){var b=o[u],p=s+b-u;if(I=n-I,b>=I)return j(e,r,b,p)}}}}return[[R,e],[f,r]]}function j(e,r,n,i){var a=e.substring(0,n),s=r.substring(0,i),t=e.substring(n),o=r.substring(i),l=M(a,s),h=M(t,o);return l.concat(h)}function A(e,r){if(!e||!r||e.charAt(0)!==r.charAt(0))return 0;for(var n=0,i=Math.min(e.length,r.length),a=i,s=0;n<a;)e.substring(s,a)==r.substring(s,a)?(n=a,s=n):i=a,a=Math.floor((i-n)/2+n);return Q(e.charCodeAt(a-1))&&a--,a}function H(e,r){if(!e||!r||e.slice(-1)!==r.slice(-1))return 0;for(var n=0,i=Math.min(e.length,r.length),a=i,s=0;n<a;)e.substring(e.length-a,e.length-s)==r.substring(r.length-a,r.length-s)?(n=a,s=n):i=a,a=Math.floor((i-n)/2+n);return G(e.charCodeAt(e.length-a))&&a--,a}function ne(e,r){var n=e.length>r.length?e:r,i=e.length>r.length?r:e;if(n.length<4||i.length*2<n.length)return null;function a(d,m,C){for(var w=d.substring(C,C+Math.floor(d.length/4)),v=-1,u="",b,p,S,I;(v=m.indexOf(w,v+1))!==-1;){var E=A(d.substring(C),m.substring(v)),N=H(d.substring(0,C),m.substring(0,v));u.length<N+E&&(u=m.substring(v-N,v)+m.substring(v,v+E),b=d.substring(0,C-N),p=d.substring(C+E),S=m.substring(0,v-N),I=m.substring(v+E))}return u.length*2>=d.length?[b,p,S,I,u]:null}var s=a(n,i,Math.ceil(n.length/4)),t=a(n,i,Math.ceil(n.length/2)),o;if(!s&&!t)return null;t?s?o=s[4].length>t[4].length?s:t:o=t:o=s;var l,h,g,c;e.length>r.length?(l=o[0],h=o[1],g=o[2],c=o[3]):(g=o[0],c=o[1],l=o[2],h=o[3]);var _=o[4];return[l,h,g,c,_]}function y(e,r){e.push([O,""]);for(var n=0,i=0,a=0,s="",t="",o;n<e.length;){if(n<e.length-1&&!e[n][1]){e.splice(n,1);continue}switch(e[n][0]){case f:a++,t+=e[n][1],n++;break;case R:i++,s+=e[n][1],n++;break;case O:var l=n-a-i-1;if(r){if(l>=0&&k(e[l][1])){var h=e[l][1].slice(-1);if(e[l][1]=e[l][1].slice(0,-1),s=h+s,t=h+t,!e[l][1]){e.splice(l,1),n--;var g=l-1;e[g]&&e[g][0]===f&&(a++,t=e[g][1]+t,g--),e[g]&&e[g][0]===R&&(i++,s=e[g][1]+s,g--),l=g}}if(K(e[n][1])){var h=e[n][1].charAt(0);e[n][1]=e[n][1].slice(1),s+=h,t+=h}}if(n<e.length-1&&!e[n][1]){e.splice(n,1);break}if(s.length>0||t.length>0){s.length>0&&t.length>0&&(o=A(t,s),o!==0&&(l>=0?e[l][1]+=t.substring(0,o):(e.splice(0,0,[O,t.substring(0,o)]),n++),t=t.substring(o),s=s.substring(o)),o=H(t,s),o!==0&&(e[n][1]=t.substring(t.length-o)+e[n][1],t=t.substring(0,t.length-o),s=s.substring(0,s.length-o)));var c=a+i;s.length===0&&t.length===0?(e.splice(n-c,c),n=n-c):s.length===0?(e.splice(n-c,c,[f,t]),n=n-c+1):t.length===0?(e.splice(n-c,c,[R,s]),n=n-c+1):(e.splice(n-c,c,[R,s],[f,t]),n=n-c+2)}n!==0&&e[n-1][0]===O?(e[n-1][1]+=e[n][1],e.splice(n,1)):n++,a=0,i=0,s="",t="";break}}e[e.length-1][1]===""&&e.pop();var _=!1;for(n=1;n<e.length-1;)e[n-1][0]===O&&e[n+1][0]===O&&(e[n][1].substring(e[n][1].length-e[n-1][1].length)===e[n-1][1]?(e[n][1]=e[n-1][1]+e[n][1].substring(0,e[n][1].length-e[n-1][1].length),e[n+1][1]=e[n-1][1]+e[n+1][1],e.splice(n-1,1),_=!0):e[n][1].substring(0,e[n+1][1].length)==e[n+1][1]&&(e[n-1][1]+=e[n+1][1],e[n][1]=e[n][1].substring(e[n+1][1].length)+e[n+1][1],e.splice(n+1,1),_=!0)),n++;_&&y(e,r)}function Q(e){return e>=55296&&e<=56319}function G(e){return e>=56320&&e<=57343}function K(e){return G(e.charCodeAt(0))}function k(e){return Q(e.charCodeAt(e.length-1))}function re(e){for(var r=[],n=0;n<e.length;n++)e[n][1].length>0&&r.push(e[n]);return r}function P(e,r,n,i){return k(e)||K(i)?null:re([[O,e],[R,r],[f,n],[O,i]])}function se(e,r,n){var i=typeof n=="number"?{index:n,length:0}:n.oldRange,a=typeof n=="number"?null:n.newRange,s=e.length,t=r.length;if(i.length===0&&(a===null||a.length===0)){var o=i.index,l=e.slice(0,o),h=e.slice(o),g=a?a.index:null;e:{var c=o+t-s;if(g!==null&&g!==c||c<0||c>t)break e;var _=r.slice(0,c),d=r.slice(c);if(d!==h)break e;var m=Math.min(o,c),C=l.slice(0,m),w=_.slice(0,m);if(C!==w)break e;var v=l.slice(m),u=_.slice(m);return P(C,v,u,h)}e:{if(g!==null&&g!==o)break e;var b=o,_=r.slice(0,b),d=r.slice(b);if(_!==l)break e;var p=Math.min(s-b,t-b),S=h.slice(h.length-p),I=d.slice(d.length-p);if(S!==I)break e;var v=h.slice(0,h.length-p),u=d.slice(0,d.length-p);return P(l,v,u,S)}}if(i.length>0&&a&&a.length===0){e:{var C=e.slice(0,i.index),S=e.slice(i.index+i.length),m=C.length,p=S.length;if(t<m+p)break e;var w=r.slice(0,m),I=r.slice(t-p);if(C!==w||S!==I)break e;var v=e.slice(m,s-p),u=r.slice(m,t-p);return P(C,v,u,S)}}return null}function U(e,r,n){return M(e,r,n,!0)}U.INSERT=f;U.DELETE=R;U.EQUAL=O;z.exports=U});var Y=F((he,X)=>{"use strict";var te=V();X.exports=function(e,r){for(var n=te(e,r),i=0;i<n.length;i++){var a=n[i];a[0]<1&&(a[1]=a[1].length)}return n}});var $=F((ce,Z)=>{"use strict";Z.exports=function(e,r){for(var n="",i=0,a=0;a<r.length;a++){var s=r[a],t=s[0],o=s[1];t==-1?i+=o:t==0?n+=e.slice(i,i+=o):n+=o}return n}});var B=W(Y()),L=W($());import{Record as D}from"https://ga.jspm.io/npm:immutable@4.0.0/dist/immutable.es.js";function ie(e,r){return D({...r,room:e,state:D(r.state)()})}var J={},T=class{session;hashCodeSession;room="";created=new Date().toISOString();constructor(r,n){let i=null;this.room=r,this.session=ie(r,{...n,state:i||n.state,capabilities:{...n.capabilities,sessionStorage:oe("sessionStorage")}})(),this.hashCodeSession=this.session.get("state").hashCode(),J[this.session.get("state").hashCode()]=this.session.get("state")}addEvent(r){this.session.get("events").push({...r}),setTimeout(()=>this.processEvents)}hashCode(){return this.session.get("state").hashCode()}processEvents(){let r=this.session.get("events"),n=r.shift();if(n)switch(n.type){case"code-init":let{code:i,transpiled:a,i:s,css:t,errorDiff:o,html:l}=n,h={code:i,transpiled:a,i:s,css:t,errorDiff:o,html:l};this.session.set("events",r),this.session.set("state",D(h)())}}createPatchFromHashCode(r,n){if(J[r]){let i=J[r],a=JSON.stringify(i.toJSON()),s=i.merge(n),t=s.hashCode();J[t]=s;let o=JSON.stringify(s.toJSON()),l=q(a,o);return{oldHash:r,newHash:t,patch:l}}}createPatch(r){if(r.code===this.session.get("state").get("code"))return{oldHash:this.session.get("state").hashCode(),newHash:this.session.get("state").hashCode(),patch:""};let n=JSON.stringify(this.session.get("state").toJSON()),i=this.session.get("state").hashCode();J[i]=this.session.get("state");let s=this.session.get("state").merge(r),t=s.hashCode();J[t]=s;let o=JSON.stringify(s.toJSON()),l=q(n,o);return{oldHash:i,newHash:t,patch:l}}applyPatch({oldHash:r,newHash:n,patch:i}){if(this.session.get("state").hashCode()!==r){console.error("Cant update");return}let s=this.session.get("state").toJSON(),t=JSON.stringify(s),o=s.code,l=JSON.parse((0,L.default)(t,JSON.parse(i))),h=D(l)();console.log({newState:l}),console.log(h.hashCode());let g=this.session.get("state").merge(h),c=g.get("code");if(o===c)return;if(console.log(g.hashCode()),g.hashCode()===n){this.session=this.session.set("state",g);return}else console.log("WRONG"),console.log({newState:l})}json(){let r=this.session.toJSON(),n=r.state.toJSON();return{...r,state:n}}setRoom(r){let n=this.session.set("room",r);this.session=n}},ae=null,be=(e,r)=>ae||new T(e,r);function oe(e){try{if(window.hasOwnProperty(e)===!1)return;var r=window[e],n="__storage_test__";return r.setItem(n,n),r.removeItem(n),!0}catch{return!1}}function q(e,r){return JSON.stringify((0,B.default)(e,r))}export{T as CodeSession,be as default};
//# sourceMappingURL=session.mjs.map
