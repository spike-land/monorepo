import{Record as g}from"https://ga.jspm.io/npm:immutable@4.0.0/dist/immutable.es.js";import m from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-create.mjs";import C from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-patch.mjs";function I(o,e){return g({...e,room:o,state:g(e.state)()})}var c={},p=class{session;hashCodeSession;room="";created=new Date().toISOString();constructor(e,s){let t=null;this.room=e,this.session=I(e,{...s,state:t||s.state,capabilities:{...s.capabilities,sessionStorage:b("sessionStorage")}})(),this.hashCodeSession=this.session.get("state").hashCode(),c[this.session.get("state").hashCode()]=this.session.get("state")}addEvent(e){this.session.get("events").push({...e}),setTimeout(()=>this.processEvents)}hashCode(){return this.session.get("state").hashCode()}processEvents(){let e=this.session.get("events"),s=e.shift();if(s)switch(s.type){case"code-init":let{code:t,transpiled:h,i:n,css:i,errorDiff:a,html:r}=s,d={code:t,transpiled:h,i:n,css:i,errorDiff:a,html:r};this.session.set("events",e),this.session.set("state",g(d)())}}createPatchFromHashCode(e,s){if(c[e]){let t=c[e],h=JSON.stringify(t.toJSON()),n=t.merge(s),i=n.hashCode();c[i]=n;let a=JSON.stringify(n.toJSON()),r=S(h,a);return{oldHash:e,newHash:i,patch:r}}}createPatch(e){if(e.code===this.session.get("state").get("code"))return{oldHash:this.session.get("state").hashCode(),newHash:this.session.get("state").hashCode(),patch:""};let s=JSON.stringify(this.session.get("state").toJSON()),t=this.session.get("state").hashCode();c[t]=this.session.get("state");let n=this.session.get("state").merge(e),i=n.hashCode();c[i]=n;let a=JSON.stringify(n.toJSON()),r=S(s,a);return{oldHash:t,newHash:i,patch:r}}applyPatch({oldHash:e,newHash:s,patch:t}){if(this.session.get("state").hashCode()!==e){console.error("Cant update");return}let n=this.session.get("state").toJSON(),i=JSON.stringify(n),a=n.code,r=JSON.parse(C(i,JSON.parse(t))),d=g(r)();console.log({newState:r}),console.log(d.hashCode());let l=this.session.get("state").merge(d),u=l.get("code");if(a===u)return;if(console.log(l.hashCode()),l.hashCode()===s){this.session=this.session.set("state",l);return}else console.log("WRONG"),console.log({newState:r})}json(){let e=this.session.toJSON(),s=e.state.toJSON();return{...e,state:s}}setRoom(e){let s=this.session.set("room",e);this.session=s}},f=null,R=(o,e)=>f||new p(o,e);function b(o){try{if(window.hasOwnProperty(o)===!1)return;var e=window[o],s="__storage_test__";return e.setItem(s,s),e.removeItem(s),!0}catch{return!1}}function S(o,e){return JSON.stringify(m(o,e))}export{p as CodeSession,R as default};
//# sourceMappingURL=session.mjs.map
