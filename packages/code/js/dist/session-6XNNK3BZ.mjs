import{Record as c}from"https://ga.jspm.io/npm:immutable@4.0.0/dist/immutable.es.js";import d from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-create.mjs";import g from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-patch.mjs";function f(s,e){return c({...e,room:s,state:c(e.state)()})}var u=class{session;hashCodeSession;room="";created=new Date().toISOString();constructor(s,e){let t=null;this.room=s,this.session=f(s,{...e,state:t||e.state,capabilities:{...e.capabilities,sessionStorage:S("sessionStorage")}})(),this.hashCodeSession=this.session.get("state").hashCode()}addEvent(s){this.session.get("events").push({...s}),setTimeout(()=>this.processEvents)}hashCode(){return this.session.get("state").hashCode()}processEvents(){let s=this.session.get("events"),e=s.shift();if(e)switch(e.type){case"code-init":let{code:t,transpiled:o,i:a,css:r,errorDiff:i,html:h}=e,n={code:t,transpiled:o,i:a,css:r,errorDiff:i,html:h};this.session.set("events",s),this.session.set("state",c(n)())}}createPatch(s){if(s.code===this.session.get("state").get("code"))return{oldHash:this.session.get("state").hashCode(),newHash:this.session.get("state").hashCode(),patch:""};let e=JSON.stringify(this.session.get("state").toJSON()),t=this.session.get("state").hashCode(),o=this.session.get("state").merge(s),a=o.hashCode(),r=JSON.stringify(o.toJSON()),i=m(e,r);return{oldHash:t,newHash:a,patch:i}}applyPatch({oldHash:s,newHash:e,patch:t}){if(this.session.get("state").hashCode()!==s){console.error("Cant update");return}let o=this.session.get("state").toJSON(),a=JSON.stringify(o),r=o.code,i=JSON.parse(g(a,JSON.parse(t))),h=c(i)();console.log({newState:i}),console.log(h.hashCode());let n=this.session.get("state").merge(h),l=n.get("code");if(r!==l)if(console.log(n.hashCode()),n.hashCode()===e){this.session=this.session.set("state",n);return}else console.log("WRONG"),console.log({newState:i})}json(){let s=this.session.toJSON(),e=s.state.toJSON();return{...s,state:e}}setRoom(s){let e=this.session.set("room",s);this.session=e}},p=null,N=(s,e)=>p||new u(s,e);function S(s){try{if(window.hasOwnProperty(s)===!1)return;var e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),!0}catch{return!1}}function m(s,e){return JSON.stringify(d(s,e))}export{u as CodeSession,N as default};
//# sourceMappingURL=session-6XNNK3BZ.mjs.map
