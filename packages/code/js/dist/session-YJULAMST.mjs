import{Record as c}from"https://ga.jspm.io/npm:immutable@4.0.0/dist/immutable.es.js";import f from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-create.mjs";import S from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-patch.mjs";function u(s,t){return c({...t,room:s,state:c(t.state)()})}var l={},p=class{session;hashCodeSession;room="";created=new Date().toISOString();constructor(s,t){let e=null;this.room=s,this.session=u(s,{...t,state:e||t.state,capabilities:{...t.capabilities,sessionStorage:C("sessionStorage")}})(),this.hashCodeSession=this.session.get("state").hashCode(),l[this.session.get("state").hashCode()]=this.session.get("state")}addEvent(s){this.session.get("events").push({...s}),setTimeout(()=>this.processEvents)}hashCode(){return this.session.get("state").hashCode()}processEvents(){let s=this.session.get("events"),t=s.shift();if(t)switch(t.type){case"code-init":let{code:e,transpiled:o,i,css:a,errorDiff:n,html:h}=t,r={code:e,transpiled:o,i,css:a,errorDiff:n,html:h};this.session.set("events",s),this.session.set("state",c(r)())}}createPatchFromHashCode(s,t){if(l[s]){let e=l[s],o=JSON.stringify(e.toJSON()),i=e.merge(t),a=i.hashCode();l[a]=i;let n=JSON.stringify(i.toJSON()),h=d(o,n);return{oldHash:s,newHash:a,patch:h}}}createPatch(s){if(s.code===this.session.get("state").get("code"))return{oldHash:this.session.get("state").hashCode(),newHash:this.session.get("state").hashCode(),patch:""};let t=JSON.stringify(this.session.get("state").toJSON()),e=this.session.get("state").hashCode();l[e]=this.session.get("state");let o=this.session.get("state").merge(s),i=o.hashCode();l[i]=o;let a=JSON.stringify(o.toJSON()),n=d(t,a);return{oldHash:e,newHash:i,patch:n}}applyPatch({oldHash:s,newHash:t,patch:e}){if(this.session.get("state").hashCode()!==s){console.error("Cant update");return}let o=this.session.get("state").toJSON(),i=JSON.stringify(o),a=o.code,n=JSON.parse(S(i,JSON.parse(e))),h=c(n)();console.log({newState:n}),console.log(h.hashCode());let r=this.session.get("state").merge(h),g=r.get("code");if(a!==g)if(console.log(r.hashCode()),r.hashCode()===t){this.session=this.session.set("state",r);return}else console.log("WRONG"),console.log({newState:n})}json(){let s=this.session.toJSON(),t=s.state.toJSON();return{...s,state:t}}setRoom(s){let t=this.session.set("room",s);this.session=t}},m=null,w=(s,t)=>m||new p(s,t);function C(s){try{if(window.hasOwnProperty(s)===!1)return;var t=window[s],e="__storage_test__";return t.setItem(e,e),t.removeItem(e),!0}catch{return!1}}function d(s,t){return JSON.stringify(f(s,t))}export{p as CodeSession,w as default};
//# sourceMappingURL=session-YJULAMST.mjs.map
