{
  "version": 3,
  "sources": ["../quickStart.mjs"],
  "sourcesContent": ["import { jsx } from \"@emotion/react\";\n\nlet formatter;\nlet transform;\n\nlet esbuildEsmTransform;\n// let esbuildTransform;\n// let babelTransform;\nlet getHtmlAndCss;\nlet initSess;\n\nexport const initSession = async (room, initData) => {\n  initSess = initSess || (await import(`./dist/session.mjs`)).default;\n\n  return initSess(room, initData);\n};\n\nexport const prettier = async (code) => {\n  formatter = formatter || (await import(`./formatter.mjs`)).formatter;\n  return await formatter(code);\n};\n\n// //\n\nexport async function startMonacoWithSession(session) {\n  const shadDom = document.getElementById(\"shadowEditor\");\n\n  const startMonaco = (await import(\"./dist/startMonaco.mjs\")).default;\n  const getEditor = await startMonaco(\n    /**\n     * @param {any} code\n     */\n    {\n      language: \"typescript\",\n      container: shadDom,\n      code: session.code,\n      /**\n       * @param {string} code\n       */\n      onChange: (code, changes) => runner(code, changes, session, ++session.i),\n    },\n  );\n\n  session.editor = getEditor();\n\n  const monaco = window.monaco;\n\n  monaco.languages.registerOnTypeFormattingEditProvider(\"typescript\", {\n    autoFormatTriggerCharacters: [\"}\", \"{\", \")\", \"(\", \";\"],\n\n    async provideOnTypeFormattingEdits(model) {\n      const text = await formatter(model.getValue());\n\n      return [\n        {\n          range: model.getFullModelRange(),\n\n          text,\n        },\n      ];\n    },\n  });\n\n  window.sess = session;\n  session.monaco = window.monaco;\n}\n\nasync function getErrors({ monaco, editor }) {\n  if (!monaco) {\n    return [{ messageText: \"Error with the error checking. Try to reload!\" }];\n  }\n\n  const model = editor.getModel();\n  const worker = await monaco.languages.typescript.getTypeScriptWorker();\n  const client = await worker(model);\n\n  const filename = model.uri.toString();\n  const diag = client.getSemanticDiagnostics(filename);\n  const comp = client.getCompilerOptionsDiagnostics(filename);\n  const syntax = client.getSyntacticDiagnostics(filename);\n  const fastError = await Promise.race([diag, comp, syntax]);\n\n  // model.dispose();\n  console.log(fastError);\n  return [];\n}\n\n// let getHtmlAndCss;\n\nasync function runner(c, changes = null, session, counter) {\n  // if (!esbuildEsmTransform || !formatter ) session.broad({...session, code: c, errorText: \"PRE\" })\n\n  session.changes.push(changes);\n  formatter = formatter || (await import(`./formatter.mjs`)).formatter;\n  esbuildEsmTransform = esbuildEsmTransform ||\n    (await import(`./esbuildEsm.mjs`)).transform;\n\n  transform = esbuildEsmTransform;\n\n  session.errorText = \"\";\n\n  const { monaco } = session;\n\n  try {\n    const cd = await formatter(c);\n\n    const transpiled = await transform(cd);\n\n    let restartError = false;\n    ///yellow\n    if (transpiled.length) {\n      if (counter < session.i) return;\n\n      try {\n        getHtmlAndCss = getHtmlAndCss ||\n          (await import(\"./vendor/renderToString.mjs\")).getHtmlAndCss;\n\n        if (counter < session.i) return;\n\n        const App = await getApp(transpiled);\n        const { html, css } = getHtmlAndCss(App);\n\n        session.transpiled = transpiled;\n        session.html = html;\n\n        const children = await getReactChild(transpiled);\n\n        // session.html = zbody.innerHTML;\n\n        session.setChild((c) => [...c, children]);\n        session.children = children;\n        restartError = !html;\n        session.code = cd;\n        session.codeNonFormatted = c;\n        // getCss = getCss || (await import(\"./templates.ts\")).getCss;\n        // setTimeout(async () => {\n        //     session.html = document.getElementById(\"zbody\").innerHTML;\n        // const css = getCss(session);\n        const code = cd;\n        session.css = css;\n        if (session.i !== counter) return;\n        session.saveCode &&\n          await session.saveCode({ transpiled, code, i: counter, css, html });\n        monaco.editor.setTheme(\"vs-dark\");\n        // }, 10);\n\n        return;\n      } catch (e) {\n        console.error(\"EXCEPTION\");\n        console.log({ e });\n        restartError = true;\n        console.error({ restartError });\n      }\n    }\n    if (session.i > counter) return;\n    const err = await getErrors(session);\n    if (session.i > counter) return;\n\n    if (restartError) {\n      err.push(\n        { messageText: \"Error while starting the app. Check the console!\" },\n      );\n    }\n\n    if (err.length) console.log({ err });\n\n    monaco.editor.setTheme(\"vs-dark\");\n  } catch (err) {\n    monaco.editor.setTheme(\"vs-light\");\n    setTimeout(() => {\n      monaco.editor.setTheme(\"hc-black\");\n    }, 50);\n    session.errorText = err.message;\n    console.error(err.message);\n  }\n}\n\nexport const startFromCode = async ({ code }) => {\n  let session = {\n    code,\n    i: 0,\n    changes: [],\n    saveCode: () => {},\n    setChild: () => {},\n  };\n  await runner(code, null, session);\n  await quickStart(session);\n};\n\nexport async function quickStart(session, room, keepFullScreen, saveCode) {\n  session.saveCode = saveCode;\n  // session.children = await getReactChild(session.transpiled);\n  session.children = null;\n  const { renderPreviewWindow } = await import(\n    \"./dist/renderPreviewWindow.mjs\"\n  );\n\n  await renderPreviewWindow(session, room, keepFullScreen);\n\n  // if (localStorage && session) {\n  //   const { code, transpiled, html, css, i } = session;\n  //   localStorage.setItem(\n  //     `state-${session.room}`,\n  //     JSON.stringify({ code, transpiled, html, css, i }),\n  //   );\n  // }\n  // // document.getElementById(\"root\").remove();\n\n  if (!keepFullScreen) await startMonacoWithSession(session);\n  session.update = (c) => runner(c, null, session);\n  runner(session.code, null, session, -1);\n}\n\nasync function getReactChild(transpiled, mode = \"window\") {\n  const codeToHydrate = mode === \"window\"\n    ? transpiled.replace(\"body{\", \"#zbody{\")\n    : transpiled;\n\n  const objUrl = createJsBlob(\n    codeToHydrate,\n  );\n\n  const mod = (await import(objUrl));\n  URL.revokeObjectURL(objUrl);\n\n  return jsx(mod.default);\n}\n\n// function createPatch(oldCode, newCode, createDelta) {\n//   return JSON.stringify(createDelta(oldCode, newCode));\n// }\n\n/**\n * @param {BlobPart} code\n */\nfunction createJsBlob(code) {\n  const blob = new Blob([code], { type: \"application/javascript\" });\n\n  return URL.createObjectURL(blob);\n}\n\nasync function getApp(transpiled, mode = \"window\") {\n  const codeToHydrate = mode === \"window\"\n    ? transpiled.replace(\"body{\", \"#zbody{\")\n    : transpiled;\n\n  const objUrl = createJsBlob(\n    codeToHydrate,\n  );\n\n  const App = (await import(objUrl)).default;\n\n  URL.revokeObjectURL(objUrl);\n\n  return App;\n}\n"],
  "mappings": "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",
  "names": []
}
