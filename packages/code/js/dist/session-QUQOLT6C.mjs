import{a as L,b as Q}from"./chunk-PT65LV75.mjs";import"./chunk-UPO26O35.mjs";import{Record as j}from"https://ga.jspm.io/npm:immutable@4.0.0/dist/immutable.es.js";var X=L((o,g)=>{var c=-1,v=1,u=0;function S(t,e,s,l){if(t===e)return t?[[u,t]]:[];if(s!=null){var n=z(t,e,s);if(n)return n}var r=D(t,e),i=t.substring(0,r);t=t.substring(r),e=e.substring(r),r=F(t,e);var h=t.substring(t.length-r);t=t.substring(0,t.length-r),e=e.substring(0,e.length-r);var a=k(t,e);return i&&a.unshift([u,i]),h&&a.push([u,h]),U(a,l),a}function k(t,e){var s;if(!t)return[[v,e]];if(!e)return[[c,t]];var l=t.length>e.length?t:e,n=t.length>e.length?e:t,r=l.indexOf(n);if(r!==-1)return s=[[v,l.substring(0,r)],[u,n],[v,l.substring(r+n.length)]],t.length>e.length&&(s[0][0]=s[2][0]=c),s;if(n.length===1)return[[c,t],[v,e]];var i=Y(t,e);if(i){var h=i[0],a=i[1],d=i[2],b=i[3],f=i[4],H=S(h,d),x=S(a,b);return H.concat([[u,f]],x)}return w(t,e)}function w(t,e){for(var s=t.length,l=e.length,n=Math.ceil((s+l)/2),r=n,i=2*n,h=new Array(i),a=new Array(i),d=0;d<i;d++)h[d]=-1,a[d]=-1;h[r+1]=0,a[r+1]=0;for(var b=s-l,f=b%2!==0,H=0,x=0,C=0,M=0,N=0;N<n;N++){for(var p=-N+H;p<=N-x;p+=2){var O=r+p,m;p===-N||p!==N&&h[O-1]<h[O+1]?m=h[O+1]:m=h[O-1]+1;for(var J=m-p;m<s&&J<l&&t.charAt(m)===e.charAt(J);)m++,J++;if(h[O]=m,m>s)x+=2;else if(J>l)H+=2;else if(f){var y=r+b-p;if(y>=0&&y<i&&a[y]!==-1){var A=s-a[y];if(m>=A)return R(t,e,m,J)}}}for(var _=-N+C;_<=N-M;_+=2){var y=r+_,A;_===-N||_!==N&&a[y-1]<a[y+1]?A=a[y+1]:A=a[y-1]+1;for(var I=A-_;A<s&&I<l&&t.charAt(s-A-1)===e.charAt(l-I-1);)A++,I++;if(a[y]=A,A>s)M+=2;else if(I>l)C+=2;else if(!f){var O=r+b-_;if(O>=0&&O<i&&h[O]!==-1){var m=h[O],J=r+m-O;if(A=s-A,m>=A)return R(t,e,m,J)}}}}return[[c,t],[v,e]]}function R(t,e,s,l){var n=t.substring(0,s),r=e.substring(0,l),i=t.substring(s),h=e.substring(l),a=S(n,r),d=S(i,h);return a.concat(d)}function D(t,e){if(!t||!e||t.charAt(0)!==e.charAt(0))return 0;for(var s=0,l=Math.min(t.length,e.length),n=l,r=0;s<n;)t.substring(r,n)==e.substring(r,n)?(s=n,r=s):l=n,n=Math.floor((l-s)/2+s);return W(t.charCodeAt(n-1))&&n--,n}function F(t,e){if(!t||!e||t.slice(-1)!==e.slice(-1))return 0;for(var s=0,l=Math.min(t.length,e.length),n=l,r=0;s<n;)t.substring(t.length-n,t.length-r)==e.substring(e.length-n,e.length-r)?(s=n,r=s):l=n,n=Math.floor((l-s)/2+s);return q(t.charCodeAt(t.length-n))&&n--,n}function Y(t,e){var s=t.length>e.length?t:e,l=t.length>e.length?e:t;if(s.length<4||l.length*2<s.length)return null;function n(x,C,M){for(var N=x.substring(M,M+Math.floor(x.length/4)),p=-1,O="",m,J,y,A;(p=C.indexOf(N,p+1))!==-1;){var _=D(x.substring(M),C.substring(p)),I=F(x.substring(0,M),C.substring(0,p));O.length<I+_&&(O=C.substring(p-I,p)+C.substring(p,p+_),m=x.substring(0,M-I),J=x.substring(M+_),y=C.substring(0,p-I),A=C.substring(p+_))}return O.length*2>=x.length?[m,J,y,A,O]:null}var r=n(s,l,Math.ceil(s.length/4)),i=n(s,l,Math.ceil(s.length/2)),h;if(!r&&!i)return null;i?r?h=r[4].length>i[4].length?r:i:h=i:h=r;var a,d,b,f;t.length>e.length?(a=h[0],d=h[1],b=h[2],f=h[3]):(b=h[0],f=h[1],a=h[2],d=h[3]);var H=h[4];return[a,d,b,f,H]}function U(t,e){t.push([u,""]);for(var s=0,l=0,n=0,r="",i="",h;s<t.length;){if(s<t.length-1&&!t[s][1]){t.splice(s,1);continue}switch(t[s][0]){case v:n++,i+=t[s][1],s++;break;case c:l++,r+=t[s][1],s++;break;case u:var a=s-n-l-1;if(e){if(a>=0&&K(t[a][1])){var d=t[a][1].slice(-1);if(t[a][1]=t[a][1].slice(0,-1),r=d+r,i=d+i,!t[a][1]){t.splice(a,1),s--;var b=a-1;t[b]&&t[b][0]===v&&(n++,i=t[b][1]+i,b--),t[b]&&t[b][0]===c&&(l++,r=t[b][1]+r,b--),a=b}}if(B(t[s][1])){var d=t[s][1].charAt(0);t[s][1]=t[s][1].slice(1),r+=d,i+=d}}if(s<t.length-1&&!t[s][1]){t.splice(s,1);break}if(r.length>0||i.length>0){r.length>0&&i.length>0&&(h=D(i,r),h!==0&&(a>=0?t[a][1]+=i.substring(0,h):(t.splice(0,0,[u,i.substring(0,h)]),s++),i=i.substring(h),r=r.substring(h)),h=F(i,r),h!==0&&(t[s][1]=i.substring(i.length-h)+t[s][1],i=i.substring(0,i.length-h),r=r.substring(0,r.length-h)));var f=n+l;r.length===0&&i.length===0?(t.splice(s-f,f),s=s-f):r.length===0?(t.splice(s-f,f,[v,i]),s=s-f+1):i.length===0?(t.splice(s-f,f,[c,r]),s=s-f+1):(t.splice(s-f,f,[c,r],[v,i]),s=s-f+2)}s!==0&&t[s-1][0]===u?(t[s-1][1]+=t[s][1],t.splice(s,1)):s++,n=0,l=0,r="",i="";break}}t[t.length-1][1]===""&&t.pop();var H=!1;for(s=1;s<t.length-1;)t[s-1][0]===u&&t[s+1][0]===u&&(t[s][1].substring(t[s][1].length-t[s-1][1].length)===t[s-1][1]?(t[s][1]=t[s-1][1]+t[s][1].substring(0,t[s][1].length-t[s-1][1].length),t[s+1][1]=t[s-1][1]+t[s+1][1],t.splice(s-1,1),H=!0):t[s][1].substring(0,t[s+1][1].length)==t[s+1][1]&&(t[s-1][1]+=t[s+1][1],t[s][1]=t[s][1].substring(t[s+1][1].length)+t[s+1][1],t.splice(s+1,1),H=!0)),s++;H&&U(t,e)}function W(t){return t>=55296&&t<=56319}function q(t){return t>=56320&&t<=57343}function B(t){return q(t.charCodeAt(0))}function K(t){return W(t.charCodeAt(t.length-1))}function $(t){for(var e=[],s=0;s<t.length;s++)t[s][1].length>0&&e.push(t[s]);return e}function G(t,e,s,l){return K(t)||B(l)?null:$([[u,t],[c,e],[v,s],[u,l]])}function z(t,e,s){var l=typeof s=="number"?{index:s,length:0}:s.oldRange,n=typeof s=="number"?null:s.newRange,r=t.length,i=e.length;if(l.length===0&&(n===null||n.length===0)){var h=l.index,a=t.slice(0,h),d=t.slice(h),b=n?n.index:null;t:{var f=h+i-r;if(b!==null&&b!==f||f<0||f>i)break t;var H=e.slice(0,f),x=e.slice(f);if(x!==d)break t;var C=Math.min(h,f),M=a.slice(0,C),N=H.slice(0,C);if(M!==N)break t;var p=a.slice(C),O=H.slice(C);return G(M,p,O,d)}t:{if(b!==null&&b!==h)break t;var m=h,H=e.slice(0,m),x=e.slice(m);if(H!==a)break t;var J=Math.min(r-m,i-m),y=d.slice(d.length-J),A=x.slice(x.length-J);if(y!==A)break t;var p=d.slice(0,d.length-J),O=x.slice(0,x.length-J);return G(a,p,O,y)}}if(l.length>0&&n&&n.length===0){t:{var M=t.slice(0,l.index),y=t.slice(l.index+l.length),C=M.length,J=y.length;if(i<C+J)break t;var N=e.slice(0,C),A=e.slice(i-J);if(M!==N||y!==A)break t;var p=t.slice(C,r-J),O=e.slice(C,i-J);return G(M,p,O,y)}}return null}function T(t,e,s){return S(t,e,s,!0)}T.INSERT=v,T.DELETE=c,T.EQUAL=u,g.exports=T}),Z=L((o,g)=>{"use strict";var c=X();g.exports=function(v,u){for(var S=c(v,u),k=0;k<S.length;k++){var w=S[k];w[0]<1&&(w[1]=w[1].length)}return S}}),E=L((o,g)=>{"use strict";g.exports=function(c,v){for(var u="",S=0,k=0;k<v.length;k++){var w=v[k],R=w[0],D=w[1];R==-1?S+=D:R==0?u+=c.slice(S,S+=D):u+=D}return u}}),tt=Q(Z()),st=Q(E());function et(o,g){return j({...g,room:o,state:j(g.state)()})}var P={},rt=class{session;hashCodeSession;room="";created=new Date().toISOString();constructor(o,g){let c=null;this.room=o,this.session=et(o,{...g,state:c||g.state,capabilities:{...g.capabilities,sessionStorage:nt("sessionStorage")}})(),this.hashCodeSession=this.session.get("state").hashCode(),P[this.session.get("state").hashCode()]=this.session.get("state")}addEvent(o){this.session.get("events").push({...o}),setTimeout(()=>this.processEvents)}hashCode(){return this.session.get("state").hashCode()}processEvents(){let o=this.session.get("events"),g=o.shift();if(g)switch(g.type){case"code-init":let{code:c,transpiled:v,i:u,css:S,errorDiff:k,html:w}=g,R={code:c,transpiled:v,i:u,css:S,errorDiff:k,html:w};this.session.set("events",o),this.session.set("state",j(R)())}}createPatchFromHashCode(o,g){if(P[o]){let c=P[o],v=JSON.stringify(c.toJSON()),u=c.merge(g),S=u.hashCode();P[S]=u;let k=JSON.stringify(u.toJSON()),w=V(v,k);return{oldHash:o,newHash:S,patch:w}}}createPatch(o){if(o.code===this.session.get("state").get("code"))return{oldHash:this.session.get("state").hashCode(),newHash:this.session.get("state").hashCode(),patch:""};let g=JSON.stringify(this.session.get("state").toJSON()),c=this.session.get("state").hashCode();P[c]=this.session.get("state");let v=this.session.get("state").merge(o),u=v.hashCode();P[u]=v;let S=JSON.stringify(v.toJSON()),k=V(g,S);return{oldHash:c,newHash:u,patch:k}}applyPatch({oldHash:o,newHash:g,patch:c}){if(this.session.get("state").hashCode()!==o){console.error("Cant update");return}let v=this.session.get("state").toJSON(),u=JSON.stringify(v),S=v.code,k=JSON.parse((0,st.default)(u,JSON.parse(c))),w=j(k)();console.log({newState:k}),console.log(w.hashCode());let R=this.session.get("state").merge(w),D=R.get("code");if(S!==D)if(console.log(R.hashCode()),R.hashCode()===g){this.session=this.session.set("state",R);return}else console.log("WRONG"),console.log({newState:k})}json(){let o=this.session.toJSON(),g=o.state.toJSON();return{...o,state:g}}setRoom(o){let g=this.session.set("room",o);this.session=g}},it=null,at=(o,g)=>it||new rt(o,g);function nt(o){try{if(window.hasOwnProperty(o)===!1)return;var g=window[o],c="__storage_test__";return g.setItem(c,c),g.removeItem(c),!0}catch{return!1}}function V(o,g){return JSON.stringify((0,tt.default)(o,g))}export{rt as CodeSession,at as default};
//# sourceMappingURL=session-QUQOLT6C.mjs.map
