import{Record as a}from"https://ga.jspm.io/npm:immutable@4.0.0/dist/immutable.es.js";import d from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-create.mjs";import l from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-patch.mjs";function p(s,t){return a({...t,room:s,state:a(t.state)()})}var u=class{session;hashCodeSession;room="";created=new Date().toISOString();constructor(s,t){let e=null;this.room=s,this.session=p(s,{...t,state:e||t.state,capabilities:{...t.capabilities,sessionStorage:f("sessionStorage")}})(),this.hashCodeSession=this.session.get("state").hashCode()}addEvent(s){this.session.get("events").push({...s}),setTimeout(()=>this.processEvents)}hashCode(){return this.session.get("state").hashCode()}processEvents(){let s=this.session.get("events"),t=s.shift();if(t)switch(t.type){case"code-init":let{code:e,transpiled:o,i,css:n,errorDiff:r,html:h}=t,c={code:e,transpiled:o,i,css:n,errorDiff:r,html:h};this.session.set("events",s),this.session.set("state",a(c)())}}updateState(s){let t=JSON.stringify(this.session.get("state").toJSON()),e=this.session.get("state").hashCode();this.session=this.session.set("state",a(s)());let o=JSON.stringify(this.session.get("state").toJSON()),i=this.session.get("state").hashCode(),n=S(t,o);return{oldHash:e,newHash:i,patch:n}}applyPatch({oldHash:s,newHash:t,patch:e}){if(this.session.get("state").hashCode()!==s){console.error("Cant update");return}let o=this.session.get("state"),i=JSON.stringify(this.session.get("state").toJSON()),n=JSON.parse(l(i,JSON.parse(e)));if(this.session=this.session.set("state",a(n)()),this.session.get("state").hashCode()!==t){this.session.set("state",o),console.error("WRONG update");return}}json(){let s=this.session.toJSON(),t=s.state.toJSON();return{...s,state:t}}setRoom(s){let t=this.session.set("room",s);this.session=t}},g=null,C=(s,t)=>g||new u(s,t);function f(s){try{if(window.hasOwnProperty(s)===!1)return;var t=window[s],e="__storage_test__";return t.setItem(e,e),t.removeItem(e),!0}catch{return!1}}function S(s,t){return JSON.stringify(d(s,t))}export{u as CodeSession,C as default};
//# sourceMappingURL=session-4LZATP2T.mjs.map
