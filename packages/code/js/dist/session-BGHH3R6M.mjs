import{Record as n}from"https://ga.jspm.io/npm:immutable@4.0.0/dist/immutable.es.js";import S from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-create.mjs";import g from"https://unpkg.com/@spike.land/esm@0.4.33/dist/textdiff-patch.mjs";function p(s,t){return n({...t,room:s,state:n(t.state)()})}var f=class{session;hashCodeSession;room="";created=new Date().toISOString();constructor(s,t){let e=null;if(this.room=s,t.state.code===""&&s){let o=`state-${s}`;if(r("localStorage")){let i=localStorage.getItem(o);i?e=JSON.parse(i):fetch(`https://code.spike.land/api/room/${s}/mySession`).then(a=>a.json()).then(a=>{localStorage.setItem(o,JSON.stringify(a.state)),this.session.set("state",n(a.state)())})}}this.session=p(s,{...t,state:e||t.state,capabilities:{...t.capabilities,sessionStorage:r("sessionStorage")}})(),this.hashCodeSession=this.session.get("state").hashCode()}addEvent(s){this.session.get("events").push({...s}),setTimeout(()=>this.processEvents)}hashCode(){return this.session.get("state").hashCode()}processEvents(){let s=this.session.get("events"),t=s.shift();if(t)switch(t.type){case"code-init":let{code:e,transpiled:o,i,css:a,errorDiff:l,html:c}=t,h={code:e,transpiled:o,i,css:a,errorDiff:l,html:c};this.session.set("events",s),this.session.set("state",n(h)());let d=`state-${this.room}`;r("localStorage")&&localStorage.setItem(d,JSON.stringify(h)),this.session.set("events",s)}}updateState(s){let t=JSON.stringify(this.session.get("state").toJS()),e=this.session.get("state").hashCode();this.session=this.session.set("state",n(s)());let o=JSON.stringify(this.session.get("state").toJS()),i=this.session.get("state").hashCode(),a=u(t,o);return{oldHash:e,newHash:i,patch:a}}applyPatch({oldHash:s,newHash:t,patch:e}){if(this.session.get("state").hashCode()!==s){console.error("Cant update");return}let o=JSON.stringify(this.session.get("state").toJS()),i=JSON.parse(g(o,JSON.parse(e)));if(this.session=this.session.set("state",n(i)()),this.session.get("state").hashCode()!==t){console.error("WRONG update");return}}json(){let s=this.session.toJSON(),t=s.state.toJSON();return{...s,state:t}}setRoom(s){let t=this.session.set("room",s);this.session=t}},m=null,y=(s,t)=>m||new f(s,t);function r(s){try{if(window.hasOwnProperty(s)===!1)return;var t=window[s],e="__storage_test__";return t.setItem(e,e),t.removeItem(e),!0}catch{return!1}}function u(s,t){return JSON.stringify(S(s,t))}export{f as CodeSession,y as default};
//# sourceMappingURL=session-BGHH3R6M.mjs.map
