const importScript=async n=>new Promise(function(t,e){const o=window.document.createElement("script");o.src=n,o.onload=t,o.onerror=e,window.document.head.appendChild(o)}),makeDraggable=async()=>{const n=await importScript("https://unpkg.com/interactjs@1.10.0/dist/interact.js"),t=window.interact;t(".draggable").draggable({inertia:!0,modifiers:[t.modifiers.restrictRect({restriction:"parent",endOnly:!0})],autoScroll:!1,listeners:{move:dragMoveListener}})};function dragMoveListener(n){const t=n.target,e=(parseFloat(t.getAttribute("data-x"))||0)+n.dx,o=(parseFloat(t.getAttribute("data-y"))||0)+n.dy;t.style.webkitTransform=t.style.transform="translate("+e+"px, "+o+"px)",t.setAttribute("data-x",e),t.setAttribute("data-y",o)}const startMonaco=async({onChange:n,code:t,language:e})=>{const o=e||"typescript";return window&&window.monaco&&window.monaco.editor?window.monaco.editor:new Promise(async function(r){if(window.monaco)return window.monaco;await loadScript("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs/loader.min.js");const l="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs";await loadScript("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs/loader.min.js"),require.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs"}}),require(["vs/editor/editor.main"],async function(){const s=window.monaco,i=s.editor.create(window.document.getElementById("container"),{cursorStyle:"block",formatOnType:!0,scrollbar:{horizontal:"hidden",verticalHasArrows:!0,verticalScrollbarSize:20},minimap:{enabled:!1},folding:!1,multiCursorModifier:"alt",wordWrap:"on",wordWrapBreakAfterCharacters:">([{]))],;}",mouseWheelZoom:!1,wordWrapColumn:70,automaticLayout:!0,scrollBeyondLastLine:!1,autoIndent:"brackets",autoClosingQuotes:"always",lineNumbers:"off",autoClosingBrackets:"always",autoClosingOvertype:"always",suggest:{},codeLens:!0,autoSurround:"languageDefined",trimAutoWhitespace:!0,codeActionsOnSaveTimeout:100,model:s.editor.createModel(t,o,s.Uri.parse(o==="typescript"?"file:///main.tsx":"file:///main.html")),value:t,language:o,theme:"vs-dark"});if(s.languages.typescript.javascriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!0,noSemanticValidation:!0,noSyntaxValidation:!0}),i.onDidChangeModelContent(()=>n(i.getValue())),r(i),o==="typescript"){const c=[{name:"react",url:"https://unpkg.com/@types/react@latest/index.d.ts",depend:["global","csstype","react-dom","prop-types"]},{name:"global",url:"https://unpkg.com/@types/react@latest/global.d.ts",depend:[]},{name:"prop-types",url:"https://unpkg.com/@types/prop-types@latest/index.d.ts",depend:[]},{name:"react-dom",url:"https://unpkg.com/@types/react-dom@latest/index.d.ts",depend:[]},{name:"csstype",url:"https://unpkg.com/csstype@latest/index.d.ts",depend:[]}],h=c.map(({name:a,url:m})=>(async()=>s.languages.typescript.typescriptDefaults.addExtraLib(await(await fetch(m)).text(),`file:///node_modules/@types/${a}/index.d.ts`))());s.languages.typescript.typescriptDefaults.setCompilerOptions({target:s.languages.typescript.ScriptTarget.ESNext,allowNonTsExtensions:!0,allowUmdGlobalAccess:!0,strict:!0,allowJs:!0,noEmitOnError:!0,allowSyntheticDefaultImports:!0,moduleResolution:s.languages.typescript.ModuleResolutionKind.NodeJs,module:s.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"],jsx:s.languages.typescript.JsxEmit.React,jsxFactory:"React.createElement",jsxFragmentFactory:"React.Fragment",esModuleInterop:!0}),await Promise.all(h),s.languages.typescript.javascriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!1,noSemanticValidation:!1,noSyntaxValidation:!1})}})})};function loadScript(n){return new Promise(function(t,e){var o;o=document.createElement("script"),o.src=n,o.onload=t,o.onerror=e,document.head.appendChild(o)})}const DIFF_DELETE=-1,DIFF_EQUAL=0;function diff_main({text1:n,text2:t,cursor_pos:e}){if(n===t)return n?[[0,n]]:[];if(e){const i=find_cursor_edit_diff(n,t,e);if(i)return i}let o=diff_commonPrefix(n,t);const r=n.substring(0,o);n=n.substring(o),t=t.substring(o),o=diff_commonSuffix(n,t);const l=n.substring(n.length-o);n=n.substring(0,n.length-o),t=t.substring(0,t.length-o);const s=diff_compute_(n,t);return r&&s.unshift([0,r]),l&&s.push([0,l]),diff_cleanupMerge(s),s}function diff_compute_(n,t){let e;if(!n)return[[1,t]];if(!t)return[[DIFF_DELETE,n]];const o=n.length>t.length?n:t,r=n.length>t.length?t:n,l=o.indexOf(r);if(l!==-1)return e=[[1,o.substring(0,l)],[0,r],[1,o.substring(l+r.length)]],n.length>t.length&&(e[0][0]=e[2][0]=DIFF_DELETE),e;if(r.length===1)return[[DIFF_DELETE,n],[1,t]];const s=diff_halfMatch_(n,t);if(s){const i=s[0],c=s[1],h=s[2],a=s[3],m=s[4],w=diff_main({text1:i[1],text2:h[1],cursor_pos:0}),u=diff_main({text1:c[1],text2:a[1],cursor_pos:0});return w.concat([[0,m[1]]],u)}return diff_bisect_(n,t)}function diff_bisect_(n,t){const e=n.length,o=t.length,r=Math.ceil((e+o)/2),l=r,s=2*r,i=new Array(s),c=new Array(s);for(let g=0;g<s;g++)i[g]=-1,c[g]=-1;i[l+1]=0,c[l+1]=0;const h=e-o,a=h%2!==0;let m=0,w=0,u=0,f=0;for(let g=0;g<r;g++){for(let d=-g+m;d<=g-w;d+=2){const b=r+d;let y;d===-g||d!==g&&i[b-1]<i[b+1]?y=i[b+1]:y=i[b-1]+1;let _=y-d;for(;y<e&&_<o&&n.charAt(y)===t.charAt(_);)y++,_++;if(i[b]=y,y>e)w+=2;else if(_>o)m+=2;else if(a){const k=r+h-d;if(k>=0&&k<s&&c[k]!==-1){const S=e-c[k];if(y>=S)return diff_bisectSplit_(n,t,y,_)}}}let p;for(let d=-g+u;d<=g-f;d+=2){const b=r+d;d===-g||d!==g&&c[b-1]<c[b+1]?p=c[b+1]:p=c[b-1]+1;let y=p-d;for(;p<e&&y<o&&n.charAt(e-p-1)===t.charAt(o-y-1);)p++,y++;if(c[b]=p,p>e)f+=2;else if(y>o)u+=2;else if(!a){const _=r+h-d;if(_>=0&&_<s&&i[_]!==-1){const k=i[_],S=r+k-_;if(p=e-p,k>=p)return diff_bisectSplit_(n,t,k,S)}}}}return[[DIFF_DELETE,n],[1,t]]}function diff_bisectSplit_(n,t,e,o){const r=n.substring(0,e),l=t.substring(0,o),s=n.substring(e),i=t.substring(o),c=diff_main({text1:r[1],text2:l[1],cursor_pos:0}),h=diff_main({text1:s[1],text2:i[1],cursor_pos:0});return c.concat(h)}function diff_commonPrefix(n,t){if(!n||!t||n.charAt(0)!==t.charAt(0))return 0;let e=0,o=Math.min(n.length,t.length),r=o,l=0;for(;e<r;)n.substring(l,r)==t.substring(l,r)?(e=r,l=e):o=r,r=Math.floor((o-e)/2+e);return is_surrogate_pair_start(n.charCodeAt(r-1))&&r--,r}function diff_commonSuffix(n,t){if(!n||!t||n.slice(-1)!==t.slice(-1))return 0;let e=0,o=Math.min(n.length,t.length),r=o,l=0;for(;e<r;)n.substring(n.length-r,n.length-l)==t.substring(t.length-r,t.length-l)?(e=r,l=e):o=r,r=Math.floor((o-e)/2+e);return is_surrogate_pair_end(n.charCodeAt(n.length-r))&&r--,r}function diff_halfMatch_(n,t){const e=n.length>t.length?n:t,o=n.length>t.length?t:n;if(e.length<4||o.length*2<e.length)return null;function r(u,f,g){const p=u.substring(g,g+Math.floor(u.length/4));let d=-1,b="",y,_,k,S;for(;(d=f.indexOf(p,d+1))!==-1;){const v=diff_commonPrefix(u.substring(g),f.substring(d)),E=diff_commonSuffix(u.substring(0,g),f.substring(0,d));b.length<E+v&&(b=f.substring(d-E,d)+f.substring(d,d+v),y=u.substring(0,g-E),_=u.substring(g+v),k=f.substring(0,d-E),S=f.substring(d+v))}return b.length*2>=u.length?[y,_,k,S,b]:null}const l=r(e,o,Math.ceil(e.length/4)),s=r(e,o,Math.ceil(e.length/2));let i;if(s===null&&l===null)return null;if(s===null){if(l===null)return null;i=l}else if(l===null){if(s===null)return null;i=s}else i=l[4].length>s[4].length?l:s;let c,h,a,m;n.length>t.length?(c=i[0],h=i[1],a=i[2],m=i[3]):(a=i[0],m=i[1],c=i[2],h=i[3]);const w=i[4];return[c,h,a,m,w]}function diff_cleanupMerge(n){const t=[...n];t.push([0,""]);let e=0,o=0,r=0,l="",s="",i,c;for(;e<t.length;){if(e<t.length-1&&!t[e][1]){t.splice(e,1);continue}switch(t[e][0]){case 1:r++,s+=t[e][1],e++;break;case DIFF_DELETE:o++,l+=t[e][1],e++;break;case 0:if(c=e-r-o-1,e<t.length-1&&!t[e][1]){t.splice(e,1);break}if(l.length>0||s.length>0){l.length>0&&s.length>0&&(i=diff_commonPrefix(s,l),i!==0&&(c>=0?t[c][1]+=s.substring(0,i):(t.splice(0,0,[0,s.substring(0,i)]),e++),s=s.substring(i),l=l.substring(i)),i=diff_commonSuffix(s,l),i!==0&&(t[e][1]=s.substring(s.length-i)+t[e][1],s=s.substring(0,s.length-i),l=l.substring(0,l.length-i)));const a=r+o;l.length===0&&s.length===0?(t.splice(e-a,a),e=e-a):l.length===0?(t.splice(e-a,a,[1,s]),e=e-a+1):s.length===0?(t.splice(e-a,a,[DIFF_DELETE,l]),e=e-a+1):(t.splice(e-a,a,[DIFF_DELETE,l],[1,s]),e=e-a+2)}e!==0&&t[e-1][0]===DIFF_EQUAL?(t[e-1][1]+=t[e][1],t.splice(e,1)):e++,r=0,o=0,l="",s="";break}}t[t.length-1][1]===""&&t.pop();let h=!1;for(e=1;e<t.length-1;)t[e-1][0]===0&&t[e+1][0]===DIFF_EQUAL&&(t[e][1].substring(t[e][1].length-t[e-1][1].length)===t[e-1][1]?(t[e][1]=t[e-1][1]+t[e][1].substring(0,t[e][1].length-t[e-1][1].length),t[e+1][1]=t[e-1][1]+t[e+1][1],t.splice(e-1,1),h=!0):t[e][1].substring(0,t[e+1][1].length)==t[e+1][1]&&(t[e-1][1]+=t[e+1][1],t[e][1]=t[e][1].substring(t[e+1][1].length)+t[e+1][1],t.splice(e+1,1),h=!0)),e++;return h?diff_cleanupMerge(t):t}function is_surrogate_pair_start(n){return n>=55296&&n<=56319}function is_surrogate_pair_end(n){return n>=56320&&n<=57343}function starts_with_pair_end(n){return is_surrogate_pair_end(n.charCodeAt(0))}function ends_with_pair_start(n){return is_surrogate_pair_start(n.charCodeAt(n.length-1))}function remove_empty_tuples(n){const t=[];for(let e=0;e<n.length;e++)n[e][1].length>0&&t.push(n[e]);return t}function make_edit_splice(n,t,e,o){return ends_with_pair_start(n)||starts_with_pair_end(o)?null:remove_empty_tuples([[0,n],[DIFF_DELETE,t],[1,e],[0,o]])}function find_cursor_edit_diff(n,t,e){const o=typeof e=="number"?{index:e,length:0}:e.oldRange,r=typeof e=="number"?null:e.newRange,l=n.length,s=t.length;if(o.length===0&&(r===null||r.length===0)){const i=o.index,c=n.slice(0,i),h=n.slice(i),a=r?r.index:null;t:{const m=i+s-l;if(a!==null&&a!==m)break t;if(m<0||m>s)break t;const w=t.slice(0,m),u=t.slice(m);if(u!==h)break t;const f=Math.min(i,m),g=c.slice(0,f),p=w.slice(0,f);if(g!==p)break t;const d=c.slice(f),b=w.slice(f);return make_edit_splice(g,d,b,h)}t:{if(a!==null&&a!==i)break t;const m=i,w=t.slice(0,i),u=t.slice(i);if(w!==c)break t;const f=Math.min(l-i,s-i),g=h.slice(h.length-f),p=u.slice(u.length-f);if(g!==p)break t;const d=h.slice(0,h.length-f),b=u.slice(0,u.length-f);return make_edit_splice(c,d,b,g)}}if(o.length>0&&r&&r.length===0){t:{const i=n.slice(0,o.index),c=n.slice(o.index+o.length),h=i.length,a=c.length;if(s<h+a)break t;const m=t.slice(0,h),w=t.slice(s-a);if(i!==m||c!==w)break t;const u=n.slice(h,l-a),f=t.slice(h,s-a);return make_edit_splice(i,u,f,c)}}return null}function diff(n,t,e){return diff_main({text1:n,text2:t,cursor_pos:e})}diff.INSERT=1,diff.DELETE=DIFF_DELETE,diff.EQUAL=0;const document=window.document;let monaco=null;async function run(){await importScript("https://cdnjs.cloudflare.com/ajax/libs/core-js/3.6.5/minified.js"),await importScript("https://unpkg.com/@babel/standalone@7.12.4/babel.min.js"),await importScript("https://unpkg.com/react@17.0.1/umd/react.production.min.js"),await importScript("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js"),await importScript("https://unpkg.com/interactjs@1.10.0/dist/interact.min.js");const n=/import/gi,t="///";setTimeout(()=>makeDraggable(),100);let e="";const o=a=>window.Babel.transform(a,{plugins:[],presets:["react",["typescript",{isTSX:!0,allExtensions:!0}]]}).code.replace(/import/gi,"///"),r=async a=>{const m=new Function("transpileCode",`return function(){ ${a} }`)(),w={codeTranspiled:a,code:e},u=JSON.stringify(w),f=new Request("https://code.zed.vision",{body:u,method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}}),g=await fetch(f),{hash:p}=await g.json();try{const d=window.localStorage,b=d.getItem("codeBoXHash");b!==p&&(d.setItem("codeBoXHash",p),d.setItem(p,e),window.history.pushState({},"","/?h="+p))}catch(d){console.log("no localStorage")}m()};let l=0,s="",i="",c=0;(async()=>{const a=getCodeToLoad();e=a,await startMonaco({language:"typescript",code:a,onChange:m=>{s=m;const w=async u=>{if(c===1)return;c=1;const f=await h(),g=document.getElementById("error");try{if(c=0,u!==s)return;if(f&&f.length){if(s!=u)return;if(i===u)return;document.getElementById("root").classList.add("transparent");const p=diff(e,u,0);if(console.log(p),p.length<=3){monaco.editor.setTheme("hc-black");return}g.innerHTML=f[0].messageText.toString(),document.getElementById("root").style.setProperty("dispay","none"),g.style.display="block",i=u,monaco.editor.setTheme("vs-light"),setTimeout(()=>{monaco.editor.setTheme("hc-black")},l++);return}e=u,g.style.display="none",window.monaco.editor.setTheme("vs-dark"),document.getElementById("root").classList.remove("transparent"),l=0,c=0,r(o(u))}catch(p){if(c=0,u!==s)return;monaco.editor.setTheme("vs-light"),setTimeout(()=>{window.monaco.editor.setTheme("hc-black")},10),console.error(p)}};if(!c)w(s);else{const u=m,f=setInterval(()=>{(m!==s||!c)&&clearInterval(f),c||w(s)},100)}}}),monaco=window.monaco})(),r(o(getCodeToLoad())),document.getElementById("root").setAttribute("style","display:block");async function h(){const a=monaco.Uri.parse("file:///main.tsx"),m=await window.monaco.languages.typescript.getTypeScriptWorker(),w=await(await m(a)).getSemanticDiagnostics("file:///main.tsx"),u=await(await m(a)).getCompilerOptionsDiagnostics("file:///main.tsx"),f=await(await m(a)).getSyntacticDiagnostics("file:///main.tsx");return[...w,...u,...f]}}function getCodeToLoad(){const n=window.localStorage.getItem("codeBoXHash");return window.localStorage.getItem(location.hash.substring(1))||n&&window.localStorage.getItem(n)||window.localStorage.getItem("STARTER")||"() => <>Hello</>"}run();
