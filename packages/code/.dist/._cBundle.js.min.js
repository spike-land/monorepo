const importScript=async n=>new Promise(function(e,t){const i=window.document.createElement("script");i.src=n,i.onload=e,i.onerror=t,window.document.head.appendChild(i)}),makeDraggable=async()=>{const n=await importScript("https://unpkg.com/interactjs@1.10.0/dist/interact.js"),e=window.interact;e(".draggable").draggable({inertia:!0,modifiers:[e.modifiers.restrictRect({restriction:"parent",endOnly:!0})],autoScroll:!1,listeners:{move:dragMoveListener}})};function dragMoveListener(n){const e=n.target,t=(parseFloat(e.getAttribute("data-x"))||0)+n.dx,i=(parseFloat(e.getAttribute("data-y"))||0)+n.dy;e.style.webkitTransform=e.style.transform="translate("+t+"px, "+i+"px)",e.setAttribute("data-x",t),e.setAttribute("data-y",i)}let modules={};const startMonaco=async({onChange:n,code:e,language:t})=>{if(window.monaco===void 0){const i="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs",{require:r}=await loadScript("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs/loader.min.js");r.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs"}}),await new Promise(l=>r(["vs/editor/editor.main"],s=>{modules.monaco=s,l(s)}))}else return modules;if(modules.editor=modules.monaco.editor.create(window.document.getElementById("container"),{cursorStyle:"block",formatOnType:!0,scrollbar:{horizontal:"hidden",verticalHasArrows:!0,verticalScrollbarSize:20},minimap:{enabled:!1},folding:!1,multiCursorModifier:"alt",wordWrap:"on",wordWrapBreakAfterCharacters:">([{]))],;}",mouseWheelZoom:!1,wordWrapColumn:70,automaticLayout:!0,scrollBeyondLastLine:!0,autoIndent:"brackets",autoClosingQuotes:"always",lineNumbers:"off",autoClosingBrackets:"always",autoClosingOvertype:"always",suggest:{},codeLens:!0,autoSurround:"languageDefined",trimAutoWhitespace:!0,codeActionsOnSaveTimeout:100,model:modules.monaco.editor.createModel(e,t,modules.monaco.Uri.parse(t==="typescript"?"file:///main.tsx":"file:///main.html")),value:e,language:t,theme:"vs-dark"}),modules.editor.onDidChangeModelContent(()=>n(modules.editor.getValue())),modules.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!0,noSemanticValidation:!0,noSyntaxValidation:!0}),t==="typescript"){const i=[{name:"react",url:"https://unpkg.com/@types/react@latest/index.d.ts",depend:["global","csstype","react-dom","prop-types"]},{name:"global",url:"https://unpkg.com/@types/react@latest/global.d.ts",depend:[]},{name:"prop-types",url:"https://unpkg.com/@types/prop-types@latest/index.d.ts",depend:[]},{name:"react-dom",url:"https://unpkg.com/@types/react-dom@latest/index.d.ts",depend:[]},{name:"csstype",url:"https://unpkg.com/csstype@latest/index.d.ts",depend:[]}],r=i.map(({name:l,url:s})=>(async()=>modules.monaco.languages.typescript.typescriptDefaults.addExtraLib(await(await fetch(s)).text(),`file:///node_modules/@types/${l}/index.d.ts`))());return modules.monaco.languages.typescript.typescriptDefaults.setCompilerOptions({target:modules.monaco.languages.typescript.ScriptTarget.ESNext,allowNonTsExtensions:!0,allowUmdGlobalAccess:!0,strict:!0,allowJs:!0,noEmitOnError:!0,allowSyntheticDefaultImports:!0,moduleResolution:modules.monaco.languages.typescript.ModuleResolutionKind.NodeJs,module:modules.monaco.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"],jsx:modules.monaco.languages.typescript.JsxEmit.React,jsxFactory:"React.createElement",jsxFragmentFactory:"React.Fragment",esModuleInterop:!0}),await Promise.all(r),modules.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!1,noSemanticValidation:!1,noSyntaxValidation:!1}),modules}};function loadScript(n){return new Promise(function(e,t){var i;i=window.document.createElement("script"),i.src=n,i.onload=()=>e(window),i.onerror=t,window.document.head.appendChild(i)})}const DIFFDELETE=-1;function diffMain({text1:n,text2:e,cursorPos:t}){if(n===e)return n?[[0,n]]:[];if(t){const o=findCursorEditDiff(n,e,t);if(o)return o}let i=diffCommonPrefix(n,e);const r=n.substring(0,i);n=n.substring(i),e=e.substring(i),i=diffCommonSuffix(n,e);const l=n.substring(n.length-i);n=n.substring(0,n.length-i),e=e.substring(0,e.length-i);const s=diffCompute_(n,e);return r&&s.unshift([0,r]),l&&s.push([0,l]),diffCleanupMerge(s),s}function diffCompute_(n,e){let t;if(!n)return[[1,e]];if(!e)return[[DIFFDELETE,n]];const i=n.length>e.length?n:e,r=n.length>e.length?e:n,l=i.indexOf(r);if(l!==-1)return t=[[1,i.substring(0,l)],[0,r],[1,i.substring(l+r.length)]],n.length>e.length&&(t[0][0]=t[2][0]=DIFFDELETE),t;if(r.length===1)return[[DIFFDELETE,n],[1,e]];const s=diffHalfMatch_(n,e);if(s){const o=s[0],a=s[1],u=s[2],c=s[3],p=s[4],k=diffMain({text1:o[1],text2:u[1],cursorPos:0}),m=diffMain({text1:a[1],text2:c[1],cursorPos:0});return k.concat([[0,p[1]]],m)}return diffBisect_(n,e)}function diffBisect_(n,e){const t=n.length,i=e.length,r=Math.ceil((t+i)/2),l=r,s=2*r,o=new Array(s),a=new Array(s);for(let f=0;f<s;f++)o[f]=-1,a[f]=-1;o[l+1]=0,a[l+1]=0;const u=t-i,c=u%2!==0;let p=0,k=0,m=0,g=0;for(let f=0;f<r;f++){for(let d=-f+p;d<=f-k;d+=2){const h=r+d;let y;d===-f||d!==f&&o[h-1]<o[h+1]?y=o[h+1]:y=o[h-1]+1;let w=y-d;for(;y<t&&w<i&&n.charAt(y)===e.charAt(w);)y++,w++;if(o[h]=y,y>t)k+=2;else if(w>i)p+=2;else if(c){const S=r+u-d;if(S>=0&&S<s&&a[S]!==-1){const E=t-a[S];if(y>=E)return diffBisectSplit_(n,e,y,w)}}}let b;for(let d=-f+m;d<=f-g;d+=2){const h=r+d;d===-f||d!==f&&a[h-1]<a[h+1]?b=a[h+1]:b=a[h-1]+1;let y=b-d;for(;b<t&&y<i&&n.charAt(t-b-1)===e.charAt(i-y-1);)b++,y++;if(a[h]=b,b>t)g+=2;else if(y>i)m+=2;else if(!c){const w=r+u-d;if(w>=0&&w<s&&o[w]!==-1){const S=o[w],E=r+S-w;if(b=t-b,S>=b)return diffBisectSplit_(n,e,S,E)}}}}return[[DIFFDELETE,n],[1,e]]}function diffBisectSplit_(n,e,t,i){const r=n.substring(0,t),l=e.substring(0,i),s=n.substring(t),o=e.substring(i),a=diffMain({text1:r[1],text2:l[1],cursorPos:0}),u=diffMain({text1:s[1],text2:o[1],cursorPos:0});return a.concat(u)}function diffCommonPrefix(n,e){if(!n||!e||n.charAt(0)!==e.charAt(0))return 0;let t=0,i=Math.min(n.length,e.length),r=i,l=0;for(;t<r;)n.substring(l,r)==e.substring(l,r)?(t=r,l=t):i=r,r=Math.floor((i-t)/2+t);return isSurrogatePairStart(n.charCodeAt(r-1))&&r--,r}function diffCommonSuffix(n,e){if(!n||!e||n.slice(-1)!==e.slice(-1))return 0;let t=0,i=Math.min(n.length,e.length),r=i,l=0;for(;t<r;)n.substring(n.length-r,n.length-l)==e.substring(e.length-r,e.length-l)?(t=r,l=t):i=r,r=Math.floor((i-t)/2+t);return isSurrogatePairEnd(n.charCodeAt(n.length-r))&&r--,r}function diffHalfMatch_(n,e){const t=n.length>e.length?n:e,i=n.length>e.length?e:n;if(t.length<4||i.length*2<t.length)return null;function r(m,g,f){const b=m.substring(f,f+Math.floor(m.length/4));let d=-1,h="",y,w,S,E;for(;(d=g.indexOf(b,d+1))!==-1;){const C=diffCommonPrefix(m.substring(f),g.substring(d)),A=diffCommonSuffix(m.substring(0,f),g.substring(0,d));h.length<A+C&&(h=g.substring(d-A,d)+g.substring(d,d+C),y=m.substring(0,f-A),w=m.substring(f+C),S=g.substring(0,d-A),E=g.substring(d+C))}return h.length*2>=m.length?[y,w,S,E,h]:null}const l=r(t,i,Math.ceil(t.length/4)),s=r(t,i,Math.ceil(t.length/2));let o;if(s===null&&l===null)return null;if(s===null){if(l===null)return null;o=l}else if(l===null){if(s===null)return null;o=s}else o=l[4].length>s[4].length?l:s;let a,u,c,p;n.length>e.length?(a=o[0],u=o[1],c=o[2],p=o[3]):(c=o[0],p=o[1],a=o[2],u=o[3]);const k=o[4];return[a,u,c,p,k]}function diffCleanupMerge(n){const e=[...n];e.push([0,""]);let t=0,i=0,r=0,l="",s="",o,a;for(;t<e.length;){if(t<e.length-1&&!e[t][1]){e.splice(t,1);continue}switch(e[t][0]){case 1:r++,s+=e[t][1],t++;break;case DIFFDELETE:i++,l+=e[t][1],t++;break;case 0:if(a=t-r-i-1,t<e.length-1&&!e[t][1]){e.splice(t,1);break}if(l.length>0||s.length>0){l.length>0&&s.length>0&&(o=diffCommonPrefix(s,l),o!==0&&(a>=0?e[a][1]+=s.substring(0,o):(e.splice(0,0,[0,s.substring(0,o)]),t++),s=s.substring(o),l=l.substring(o)),o=diffCommonSuffix(s,l),o!==0&&(e[t][1]=s.substring(s.length-o)+e[t][1],s=s.substring(0,s.length-o),l=l.substring(0,l.length-o)));const c=r+i;l.length===0&&s.length===0?(e.splice(t-c,c),t=t-c):l.length===0?(e.splice(t-c,c,[1,s]),t=t-c+1):s.length===0?(e.splice(t-c,c,[DIFFDELETE,l]),t=t-c+1):(e.splice(t-c,c,[DIFFDELETE,l],[1,s]),t=t-c+2)}t!==0&&e[t-1][0]===0?(e[t-1][1]+=e[t][1],e.splice(t,1)):t++,r=0,i=0,l="",s="";break}}e[e.length-1][1]===""&&e.pop();let u=!1;for(t=1;t<e.length-1;)e[t-1][0]===0&&e[t+1][0]===0&&(e[t][1].substring(e[t][1].length-e[t-1][1].length)===e[t-1][1]?(e[t][1]=e[t-1][1]+e[t][1].substring(0,e[t][1].length-e[t-1][1].length),e[t+1][1]=e[t-1][1]+e[t+1][1],e.splice(t-1,1),u=!0):e[t][1].substring(0,e[t+1][1].length)==e[t+1][1]&&(e[t-1][1]+=e[t+1][1],e[t][1]=e[t][1].substring(e[t+1][1].length)+e[t+1][1],e.splice(t+1,1),u=!0)),t++;return u?diffCleanupMerge(e):e}function isSurrogatePairStart(n){return n>=55296&&n<=56319}function isSurrogatePairEnd(n){return n>=56320&&n<=57343}function startsWithPairEnd(n){return isSurrogatePairEnd(n.charCodeAt(0))}function endsWithPairStart(n){return isSurrogatePairStart(n.charCodeAt(n.length-1))}function removeEmptyTuples(n){const e=[];for(let t=0;t<n.length;t++)n[t][1].length>0&&e.push(n[t]);return e}function makeEditSplice(n,e,t,i){return endsWithPairStart(n)||startsWithPairEnd(i)?null:removeEmptyTuples([[0,n],[DIFFDELETE,e],[1,t],[0,i]])}function findCursorEditDiff(n,e,t){const i=typeof t=="number"?{index:t,length:0}:t.oldRange,r=typeof t=="number"?null:t.newRange,l=n.length,s=e.length;if(i.length===0&&(r===null||r.length===0)){const o=i.index,a=n.slice(0,o),u=n.slice(o),c=r?r.index:null;e:{const p=o+s-l;if(c!==null&&c!==p)break e;if(p<0||p>s)break e;const k=e.slice(0,p),m=e.slice(p);if(m!==u)break e;const g=Math.min(o,p),f=a.slice(0,g),b=k.slice(0,g);if(f!==b)break e;const d=a.slice(g),h=k.slice(g);return makeEditSplice(f,d,h,u)}e:{if(c!==null&&c!==o)break e;const p=o,k=e.slice(0,o),m=e.slice(o);if(k!==a)break e;const g=Math.min(l-o,s-o),f=u.slice(u.length-g),b=m.slice(m.length-g);if(f!==b)break e;const d=u.slice(0,u.length-g),h=m.slice(0,m.length-g);return makeEditSplice(a,d,h,f)}}if(i.length>0&&r&&r.length===0){e:{const o=n.slice(0,i.index),a=n.slice(i.index+i.length),u=o.length,c=a.length;if(s<u+c)break e;const p=e.slice(0,u),k=e.slice(s-c);if(o!==p||a!==k)break e;const m=n.slice(u,l-c),g=e.slice(u,s-c);return makeEditSplice(o,m,g,a)}}return null}function diff(n,e,t){return diffMain({text1:n,text2:e,cursorPos:t})}diff.INSERT=1,diff.DELETE=DIFFDELETE,diff.EQUAL=0;const document=window.document;let busy=0,keystrokeTillNoError=0,latestCode="",errorReported="",latestGoodCode="";async function run(){await importScript("https://unpkg.com/@babel/standalone@7.12.6/babel.min.js"),await importScript("https://unpkg.com/react@17.0.1/umd/react.production.min.js"),await importScript("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js"),await importScript("https://unpkg.com/interactjs@1.10.0/dist/interact.min.js"),setTimeout(()=>makeDraggable(),100),(async()=>{const n=getCodeToLoad();latestGoodCode=n;let e;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)&&(await Promise.all([importScript("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"),importScript("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-typescript.min.js"),importScript("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.js")]),document.getElementById("ace").style.setProperty("display","block"),document.getElementById("container").style.setProperty("display","none"),e=window.ace.edit("ace"),e.setTheme("ace/theme/monokai"),e.session.setMode("ace/mode/typescript"),e.setValue(n));const t=await startMonaco({language:"typescript",code:n,onChange:i});e&&e.session.on("change",function(){const s=e.getValue();t.editor.setValue(s),i(s)});function i(s){if(!t)return;if(latestCode=s,!busy)l(latestCode);else{const o=s,a=setInterval(()=>{(s!==latestCode||!busy)&&clearInterval(a),busy||l(latestCode)},100)}}async function r(){if(!t||!t.monaco)return;const s=t.monaco.Uri.parse("file:///main.tsx"),o=await t.monaco.languages.typescript.getTypeScriptWorker(),a=await(await o(s)).getSemanticDiagnostics("file:///main.tsx"),u=await(await o(s)).getCompilerOptionsDiagnostics("file:///main.tsx"),c=await(await o(s)).getSyntacticDiagnostics("file:///main.tsx");return[...a,...u,...c]}async function l(s){if(busy===1)return;try{busy=1;const o=await r(),a=document.getElementById("error");if(busy=0,s!==latestCode)return;if(o&&o.length){if(latestCode!=s)return;if(errorReported===s)return;document.getElementById("root").classList.add("transparent");const u=diff(latestGoodCode,s,0);if(console.log(u),u.length<=3){t.monaco.editor.setTheme("hc-black");return}a.innerHTML=o[0].messageText.toString(),document.getElementById("root").style.setProperty("dispay","none"),a.style.display="block",errorReported=s,t.monaco.editor.setTheme("vs-light"),setTimeout(()=>{t.monaco.editor.setTheme("hc-black")},keystrokeTillNoError++);return}latestGoodCode=s,a.style.display="none",t.monaco.editor.setTheme("vs-dark"),document.getElementById("root").classList.remove("transparent"),keystrokeTillNoError=0,busy=0,restartCode(transpileCode(s))}catch(o){if(busy=0,s!==latestCode)return;t.monaco.editor.setTheme("vs-light"),setTimeout(()=>{t.monaco.editor.setTheme("hc-black")},10),console.error(o)}}})(),restartCode(transpileCode(getCodeToLoad())),document.getElementById("root").setAttribute("style","display:block")}async function restartCode(n){const e=new Function("transpileCode",`return function(){ ${n} }`)(),t={codeTranspiled:n,code:latestGoodCode},i=JSON.stringify(t),r=new Request("https://code.zed.vision",{body:i,method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}}),l=await fetch(r),{hash:s}=await l.json();try{const o=window.localStorage,a=o.getItem("codeBoXHash");a!==s&&(o.setItem("codeBoXHash",s),o.setItem(s,latestGoodCode),window.history.pushState({},"","/?h="+s))}catch(o){console.log("no localStorage")}e()}function getCodeToLoad(){const n=new URLSearchParams(window.location.search),e=n.get("h")||localStorage.getItem("codeBoXHash");return e&&window.localStorage.getItem(e)||window.localStorage.getItem("STARTER")||"() => <>Hello</>"}function transpileCode(n){return window.Babel.transform(n,{plugins:[],presets:["react",["typescript",{isTSX:!0,allExtensions:!0}]]}).code.replace(/import/gi,"///")}run();
