const U=async({onChange:n,code:e,language:t})=>{const r=window.document.getElementById("container");if(!r){const o=C.getElementById("container");o.id="container",C.body.appendChild(o)}if(window.monaco===void 0){const o="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs",{require:l}=await q("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs/loader.min.js");l.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs"}}),await new Promise(a=>l(["vs/editor/editor.main"],d=>{a(d)}))}const i=window.monaco,s={monaco:i,editor:i.editor.create(window.document.getElementById("container"),{formatOnType:!0,scrollbar:{horizontal:"hidden",verticalHasArrows:!0,verticalScrollbarSize:20},minimap:{enabled:!1},folding:!1,multiCursorModifier:"alt",wordWrap:"on",wordWrapBreakAfterCharacters:">([{]))],;}",mouseWheelZoom:!1,wordWrapColumn:80,automaticLayout:!0,scrollBeyondLastLine:!1,autoIndent:"brackets",autoClosingQuotes:"always",padding:{bottom:300},lineNumbers:"on",autoClosingBrackets:"always",autoClosingOvertype:"always",suggest:{},codeLens:!0,autoSurround:"languageDefined",trimAutoWhitespace:!0,codeActionsOnSaveTimeout:100,model:i.editor.createModel(e,t,i.Uri.parse(t==="typescript"?"file:///main.tsx":"file:///main.html")),value:e,language:t,theme:"vs-dark"})};if(s.editor.onDidChangeModelContent(()=>n(s.editor.getValue())),s.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!0,noSemanticValidation:!0,noSyntaxValidation:!0}),t==="typescript"){const o=[{name:"react",url:"https://unpkg.com/@types/react@16.9.56/index.d.ts",depend:["global","csstype","react-dom","prop-types"]},{name:"global",url:"https://unpkg.com/@types/react@16.9.56/global.d.ts",depend:[]},{name:"prop-types",url:"https://unpkg.com/@types/prop-types@15.7.3/index.d.ts",depend:[]},{name:"react-dom",url:"https://unpkg.com/@types/react-dom@16.9.9/index.d.ts",depend:[]},{name:"csstype",url:"https://unpkg.com/csstype@3.0.5/index.d.ts",depend:[]},{name:"@emotion/styled/base.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/base.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/styled/index.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/index.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/cache/index.d.ts",url:"https://unpkg.com/@emotion/cache@11.0.0/types/index.d.ts",depend:["@emotion/utils"]},{name:"@emotion/react/index.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/index.d.ts",depend:["@emotion/cache"]},{name:"@emotion/react/jsx-namespace.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/jsx-namespace.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/css-prop.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/css-prop.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/helper.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/helper.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/theming.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/theming.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/serialize/index.d.ts",url:"https://unpkg.com/@emotion/serialize@1.0.0/types/index.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/utils/index.d.ts",url:"https://unpkg.com/@emotion/utils@1.0.0/types/index.d.ts",depend:[]}],l=o.map(({name:a,url:d})=>(async()=>s.monaco.languages.typescript.typescriptDefaults.addExtraLib(await(await fetch(d)).text(),a.includes("@emotion")?`file:///node_modules/${a}`:`file:///node_modules/@types/${a}/index.d.ts`))());return s.monaco.languages.typescript.typescriptDefaults.setCompilerOptions({target:s.monaco.languages.typescript.ScriptTarget.ESNext,allowNonTsExtensions:!0,allowUmdGlobalAccess:!0,strict:!0,allowJs:!0,noEmitOnError:!0,allowSyntheticDefaultImports:!0,moduleResolution:s.monaco.languages.typescript.ModuleResolutionKind.NodeJs,module:s.monaco.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"],jsx:s.monaco.languages.typescript.JsxEmit.React,jsxFactory:"React.createElement",jsxFragmentFactory:"React.Fragment",esModuleInterop:!0}),await Promise.all(l),s.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!1,noSemanticValidation:!1,noSyntaxValidation:!1}),s}};function q(n){return new Promise(function(e,t){var r;r=window.document.createElement("script"),r.src=n,r.onload=()=>e(window),r.onerror=t,window.document.head.appendChild(r)})}const A=async n=>C.querySelector(`script[src="${n}"]`)||new Promise(function(e,t){const r=window.document.createElement("script");r.src=n,r.onload=e,r.onerror=t,window.document.head.appendChild(r)}),J=`import React from "react";
import ReactDOM from "react-dom"
/** @jsx jsx */
import styled from "@emotion/styled"

const Counter = () => {
  const [clicks, setClicks] = React.useState(0);

  return <Container>
    <Button css={\`background: green\`} onClick={() => setClicks(clicks - 1)}>-</Button>
    {clicks}
    <Button css={\`background: red\`} onClick={() => setClicks(clicks + 1)}>+</Button>
  </Container>
}

const Container = styled.div\`
  margin: 2em;
  display: inline-block;
  min-width: 200px;
  background: white;
  border: 4px dotted red;
  border-radius: 30px;
  padding: 1rem;
\`

const Button = styled.button\`
  text-align: center;
  display: inline-block;
  border-radius: 6px;
  padding: 0.5rem 0;
  margin: 0.5rem 2rem;
  width: 4rem;
  color: white;
  border: none;
  :focus{
    outline: none;
  }
  \`

const elementToRender = document.getElementById("root");
ReactDOM.render(<Counter />, elementToRender);



`,E=-1;function I({text1:n,text2:e,cursorPos:t}){if(n===e)return n?[[0,n]]:[];if(t){const l=Y(n,e,t);if(l)return l}let r=R(n,e);const i=n.substring(0,r);n=n.substring(r),e=e.substring(r),r=O(n,e);const s=n.substring(n.length-r);n=n.substring(0,n.length-r),e=e.substring(0,e.length-r);const o=$(n,e);return i&&o.unshift([0,i]),s&&o.push([0,s]),H(o),o}function $(n,e){let t;if(!n)return[[1,e]];if(!e)return[[E,n]];const r=n.length>e.length?n:e,i=n.length>e.length?e:n,s=r.indexOf(i);if(s!==-1)return t=[[1,r.substring(0,s)],[0,i],[1,r.substring(s+i.length)]],n.length>e.length&&(t[0][0]=t[2][0]=E),t;if(i.length===1)return[[E,n],[1,e]];const o=G(n,e);if(o){const l=o[0]||"",a=o[1]||"",d=o[2]||"",c=o[3]||"",u=o[4]||"",h=I({text1:l,text2:d,cursorPos:0}),m=I({text1:a,text2:c,cursorPos:0});return h.concat([[0,u[1]]],m)}return X(n,e)}function X(n,e){const t=n.length,r=e.length,i=Math.ceil((t+r)/2),s=i,o=2*i,l=new Array(o),a=new Array(o);for(let f=0;f<o;f++)l[f]=-1,a[f]=-1;l[s+1]=0,a[s+1]=0;const d=t-r,c=d%2!==0;let u=0,h=0,m=0,p=0;for(let f=0;f<i;f++){for(let g=-f+u;g<=f-h;g+=2){const y=i+g;let b;g===-f||g!==f&&l[y-1]<l[y+1]?b=l[y+1]:b=l[y-1]+1;let k=b-g;for(;b<t&&k<r&&n.charAt(b)===e.charAt(k);)b++,k++;if(l[y]=b,b>t)h+=2;else if(k>r)u+=2;else if(c){const S=i+d-g;if(S>=0&&S<o&&a[S]!==-1){const v=t-a[S];if(b>=v)return F(n,e,b,k)}}}let w;for(let g=-f+m;g<=f-p;g+=2){const y=i+g;g===-f||g!==f&&a[y-1]<a[y+1]?w=a[y+1]:w=a[y-1]+1;let b=w-g;for(;w<t&&b<r&&n.charAt(t-w-1)===e.charAt(r-b-1);)w++,b++;if(a[y]=w,w>t)p+=2;else if(b>r)m+=2;else if(!c){const k=i+d-g;if(k>=0&&k<o&&l[k]!==-1){const S=l[k],v=i+S-k;if(w=t-w,S>=w)return F(n,e,S,v)}}}}return[[E,n],[1,e]]}function F(n,e,t,r){const i=n.substring(0,t),s=e.substring(0,r),o=n.substring(t),l=e.substring(r),a=I({text1:i,text2:s,cursorPos:0}),d=I({text1:o,text2:l,cursorPos:0});return a.concat(d)}function R(n,e){if(!n||!e||n.charAt(0)!==e.charAt(0))return 0;let t=0,r=Math.min(n.length,e.length),i=r,s=0;for(;t<i;)n.substring(s,i)==e.substring(s,i)?(t=i,s=t):r=i,i=Math.floor((r-t)/2+t);return T(n.charCodeAt(i-1))&&i--,i}function O(n,e){if(!n||!e||n.slice(-1)!==e.slice(-1))return 0;let t=0,r=Math.min(n.length,e.length),i=r,s=0;for(;t<i;)n.substring(n.length-i,n.length-s)==e.substring(e.length-i,e.length-s)?(t=i,s=t):r=i,i=Math.floor((r-t)/2+t);return W(n.charCodeAt(n.length-i))&&i--,i}function G(n,e){const t=n.length>e.length?n:e,r=n.length>e.length?e:n;if(t.length<4||r.length*2<t.length)return null;function i(m,p,f){const w=m.substring(f,f+Math.floor(m.length/4));let g=-1,y="",b,k,S,v;for(;(g=p.indexOf(w,g+1))!==-1;){const L=R(m.substring(f),p.substring(g)),D=O(m.substring(0,f),p.substring(0,g));y.length<D+L&&(y=p.substring(g-D,g)+p.substring(g,g+L),b=m.substring(0,f-D),k=m.substring(f+L),S=p.substring(0,g-D),v=p.substring(g+L))}return y.length*2>=m.length?[b,k,S,v,y]:null}const s=i(t,r,Math.ceil(t.length/4)),o=i(t,r,Math.ceil(t.length/2));let l;if(o===null&&s===null)return null;if(o===null){if(s===null)return null;l=s}else if(s===null){if(o===null)return null;l=o}else l=s[4].length>o[4].length?s:o;let a,d,c,u;n.length>e.length?(a=l[0],d=l[1],c=l[2],u=l[3]):(c=l[0],u=l[1],a=l[2],d=l[3]);const h=l[4];return[a,d,c,u,h]}function H(n){const e=[...n];e.push([0,""]);let t=0,r=0,i=0,s="",o="",l,a;for(;t<e.length;){if(t<e.length-1&&!e[t][1]){e.splice(t,1);continue}switch(e[t][0]){case 1:i++,o+=e[t][1],t++;break;case E:r++,s+=e[t][1],t++;break;case 0:if(a=t-i-r-1,t<e.length-1&&!e[t][1]){e.splice(t,1);break}if(s.length>0||o.length>0){s.length>0&&o.length>0&&(l=R(o,s),l!==0&&(a>=0?e[a][1]+=o.substring(0,l):(e.splice(0,0,[0,o.substring(0,l)]),t++),o=o.substring(l),s=s.substring(l)),l=O(o,s),l!==0&&(e[t][1]=o.substring(o.length-l)+e[t][1],o=o.substring(0,o.length-l),s=s.substring(0,s.length-l)));const c=i+r;s.length===0&&o.length===0?(e.splice(t-c,c),t=t-c):s.length===0?(e.splice(t-c,c,[1,o]),t=t-c+1):o.length===0?(e.splice(t-c,c,[E,s]),t=t-c+1):(e.splice(t-c,c,[E,s],[1,o]),t=t-c+2)}t!==0&&e[t-1][0]===0?(e[t-1][1]+=e[t][1],e.splice(t,1)):t++,i=0,r=0,s="",o="";break}}e[e.length-1][1]===""&&e.pop();let d=!1;for(t=1;t<e.length-1;)e[t-1][0]===0&&e[t+1][0]===0&&(e[t][1].substring(e[t][1].length-e[t-1][1].length)===e[t-1][1]?(e[t][1]=e[t-1][1]+e[t][1].substring(0,e[t][1].length-e[t-1][1].length),e[t+1][1]=e[t-1][1]+e[t+1][1],e.splice(t-1,1),d=!0):e[t][1].substring(0,e[t+1][1].length)==e[t+1][1]&&(e[t-1][1]+=e[t+1][1],e[t][1]=e[t][1].substring(e[t+1][1].length)+e[t+1][1],e.splice(t+1,1),d=!0)),t++;return d?H(e):e}function T(n){return n>=55296&&n<=56319}function W(n){return n>=56320&&n<=57343}function K(n){return W(n.charCodeAt(0))}function Q(n){return T(n.charCodeAt(n.length-1))}function Z(n){const e=[];for(let t=0;t<n.length;t++)n[t][1].length>0&&e.push(n[t]);return e}function x(n,e,t,r){return Q(n)||K(r)?null:Z([[0,n],[E,e],[1,t],[0,r]])}function Y(n,e,t){const r=typeof t=="number"?{index:t,length:0}:t.oldRange,i=typeof t=="number"?null:t.newRange,s=n.length,o=e.length;if(r.length===0&&(i===null||i.length===0)){const l=r.index,a=n.slice(0,l),d=n.slice(l),c=i?i.index:null;e:{const u=l+o-s;if(c!==null&&c!==u)break e;if(u<0||u>o)break e;const h=e.slice(0,u),m=e.slice(u);if(m!==d)break e;const p=Math.min(l,u),f=a.slice(0,p),w=h.slice(0,p);if(f!==w)break e;const g=a.slice(p),y=h.slice(p);return x(f,g,y,d)}e:{if(c!==null&&c!==l)break e;const u=l,h=e.slice(0,l),m=e.slice(l);if(h!==a)break e;const p=Math.min(s-l,o-l),f=d.slice(d.length-p),w=m.slice(m.length-p);if(f!==w)break e;const g=d.slice(0,d.length-p),y=m.slice(0,m.length-p);return x(a,g,y,f)}}if(r.length>0&&i&&i.length===0){e:{const l=n.slice(0,r.index),a=n.slice(r.index+r.length),d=l.length,c=a.length;if(o<d+c)break e;const u=e.slice(0,d),h=e.slice(o-c);if(l!==u||a!==h)break e;const m=n.slice(d,s-c),p=e.slice(d,o-c);return x(l,m,p,a)}}return null}function P(n,e,t){return I({text1:n,text2:e,cursorPos:t})}P.INSERT=1,P.DELETE=E,P.EQUAL=0;const C=window.document;let _=!0,M=0,N=0,B="",V="",z="",j="";export async function run(){const n=A("https://unpkg.com/jsframe.js@1.6.2/lib/jsframe.min.js");await A("https://unpkg.com/@babel/standalone@7.12.6/babel.min.js"),(async()=>{const i=t();j=i;let s;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)&&(await Promise.all([A("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"),A("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-typescript.min.js"),A("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.js")]),C.getElementById("ace").style.setProperty("display","block"),C.getElementById("container").style.setProperty("display","none"),s=window.ace.edit("ace"),s.getSession().setMode("ace/mode/typescript"),setTimeout(()=>s.setTheme("ace/theme/monokai"),100),s.setValue(i),s.blur());const o=await U({language:"typescript",code:i,onChange:l});s&&s.session.on("change",function(){const c=s.getValue();o.editor.setValue(c),l(c)});function l(c){if(!o)return;if(B=c,!M)d(B);else{const u=c,h=setInterval(()=>{(c!==B||!M)&&clearInterval(h),M||d(B)},100)}}async function a(){if(!o||!o.monaco)return;const c=o.monaco.Uri.parse("file:///main.tsx"),u=await o.monaco.languages.typescript.getTypeScriptWorker(),h=await(await u(c)).getSemanticDiagnostics("file:///main.tsx"),m=await(await u(c)).getCompilerOptionsDiagnostics("file:///main.tsx"),p=await(await u(c)).getSyntacticDiagnostics("file:///main.tsx");return[...h,...m,...p]}async function d(c){if(M===1)return;try{M=1;const u=await a(),h=C.getElementById("error");if(M=0,c!==B)return;if(u&&u.length){if(B!=c)return;if(V===c)return;C.getElementById("root").classList.add("transparent");const m=P(j,c,0);if(m.length<=3){o.monaco.editor.setTheme("hc-black");return}h.innerHTML=u[0].messageText.toString(),C.getElementById("root").style.setProperty("dispay","none"),h.style.display="block",V=c,o.monaco.editor.setTheme("vs-light"),setTimeout(()=>{o.monaco.editor.setTheme("hc-black")},N++);return}j=c,h.style.display="none",o.monaco.editor.setTheme("vs-dark"),C.getElementById("root").classList.remove("transparent"),N=0,M=0,e(r(c))}catch(u){if(M=0,c!==B)return;o.monaco.editor.setTheme("vs-light"),setTimeout(()=>{o.monaco.editor.setTheme("hc-black")},10),console.error(u)}}})(),e(r(t())),C.getElementById("root").setAttribute("style","display:block");async function e(i){console.log(i);const s=new Function("transpileCode",`return function(){ 
        ${i} 
    }`)();if(!_){const o=async a=>{if(a!==j)return;if(z===a)return;z=a;const d={codeTranspiled:i,code:j},c=JSON.stringify(d),u=new Request("https://code.zed.vision",{body:c,method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}}),h=await fetch(u),{hash:m}=await h.json();try{const p=window.localStorage,f=p.getItem("codeBoXHash");f!==m&&(p.setItem("codeBoXHash",m),p.setItem(m,j),window.history.pushState({},"","/?h="+m))}catch(p){console.log("no localStorage")}},l=B;setTimeout(()=>o(B),500)}_=!1,s()}function t(){const i=new URLSearchParams(window.location.search),s=i.get("h")||localStorage.getItem("codeBoXHash");return s&&window.localStorage.getItem(s)||window.localStorage.getItem("STARTER")||J}function r(i){return window.Babel.transform(i,{plugins:[],presets:["react",["typescript",{isTSX:!0,allExtensions:!0}]]}).code.replace(/import/gi,"///")}}
