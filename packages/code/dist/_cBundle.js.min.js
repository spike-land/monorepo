const q=async({onChange:n,code:e,language:t})=>{const o=window.document.getElementById("container");if(!o){const l=E.getElementById("container");l.id="container",E.body.appendChild(l)}if(window.monaco===void 0){const l="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs",{require:r}=await J("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs/loader.min.js");r.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs"}}),await new Promise(d=>r(["vs/editor/editor.main"],c=>{d(c)}))}const i=window.monaco,s={monaco:i,editor:i.editor.create(window.document.getElementById("container"),{cursorStyle:"block",formatOnType:!0,scrollbar:{horizontal:"hidden",verticalHasArrows:!0,verticalScrollbarSize:20},minimap:{enabled:!0},folding:!1,multiCursorModifier:"alt",wordWrap:"on",wordWrapBreakAfterCharacters:">([{]))],;}",mouseWheelZoom:!1,wordWrapColumn:80,automaticLayout:!0,scrollBeyondLastLine:!1,autoIndent:"brackets",autoClosingQuotes:"always",padding:{bottom:300},lineNumbers:"on",autoClosingBrackets:"always",autoClosingOvertype:"always",suggest:{},codeLens:!0,autoSurround:"languageDefined",trimAutoWhitespace:!0,codeActionsOnSaveTimeout:100,model:i.editor.createModel(e,t,i.Uri.parse(t==="typescript"?"file:///main.tsx":"file:///main.html")),value:e,language:t,theme:"vs-dark"})};if(s.editor.onDidChangeModelContent(()=>n(s.editor.getValue())),s.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!0,noSemanticValidation:!0,noSyntaxValidation:!0}),t==="typescript"){const l=[{name:"react",url:"https://unpkg.com/@types/react@16.9.56/index.d.ts",depend:["global","csstype","react-dom","prop-types"]},{name:"global",url:"https://unpkg.com/@types/react@16.9.56/global.d.ts",depend:[]},{name:"prop-types",url:"https://unpkg.com/@types/prop-types@15.7.3/index.d.ts",depend:[]},{name:"react-dom",url:"https://unpkg.com/@types/react-dom@16.9.9/index.d.ts",depend:[]},{name:"csstype",url:"https://unpkg.com/csstype@3.0.5/index.d.ts",depend:[]},{name:"@emotion/styled/base.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/base.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/styled/index.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/index.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/cache/index.d.ts",url:"https://unpkg.com/@emotion/cache@11.0.0/types/index.d.ts",depend:["@emotion/utils"]},{name:"@emotion/react/index.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/index.d.ts",depend:["@emotion/cache"]},{name:"@emotion/react/jsx-namespace.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/jsx-namespace.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/css-prop.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/css-prop.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/helper.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/helper.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/theming.d.ts",url:"https://unpkg.com/@emotion/react@11.0.0/types/theming.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/serialize/index.d.ts",url:"https://unpkg.com/@emotion/serialize@1.0.0/types/index.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/utils/index.d.ts",url:"https://unpkg.com/@emotion/utils@1.0.0/types/index.d.ts",depend:[]}],r=l.map(({name:d,url:c})=>(async()=>s.monaco.languages.typescript.typescriptDefaults.addExtraLib(await(await fetch(c)).text(),d.includes("@emotion")?`file:///node_modules/${d}`:`file:///node_modules/@types/${d}/index.d.ts`))());return s.monaco.languages.typescript.typescriptDefaults.setCompilerOptions({target:s.monaco.languages.typescript.ScriptTarget.ESNext,allowNonTsExtensions:!0,allowUmdGlobalAccess:!0,strict:!0,allowJs:!0,noEmitOnError:!0,allowSyntheticDefaultImports:!0,moduleResolution:s.monaco.languages.typescript.ModuleResolutionKind.NodeJs,module:s.monaco.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"],jsx:s.monaco.languages.typescript.JsxEmit.React,jsxFactory:"React.createElement",jsxFragmentFactory:"React.Fragment",esModuleInterop:!0}),await Promise.all(r),s.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!1,noSemanticValidation:!1,noSyntaxValidation:!1}),s}};function J(n){return new Promise(function(e,t){var o;o=window.document.createElement("script"),o.src=n,o.onload=()=>e(window),o.onerror=t,window.document.head.appendChild(o)})}const R=async n=>E.querySelector(`script[src="${n}"]`)||new Promise(function(e,t){const o=window.document.createElement("script");o.src=n,o.onload=e,o.onerror=t,window.document.head.appendChild(o)}),$=`import React from "react";
import ReactDOM from "react-dom"
/** @jsx jsx */
import styled from "@emotion/styled"

const Counter = () => {
  const [clicks, setClicks] = React.useState(0);

  return <Container>
    <Button css={\`background: green\`} onClick={() => setClicks(clicks - 1)}>-</Button>
    {clicks}
    <Button css={\`background: red\`} onClick={() => setClicks(clicks + 1)}>+</Button>
  </Container>
}

const Container = styled.div\`
  margin: 2em;
  max-width: 400px;
  background: white;
  border: 6px solid grey;
  border-radius: 20px;
  padding: 1rem;
 \`

const Button = styled.button\`
  text-align: center;
  display: inline-block;
  border-radius: 6px;
  padding: 0.5rem 0;
  margin: 0.5rem 1rem;
  width: 3rem;
  color: white;
  border: none;
  :focus{
    outline: none;
  }
  \`

const elementToRender = document.getElementById("root");
ReactDOM.render(<Counter />, elementToRender);


`,M=-1;function I({text1:n,text2:e,cursorPos:t}){if(n===e)return n?[[0,n]]:[];if(t){const r=ee(n,e,t);if(r)return r}let o=O(n,e);const i=n.substring(0,o);n=n.substring(o),e=e.substring(o),o=T(n,e);const s=n.substring(n.length-o);n=n.substring(0,n.length-o),e=e.substring(0,e.length-o);const l=X(n,e);return i&&l.unshift([0,i]),s&&l.push([0,s]),_(l),l}function X(n,e){let t;if(!n)return[[1,e]];if(!e)return[[M,n]];const o=n.length>e.length?n:e,i=n.length>e.length?e:n,s=o.indexOf(i);if(s!==-1)return t=[[1,o.substring(0,s)],[0,i],[1,o.substring(s+i.length)]],n.length>e.length&&(t[0][0]=t[2][0]=M),t;if(i.length===1)return[[M,n],[1,e]];const l=K(n,e);if(l){const r=l[0]||"",d=l[1]||"",c=l[2]||"",a=l[3]||"",m=l[4]||"",y=I({text1:r,text2:c,cursorPos:0}),f=I({text1:d,text2:a,cursorPos:0});return y.concat([[0,m[1]]],f)}return G(n,e)}function G(n,e){const t=n.length,o=e.length,i=Math.ceil((t+o)/2),s=i,l=2*i,r=new Array(l),d=new Array(l);for(let g=0;g<l;g++)r[g]=-1,d[g]=-1;r[s+1]=0,d[s+1]=0;const c=t-o,a=c%2!==0;let m=0,y=0,f=0,p=0;for(let g=0;g<i;g++){for(let u=-g+m;u<=g-y;u+=2){const w=i+u;let b;u===-g||u!==g&&r[w-1]<r[w+1]?b=r[w+1]:b=r[w-1]+1;let S=b-u;for(;b<t&&S<o&&n.charAt(b)===e.charAt(S);)b++,S++;if(r[w]=b,b>t)y+=2;else if(S>o)m+=2;else if(a){const C=i+c-u;if(C>=0&&C<l&&d[C]!==-1){const j=t-d[C];if(b>=j)return W(n,e,b,S)}}}let k;for(let u=-g+f;u<=g-p;u+=2){const w=i+u;u===-g||u!==g&&d[w-1]<d[w+1]?k=d[w+1]:k=d[w-1]+1;let b=k-u;for(;k<t&&b<o&&n.charAt(t-k-1)===e.charAt(o-b-1);)k++,b++;if(d[w]=k,k>t)p+=2;else if(b>o)f+=2;else if(!a){const S=i+c-u;if(S>=0&&S<l&&r[S]!==-1){const C=r[S],j=i+C-S;if(k=t-k,C>=k)return W(n,e,C,j)}}}}return[[M,n],[1,e]]}function W(n,e,t,o){const i=n.substring(0,t),s=e.substring(0,o),l=n.substring(t),r=e.substring(o),d=I({text1:i,text2:s,cursorPos:0}),c=I({text1:l,text2:r,cursorPos:0});return d.concat(c)}function O(n,e){if(!n||!e||n.charAt(0)!==e.charAt(0))return 0;let t=0,o=Math.min(n.length,e.length),i=o,s=0;for(;t<i;)n.substring(s,i)==e.substring(s,i)?(t=i,s=t):o=i,i=Math.floor((o-t)/2+t);return x(n.charCodeAt(i-1))&&i--,i}function T(n,e){if(!n||!e||n.slice(-1)!==e.slice(-1))return 0;let t=0,o=Math.min(n.length,e.length),i=o,s=0;for(;t<i;)n.substring(n.length-i,n.length-s)==e.substring(e.length-i,e.length-s)?(t=i,s=t):o=i,i=Math.floor((o-t)/2+t);return H(n.charCodeAt(n.length-i))&&i--,i}function K(n,e){const t=n.length>e.length?n:e,o=n.length>e.length?e:n;if(t.length<4||o.length*2<t.length)return null;function i(f,p,g){const k=f.substring(g,g+Math.floor(f.length/4));let u=-1,w="",b,S,C,j;for(;(u=p.indexOf(k,u+1))!==-1;){const L=O(f.substring(g),p.substring(u)),D=T(f.substring(0,g),p.substring(0,u));w.length<D+L&&(w=p.substring(u-D,u)+p.substring(u,u+L),b=f.substring(0,g-D),S=f.substring(g+L),C=p.substring(0,u-D),j=p.substring(u+L))}return w.length*2>=f.length?[b,S,C,j,w]:null}const s=i(t,o,Math.ceil(t.length/4)),l=i(t,o,Math.ceil(t.length/2));let r;if(l===null&&s===null)return null;if(l===null){if(s===null)return null;r=s}else if(s===null){if(l===null)return null;r=l}else r=s[4].length>l[4].length?s:l;let d,c,a,m;n.length>e.length?(d=r[0],c=r[1],a=r[2],m=r[3]):(a=r[0],m=r[1],d=r[2],c=r[3]);const y=r[4];return[d,c,a,m,y]}function _(n){const e=[...n];e.push([0,""]);let t=0,o=0,i=0,s="",l="",r,d;for(;t<e.length;){if(t<e.length-1&&!e[t][1]){e.splice(t,1);continue}switch(e[t][0]){case 1:i++,l+=e[t][1],t++;break;case M:o++,s+=e[t][1],t++;break;case 0:if(d=t-i-o-1,t<e.length-1&&!e[t][1]){e.splice(t,1);break}if(s.length>0||l.length>0){s.length>0&&l.length>0&&(r=O(l,s),r!==0&&(d>=0?e[d][1]+=l.substring(0,r):(e.splice(0,0,[0,l.substring(0,r)]),t++),l=l.substring(r),s=s.substring(r)),r=T(l,s),r!==0&&(e[t][1]=l.substring(l.length-r)+e[t][1],l=l.substring(0,l.length-r),s=s.substring(0,s.length-r)));const a=i+o;s.length===0&&l.length===0?(e.splice(t-a,a),t=t-a):s.length===0?(e.splice(t-a,a,[1,l]),t=t-a+1):l.length===0?(e.splice(t-a,a,[M,s]),t=t-a+1):(e.splice(t-a,a,[M,s],[1,l]),t=t-a+2)}t!==0&&e[t-1][0]===0?(e[t-1][1]+=e[t][1],e.splice(t,1)):t++,i=0,o=0,s="",l="";break}}e[e.length-1][1]===""&&e.pop();let c=!1;for(t=1;t<e.length-1;)e[t-1][0]===0&&e[t+1][0]===0&&(e[t][1].substring(e[t][1].length-e[t-1][1].length)===e[t-1][1]?(e[t][1]=e[t-1][1]+e[t][1].substring(0,e[t][1].length-e[t-1][1].length),e[t+1][1]=e[t-1][1]+e[t+1][1],e.splice(t-1,1),c=!0):e[t][1].substring(0,e[t+1][1].length)==e[t+1][1]&&(e[t-1][1]+=e[t+1][1],e[t][1]=e[t][1].substring(e[t+1][1].length)+e[t+1][1],e.splice(t+1,1),c=!0)),t++;return c?_(e):e}function x(n){return n>=55296&&n<=56319}function H(n){return n>=56320&&n<=57343}function Q(n){return H(n.charCodeAt(0))}function Z(n){return x(n.charCodeAt(n.length-1))}function Y(n){const e=[];for(let t=0;t<n.length;t++)n[t][1].length>0&&e.push(n[t]);return e}function F(n,e,t,o){return Z(n)||Q(o)?null:Y([[0,n],[M,e],[1,t],[0,o]])}function ee(n,e,t){const o=typeof t=="number"?{index:t,length:0}:t.oldRange,i=typeof t=="number"?null:t.newRange,s=n.length,l=e.length;if(o.length===0&&(i===null||i.length===0)){const r=o.index,d=n.slice(0,r),c=n.slice(r),a=i?i.index:null;e:{const m=r+l-s;if(a!==null&&a!==m)break e;if(m<0||m>l)break e;const y=e.slice(0,m),f=e.slice(m);if(f!==c)break e;const p=Math.min(r,m),g=d.slice(0,p),k=y.slice(0,p);if(g!==k)break e;const u=d.slice(p),w=y.slice(p);return F(g,u,w,c)}e:{if(a!==null&&a!==r)break e;const m=r,y=e.slice(0,r),f=e.slice(r);if(y!==d)break e;const p=Math.min(s-r,l-r),g=c.slice(c.length-p),k=f.slice(f.length-p);if(g!==k)break e;const u=c.slice(0,c.length-p),w=f.slice(0,f.length-p);return F(d,u,w,g)}}if(o.length>0&&i&&i.length===0){e:{const r=n.slice(0,o.index),d=n.slice(o.index+o.length),c=r.length,a=d.length;if(l<c+a)break e;const m=e.slice(0,c),y=e.slice(l-a);if(r!==m||d!==y)break e;const f=n.slice(c,s-a),p=e.slice(c,l-a);return F(r,f,p,d)}}return null}function P(n,e,t){return I({text1:n,text2:e,cursorPos:t})}P.INSERT=1,P.DELETE=M,P.EQUAL=0;const E=window.document;let N=!0,v=0,V=0,B="",z="",U="",A="";export async function run(){await R("https://unpkg.com/jsframe.js@1.6.2/lib/jsframe.min.js"),await R("https://unpkg.com/@babel/standalone@7.12.6/babel.min.js"),window.css=window.emotionReact.css,window.jsx=window.emotionReact.jsx,window.styled=window.emotionStyled,(async()=>{const o=e();A=o;let i;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)&&(await Promise.all([R("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"),R("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.js")]),E.getElementById("ace").style.setProperty("display","block"),E.getElementById("container").style.setProperty("display","none"),i=window.ace.edit("ace"),i.setTheme("ace/theme/monokai"),i.session.setMode("ace/mode/typescript"),i.setValue(o));const s=await q({language:"typescript",code:o,onChange:l});i&&i.session.on("change",function(){const c=i.getValue();s.editor.setValue(c),l(c)});function l(c){if(!s)return;if(B=c,!v)d(B);else{const a=c,m=setInterval(()=>{(c!==B||!v)&&clearInterval(m),v||d(B)},100)}}async function r(){if(!s||!s.monaco)return;const c=s.monaco.Uri.parse("file:///main.tsx"),a=await s.monaco.languages.typescript.getTypeScriptWorker(),m=await(await a(c)).getSemanticDiagnostics("file:///main.tsx"),y=await(await a(c)).getCompilerOptionsDiagnostics("file:///main.tsx"),f=await(await a(c)).getSyntacticDiagnostics("file:///main.tsx");return[...m,...y,...f]}async function d(c){if(v===1)return;try{v=1;const a=await r(),m=E.getElementById("error");if(v=0,c!==B)return;if(a&&a.length){if(B!=c)return;if(z===c)return;E.getElementById("root").classList.add("transparent");const y=P(A,c,0);if(y.length<=3){s.monaco.editor.setTheme("hc-black");return}m.innerHTML=a[0].messageText.toString(),E.getElementById("root").style.setProperty("dispay","none"),m.style.display="block",z=c,s.monaco.editor.setTheme("vs-light"),setTimeout(()=>{s.monaco.editor.setTheme("hc-black")},V++);return}A=c,m.style.display="none",s.monaco.editor.setTheme("vs-dark"),E.getElementById("root").classList.remove("transparent"),V=0,v=0,n(t(c))}catch(a){if(v=0,c!==B)return;s.monaco.editor.setTheme("vs-light"),setTimeout(()=>{s.monaco.editor.setTheme("hc-black")},10),console.error(a)}}})(),n(t(e())),E.getElementById("root").setAttribute("style","display:block");async function n(o){console.log(o);const i=new Function("transpileCode",`return function(){ 
        ${o} 
    }`)();if(!N){const s=async r=>{if(r!==A)return;if(U===r)return;U=r;const d={codeTranspiled:o,code:A},c=JSON.stringify(d),a=new Request("https://code.zed.vision",{body:c,method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}}),m=await fetch(a),{hash:y}=await m.json();try{const f=window.localStorage,p=f.getItem("codeBoXHash");p!==y&&(f.setItem("codeBoXHash",y),f.setItem(y,A),window.history.pushState({},"","/?h="+y))}catch(f){console.log("no localStorage")}},l=B;setTimeout(()=>s(B),500)}N=!1,i()}function e(){const o=new URLSearchParams(window.location.search);return h&&window.localStorage.getItem(h)||window.localStorage.getItem("STARTER")||$}function t(o){return window.Babel.transform(o,{plugins:[],presets:["react",["typescript",{isTSX:!0,allExtensions:!0}]]}).code.replace(/import/gi,"///")}}
