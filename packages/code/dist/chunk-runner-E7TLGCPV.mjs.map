{
  "version": 3,
  "sources": ["../js/runner.tsx", "../js/renderToString.tsx"],
  "sourcesContent": ["// import type { Dispatch, ReactNode, SetStateAction } from \"react\";\nimport { saveCode } from \"./ws\";\nimport { appFactory } from \"./starter\";\nimport { mST } from \"./session\";\nimport { renderFromString } from \"./renderToString\";\n// import { toUmd } from \"./toUmd\";\nimport type { TransformOptions } from \"esbuild-wasm\";\n// import { md5 } from \"./md5\";\n// var Stream = require('stream/')\n\n// import \"es-module-shims\";\n\n// if (\"serviceWorker\" in navigator) {\n//   const wb = new Workbox(\"/sw.js\");\n\n//   wb.register();\n// }\n\n// const hash = new Sha256();\n\n// const importMap = { imports: {\n//   \"framer-motion\": \"/framer-motion.mjs\",\n//   \"react-dom/server\": \"/react.mjs\",\n//   \"@emotion/react\": \"/emotion.mjs\",\n//   \"react\": \"/react.mjs\",} };\n\n// importShim.addImportMap(importMap)\n\nexport interface IRunnerSession {\n  // changes: unknown[];\n  errorText: string;\n  child: Dispatch<SetStateAction<ReactNode[]>>;\n  url: string;\n}\n\n// const debounced = debounce(runner, 300, {\n//   maxWait: 600,\n//   trailing: true,\n//   leading: true,\n// });\n\n// export const runnerDebounced: typeof runner = (props) => debounced(props);\n\nconst mod = {\n  i: 0,\n  esbuildInit: async () => await (await (await import(\"./esbuildEsm\"))).init(),\n};\n\nexport async function runner({ code, counter, codeSpace }: {\n  code: string;\n  codeSpace: string;\n  counter: number;\n}) {\n  // console.log({ i, counter });\n\n  const esbuild = await (mod.esbuildInit());\n\n  mod.i = counter;\n\n  if (code === mST().code) return;\n  if (mod.i > counter) return;\n\n  // session.changes.push(changes);\n\n  // esbuildEsmTransform = esbuildEsmTransform ||\n  //   (await import(\"./esbuildEsm.ts\")).transform;\n\n  try {\n    const transpiled = await esbuild.transform(code, {\n      loader: \"tsx\",\n      format: \"esm\",\n      treeShaking: true,\n      tsconfigRaw: {\n        \"compilerOptions\": {\n          \"jsx\": \"react-jsx\",\n          \"jsxImportSource\": \"@emotion/react\",\n        },\n      },\n      target: \"es2021\",\n    } as unknown as TransformOptions);\n\n  //   try{\n  //     (async ()=>{\n  //       const name = `${location.origin}/live/${codeSpace}-${md5(code)}.tsx`;\n  //   const UMD = await toUmd(code,name);\n  //   console.log({ UMD });\n  // //  console.log(UMD?.toJs(name));\n  //     // const hashName = UMD?.hashMap[name];\n  //     // UMD?.data[hashName!].code + \n  //   // console.log(UMD.toJs(`${location.origin}/live/${codeSpace}-${md5(code)}.tsx`))\n  //     })();\n  //   }\n  //   catch(e){\n  //     console.error({e});\n  //   }\n    if (transpiled.code === mST().transpiled) return;\n\n    let restartError = false;\n    /// yellow\n    if (transpiled.code.length > 0) {\n      try {\n        // console.log(transpiled);\n\n        const App = await appFactory(transpiled.code);\n        const { html, css } = renderFromString(App, codeSpace);\n        // console.log({html, css});\n\n        await saveCode({\n          code,\n          transpiled: transpiled.code,\n          i: counter,\n          html,\n          css,\n        });\n\n        return;\n      } catch (error) {\n        console.error(\"EXCEPTION\");\n        console.error(error);\n        restartError = true;\n        console.error({ restartError });\n        return;\n      }\n    }\n  } catch (error) {\n    console.error({ error });\n  }\n}\n", "// import {CacheProvider } from \"@emotion/react\"\n\nimport { render } from \"react-dom\";\nimport type { FC } from \"react\";\nimport { hashCode, mST, patchSync } from \"./session\";\n\n// const WithCache: FC<{children: ReactNode, cache: EmotionCache}> = ({children, cache}) => <CacheProvider value={cache}>{children}</CacheProvider>\n\nexport const renderFromString = (App: FC, codeSpace: string) => {\n  // const myCache =  createCache({\n  //   prepend: true,\n  //   key: 'css',\n  //   stylisPlugins: [\n  //   ]\n  // });\n\n  const temp = document.createElement(\"div\");\n  render(<App />, temp);\n  const html = temp.innerHTML;\n\n  setTimeout(() => {\n    const hash = hashCode();\n    setTimeout(() => {\n      if (hash !== hashCode()) return;\n      const { css, html } = mST();\n      // @ts-ignore\n      // const codeSpace: string = globalThis[\"codeSpace\"] as unknown as string;\n      const temp = document.getElementById(\"root-\" + codeSpace)!;\n\n      const htmlHtml = temp.innerHTML;\n      const newCss = extractCritical(htmlHtml);\n      if (css !== newCss || html !== htmlHtml) {\n        patchSync({\n          ...mST(),\n          html: htmlHtml,\n          css: newCss,\n        });\n      }\n    }, 50);\n  }, 100);\n\n  return {\n    html,\n    css: extractCritical(html),\n  };\n};\nconst extractCritical = (html: string) => {\n  try {\n    const rules: { [key: string]: string } = {};\n    for (let i in document.styleSheets) {\n      const styleSheet = document.styleSheets[i];\n      // for (let r in styleSheet.cssRules) {\n      if (styleSheet?.cssRules) {\n        Array.from(styleSheet.cssRules).forEach((rule) => {\n          if (rule && rule.cssText && rule.cssText.slice(0, 5) === \".css-\") {\n            const selector = rule.cssText.slice(1, 11);\n            if (\n              !rules[selector] && html.includes(selector) &&\n              !rule.cssText.slice(10).includes(\".css-\")\n            ) {\n              rules[selector] = rule.cssText;\n            }\n          }\n        });\n      }\n    }\n\n    return Object.keys(rules).map((r) => rules[r]).join(\" \");\n  } catch {\n    console.error(\"no css\");\n    return \"\";\n  }\n};\n"],
  "mappings": "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",
  "names": ["html", "temp"]
}
