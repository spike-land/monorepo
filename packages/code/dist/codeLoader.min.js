function D(){return{i:0,unmount:()=>{},hydrated:!1,preRendered:!1,lastErrors:0,rootElement:null,div:window.document.createElement("div"),html:"",versions:{},ipfs:0,transpiled:"",code:""}}export async function run(m="window",v,p=""){const{renderPreviewWindow:b}=await import("./renderPreviewWindow.js"),{sendSignalToQrCode:E}=await import("./sendSignalToQrCode.js"),{v:a}=await import("./versions.js"),{getCodeToLoad:T,saveCode:j}=await import("./data.js"),{transpileCode:u}=await import("./transpile.js");await E();const{formatter:g}=await import("./formatter.js");if(m==="window"){const{openWindows:e}=await import("./openWindows.js");await e(a)}const{open:C}=v,t=D();if(t.code=p?await g(p):"",!p)try{const{code:e,transpiled:o,html:i,versions:r}=await T();t.code=e,t.transpiled=await u(e)||o,t.div.innerHTML=i,t.versions=r?JSON.parse(r):Object.assign({},a)}catch(e){console.error({e,message:"couldn't start"});return}if(t.versions=t.versions||Object.assign({},a),t.transpiled===""){const e=await u(t.code);console.log(e),t.transpiled=e}const{renderEmotion:y,jsx:k,DraggableWindow:S}=await import(a.emotionRenderer);await(await b(m,t,C,y,k,S)),await h(t.transpiled,t.i);const x=(await import(a.editor)).default,W=window.document.getElementById("editor"),c=await x({language:"typescript",container:W,code:t.code,onChange:e=>O(e)});async function O(e){t.i++;const o=t.i,i=await g(e);try{const r=await u(i);let n=!1;if(r.length&&t.lastErrors<2){if(o<t.i)return;n=await h(r,o)}if(t.i>o)return;const s=await z(i);if(t.i>o)return;if(n&&s.push({messageText:"Error while starting the app. Check the console!"}),s.length&&console.log({err:s}),t.lastErrors&&s.length===0&&h(r,o),t.lastErrors=s.length,s.length===0&&r.length){if(t.i>o||(t.code=await g(i),t.i>o))return;t.versions=Object.assign({},a),j(t,o)}else{if(t.i>o)return;const{diff:d}=await import(`https://unpkg.com/@zedvision/shadb@${a.shadb}/src/diff.js`),l=await d(t.code,i);if(l.c.length<=3){t.lastErrors=0;return}if(l.c.length==4){t.lastErrors=0,c.monaco.editor.setTheme("hc-black");return}console.error(s[0].messageText.toString());return}c.monaco.editor.setTheme("vs-dark")}catch(r){c.monaco.editor.setTheme("vs-light"),setTimeout(()=>{c.monaco.editor.setTheme("hc-black")},50),console.error(r)}}async function z(e){if(!c||!c.monaco)return[{messageText:"Error with the error checking. Try to reload!"}];const{monaco:o}=c,{sha256:i}=await import(`https://unpkg.com/@zedvision/shadb@${a.shadb}/src/sha256.js`),n=`file:///${await i(e)}.tsx`,s=o.Uri.parse(n),d=o.editor.getModel(s)||await o.editor.createModel(e,"typescript",s),w=await(await o.languages.typescript.getTypeScriptWorker())(d.uri),f=w.getSemanticDiagnostics(n),L=w.getCompilerOptionsDiagnostics(n),M=w.getSyntacticDiagnostics(n),B=await Promise.race([f,L,M]);return d.dispose(),[...B]}async function h(e,o){t.html="",t.transpiled="";let i=!1;if(typeof e!="string"||e==="")return i=!0,i;const r=m==="window"?e.replace("body{","#zbody{"):e,n=window.document.createElement("div");if(t.i>o)return!1;const s=(await import(l(r))).default;t.unmount(),t.unmount=y(s(),n);const d=window.document.getElementById("zbody");return d&&d.children[0].replaceWith(n),t.div=n,t.html=n.innerHTML,t.transpiled=e,!t.html;function l(w){const f=new Blob([w],{type:"application/javascript"});return URL.createObjectURL(f)}}}
