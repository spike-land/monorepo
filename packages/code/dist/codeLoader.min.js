function I(){return{i:0,unmount:()=>{},hydrated:!1,preRendered:!1,lastErrors:0,rootElement:null,div:window.document.createElement("div"),html:"",url:"",versions:{},ipfs:0,transpiled:"",code:""}}export async function run(p="window",E,m=""){const{pathname:v}=new URL(window.location.href),T=await import("./ipfsClient.js").then(e=>e.getIpfs());window.ipfs=T,setTimeout(async()=>Object.assign(window,await import("./hash.js")));const{renderPreviewWindow:C}=await import("./renderPreviewWindow.js"),{getCodeToLoad:k,getIPFSCodeToLoad:L,saveCode:b}=await import("./data.js"),{transpileCode:h}=await import("./transpile.js"),{formatter:u}=await import("./formatter.js"),{open:S}=E,t=I();if(t.code=m?await u(m):"",!m)try{const{code:e,transpiled:o,html:r,versions:n}=v.endsWith("/edit/")||v.endsWith("/edit")?await L():await k();t.code=e,t.transpiled=await h(e)||o,t.div.innerHTML=r,t.versions=n,typeof n=="string"&&n!==""&&(t.versions=JSON.parse(n))}catch(e){console.error({e,message:"couldn't start"});return}const{v:a}=await import("./versions.js");if(p==="window"){const{openWindows:e}=await import("./openWindows.js");await e(a)}if(t.versions=t.versions||Object.assign({},a),t.transpiled===""){const e=await h(t.code);console.log(e),t.transpiled=e}const{renderEmotion:j,jsx:W,DraggableWindow:x}=await import(a.emotionRenderer);await(await C(p,t,S,j,W,x)),await f(t.transpiled,t.i);const O=(await import(a.editor)).default,R=window.document.getElementById("editor"),c=await O({language:"typescript",container:R,code:t.code,onChange:e=>z(e)}),{sendSignalToQrCode:U}=await import("./sendSignalToQrCode.js");t.url||await b(t,t.i),await U(t.url);async function z(e){t.i++;const o=t.i,r=await u(e);try{const n=await h(r);let s=!1;if(n.length&&t.lastErrors<2){if(o<t.i)return;s=await f(n,o)}if(t.i>o)return;const i=await M(r);if(t.i>o)return;if(s&&i.push({messageText:"Error while starting the app. Check the console!"}),i.length&&console.log({err:i}),t.lastErrors&&i.length===0&&f(n,o),t.lastErrors=i.length,i.length===0&&n.length){if(t.i>o||(t.code=await u(r),t.i>o))return;t.versions=Object.assign({},a),b(t,o)}else{if(t.i>o)return;if(r.length<1e3&&t.code.length<1e3){const{diff:d}=await import(`https://unpkg.com/@zedvision/shadb@${a.shadb}/src/diff.js`),l=await d(t.code,r);if(l.c.length<=3){t.lastErrors=0;return}if(l.c.length==4){t.lastErrors=0,c.monaco.editor.setTheme("hc-black");return}}console.error(i[0].messageText.toString());return}c.monaco.editor.setTheme("vs-dark")}catch(n){c.monaco.editor.setTheme("vs-light"),setTimeout(()=>{c.monaco.editor.setTheme("hc-black")},50),console.error(n)}}async function M(e){if(!c||!c.monaco)return[{messageText:"Error with the error checking. Try to reload!"}];const{monaco:o}=c,{sha256:r}=await import(`https://unpkg.com/@zedvision/shadb@${a.shadb}/src/sha256.js`),s=`file:///${await r(e)}.tsx`,i=o.Uri.parse(s),d=o.editor.getModel(i)||await o.editor.createModel(e,"typescript",i),w=await(await o.languages.typescript.getTypeScriptWorker())(d.uri),g=w.getSemanticDiagnostics(s),y=w.getCompilerOptionsDiagnostics(s),B=w.getSyntacticDiagnostics(s),D=await Promise.race([g,y,B]);return d.dispose(),[...D]}async function f(e,o){t.html="",t.transpiled="";let r=!1;if(typeof e!="string"||e==="")return r=!0,r;const n=p==="window"?e.replace("body{","#zbody{"):e,s=window.document.createElement("div");if(t.i>o)return!1;const i=w(n),d=(await import(i)).default;URL.revokeObjectURL(i),t.unmount(),t.unmount=j(d(),s);const l=window.document.getElementById("zbody");return l&&l.children[0].replaceWith(s),t.div=s,t.html=s.innerHTML,t.transpiled=e,!t.html;function w(g){const y=new Blob([g],{type:"application/javascript"});return URL.createObjectURL(y)}}}
