import{renderPreviewWindow as L}from"./renderPreviewWindow.js";import{sendSignalToQrCode as M}from"./sendSignalToQrCode.js";import{v as d}from"./versions.js";import{getCodeToLoad as O,saveCode as B}from"./data.js";import{transpileCode as h}from"./transpile.js";function D(){return{i:0,unmount:()=>{},hydrated:!1,preRendered:!1,lastErrors:0,rootElement:null,div:window.document.createElement("div"),html:"",versions:{},ipfs:0,transpiled:"",code:""}}export async function run(p="window",v,w=""){await M();const{formatter:u}=await import("./formatter.js");if(p==="window"){const{openWindows:e}=await import("./openWindows.js");await e(d)}const{open:E}=v,t=D();if(t.code=w?await u(w):"",!w)try{const{code:e,transpiled:o,html:s,versions:r}=await O();t.code=e,t.transpiled=await h(e)||o,t.div.innerHTML=s,t.versions=r?JSON.parse(r):Object.assign({},d)}catch(e){console.error({e,message:"couldn't start"});return}if(t.versions=t.versions||Object.assign({},d),t.transpiled===""){const e=await h(t.code);console.log(e),t.transpiled=e}const{renderEmotion:y,jsx:b,DraggableWindow:T}=await import(d.emotionRenderer);await L(p,t,E,y,b,T),await f(t.transpiled,t.i);const j=(await import(d.editor)).default,C=window.document.getElementById("editor"),a=await j({language:"typescript",container:C,code:t.code,onChange:e=>k(e)});async function k(e){t.i++;const o=t.i,s=await u(e);try{const r=await h(s);let n=!1;if(r.length&&t.lastErrors<2){if(o<t.i)return;n=await f(r,o)}if(t.i>o)return;const i=await S(s);if(t.i>o)return;if(n&&i.push({messageText:"Error while starting the app. Check the console!"}),i.length&&console.log({err:i}),t.lastErrors&&i.length===0&&f(r,o),t.lastErrors=i.length,i.length===0&&r.length){if(t.i>o||(t.code=await u(s),t.i>o))return;B(t,o)}else{if(t.i>o)return;const{diff:c}=await import(`https://unpkg.com/@zedvision/shadb@${d.shadb}/src/diff.js`),l=await c(t.code,s);if(l.c.length<=3){t.lastErrors=0;return}if(l.c.length==4){t.lastErrors=0,a.monaco.editor.setTheme("hc-black");return}console.error(i[0].messageText.toString());return}a.monaco.editor.setTheme("vs-dark")}catch(r){a.monaco.editor.setTheme("vs-light"),setTimeout(()=>{a.monaco.editor.setTheme("hc-black")},50),console.error(r)}}async function S(e){if(!a||!a.monaco)return[{messageText:"Error with the error checking. Try to reload!"}];const{monaco:o}=a,{sha256:s}=await import(`https://unpkg.com/@zedvision/shadb@${d.shadb}/src/sha256.js`),n=`file:///${await s(e)}.tsx`,i=o.Uri.parse(n),c=o.editor.getModel(i)||await o.editor.createModel(e,"typescript",i),m=await(await o.languages.typescript.getTypeScriptWorker())(c.uri),g=m.getSemanticDiagnostics(n),x=m.getCompilerOptionsDiagnostics(n),W=m.getSyntacticDiagnostics(n),z=await Promise.race([g,x,W]);return c.dispose(),[...z]}async function f(e,o){t.html="",t.transpiled="";let s=!1;if(typeof e!="string"||e==="")return s=!0,s;const r=p==="window"?e.replace("body{","#zbody{"):e,n=window.document.createElement("div");if(t.i>o)return!1;const i=(await import(l(r))).default;t.unmount(),t.unmount=y(i(),n);const c=window.document.getElementById("zbody");return c&&c.children[0].replaceWith(n),t.div=n,t.html=n.innerHTML,t.transpiled=e,!t.html;function l(m){const g=new Blob([m],{type:"application/javascript"});return URL.createObjectURL(g)}}}
