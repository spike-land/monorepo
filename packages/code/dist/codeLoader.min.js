import{importScript as w}from"../dist/importScript.js";import{starter as f}from"./starterNoFramerMotion.js";const e={hydrated:!1,preRendered:!1,lastErrors:0,transpiled:"",code:""};function y(c){try{return window.prettier.format(c,{arrowParens:"always",bracketSpacing:!0,embeddedLanguageFormatting:"auto",htmlWhitespaceSensitivity:"css",insertPragma:!1,jsxBracketSameLine:!0,jsxSingleQuote:!1,printWidth:80,proseWrap:"preserve",quoteProps:"as-needed",requirePragma:!1,semi:!0,singleQuote:!0,tabWidth:2,trailingComma:"all",useTabs:!1,parser:"babel-ts",plugins:window.prettierPlugins})}catch{return c}}export async function run(c="window"){const{transpileCode:j}=await import("./transpile.js");if(await w("https://unpkg.com/prettier@2.2.1/standalone.js"),await w("https://unpkg.com/prettier@2.2.1/parser-babel.js"),await w("https://unpkg.com/prettier@2.2.1/parser-html.js"),e.code=y(await M()),e.transpiled=await j(e.code),c==="editor"){const{renderDraggableEditor:t}=await import("./DraggableEditor.js");await t()}if(c==="window"){const{renderDraggableWindow:t}=await import("./DraggableWindow.js"),{shareItAsHtml:r}=await import("./share.js");await t({onShare:async()=>{const n=await r({code:e.transpiled});window.open(n)}})}const{getDB:v}=await import("../dist/shaDB.min.js"),{getUserId:P,getProjects:R,saveCode:b}=await import("./data.js"),T=await j(e.code);E(T);const{startMonaco:S}=await import("../dist/editor.min.js"),s=await S({language:"typescript",code:y(e.code),onChange:t=>k(y(t))});async function k(t){try{const r=await j(t,e.lastErrors);if(e.transpiled===r)return;let n=!1;r.length&&e.lastErrors===0&&(n=E(r));const a=[...n?[{messageText:"Error while starting the app. Check the console!"}]:[],...await C(t)];e.lastErrors&&a.length===0&&E(r),e.lastErrors=a.length;const o=window.document.getElementById("error");if(a.length===0&&r.length)e.code=t,e.transpiled!==r&&(e.transpiled=r,await b(y(t),e.transpiled)),await b(t);else{e.error=t;const{diff:l}=await import("../dist/diff.min.js"),i=await l(e.code,t);if(i.c.length<=3){e.lastErrors=0;return}if(i.c.length==4){e.lastErrors=0,s.monaco.editor.setTheme("hc-black");return}o.innerHTML=a[0].messageText.toString(),o.style.display="block";return}o.style.display="none",s.monaco.editor.setTheme("vs-dark")}catch(r){s.monaco.editor.setTheme("vs-light"),setTimeout(()=>{s.monaco.editor.setTheme("hc-black")},50),console.error(r)}}async function C(t){if(!s||!s.monaco)return;const{monaco:r}=s,{sha256:n}=await import("./sha256.js"),a=await n(t),o=`file:///${a}.tsx`,l=r.Uri.parse(o),i=r.editor.getModel(l)||await r.editor.createModel(t,"typescript",l),u=await r.languages.typescript.getTypeScriptWorker(),m=await u(i.uri),d=m.getSemanticDiagnostics(o),p=m.getCompilerOptionsDiagnostics(o),g=m.getSyntacticDiagnostics(o),h=await Promise.race([d,p,g]);return i.dispose(),[...h]}await w("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js");function E(t){if(typeof t!="string"||t==="")return 1;const r=c==="window"?t.replace("body{","#zroot{"):t;if(e.hydrated)try{const a=window.document.getElementById("zbody"),o=a.innerHTML;o.length>0&&(ReactDOM.unmountComponentAtNode(e.hydrated),e.hydrated=!1,a.innerHTML=o)}catch(a){console.error("Error in un-mount",a)}const n=new Function("importScript","session",`return function(){  
          let DefaultElement;


          try{
                ${r}

                const innerHTML = ReactDOMServer.renderToString(jsx(DefaultElement));

                session.preRendered = DefaultElement;

                const root = document.createElement("div");
                root.innerHTML = innerHTML;
                
                if(document.getElementById("zbody").children.length) {
                  document.getElementById("zbody").children[0].remove();
                }
      
                document.getElementById("zbody").appendChild(root);

                setTimeout(async()=>{
                  if (session.preRendered === DefaultElement){
                    session.hydrated = root;
                    ReactDOM.hydrate(jsx(DefaultElement), root);
                  }
                }, 500);

          } catch (e) {
            if (session.lastError!==0) console.error({e});
            session.preRendered=false;
          }

         
      }`)(w,e);return n(),!e.preRendered}async function M(){const{getUserId:t,getProjects:r,saveCode:n}=await import("./data.js"),{getDB:a}=await import("../dist/shaDB.min.js"),o=await a(),l=await t(),i=await r(),u=i[0],m=new URLSearchParams(window.location.search),d=m.get("h")||await o.get(u);if(d){let p;try{p=await o.get(d)}catch{console.error("error load key: "+d)}if(p)return p;let g;try{const h=await fetch("https://code.zed.vision/?h="+d);g=await h.json()}catch(h){const{sha256:L}=await import("./sha256.js"),D=await L(f);return o.put(D,f),await o.put(u,D),f}return g}return f}function x(t,r){const n=new URLSearchParams(window.location.search);n.set(t,r),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${n}`))}}
