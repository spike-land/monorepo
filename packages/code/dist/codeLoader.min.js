import{renderPreviewWindow as x}from"./renderPreviewWindow.js";import{sendSignalToQrCode as S}from"./sendSignalToQrCode.js";import{v as l}from"./versions.js";import{getCodeToLoad as W,saveCode as z}from"./data.js";export async function transpile(s){const{transpileCode:p}=await import("./transpile.js");return p(s,!1)}function B(){return{unmount:()=>{},hydrated:!1,preRendered:!1,lastErrors:0,rootElement:null,div:window.document.createElement("div"),HTML:"",devtoolHash:"",ipfs:0,transpiled:"",code:""}}export async function run(s="window",p,u=""){await S();const{formatter:f}=await import("./formatter.js");if(s==="window"){const{openWindows:e}=await import("./openWindows.js");await e(l)}const{open:v}=p,t=B();if(t.code=u,!u)try{const{code:e,transpiled:r,html:o,versions:a}=await W();t.code=e,t.transpiled=await transpile(e)||r,t.div.innerHTML=o}catch(e){console.error({e,message:"couldn't start"});return}t.transpiled=t.transpiled||await transpile(t.code);const{renderEmotion:g,jsx:T,DraggableWindow:E}=await import(l.emotionRenderer);await x(s,t,v,l,g,T,E),await D(h,t);const b=(await import(l.editor)).default,w=window.document.getElementById("editor");s==="preview"&&(w==null||(w.style.height="70vh"));const i=await b({language:"typescript",container:w,code:t.code,onChange:e=>j(e)});async function j(e){const r=await f(e);try{const o=await transpile(r);if(t.transpiled===o&&o!=="")return;let a=!1;o.length&&t.lastErrors===0&&(a=await h(o));const n=await C(r);if(a&&n.push({messageText:"Error while starting the app. Check the console!"}),n.length&&console.log({err:n}),t.lastErrors&&n.length===0&&h(o),t.lastErrors=n.length,n.length===0&&o.length)t.code=await f(r),t.transpiled!==o&&(t.transpiled=o,z({code:t.code,transpiled:t.transpiled,html:t.HTML,versions:t.devtoolHash}));else{const{diff:c}=await import(`https://unpkg.com/@zedvision/shadb@${l.shadb}/src/diff.js`),d=await c(t.code,r);if(d.c.length<=3){t.lastErrors=0;return}if(d.c.length==4){t.lastErrors=0,i.monaco.editor.setTheme("hc-black");return}console.error(n[0].messageText.toString());return}i.monaco.editor.setTheme("vs-dark")}catch(o){i.monaco.editor.setTheme("vs-light"),setTimeout(()=>{i.monaco.editor.setTheme("hc-black")},50),console.error(o)}}async function C(e){if(!i||!i.monaco)return[{messageText:"Error with the error checking. Try to reload!"}];const{monaco:r}=i,{sha256:o}=await import(`https://unpkg.com/@zedvision/shadb@${l.shadb}/src/sha256.js`),n=`file:///${await o(e)}.tsx`,c=r.Uri.parse(n),d=r.editor.getModel(c)||await r.editor.createModel(e,"typescript",c),m=await(await r.languages.typescript.getTypeScriptWorker())(d.uri),k=m.getSemanticDiagnostics(n),H=m.getCompilerOptionsDiagnostics(n),L=m.getSyntacticDiagnostics(n),M=await Promise.race([k,H,L]);return d.dispose(),[...M]}async function h(e){t.HTML="";let r=!1;if(typeof e!="string"||e==="")return r=!0,r;const o=s==="window"?e.replace("body{","#zbody{"):e,a=window.document.createElement("div"),n=(await import(d(o))).default;t.unmount(),t.unmount=g(n(),a);const c=window.document.getElementById("zbody");return c&&c.children[0].replaceWith(a),t.HTML=t.div.innerHTML,!!t.HTML;function d(y){const m=new Blob([y],{type:"application/javascript"});return URL.createObjectURL(m)}}}async function D(s,p){await s(p.transpiled)}
