const x=async l=>p.querySelector(`script[src="${l}"]`)||new Promise(function(d,a){const n=window.document.createElement("script");n.src=l,n.onload=d,n.onerror=a,window.document.head.appendChild(n)}),C=async()=>(await x("https://unpkg.com/jsframe.js@1.6.2/lib/jsframe.min.js"),new Promise(l=>{setTimeout(()=>{const d=window.JSFrame,a=new d({horizontalAlign:"left",verticalAlign:"top"}),n=a.create({name:"Win2",title:"Z",left:(window.innerWidth-window.innerWidth*.7)/2,top:20,width:window.innerWidth*.7,height:320,minWidth:300,minHeight:200,appearanceName:"material",appearanceParam:{border:{shadow:"2px 2px 10px  rgba(0, 0, 0, 0.5)",width:0,radius:6},titleBar:{color:"white",background:"#b22",leftMargin:40,height:30,fontSize:20,buttonWidth:36,buttonHeight:16,buttonColor:"white",fontWeight:"bolder",buttons:[{fa:"fas fa-times",name:"closeButton",visible:!0},{fa:"fas fa-expand-arrows-alt",name:"maximizeButton",visible:!0},{fa:"fas fa-compress-arrows-alt",name:"minimizedButton",visible:!1}],buttonsOnLeft:[{fa:"fas fa-bars",name:"menu",visible:!0,childMenuHTML:'<div class="list-group">  <div name="menu1" class="list-group-item list-group-item-action py-2">Menu Item 01</div>  <div name="menu2" class="list-group-item list-group-item-action py-2">Menu Item 02</div>  <div name="menu3" class="list-group-item list-group-item-action py-2">Menu Item 03</div></div>',childMenuWidth:300}]}},style:{backgroundColor:"rgba(198,198,198,0.8)",fontSize:"1rem",overflow:"hidden",width:"100%"},html:'<div id="root"></div>'}).show();n.setControl({maximizeButton:"maximizeButton",demaximizeButton:"restoreButton",minimizeButton:"minimizeButton",deminimizeButton:"deminimizeButton",hideButton:"closeButton",animation:!0,animationDuration:150,maximizeWithoutTitleBar:!0,restoreKey:"Escape"}),n.control.on("hid",(r,e)=>{r.closeFrame()}),n.control.on("maximized",(r,e)=>{a.showToast({text:'Press "ESC" to minimize.',align:"center"})}),n.control.on("demaximized",(r,e)=>{}),n.on("menu","click",(r,e,m)=>{const o=e.target.getAttribute("name");o&&o.startsWith("menu")&&alert(o+" clicked")}),l()})})),T=async({onChange:l,code:d,language:a})=>{const n=window.document.getElementById("container");if(!n){const s=p.getElementById("container");s.id="container",p.body.appendChild(s)}const r=a==="typescript"?"file:///main.tsx":"file:///main.html";let e;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)){const s=window.document.createElement("div");s.id="ace",window.document.body.appendChild(s),await f("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"),a==="typescript"?await f("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-typescript.min.js"):await f("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-html.min.js"),await f("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.js"),window.document.getElementById("ace").style.setProperty("display","block"),n.style.setProperty("display","none"),e=window.ace.edit("ace"),e.getSession().setMode("ace/mode/typescript");const t=c=>setTimeout(()=>{let i=window.ace.edit("ace"),u=i.getTheme();u!=="ace/theme/monokai "&&(i.setOptions({fontSize:"14pt"}),i.setTheme("ace/theme/monokai"),t(2*c))},c);t(100),e.setValue(d),e.blur()}if(window.monaco===void 0){const s="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs",{require:t}=await f("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs/loader.min.js");t.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs"}}),await new Promise(c=>t(["vs/editor/editor.main"],i=>{c(i)}))}const m=window.monaco,o={monaco:m,editor:m.editor.create(window.document.getElementById("container"),{formatOnType:!0,scrollbar:{horizontal:"hidden",verticalHasArrows:!0,verticalScrollbarSize:20},minimap:{enabled:!1},folding:!1,multiCursorModifier:"alt",wordWrap:"on",wordWrapBreakAfterCharacters:">([{]))],;}",mouseWheelZoom:!1,wordWrapColumn:80,automaticLayout:!0,scrollBeyondLastLine:!1,autoIndent:"brackets",autoClosingQuotes:"always",padding:{bottom:300},lineNumbers:"on",autoClosingBrackets:"always",autoClosingOvertype:"always",suggest:{},codeLens:!0,autoSurround:"languageDefined",trimAutoWhitespace:!0,codeActionsOnSaveTimeout:100,model:m.editor.getModel(r)||m.editor.createModel(d,a,m.Uri.parse(r)),value:d,language:a,theme:"vs-dark"})};if(o.editor.onDidChangeModelContent(()=>l(o.editor.getValue())),e&&e.session.on("change",function(){const s=e.getValue();o.editor.setValue(s),l(s)}),e&&p.getElementById("container").replaceWith(p.getElementById("ace")),o.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!0,noSemanticValidation:!0,noSyntaxValidation:!0}),a==="typescript"){const s=[{name:"react",url:"https://unpkg.com/@types/react@16.9.56/index.d.ts",depend:["global","csstype","react-dom","prop-types"]},{name:"global",url:"https://unpkg.com/@types/react@16.9.56/global.d.ts",depend:[]},{name:"prop-types",url:"https://unpkg.com/@types/prop-types@15.7.3/index.d.ts",depend:[]},{name:"react-dom",url:"https://unpkg.com/@types/react-dom@16.9.9/index.d.ts",depend:[]},{name:"csstype",url:"https://unpkg.com/csstype@3.0.5/index.d.ts",depend:[]},{name:"@emotion/styled/base.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/base.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/styled/index.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/index.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/cache/index.d.ts",url:"https://unpkg.com/@emotion/cache@11.0.0/types/index.d.ts",depend:["@emotion/utils"]},{name:"@emotion/react/index.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/index.d.ts",depend:["@emotion/cache"]},{name:"@emotion/react/jsx-namespace.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/jsx-namespace.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/css-prop.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/css-prop.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/helper.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/helper.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/theming.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/theming.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/serialize/index.d.ts",url:"https://unpkg.com/@emotion/serialize@1.0.0/types/index.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/utils/index.d.ts",url:"https://unpkg.com/@emotion/utils@1.0.0/types/index.d.ts",depend:[]}],t=s.map(({name:c,url:i})=>(async()=>o.monaco.languages.typescript.typescriptDefaults.addExtraLib(await(await fetch(i)).text(),c.includes("@emotion")?`file:///node_modules/${c}`:`file:///node_modules/@types/${c}/index.d.ts`))());return o.monaco.languages.typescript.typescriptDefaults.setCompilerOptions({target:o.monaco.languages.typescript.ScriptTarget.ESNext,allowNonTsExtensions:!0,allowUmdGlobalAccess:!0,strict:!0,allowJs:!0,noEmitOnError:!0,allowSyntheticDefaultImports:!0,moduleResolution:o.monaco.languages.typescript.ModuleResolutionKind.NodeJs,module:o.monaco.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"],jsx:o.monaco.languages.typescript.JsxEmit.React,jsxFactory:"React.createElement",jsxFragmentFactory:"React.Fragment",esModuleInterop:!0}),await Promise.all(t),o.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!1,noSemanticValidation:!1,noSyntaxValidation:!1}),o}};function f(l){return new Promise(function(d,a){var n;n=window.document.createElement("script"),n.src=l,n.onload=()=>d(window),n.onerror=a,window.document.head.appendChild(n)})}const E=`import React from "react";
import ReactDOM from "react-dom";
/** @jsx jsx */
import styled from "@emotion/styled";

const Counter = () => {
  const [clicks, setClicks] = React.useState(0);

  return <Container>
    <Button css={\`background: green\`} onClick={() => setClicks(clicks - 1)}>
      -
    </Button>
    {clicks}
    <Button css={\`background: red\`} onClick={() => setClicks(clicks + 1)}>
      +
    </Button>
  </Container>;
};

const Container = styled.div\`
  margin: 2em;
  display: inline-block;
  min-width: 200px;
  background: white;
  border: 4px dotted red;
  border-radius: 30px;
  padding: 1rem;
\`;

const Button = styled.button\`
  text-align: center;
  display: inline-block;
  border-radius: 6px;
  padding: 0.5rem 0;
  margin: 0.5rem 2rem;
  width: 4rem;
  color: white;
  border: none;
  :focus{
    outline: none;
  }
  \`;

const elementToRender = document.getElementById("root");
ReactDOM.render(<Counter />, elementToRender);

`,p=window.document;let k=!0,y=0,S=0,g="",v="",B="",w="";export async function run(){const l=x("https://unpkg.com/@ampproject/worker-dom@0.27.3/dist/main.js");await C(),await x("https://unpkg.com/@babel/standalone@7.12.6/babel.min.js"),(async()=>{const r=a();w=r;const e=await T({language:"typescript",code:r,onChange:m});function m(t){if(!e)return;if(g=t,!y)s(g);else{const c=t,i=setInterval(()=>{(t!==g||!y)&&clearInterval(i),y||s(g)},100)}}async function o(){if(!e||!e.monaco)return;const t=e.monaco.Uri.parse("file:///main.tsx"),c=await e.monaco.languages.typescript.getTypeScriptWorker(),i=await(await c(t)).getSemanticDiagnostics("file:///main.tsx"),u=await(await c(t)).getCompilerOptionsDiagnostics("file:///main.tsx"),h=await(await c(t)).getSyntacticDiagnostics("file:///main.tsx");return[...i,...u,...h]}async function s(t){const{diff:c}=await import("../dist/diff.min.js");if(y===1)return;try{y=1;const i=await o(),u=p.getElementById("error");if(y=0,t!==g)return;if(i&&i.length){if(g!=t)return;if(v===t)return;p.getElementById("root").classList.add("transparent");const h=c(w,t,0);if(h.length<=3){e.monaco.editor.setTheme("hc-black");return}u.innerHTML=i[0].messageText.toString(),p.getElementById("root").style.setProperty("dispay","none"),u.style.display="block",v=t,e.monaco.editor.setTheme("vs-light"),setTimeout(()=>{e.monaco.editor.setTheme("hc-black")},S++);return}w=t,u.style.display="none",e.monaco.editor.setTheme("vs-dark"),p.getElementById("root").classList.remove("transparent"),S=0,y=0,d(n(t))}catch(i){if(y=0,t!==g)return;e.monaco.editor.setTheme("vs-light"),setTimeout(()=>{e.monaco.editor.setTheme("hc-black")},10),console.error(i)}}})(),d(n(a())),p.getElementById("root").setAttribute("style","display:block"),await l;async function d(r){const e=new Function("transpileCode",`return function(){ 
        ${r} 
    }`)();if(!k){const m=async s=>{if(s!==w)return;if(B===s)return;B=s;const t={codeTranspiled:r,code:w},c=JSON.stringify(t),i=new Request("https://code.zed.vision",{body:c,method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}}),u=await fetch(i),{hash:h}=await u.json();try{const b=window.localStorage,j=b.getItem("codeBoXHash");j!==h&&(b.setItem("codeBoXHash",h),b.setItem(h,w),I("h",h))}catch(b){console.log("no localStorage")}},o=g;setTimeout(()=>m(g),500)}k=!1,e()}function a(){const r=new URLSearchParams(window.location.search),e=r.get("h")||localStorage.getItem("codeBoXHash");return e&&window.localStorage.getItem(e)||window.localStorage.getItem("STARTER")||E}function n(r){return window.Babel.transform(r,{plugins:[],presets:["react",["typescript",{isTSX:!0,allExtensions:!0}]]}).code.replace(/import/gi,"///")}}function I(l,d){const a=new URLSearchParams(window.location.search);a.set(l,d),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${a}`))}
