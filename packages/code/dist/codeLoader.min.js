import{importScript as w}from"../dist/importScript.js";import{starter as y}from"./starterNoFramerMotion.js";const n={hydrated:!1,preRendered:!1,transpiled:"",code:""};function S(d){return window.prettier.format(d,{arrowParens:"always",bracketSpacing:!0,embeddedLanguageFormatting:"auto",htmlWhitespaceSensitivity:"css",insertPragma:!1,jsxBracketSameLine:!0,jsxSingleQuote:!1,printWidth:80,proseWrap:"preserve",quoteProps:"as-needed",requirePragma:!1,semi:!0,singleQuote:!0,tabWidth:2,trailingComma:"all",useTabs:!1,parser:"babel-ts",plugins:window.prettierPlugins})}export async function run(d="window"){const{transpileCode:u}=await import("./transpile.js");if(n.code=await v(),d==="editor"){const{renderDraggableEditor:t}=await import("./DraggableEditor.js");await t()}if(d==="window"){const{renderDraggableWindow:t}=await import("./DraggableWindow.js"),{shareItAsHtml:e}=await import("./share.js");await t({onShare:async()=>{const a=await e({code:await u(n.code)});window.open(a)}})}const{getDB:R}=await import("../dist/shaDB.min.js"),{getUserId:B,getProjects:P,saveCode:D}=await import("./data.js"),T=await u(n.code);b(T);const{startMonaco:k}=await import("../dist/editor.min.js");let j=0;await w("https://unpkg.com/prettier@2.2.1/standalone.js"),await w("https://unpkg.com/prettier@2.2.1/parser-babel.js"),await w("https://unpkg.com/prettier@2.2.1/parser-html.js");const s=await k({language:"typescript",code:S(n.code),onChange:C});async function C(t){try{const e=await u(t);let a=!1;e.length&&j===0&&(a=b(e));const o=[...a?[a]:[],...await M(t)];j&&o.length===0&&b(e),j=o.length;const r=window.document.getElementById("error");if(o.length===0&&e.length)n.code=t,n.transPiled!==e&&(n.transPiled=e,await D(S(t),u)),await D(t);else{n.error=t;const{diff:l}=await import("../dist/diff.min.js"),i=await l(n.code,t);if(i.c.length<=3){s.monaco.editor.setTheme("hc-black");return}r.innerHTML=o[0].messageText.toString(),r.style.display="block";return}r.style.display="none",s.monaco.editor.setTheme("vs-dark")}catch(e){s.monaco.editor.setTheme("vs-light"),setTimeout(()=>{s.monaco.editor.setTheme("hc-black")},50),console.error(e)}}async function M(t){if(!s||!s.monaco)return;const{monaco:e}=s,{sha256:a}=await import("./sha256.js"),o=await a(t),r=`file:///${o}.tsx`,l=e.Uri.parse(r),i=e.editor.getModel(l)||await e.editor.createModel(t,"typescript",l),g=await e.languages.typescript.getTypeScriptWorker(),m=await g(i.uri),c=m.getSemanticDiagnostics(r),p=m.getCompilerOptionsDiagnostics(r),h=m.getSyntacticDiagnostics(r),f=await Promise.race([c,p,h]);return i.dispose(),[...f]}await w("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js");function b(t){if(typeof t!="string"||t==="")return 1;const e=d==="window"?t.replace("body{","#zroot{"):t;if(n.hydrated)try{const o=window.document.getElementById("zbody"),r=o.innerHTML;r.length>0&&(ReactDOM.unmountComponentAtNode(o),n.hydrated=!1,o.innerHTML=r)}catch(o){console.error("Error in un-mount",o)}const a=new Function("importScript","session",`return function(){  
          let DefaultElement;
          const root = document.createElement("div");

          try{
                ${e}

                root.innerHTML = ReactDOMServer.renderToString(jsx(DefaultElement));

                session.preRendered = DefaultElement;

                setTimeout(async()=>{
                  if (session.preRendered === DefaultElement){
                    session.hydrated = DefaultElement;
                    ReactDOM.hydrate(jsx(DefaultElement), root);
                  }
                }, 500);

          } catch (e) {
            console.error({e});
            session.preRendered=false;
            root.innerHTML = e.message;
          }

          if(document.getElementById("zbody").children.length) {
            document.getElementById("zbody").children[0].remove();
          }
          
          document.getElementById("zbody").appendChild(root);
      }`)(w,n);return a(),!n.preRendered}async function v(){const{getUserId:t,getProjects:e,saveCode:a}=await import("./data.js"),{getDB:o}=await import("../dist/shaDB.min.js"),r=await o(),l=await t(),i=await e(),g=i[0],m=new URLSearchParams(window.location.search),c=m.get("h")||await r.get(g);if(c){let p;try{p=await r.get(c)}catch{console.error("error load key: "+c)}if(p)return p;let h;try{const f=await fetch("https://code.zed.vision/?h="+c);h=await f.json()}catch(f){const{sha256:L}=await import("./sha256.js"),E=await L(y);return r.put(E,y),await r.put(g,E),y}return h}return y}function x(t,e){const a=new URLSearchParams(window.location.search);a.set(t,e),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${a}`))}}
