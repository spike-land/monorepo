const C=async r=>new Promise(c=>{const o=window.JSFrame,e=new o({horizontalAlign:"left",verticalAlign:"top"}),l=e.create({name:"Win2",title:"Z",left:(window.innerWidth-window.innerWidth*.7)/2,top:20,width:window.innerWidth*.7,height:320,minWidth:300,minHeight:200,appearanceName:"material",appearanceParam:{border:{shadow:"2px 2px 10px  rgba(0, 0, 0, 0.5)",width:0,radius:6},titleBar:{color:"white",background:"#b22",leftMargin:40,height:30,fontSize:20,buttonWidth:36,buttonHeight:16,buttonColor:"white",fontWeight:"bolder",buttons:[{fa:"fas fa-times",name:"closeButton",visible:!0},{fa:"fas fa-expand-arrows-alt",name:"maximizeButton",visible:!0},{fa:"fas fa-compress-arrows-alt",name:"minimizedButton",visible:!1}],buttonsOnLeft:[{fa:"fas fa-bars",name:"menu",visible:!0,childMenuHTML:'<div class="list-group">  <div name="menu1" class="list-group-item list-group-item-action py-2">Menu Item 01</div>  <div name="menu2" class="list-group-item list-group-item-action py-2">Menu Item 02</div>  <div name="menu3" class="list-group-item list-group-item-action py-2">Menu Item 03</div></div>',childMenuWidth:300}]}},style:{overflowY:"scroll",width:"100%"},url:r}).show();l.setControl({maximizeButton:"maximizeButton",demaximizeButton:"restoreButton",minimizeButton:"minimizeButton",deminimizeButton:"deminimizeButton",hideButton:"closeButton",animation:!0,animationDuration:150,maximizeWithoutTitleBar:!0,restoreKey:"Escape"}),l.control.on("hid",(i,m)=>{i.closeFrame()}),l.control.on("maximized",(i,m)=>{e.showToast({text:'Press "ESC" to minimize.',align:"center"})}),l.control.on("demaximized",(i,m)=>{}),l.on("menu","click",(i,m,t)=>{const n=m.target.getAttribute("name");n&&n.startsWith("menu")&&alert(n+" clicked")}),c()}),z=async({onChange:r,code:c,language:o})=>{const e=window.document.getElementById("container");if(!e){const n=p.getElementById("container");n.id="container",p.body.appendChild(n)}const l=o==="typescript"?"https://zed.vision/code/?h=main.tsx":"https://zed.vision/code/?h=main.tsxmain.html";let i;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)){const n=window.document.createElement("div");n.id="ace",window.document.body.appendChild(n),await x("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"),o==="typescript"?await x("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-typescript.min.js"):await x("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-html.min.js"),await x("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.js"),window.document.getElementById("ace").style.setProperty("display","block"),e.style.setProperty("display","none"),i=window.ace.edit("ace"),i.getSession().setMode("ace/mode/typescript");const s=a=>setTimeout(()=>{let d=window.ace.edit("ace"),b=d.getTheme();b!=="ace/theme/monokai "&&(d.setOptions({fontSize:"14pt"}),d.setTheme("ace/theme/monokai"),s(2*a))},a);s(100),i.setValue(c),i.blur()}if(window.monaco===void 0){const n="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs",{require:s}=await x("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs/loader.min.js");s.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs"}}),await new Promise(a=>s(["vs/editor/editor.main"],d=>{a(d)}))}const m=window.monaco,t={monaco:m,editor:m.editor.create(window.document.getElementById("container"),{formatOnType:!0,scrollbar:{horizontal:"hidden",verticalHasArrows:!0,verticalScrollbarSize:20},minimap:{enabled:!1},folding:!1,multiCursorModifier:"alt",wordWrap:"on",wordWrapBreakAfterCharacters:">([{]))],;}",mouseWheelZoom:!1,wordWrapColumn:80,automaticLayout:!0,scrollBeyondLastLine:!1,autoIndent:"brackets",autoClosingQuotes:"always",padding:{bottom:300},lineNumbers:"on",autoClosingBrackets:"always",autoClosingOvertype:"always",suggest:{},codeLens:!0,autoSurround:"languageDefined",trimAutoWhitespace:!0,codeActionsOnSaveTimeout:100,model:m.editor.getModel(l)||m.editor.createModel(c,o,m.Uri.parse(l)),value:c,language:o,theme:"vs-dark"})};if(t.editor.onDidChangeModelContent(()=>r(t.editor.getValue())),i&&i.session.on("change",function(){const n=i.getValue();t.editor.setValue(n),r(n)}),i&&p.getElementById("container").replaceWith(p.getElementById("ace")),t.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!0,noSemanticValidation:!0,noSyntaxValidation:!0}),o==="typescript"){const n=[{name:"react",url:"https://unpkg.com/@types/react@17.0.0/index.d.ts",depend:["global","csstype","react-dom","prop-types"]},{name:"global",url:"https://unpkg.com/@types/react@17.0.0/global.d.ts",depend:[]},{name:"prop-types",url:"https://unpkg.com/@types/prop-types@15.7.3/index.d.ts",depend:[]},{name:"react-dom",url:"https://unpkg.com/@types/react-dom@17.0.0/index.d.ts",depend:[]},{name:"csstype",url:"https://unpkg.com/csstype@3.0.5/index.d.ts",depend:[]},{name:"@emotion/styled/base.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/base.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/styled/index.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/index.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/cache/index.d.ts",url:"https://unpkg.com/@emotion/cache@11.0.0/types/index.d.ts",depend:["@emotion/utils"]},{name:"@emotion/react/index.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/index.d.ts",depend:["@emotion/cache"]},{name:"@emotion/react/jsx-namespace.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/jsx-namespace.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/css-prop.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/css-prop.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/helper.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/helper.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/theming.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/theming.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/serialize/index.d.ts",url:"https://unpkg.com/@emotion/serialize@1.0.0/types/index.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/utils/index.d.ts",url:"https://unpkg.com/@emotion/utils@1.0.0/types/index.d.ts",depend:[]},{name:"framer-motion",url:"https://unpkg.com/framer-motion@2.9.4/dist/framer-motion.d.ts",depend:[]},{name:"popmotion",url:"https://unpkg.com/browse/popmotion@9.0.0/lib/index.d.ts"}],s=n.map(({name:a,url:d})=>(async()=>t.monaco.languages.typescript.typescriptDefaults.addExtraLib(await(await fetch(d)).text(),a.includes("@emotion")?`file:///node_modules/${a}`:`file:///node_modules/@types/${a}/index.d.ts`))());return t.monaco.languages.typescript.typescriptDefaults.setCompilerOptions({target:t.monaco.languages.typescript.ScriptTarget.ESNext,allowNonTsExtensions:!0,allowUmdGlobalAccess:!0,strict:!0,allowJs:!0,noEmitOnError:!0,allowSyntheticDefaultImports:!0,moduleResolution:t.monaco.languages.typescript.ModuleResolutionKind.Nodejs,module:t.monaco.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"],jsx:t.monaco.languages.typescript.JsxEmit.React,jsxFactory:"React.createElement",jsxFragmentFactory:"React.Fragment",esModuleInterop:!0}),await Promise.all(s),t.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!1,noSemanticValidation:!1,noSyntaxValidation:!1}),t}};function x(r){return new Promise(function(c,o){var e;e=window.document.createElement("script"),e.src=r,e.onload=()=>c(window),e.onerror=o,window.document.head.appendChild(e)})}const D=async r=>p.querySelector(`script[src="${r}"]`)||new Promise(function(c,o){const e=window.document.createElement("script");e.src=r,e.onload=c,e.onerror=o,window.document.head.appendChild(e)}),M=`/** @jsx jsx */

import {
  css, jsx, Global
} from "@emotion/react";

import {motion} from "framer-motion";

const Counter = () => {
  const [clicks, setClicks] = React.useState(0);

  return <>
    <Global styles={css\`
    body{
        margin: 0;
        height: 100vh;
        background: khaki;
      }  
    \`} />
    <motion.div 
        animate={{scale: 1}}
        initial={{scale: 0.7}} 
        transition={{duration: 0.5}} 
        css={\`
        margin: 2rem;
        display: inline-block;
        min-width: 200px;
        background: white;
        border: 4px dotted red;
        border-radius: 30px;
        padding: 2rem;
      \`}>
      <h1>Counter example</h1>
      <button css={buttonStyles("green")} onClick={() => setClicks(clicks - 1)}>
        -
    </button>
      {clicks}
      <button css={buttonStyles("red")} onClick={() => setClicks(clicks + 1)}>
        +
    </button>
    </motion.div>
  </>;
};



const buttonStyles = (color: string) => css\`
  border-radius: 6px;
  padding: 0.5rem 0;
  margin: 0.5rem 2rem;
  width: 4rem;
  background: \${color};
  color: white;
  border: none;
  :focus{
    outline: none;
  }
  \`;

export default Counter;
`,p=window.document;let v=!0,g=0,I=0,y="",j="",B="",w="";export async function run(){await D("https://unpkg.com/@babel/standalone@7.12.7/babel.min.js"),(async()=>{const o=c();w=o;const e=await z({language:"typescript",code:o,onChange:l});function l(t){if(!e)return;if(y=t,!g)m(y);else{const n=t,s=setInterval(()=>{(t!==y||!g)&&clearInterval(s),g||m(y)},100)}}async function i(){if(!e||!e.monaco)return;const t=e.monaco.Uri.parse("https://zed.vision/code/?h=main.tsx"),n=await e.monaco.languages.typescript.getTypeScriptWorker(),s=await(await n(t)).getSemanticDiagnostics("https://zed.vision/code/?h=main.tsx"),a=await(await n(t)).getCompilerOptionsDiagnostics("https://zed.vision/code/?h=main.tsx"),d=await(await n(t)).getSyntacticDiagnostics("https://zed.vision/code/?h=main.tsx");return[...s,...a,...d]}async function m(t){const{diff:n}=await import("../dist/diff.min.js");if(g===1)return;try{g=1;const s=await i(),a=p.getElementById("error");if(g=0,t!==y)return;if(s&&s.length){if(y!=t)return;if(j===t)return;const d=n(w,t,0);if(d.length<=3){e.monaco.editor.setTheme("hc-black");return}a.innerHTML=s[0].messageText.toString(),a.style.display="block",j=t;return}w=t,a.style.display="none",e.monaco.editor.setTheme("vs-dark"),I=0,g=0,r(E(t))}catch(s){if(g=0,t!==y)return;e.monaco.editor.setTheme("vs-light"),setTimeout(()=>{e.monaco.editor.setTheme("hc-black")},50),console.error(s)}}})(),r(E(c()));async function r(o){const e=/import/gi,l="///",i=o.replaceAll(/import/gi,"///").replace("export default","DefaultElement = ").replace('"framer-motion"',`
    const {motion} = Motion;
    `),m=async()=>{const t=new Function("code",`return function(){  
          let DefaultElement;
        
        ${i}

                return ReactDOMServer.renderToString(jsx(DefaultElement));
      }`)(),n=t(),s=Array.from(p.querySelector("head > style[data-emotion=css]").sheet.cssRules).map(h=>h.cssText).filter(h=>n.includes(h.substring(3,8))).join(`
  `);let a;if(i.includes("body{")){const h=i.indexOf("body{"),S=i.slice(h),T=S.indexOf("}");a=S.slice(0,T+1)}let d="",b="";i.includes("Motion")&&(d='<script crossorigin src="https://unpkg.com/framer-motion@2.9.4/dist/framer-motion.js"></script>',b="const {motion} = Motion");const f=`<!DOCTYPE html>
      <html lang="en">
      <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <style>
      ${a}
      ${s}
      </style>
      </head>
      <body>
      <div id="root">
      ${n}
      </div>
      <script crossorigin src="https://unpkg.com/react@17.0.1/umd/react.production.min.js"></script>
      ${d}
      <script crossorigin src="https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js"></script>
      <script crossorigin src="https://unpkg.com/@emotion/react@11.1.1/dist/emotion-react.umd.min.js"></script>
      <script crossorigin src="https://unpkg.com/@emotion/styled@11.0.0/dist/emotion-styled.umd.min.js"></script>
      <script type="module">
      Object.assign(window, emotionReact);

     const styled = window["emotionStyled"];

      let DefaultElement;
        
      ${i}

      ReactDOM.hydrate(jsx(DefaultElement), document.body.children[0]);
      </script>
      </body>
      </html>
      `,u=await R(f),k=p.getElementsByTagName("iframe").item(0);if(k){const h=p.createElement("iframe");h.setAttribute("src",u),setTimeout(()=>{window.requestAnimationFrame(()=>{k.setAttribute("src",u),h.remove()})})}else await C(u)};if(!v){const t=async n=>{if(!location.origin.includes("zed.vision"))return;if(n!==w)return;if(B===n)return;B=n;const s={codeTranspiled:o,code:w},a=JSON.stringify(s),d=new Request("https://code.zed.vision",{body:a,method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}}),b=await fetch(d),{hash:f}=await b.json();try{const u=window.localStorage,k=u.getItem("codeBoXHash2");k!==f&&(u.setItem("codeBoXHash2",f),u.setItem(f,w),O("h",f))}catch(u){console.log("no localStorage")}};setTimeout(()=>t(y),500)}v=!1,m()}function c(){const o=new URLSearchParams(window.location.search),e=o.get("h")||localStorage.getItem("codeBoXHash2");return e&&window.localStorage.getItem(e)||window.localStorage.getItem("STARTER")||M}}function O(r,c){const o=new URLSearchParams(window.location.search);o.set(r,c),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${o}`))}function R(r){const c=new Blob([r],{type:"text/html"}),o=window.URL.createObjectURL(c);return o}function E(r){const{transform:c}=window.Babel;return c(r,{plugins:[],presets:["react",["typescript",{isTSX:!0,allExtensions:!0}]]}).code}
