import{importScript as w}from"../dist/importScript.js";import{starter as f}from"./starterNoFramerMotion.js";const r={hydrated:!1,preRendered:!1,lastErrors:0,transpiled:"",code:""};function y(c){try{return window.prettier.format(c,{arrowParens:"always",bracketSpacing:!0,embeddedLanguageFormatting:"auto",htmlWhitespaceSensitivity:"css",insertPragma:!1,jsxBracketSameLine:!0,jsxSingleQuote:!1,printWidth:80,proseWrap:"preserve",quoteProps:"as-needed",requirePragma:!1,semi:!0,singleQuote:!0,tabWidth:2,trailingComma:"all",useTabs:!1,parser:"babel-ts",plugins:window.prettierPlugins})}catch{return c}}export async function run(c="window"){const{transpileCode:j}=await import("./transpile.js");if(await w("https://unpkg.com/prettier@2.2.1/standalone.js"),await w("https://unpkg.com/prettier@2.2.1/parser-babel.js"),await w("https://unpkg.com/prettier@2.2.1/parser-html.js"),r.code=y(await v()),r.transpiled=await j(r.code),c==="editor"){const{renderDraggableEditor:t}=await import("./DraggableEditor.js");await t()}if(c==="window"){const{renderDraggableWindow:t}=await import("./DraggableWindow.js"),{shareItAsHtml:e}=await import("./share.js");await t({onShare:async()=>{const o=await e({code:r.transpiled});window.open(o)}})}const{getDB:x}=await import("../dist/shaDB.min.js"),{getUserId:L,getProjects:M,saveCode:b}=await import("./data.js"),S=await j(r.code);E(S);const{startMonaco:T}=await import("../dist/editor.min.js"),n=await T({language:"typescript",code:y(r.code),onChange:t=>k(y(t))});async function k(t){try{const e=await j(t,r.lastErrors);if(r.transpiled===e)return;let o=!1;e.length&&r.lastErrors===0&&(o=E(e));const s=[...o?[{messageText:"Error while starting the app. Check the console!"}]:[],...await C(t)];r.lastErrors&&s.length===0&&E(e),r.lastErrors=s.length;const a=window.document.getElementById("error");if(s.length===0&&e.length)r.code=t,r.transpiled!==e&&(r.transpiled=e,await b(y(t),r.transpiled)),await b(t);else{r.error=t;const{diff:l}=await import("../dist/diff.min.js"),i=await l(r.code,t);if(i.c.length<=3){r.lastErrors=0;return}if(i.c.length==4){r.lastErrors=0,n.monaco.editor.setTheme("hc-black");return}a.innerHTML=s[0].messageText.toString(),a.style.display="block";return}a.style.display="none",n.monaco.editor.setTheme("vs-dark")}catch(e){n.monaco.editor.setTheme("vs-light"),setTimeout(()=>{n.monaco.editor.setTheme("hc-black")},50),console.error(e)}}async function C(t){if(!n||!n.monaco)return;const{monaco:e}=n,{sha256:o}=await import("./sha256.js"),s=await o(t),a=`file:///${s}.tsx`,l=e.Uri.parse(a),i=e.editor.getModel(l)||await e.editor.createModel(t,"typescript",l),g=await e.languages.typescript.getTypeScriptWorker(),p=await g(i.uri),d=p.getSemanticDiagnostics(a),m=p.getCompilerOptionsDiagnostics(a),u=p.getSyntacticDiagnostics(a),h=await Promise.race([d,m,u]);return i.dispose(),[...h]}await w("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js");function E(t){if(typeof t!="string"||t==="")return 1;const e=c==="window"?t.replace("body{","#zbody{"):t,o=new Function("importScript","session",`return function(){  
          let DefaultElement;


          try{
                ${e}

                const innerHTML = ReactDOMServer.renderToString(jsx(DefaultElement));

                session.preRendered = DefaultElement;

                const root = document.createElement("div");
                root.innerHTML = innerHTML;
                
                if(document.getElementById("zbody").children.length) {
                  document.getElementById("zbody").children[0].remove();
                }
      
                document.getElementById("zbody").appendChild(root);

                setTimeout(async()=>{
                  if (session.preRendered === DefaultElement){
                    session.hydrated = root;
                    ReactDOM.hydrate(jsx(DefaultElement), root);
                  }
                }, 500);

          } catch (e) {
            if (session.lastError!==0) console.error({e});
            session.preRendered=false;
          }

         
      }`)(w,r);return o(),!r.preRendered}async function v(){const{getUserId:t,getProjects:e,saveCode:o}=await import("./data.js"),{getDB:s}=await import("../dist/shaDB.min.js"),a=await s(),l=await t(),i=await e(),g=i[0],p=new URLSearchParams(window.location.search),d=p.get("h")||await a.get(g);if(d){let m;try{m=await a.get(d)}catch{console.error("error load key: "+d)}if(m)return m;let u;try{const h=await fetch("https://code.zed.vision/?h="+d);u=await h.json()}catch(h){const{sha256:P}=await import("./sha256.js"),D=await P(f);return a.put(D,f),await a.put(g,D),f}return u}return f}function R(t,e){const o=new URLSearchParams(window.location.search);o.set(t,e),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${o}`))}}
