import P from"./versions.js";const p=P();async function g(a){const{transpileCode:d}=await import("./transpile.js");return d(a,!1)}const T=`https://unpkg.com/@zedvision/emotion-react-renderer@${p.emotionRenderer}/dist/bundle.js`;function R(){return{unmount:()=>{},hydrated:!1,preRendered:!1,lastErrors:0,rootElement:null,div:window.document.createElement("div"),HTML:"",devtoolHash:"",ipfs:0,transpiled:"",code:""}}async function k(a){const d=(await import(`https://unpkg.com/prettier@${p.prettier}/esm/standalone.mjs`)).default,h=(await import(`https://unpkg.com/prettier@${p.prettier}/esm/parser-babel.mjs`)).default,w=(await import(`https://unpkg.com/prettier@${p.prettier}/esm/parser-html.mjs`)).default;try{return d.format(a,{arrowParens:"always",bracketSpacing:!0,embeddedLanguageFormatting:"auto",htmlWhitespaceSensitivity:"css",insertPragma:!1,jsxBracketSameLine:!0,jsxSingleQuote:!1,printWidth:80,proseWrap:"preserve",quoteProps:"as-needed",requirePragma:!1,semi:!0,singleQuote:!0,tabWidth:2,trailingComma:"all",useTabs:!1,parser:"babel-ts",plugins:[h,w]})}catch(f){return a}}export async function run(a="window",d){const{importScript:h}=await import("./importScript.js"),{WindowManager:w}=await h("https://unpkg.com/simple-window-manager@2.1.2/public/simple-window-manager.min.js"),f=new w.WindowManager({backgroundWindow:"green"});f.snap(!1);const E=f.createWindow({width:720,height:640,style:{backgroundWindow:"#1e1e1e"},title:"React Live Editor"}),v=()=>typeof window=="undefined"?!1:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent),{document:u,open:M}=d;if(E.content.innerHTML=`<div style="min-height: 700px;  min-width: 600px; height: ${v()?"2000px":"100%"}; width:100%; display: block;" id="editor"></div>`,console.log("Runner"),!v())try{const o=u.querySelector("body > div:nth-child(2) > div:nth-child(3) > div:nth-child(1) > section");o!==null&&(o.style.overflow="")}catch(o){console.error({e})}const t=R();try{const{getCodeToLoad:o}=await import("./data.js"),{code:i,transpiled:r,html:s,versions:n}=await o();t.code=i,t.transpiled=r||await g(i),t.div.innerHTML=s}catch(o){console.error({e:o,message:"couldn't start"});return}if(t.transpiled=t.transpiled||await g(t.code),a==="window"){const o=async()=>{const{shareItAsHtml:s}=await import("./share.js"),n=await s({code:t.code,transpiled:t.transpiled,HTML:t.HTML});console.log({link:n}),M(n)},{renderDraggableWindow:i}=await import("./DraggableWindow.js");await i({onShare:o},T);const r=window.document.getElementById("zbody");r!==null&&r.appendChild(t.div),t.HTML&&(t.div.innerHTML=t.HTML)}const{renderEmotion:j}=await import(T),L=await g(t.code);await y(L);const H=(await import(`https://unpkg.com/@zedvision/smart-monaco-editor@${p.editor}/dist/editor.js`)).default,S=u.getElementById("editor"),l=await H({language:"typescript",container:S,code:t.code,onChange:o=>W(o)});async function W(o){const i=await k(o);try{const r=await g(i);if(t.transpiled===r&&r!=="")return;let s=!1;r.length&&t.lastErrors===0&&(s=await y(r));const n=await x(i);if(s&&n.push({messageText:"Error while starting the app. Check the console!"}),n.length&&console.log({err:n}),t.lastErrors&&n.length===0&&y(r),t.lastErrors=n.length,n.length===0&&r.length){if(t.code=await k(i),t.transpiled!==r){t.transpiled=r;const{saveCode:c}=await import("./data.js");await c({code:t.code,transpiled:t.transpiled,html:t.HTML,versions:t.devtoolHash})}}else{const{diff:c}=await import(`https://unpkg.com/@zedvision/diff@${p.diff}/src/diff.js`),m=await c(t.code,i);if(m.c.length<=3){t.lastErrors=0;return}if(m.c.length==4){t.lastErrors=0,l.monaco.editor.setTheme("hc-black");return}console.error(n[0].messageText.toString());return}l.monaco.editor.setTheme("vs-dark")}catch(r){l.monaco.editor.setTheme("vs-light"),setTimeout(()=>{l.monaco.editor.setTheme("hc-black")},50),console.error(r)}}async function x(o){if(!l||!l.monaco)return[{messageText:"Error with the error checking. Try to reload!"}];const{monaco:i}=l,{sha256:r}=await import(`https://unpkg.com/@zedvision/sha256@${p.sha256}/sha256.js`),n=`file:///${await r(o)}.tsx`,c=i.Uri.parse(n),m=i.editor.getModel(c)||await i.editor.createModel(o,"typescript",c),b=await(await i.languages.typescript.getTypeScriptWorker())(m.uri),C=b.getSemanticDiagnostics(n),z=b.getCompilerOptionsDiagnostics(n),B=b.getSyntacticDiagnostics(n),$=await Promise.race([C,z,B]);return m.dispose(),[...$]}async function y(o){t.HTML="";let i=!1;if(typeof o!="string"||o==="")return i=!0,i;const r=a==="window"?o.replace("body{","#zbody{"):o,s=u.createElement("div"),n=(await import(D(r))).default;t.unmount(),t.unmount=j(n(),s);const c=u.getElementById("zbody");return c&&c.children[0].replaceWith(s),t.HTML=t.div.innerHTML,!!t.HTML}}function D(a){const d=new Blob([a],{type:"application/javascript"});return URL.createObjectURL(d)}
