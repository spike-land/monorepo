import{importScript as b}from"../dist/importScript.js";import{starter as f}from"./starterNoFramerMotion.js";const i={firstLoad:!0,errorCode:"",code:""};function H(c="zbody",d){try{const m=window.document.getElementById(c),j=m.innerHTML;j.length>0&&(ReactDOM.unmountComponentAtNode(d),m.innerHTML=j)}catch(m){console.error("Error in un-mount",m)}}export async function run(c="window"){const{transpileCode:d}=await import("./transpile.js");if(i.code=await I(),c==="editor"){const{renderDraggableEditor:t}=await import("./DraggableEditor.js");await t()}if(c==="window"){const{renderDraggableWindow:t}=await import("./DraggableWindow.js"),{shareItAsHtml:e}=await import("./share.js");await t({onShare:async()=>{const o=await e({code:await d(i.code)});window.open(o)}})}const{getDB:m}=await import("../dist/shaDB.min.js"),{getUserId:j,getProjects:x,saveCode:S}=await import("./data.js"),C=await d(i.code);E(C);const{startMonaco:M}=await import("../dist/editor.min.js"),r=await M({language:"typescript",code:i.code,onChange:v});let D=0;async function k(t){try{const e=await d(t);e.length&&D===0&&E(e);const o=await B(t);D=o.length;const n=window.document.getElementById("error");if(o.length===0)i.code=t,await S(t);else{i.error=t;const{diff:a}=await import("../dist/diff.min.js"),l=await a(i.code,t);if(l.c.length<=3){r.monaco.editor.setTheme("hc-black");return}n.innerHTML=o[0].messageText.toString(),n.style.display="block";return}n.style.display="none",r.monaco.editor.setTheme("vs-dark")}catch(e){r.monaco.editor.setTheme("vs-light"),setTimeout(()=>{r.monaco.editor.setTheme("hc-black")},50),console.error(e)}}function v(t){if(!r)return;window.requestAnimationFrame(()=>k(t))}async function B(t){if(!r||!r.monaco)return;const{monaco:e}=r,{sha256:o}=await import("./sha256.js"),n=await o(t),a=`file:///${n}.tsx`,l=e.Uri.parse(a),u=e.editor.getModel(l)||await e.editor.createModel(t,"typescript",l),g=await e.languages.typescript.getTypeScriptWorker(),w=await g(u.uri),s=w.getSemanticDiagnostics(a),p=w.getCompilerOptionsDiagnostics(a),h=w.getSyntacticDiagnostics(a),y=await Promise.race([s,p,h]);return u.dispose(),[...y]}await b("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js");function E(t){if(typeof t!="string"||t==="")return;let e=!1;const o=()=>{const n=c==="window"?t.replace("body{","#root{"):t;e&&(H("zbody",e),e=!1);const a=new Function("importScript",`return function(){  
          let DefaultElement;
          ${n}

          const root = document.createElement("div");
          
          root.innerHTML = ReactDOMServer.renderToString(jsx(DefaultElement));
          if(document.getElementById("zbody").children.length) {
            document.getElementById("zbody").children[0].remove();
          }
          document.getElementById("zbody").appendChild(root);

          hydrated = DefaultElement;
          setTimeout(async()=>{
            if (hydrated === DefaultElement){
              ReactDOM.hydrate(jsx(DefaultElement), root);
            }

          }, 500);

      }`)(b);setTimeout(()=>a())};o()}async function I(){const{getUserId:t,getProjects:e,saveCode:o}=await import("./data.js"),{getDB:n}=await import("../dist/shaDB.min.js"),a=await n(),l=await t(),u=await e(),g=u[0],w=new URLSearchParams(window.location.search),s=w.get("h")||await a.get(g);if(s){let p;try{p=await a.get(s)}catch{console.error("error load key: "+s)}if(p)return p;let h;try{const y=await fetch("https://code.zed.vision/?h="+s);h=await y.json()}catch(y){const{sha256:L}=await import("./sha256.js"),T=await L(f);return a.put(T,f),await a.put(g,T),f}return h}return f}function z(t,e){const o=new URLSearchParams(window.location.search);o.set(t,e),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${o}`))}}
