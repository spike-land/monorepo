{
  "version": 3,
  "sources": ["../js/runner.tsx", "../js/renderToString.tsx"],
  "sourcesContent": ["import type { Dispatch, ReactNode, SetStateAction } from \"react\";\nimport { saveCode } from \"./ws\";\nimport { appFactory } from \"./starter\";\nimport { mST } from \"./session\";\nimport { renderFromString } from \"./renderToString\";\n// var Stream = require('stream/')\n\n// import \"es-module-shims\";\n\n// if (\"serviceWorker\" in navigator) {\n//   const wb = new Workbox(\"/sw.js\");\n\n//   wb.register();\n// }\n\n// const hash = new Sha256();\n\n// const importMap = { imports: {\n//   \"framer-motion\": \"/framer-motion.mjs\",\n//   \"react-dom/server\": \"/react.mjs\",\n//   \"@emotion/react\": \"/emotion.mjs\",\n//   \"react\": \"/react.mjs\",} };\n\n// importShim.addImportMap(importMap)\n\nexport interface IRunnerSession {\n  // changes: unknown[];\n  errorText: string;\n  child: Dispatch<SetStateAction<ReactNode[]>>;\n  url: string;\n}\n\n// const debounced = debounce(runner, 300, {\n//   maxWait: 600,\n//   trailing: true,\n//   leading: true,\n// });\n\n// export const runnerDebounced: typeof runner = (props) => debounced(props);\n\ntype ITransform = (code: string) => Promise<string>;\n\nlet transform: ITransform | null = null;\nlet i = 0;\n\nexport async function runner({ code, counter }: {\n  code: string;\n  counter: number;\n}) {\n  // console.log({ i, counter });\n  \n  i = counter;\n\n  transform = transform || (await (await import(\"./esbuildEsm\")).init());\n  if (code === mST().code) return;\n  if (i > counter) return;\n\n  // session.changes.push(changes);\n\n  // esbuildEsmTransform = esbuildEsmTransform ||\n  //   (await import(\"./esbuildEsm.ts\")).transform;\n\n  try {\n    const transpiled = await transform(code);\n    if (transpiled === mST().transpiled) return;\n\n    let restartError = false;\n    /// yellow\n    if (transpiled.length > 0) {\n      try {\n        // console.log(transpiled);\n\n        const App = await appFactory(transpiled);\n        const { html, css } = renderFromString(App);\n        // console.log({html, css});\n\n        await saveCode({\n          code,\n          transpiled,\n          i: counter,\n          html,\n          css,\n        });\n\n        return;\n      } catch (error) {\n        console.error(\"EXCEPTION\");\n        console.error(error);\n        restartError = true;\n        console.error({ restartError });\n        return;\n      }\n    }\n  } catch (error) {\n    console.error({ error });\n  }\n}\n", "// import {CacheProvider } from \"@emotion/react\"\n\nimport { render } from \"react-dom\";\nimport type { FC } from \"react\";\nimport { hashCode, mST, patchSync } from \"./session\";\n\n// const WithCache: FC<{children: ReactNode, cache: EmotionCache}> = ({children, cache}) => <CacheProvider value={cache}>{children}</CacheProvider>\n\nexport const renderFromString = (App: FC) => {\n  // const myCache =  createCache({\n  //   prepend: true,\n  //   key: 'css',\n  //   stylisPlugins: [\n  //   ]\n  // });\n\n  const temp = document.createElement(\"div\");\n  render(<App />, temp);\n  const html = temp.innerHTML;\n\n  setTimeout(() => {\n    const hash = hashCode();\n    setTimeout(() => {\n      if (hash !== hashCode()) return;\n      const { css, html } = mST();\n      // @ts-ignore\n      const codeSpace: string = globalThis[\"codeSpace\"] as unknown as string;\n      const temp = document.getElementById(\"root-\" + codeSpace)!;\n\n      const htmlHtml = temp.innerHTML;\n      const newCss = extractCritical(htmlHtml);\n      if (css !== newCss || html !== htmlHtml) {\n        patchSync({\n          ...mST(),\n          html: htmlHtml,\n          css: newCss,\n        });\n      }\n    }, 50);\n  }, 100);\n\n  return {\n    html,\n    css: extractCritical(html),\n  };\n};\nconst extractCritical = (html: string) => {\n  try{\n  const rules: { [key: string]: string } = {};\n  for (let i in document.styleSheets) {\n    const styleSheet = document.styleSheets[i];\n    // for (let r in styleSheet.cssRules) {\n    if (styleSheet?.cssRules) {\n      Array.from(styleSheet.cssRules).forEach((rule) => {\n        if (rule && rule.cssText && rule.cssText.slice(0, 5) === \".css-\") {\n          const selector = rule.cssText.slice(1, 11);\n          if (\n            !rules[selector] && html.includes(selector) &&\n            !rule.cssText.slice(10).includes(\".css-\")\n          ) {\n            rules[selector] = rule.cssText;\n          }\n        }\n      });\n    }\n     }\n\n  return Object.keys(rules).map((r) => rules[r]).join(\" \");\n}catch{\n\n  console.error('no css')\n  return \"\"\n}\n\n};\n"],
  "mappings": ";;;;;;;;;;;;;;AAAA;;;ACAA;AAEA,SAAS,cAAc;AAed;AATF,IAAM,mBAAmB,CAAC,QAAY;AAQ3C,QAAM,OAAO,SAAS,cAAc,KAAK;AACzC,SAAO,oBAAC,OAAI,GAAI,IAAI;AACpB,QAAM,OAAO,KAAK;AAElB,aAAW,MAAM;AACf,UAAM,OAAO,SAAS;AACtB,eAAW,MAAM;AACf,UAAI,SAAS,SAAS;AAAG;AACzB,YAAM,EAAE,KAAK,MAAAA,MAAK,IAAI,IAAI;AAE1B,YAAM,YAAoB,WAAW;AACrC,YAAMC,QAAO,SAAS,eAAe,UAAU,SAAS;AAExD,YAAM,WAAWA,MAAK;AACtB,YAAM,SAAS,gBAAgB,QAAQ;AACvC,UAAI,QAAQ,UAAUD,UAAS,UAAU;AACvC,kBAAU;AAAA,UACR,GAAG,IAAI;AAAA,UACP,MAAM;AAAA,UACN,KAAK;AAAA,QACP,CAAC;AAAA,MACH;AAAA,IACF,GAAG,EAAE;AAAA,EACP,GAAG,GAAG;AAEN,SAAO;AAAA,IACL;AAAA,IACA,KAAK,gBAAgB,IAAI;AAAA,EAC3B;AACF;AACA,IAAM,kBAAkB,CAAC,SAAiB;AACxC,MAAG;AACH,UAAM,QAAmC,CAAC;AAC1C,aAASE,MAAK,SAAS,aAAa;AAClC,YAAM,aAAa,SAAS,YAAYA;AAExC,UAAI,YAAY,UAAU;AACxB,cAAM,KAAK,WAAW,QAAQ,EAAE,QAAQ,CAAC,SAAS;AAChD,cAAI,QAAQ,KAAK,WAAW,KAAK,QAAQ,MAAM,GAAG,CAAC,MAAM,SAAS;AAChE,kBAAM,WAAW,KAAK,QAAQ,MAAM,GAAG,EAAE;AACzC,gBACE,CAAC,MAAM,aAAa,KAAK,SAAS,QAAQ,KAC1C,CAAC,KAAK,QAAQ,MAAM,EAAE,EAAE,SAAS,OAAO,GACxC;AACA,oBAAM,YAAY,KAAK;AAAA,YACzB;AAAA,UACF;AAAA,QACF,CAAC;AAAA,MACH;AAAA,IACC;AAEH,WAAO,OAAO,KAAK,KAAK,EAAE,IAAI,CAAC,MAAM,MAAM,EAAE,EAAE,KAAK,GAAG;AAAA,EACzD,QAAC;AAEC,YAAQ,MAAM,QAAQ;AACtB,WAAO;AAAA,EACT;AAEA;;;ADhCA,IAAI,YAA+B;AACnC,IAAI,IAAI;AAER,eAAsB,OAAO,EAAE,MAAM,QAAQ,GAG1C;AAGD,MAAI;AAEJ,cAAY,aAAc,OAAO,MAAM,OAAO,oCAAiB,KAAK;AACpE,MAAI,SAAS,IAAI,EAAE;AAAM;AACzB,MAAI,IAAI;AAAS;AAOjB,MAAI;AACF,UAAM,aAAa,MAAM,UAAU,IAAI;AACvC,QAAI,eAAe,IAAI,EAAE;AAAY;AAErC,QAAI,eAAe;AAEnB,QAAI,WAAW,SAAS,GAAG;AACzB,UAAI;AAGF,cAAM,MAAM,MAAM,WAAW,UAAU;AACvC,cAAM,EAAE,MAAM,IAAI,IAAI,iBAAiB,GAAG;AAG1C,cAAM,SAAS;AAAA,UACb;AAAA,UACA;AAAA,UACA,GAAG;AAAA,UACH;AAAA,UACA;AAAA,QACF,CAAC;AAED;AAAA,MACF,SAAS,OAAP;AACA,gBAAQ,MAAM,WAAW;AACzB,gBAAQ,MAAM,KAAK;AACnB,uBAAe;AACf,gBAAQ,MAAM,EAAE,aAAa,CAAC;AAC9B;AAAA,MACF;AAAA,IACF;AAAA,EACF,SAAS,OAAP;AACA,YAAQ,MAAM,EAAE,MAAM,CAAC;AAAA,EACzB;AACF;",
  "names": ["html", "temp", "i"]
}
