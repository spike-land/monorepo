import{a as Z,c as ee}from"./chunk-chunk-WEKY6WJN.mjs";import{a as me,b as K,e as d,f as k,g as j,h as X,i as V,j as z,k as Y}from"./chunk-chunk-HP6SK5W2.mjs";import{d as pe,i as b}from"./chunk-chunk-VQAZ3CH6.mjs";b();var G=pe(me(),1);b();b();function te(t,e=n=>n.key){var n=[];return J(t,"",!0,r=>n.push(r),e),n.join("")}function J(t,e,n,r,a){if(t){r(`${e}${n?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 "}${a(t)}
`);let o=e+(n?"    ":"\u2502   ");t.left&&J(t.left,o,!1,r,a),t.right&&J(t.right,o,!0,r,a)}}function x(t){if(t===null)return!0;var e=R(t.left),n=R(t.right);return!!(Math.abs(e-n)<=1&&x(t.left)&&x(t.right))}function R(t){return t?1+Math.max(R(t.left),R(t.right)):0}function E(t,e,n,r,a){let o=a-r;if(o>0){let i=r+Math.floor(o/2),s=e[i],c=n[i],p={key:s,data:c,parent:t};return p.left=E(p,e,n,r,i),p.right=E(p,e,n,i+1,a),p}return null}function O(t){if(t===null)return 0;let e=O(t.left),n=O(t.right);return t.balanceFactor=e-n,Math.max(e,n)+1}function D(t,e,n,r,a){if(n>=r)return;let o=t[n+r>>1],i=n-1,s=r+1;for(;;){do i++;while(a(t[i],o)<0);do s--;while(a(t[s],o)>0);if(i>=s)break;let c=t[i];t[i]=t[s],t[s]=c,c=e[i],e[i]=e[s],e[s]=c}D(t,e,n,s,a),D(t,e,s+1,r,a)}function ge(t,e){return t>e?1:t<e?-1:0}function H(t){var e=t.right;return t.right=e.left,e.left&&(e.left.parent=t),e.parent=t.parent,e.parent&&(e.parent.left===t?e.parent.left=e:e.parent.right=e),t.parent=e,e.left=t,t.balanceFactor+=1,e.balanceFactor<0&&(t.balanceFactor-=e.balanceFactor),e.balanceFactor+=1,t.balanceFactor>0&&(e.balanceFactor+=t.balanceFactor),e}function N(t){var e=t.left;return t.left=e.right,t.left&&(t.left.parent=t),e.parent=t.parent,e.parent&&(e.parent.left===t?e.parent.left=e:e.parent.right=e),t.parent=e,e.right=t,t.balanceFactor-=1,e.balanceFactor>0&&(t.balanceFactor-=e.balanceFactor),e.balanceFactor-=1,t.balanceFactor<0&&(e.balanceFactor+=t.balanceFactor),e}var v=class{constructor(e,n=!1){this._comparator=e||ge,this._root=null,this._size=0,this._noDuplicates=!!n}destroy(){return this.clear()}clear(){return this._root=null,this._size=0,this}get size(){return this._size}contains(e){if(this._root)for(var n=this._root,r=this._comparator;n;){var a=r(e,n.key);if(a===0)return!0;a<0?n=n.left:n=n.right}return!1}next(e){var n=e;if(n)if(n.right)for(n=n.right;n.left;)n=n.left;else for(n=e.parent;n&&n.right===e;)e=n,n=n.parent;return n}prev(e){var n=e;if(n)if(n.left)for(n=n.left;n.right;)n=n.right;else for(n=e.parent;n&&n.left===e;)e=n,n=n.parent;return n}forEach(e){for(var n=this._root,r=[],a=!1,o=0;!a;)n?(r.push(n),n=n.left):r.length>0?(n=r.pop(),e(n,o++),n=n.right):a=!0;return this}range(e,n,r,a){let o=[],i=this._comparator,s=this._root,c;for(;o.length!==0||s;)if(s)o.push(s),s=s.left;else{if(s=o.pop(),c=i(s.key,n),c>0)break;if(i(s.key,e)>=0&&r.call(a,s))return this;s=s.right}return this}keys(){for(var e=this._root,n=[],r=[],a=!1;!a;)e?(n.push(e),e=e.left):n.length>0?(e=n.pop(),r.push(e.key),e=e.right):a=!0;return r}values(){for(var e=this._root,n=[],r=[],a=!1;!a;)e?(n.push(e),e=e.left):n.length>0?(e=n.pop(),r.push(e.data),e=e.right):a=!0;return r}at(e){for(var n=this._root,r=[],a=!1,o=0;!a;)if(n)r.push(n),n=n.left;else if(r.length>0){if(n=r.pop(),o===e)return n;o++,n=n.right}else a=!0;return null}minNode(){var e=this._root;if(!e)return null;for(;e.left;)e=e.left;return e}maxNode(){var e=this._root;if(!e)return null;for(;e.right;)e=e.right;return e}min(){var e=this._root;if(!e)return null;for(;e.left;)e=e.left;return e.key}max(){var e=this._root;if(!e)return null;for(;e.right;)e=e.right;return e.key}isEmpty(){return!this._root}pop(){var e=this._root,n=null;if(e){for(;e.left;)e=e.left;n={key:e.key,data:e.data},this.remove(e.key)}return n}popMax(){var e=this._root,n=null;if(e){for(;e.right;)e=e.right;n={key:e.key,data:e.data},this.remove(e.key)}return n}find(e){for(var n=this._root,r=n,a,o=this._comparator;r;){if(a=o(e,r.key),a===0)return r;a<0?r=r.left:r=r.right}return null}insert(e,n){if(!this._root)return this._root={parent:null,left:null,right:null,balanceFactor:0,key:e,data:n},this._size++,this._root;var r=this._comparator,a=this._root,o=null,i=0;if(this._noDuplicates)for(;a;){if(i=r(e,a.key),o=a,i===0)return null;i<0?a=a.left:a=a.right}else for(;a;)i=r(e,a.key),o=a,i<=0?a=a.left:a=a.right;var s={left:null,right:null,balanceFactor:0,parent:o,key:e,data:n},c;for(i<=0?o.left=s:o.right=s;o&&(i=r(o.key,e),i<0?o.balanceFactor-=1:o.balanceFactor+=1,o.balanceFactor!==0);){if(o.balanceFactor<-1){o.right.balanceFactor===1&&N(o.right),c=H(o),o===this._root&&(this._root=c);break}else if(o.balanceFactor>1){o.left.balanceFactor===-1&&H(o.left),c=N(o),o===this._root&&(this._root=c);break}o=o.parent}return this._size++,s}remove(e){if(!this._root)return null;for(var n=this._root,r=this._comparator,a=0;n&&(a=r(e,n.key),a!==0);)a<0?n=n.left:n=n.right;if(!n)return null;var o=n.key,i,s;if(n.left){for(i=n.left;i.left||i.right;){for(;i.right;)i=i.right;n.key=i.key,n.data=i.data,i.left&&(n=i,i=i.left)}n.key=i.key,n.data=i.data,n=i}if(n.right){for(s=n.right;s.left||s.right;){for(;s.left;)s=s.left;n.key=s.key,n.data=s.data,s.right&&(n=s,s=s.right)}n.key=s.key,n.data=s.data,n=s}for(var c=n.parent,p=n,y;c&&(c.left===p?c.balanceFactor-=1:c.balanceFactor+=1,c.balanceFactor<-1?(c.right.balanceFactor===1&&N(c.right),y=H(c),c===this._root&&(this._root=y),c=y):c.balanceFactor>1&&(c.left.balanceFactor===-1&&H(c.left),y=N(c),c===this._root&&(this._root=y),c=y),!(c.balanceFactor===-1||c.balanceFactor===1));)p=c,c=c.parent;return n.parent&&(n.parent.left===n?n.parent.left=null:n.parent.right=null),n===this._root&&(this._root=null),this._size--,o}load(e=[],n=[],r){if(this._size!==0)throw new Error("bulk-load: tree is not empty");let a=e.length;return r&&D(e,n,0,a-1,this._comparator),this._root=E(null,e,n,0,a),O(this._root),this._size=a,this}isBalanced(){return x(this._root)}toString(e){return te(this._root,e)}};v.default=v;b();var M,we=new Uint8Array(16);function ye(){if(!M&&(M=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!M))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return M(we)}var be=/^(?:[\da-f]{8}-[\da-f]{4}-[1-5][\da-f]{3}-[89ab][\da-f]{3}-[\da-f]{12}|0{8}-(?:0{4}-){3}0{12})$/i;function Ce(t){return typeof t=="string"&&be.test(t)}var f=[];for(let t=0;t<256;++t)f.push((t+256).toString(16).slice(1));function ve(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(f[t[e+0]]+f[t[e+1]]+f[t[e+2]]+f[t[e+3]]+"-"+f[t[e+4]]+f[t[e+5]]+"-"+f[t[e+6]]+f[t[e+7]]+"-"+f[t[e+8]]+f[t[e+9]]+"-"+f[t[e+10]]+f[t[e+11]]+f[t[e+12]]+f[t[e+13]]+f[t[e+14]]+f[t[e+15]]).toLowerCase();if(!Ce(n))throw new TypeError("Stringified UUID is invalid");return n}function ne(t,e,n){t=t||{};let r=t.random||(t.rng||ye)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){n=n||0;for(let a=0;a<16;++a)e[n+a]=r[a];return e}return ve(r)}var Se=new v((t,e)=>t===e?0:t<e?1:-1,!0),I=[],u=(self&&self.crypto&&self.crypto.randomUUID&&self.crypto.randomUUID()||ne()).slice(0,8);Se.insert(u);var l={},F,g,re="",_=0,L=0,ie=0,Q=0,h=null,ae,S=!1,$={},w={localStream:null,webRtcArray:I,tracks:$,user:u,rtcConns:l,send(t){let e=JSON.stringify({...t,name:t.name||u});I.map(n=>{try{if(n.readyState!=="open")return;(!t.target||n.target===t.target&&!T.includes(n.target))&&n.send(e)}catch{}})}};Object.assign(globalThis,{sendChannel:w});var Je=async t=>{let{mST:e,address:n}=t;g=t.codeSpace,F=new BroadcastChannel(location.origin),!(location.pathname.endsWith("dehydrated")&&(F.onmessage=r=>{r.data.codeSpace===g&&console.log(r.data)}))&&(Y(g,{name:u,state:e},location.origin),await ee(e.transpiled,g),await se(),F=new BroadcastChannel(location.origin),F.onmessage=async r=>{if(!(r.data.ignoreUser&&r.data.ignoreUser===u)&&(r.data.codeSpace===g&&r.data.address&&!n&&h?.send(JSON.stringify({codeSpace:g,address:r.data.address})),r.data.ignoreUser&&!T.includes(r.data.ignoreUser)&&T.push(r.data.ignoreUser),r.data.codeSpace===g&&r.data.sess.code!==k().code)){let a=await z(r.data.sess);await j(a)}},X(()=>{ke(),_e();let r=k(),a=K(JSON.stringify(r));a!==re&&(re=a,F.postMessage({ignoreUser:u,sess:r,codeSpace:g,address:n}))},"broadcast"))},B=null;async function U(){return!S||h===null?(h=null,await se()):h}var T=[],_e=(0,G.default)(Te,100,{trailing:!0,leading:!0,maxWait:500}),ke=(0,G.default)(Fe,1200,{trailing:!0,leading:!0,maxWait:2500});async function Fe(){try{if(h){if(_===d())return;let t=k(),e=await V(_,t);if(!e||e.newHash!==d())return;let n=JSON.stringify({...e,name:u});ae(n)}else S=!1,await U()}catch{}}async function Te(){try{if(Object.keys(l).length>0){if(L===d())return;let t=k(),e=L?await V(L,t):await z(t);e&&e.patch&&w.send(e)}}catch{}}async function se(){if(h!==null)return h;if(S=!0,location.origin.includes("localhost"))return;let t=new WebSocket(`wss://${location.host}/live/`+g+"/websocket");return S=!1,t.addEventListener("open",()=>{h=t,ae=r=>{try{h&&h?.send&&h?.send(r)}catch{h=null,S=!1,U()}};let n=Object.assign(t,{hashCode:d()});return h.addEventListener("message",r=>oe(r,"ws",n)),B&&clearInterval(B),B=setInterval(()=>{let a=Date.now()-Q;if(a>4e4)try{if(t.readyState===t.OPEN){t?.send(JSON.stringify({name:u,timestamp:ie+a}));return}S=!1,U()}catch{S=!1,U()}},3e4),t.send(JSON.stringify({name:u})),t}),t}var A={};async function oe(t,e,n){if(h==null)return;Q=Date.now();let r=JSON.parse(t.data);xe(r,e,n)}async function xe(t,e,n){if(e==="ws"&&t.timestamp&&(Q=Date.now(),ie=t.timestamp),(t.hashCode||t.newHash&&n)&&(n.hashCode=t.hashCode||t.newHash),e==="ws"&&t.hashCode&&(_=t.hashCode),e==="ws"&&t.hashCode&&(_=t.hashCode),(e==="rtc"&&t.hashCode||t.newHash)&&(L=t.hashCode||t.newHash),T.includes(t.name)||t.newHash===d())return;if(t.oldHash&&t.newHash){if(A[t.oldHash]&&A[t.oldHash]===t.newHash)return;A[t.oldHash]=t.newHash}if(t.newHash===d())return;if((async()=>{try{if(t.type==="new-ice-candidate"){await Re(t.candidate,t.name);return}if(t.type==="video-offer"){await o(t.offer,t.name);return}if(t.type==="video-answer"){await a(t.answer,t.name);return}if(t.name&&t.name!==u&&!l[t.name]&&!T.includes(t.name)){await r(t.name);let i=t.users;for(;i.length;){await Z(2e3);let s=i.pop();s&&!w.rtcConns[s]&&await r(s)}return}}catch{}})(),t.patch&&t.name!==u){if(t.newHash===d())return;if(await j(t),t.newHash===d()){w&&w.send({hashCode:t.newHash});return}return}if(t.patch&&t.name===u){_=t.newHash;return}if(t.name===u)return;d();function r(i){if(l[i])return;l[i]=new RTCPeerConnection(ce),l[i].onicecandidate=m=>{m.candidate&&h?.send(JSON.stringify({type:"new-ice-candidate",target:i,name:u,candidate:m.candidate.toJSON()}))},l[i].oniceconnectionstatechange=le,l[i].onicegatheringstatechange=fe,l[i].onsignalingstatechange=()=>{switch(l[i].signalingState){case"closed":break}},l[i].onnegotiationneeded=y,l[i].ontrack=function({track:m,streams:C}){$[i]={track:m,streams:C}},l[i].ondatachannel=m=>{let C=m.channel;C.binaryType="arraybuffer",C.addEventListener("close",p),w&&w.localStream&&w.localStream.active&&w.localStream.getTracks().forEach(W=>{let q=l[i];q.addTrack(W),q.ontrack=({track:ue,streams:de})=>$[i]={track:ue,streams:de}}),C.addEventListener("message",async W=>oe(W,"rtc",Object.assign(C,{hashCode:d()})));let he=Object.assign(C,{target:i});I.push(he)};let s={ordered:!0,reliable:!0,maxPacketLifeTime:3e3},c=Object.assign(l[i].createDataChannel(i,s),{target:i});return c.binaryType="arraybuffer",c.addEventListener("error",m=>{console.log("xxxxxx-  Data Channel Error:",m)}),c.addEventListener("open",()=>{I.push(c)}),c.addEventListener("close",()=>{}),l[i];function p(){l[i].close(),delete l[i]}async function y(){try{let m=await l[i].createOffer();if(l[i].signalingState!="stable")return;await l[i].setLocalDescription(m),h?.send(JSON.stringify({target:i,name:u,type:"video-offer",offer:l[i].localDescription}))}catch{}}function le(){switch(l[i].iceConnectionState){case"closed":case"failed":case"disconnected":break}}function fe(){}}async function a(i,s){await l[s].setRemoteDescription(new RTCSessionDescription(i)).catch(console.error)}async function o(i,s){l[s]||r(s),await l[s].setRemoteDescription(new RTCSessionDescription(i));let c=await l[s].createAnswer();await l[s].setLocalDescription(c),h?.send(JSON.stringify({target:s,name:u,type:"video-answer",answer:c}))}}var ce={iceServers:["stun3.l.google.com:19302"].map(t=>({urls:`stun:${t}`}))};ce.iceServers=[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}];async function Re(t,e){let n=new RTCIceCandidate(t);await l[e].addIceCandidate(n)}export{w as a,Je as b};
