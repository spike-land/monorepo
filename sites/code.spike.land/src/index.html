<!DOCTYPE html>
<html lang="en">
<head profile="http://www.w3.org/2005/10/profile">
  <meta http-equiv="Content-Type" content="text/html,charset=utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <link rel="icon" type="image/png" href="./assets/zed-icon-big.png" />
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />
  <link rel="stylesheet" href="./assets/app.css" />
  <link rel="stylesheet" href="./assets/roboto.css" />

  <script async src="https://unpkg.com/es-module-shims@1.3.1/dist/es-module-shims.js"></script>
  <title>Instant React Editor</title>
  <script type="esms-options">
    {
      "shimMode": true,
      "polyfillEnable": ["css-modules", "json-modules"],
      "nonce": "n0nce"
    }
    </script>
</head>
<body>
  <script type="importmap-shim" src="./js/importmap.json"></script>
  <script type="module-shim" src="./js/starter.mjs"></script>
  <script type="text/javascript">
    (async()=>{
    let currentWebSocket = null;

    const chCode = (code) => {
        const { monaco } = window;
        if (!monaco || !monaco.Uri) return;
        const modelUri = monaco.Uri.parse(`file:///main.tsx`);
        const model = monaco.editor.getModel(modelUri);
        const oldCode = model.getValue();

        if (oldCode !==code ){
          console.log({oldCode});

          model.setValue(code);
        }
          
      }


    let hostname = window.location.host;
if (hostname == "") {
  // Probably testing the HTML locally.
  hostname = "code.spike.land";
}


let roomName = "ROOMNAMEagain";
let username = 'Pisti'+Math.random();
let lastSeenTimestamp = Date.now();
let lastSeenCode = "";

    function join() {
  let ws = new WebSocket("wss://" + hostname + "/api/room/" + roomName + "/websocket");
  let rejoined = false;
  let startTime = Date.now();

  let rejoin = async () => {
    if (!rejoined) {
      rejoined = true;
      currentWebSocket = null;

      // Clear the roster.
    //  while (roster.firstChild) {
     //   roster.removeChild(roster.firstChild);
  //    }

      // Don't try to reconnect too rapidly.
      let timeSinceLastJoin = Date.now() - startTime;
      if (timeSinceLastJoin < 10000) {
        // Less than 10 seconds elapsed since last join. Pause a bit.
        await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
      }

      // OK, reconnect now!
      join();
    }
  }

  ws.addEventListener("open", event => {
    currentWebSocket = ws;
    window.chCode = chCode;
    window.broad = (code)=>{
      chCode(code);
      if (code !== lastSeenCode) currentWebSocket.send(JSON.stringify({message:  code}));
  }

    // Send user info message.
    ws.send(JSON.stringify({name: username}));
  });

 

  ws.addEventListener("message", event => {
    let data = JSON.parse(event.data);

    if (data.code) {

     chCode(data.code)
    
    } else {
     

      // A regular chat message.
      if (data.timestamp > lastSeenTimestamp) {
        if (data.message && data.message!==lastSeenCode && data.name !== username){

          lastSeenCode = data.message;
          chCode(data.message)
        }
       // addChatMessage(data.name, data.message);
        lastSeenTimestamp = data.timestamp;
      }
    }
  });

  ws.addEventListener("close", event => {
    console.log("WebSocket closed, reconnecting:", event.code, event.reason);
    rejoin();
  });
  ws.addEventListener("error", event => {
    console.log("WebSocket error, reconnecting:", event);
    rejoin();
  });
}



    console.log("hello hello2");
    join();
})()
    /**************/
  </script>
</body>
</html>
