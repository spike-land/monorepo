/** @jsx jsx */

import { css, jsx } from '@emotion/react';
import { useState } from 'react';

//import {} from "react-dom/next";

import {createRoot} from 'react-dom';


export default (() => {
  const [counter, setCounter] = useState(0);
  return jsx('button', {
    onClick: state => {
      setCounter(counter + 1);
    },
    css: css`
      margin-top: 20px;
      border-radius: 40px;
      color: blue;;
      box-shadow: 0;
  
      background-color: yellow;
      
      height: 100px;
      width: 100px;
      opacity: ${counter}%;

    `
  }, counter);
});
export const processWs = async (msg, session, send) => {
  console.log({
    msg,
    session,
    send
  });
  let processed = false;
  const data = msg;

  if (data.transpiled && globalThis.reactRoot) {
    const App = await getApp(data.transpiled);
    globalThis.reactRoot.unmount();
   
    const rootEl = document.getElementById('root');
    rootEl.innerHTML = "";

    setTimeout(()=>{
    rootEl.innerHTML = "<style>"+data.css+'</style><div id="zbody">'+data.html+'</div>';
    
    const root = createRoot(document.getElementById('zbody'));
    root.render(jsx(App, null));
    globalThis.reactRoot = root;
    }, 200);
    return;
  }

  if (data.code && !window.sess) {
    const path = location.pathname.split('/');
    const room = path[1] === 'api' && path[2] === 'room' ? path[3] : (path.pop() || path.pop()).slice(-12);
    const sess = {
      code: data.code,
      errorText: '',
      changes: [],
      setChild: () => {},
      transpiled: data.transpiled,
      html: data.html,
      i: data.i,
      css: data.css,
      room
    };

    if (!window.location.href.endsWith('/public')) {} else {
      window.sess = sess;
      console.log(globalThis.chCode);
      globalThis.chCode && globalThis.chCode(sess.code);
    }

    return;
  }

  if (session.i === 266) alert(266);
  '';
  return false;
};

function createJsBlob(code) {
  const blob = new Blob([code], {
    type: 'application/javascript'
  });
  return URL.createObjectURL(blob);
}

async function getApp(transpiled, mode = 'window') {
  const codeToHydrate = mode === 'window' ? transpiled.replace('body{', '#zbody{') : transpiled;
  const objUrl = createJsBlob(codeToHydrate);
  const App = (await import(objUrl)).default;
  URL.revokeObjectURL(objUrl);
  return App;
}