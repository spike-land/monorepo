import"./chunks/chunk-UT4UBVWW.mjs";import{jsx as ee}from"https://unpkg.com/@spike.land/esm@0.6.220/dist/emotion-react.mjs";var O,W,U;var j,F=async(e,n)=>(j=j||(await import("./chunks/session-KKRBFQ23.mjs")).default,j(e,n));async function te(e){let n=document.querySelector("#monacoEditor"),{startMonaco:t}=await import("./chunks/editor-WJR5UIST.mjs"),o=(await import("./chunks/throttle-3WFK5HZS.mjs")).default,a=c=>N(i.getModel().getValue(),c.changes,e,++e.i),{editor:i,monaco:r}=await t({language:"typescript",container:n,code:e.code});i.onDidChangeModelContent(o(a,100)),window.monaco=r,e.editor=i,window.sess=e}async function ne({monaco:e,editor:n}){if(!e)return[{messageText:"Error with the error checking. Try to reload!"}];let t=n.getModel(),a=await(await e.languages.typescript.getTypeScriptWorker())(t),i=t.uri.toString(),r=a.getSemanticDiagnostics(i),c=a.getCompilerOptionsDiagnostics(i),d=a.getSyntacticDiagnostics(i),g=await Promise.race([r,c,d]);return console.log(g),[]}async function N(e,n=null,t,o){t.changes.push(n),O=O||(await import("./chunks/prettierEsm-KTD3QDBM.mjs")).formatter,U=U||(await import("./chunks/babelEsm-KXY4A2AB.mjs")).babelTransform,W=U,t.errorText="";try{let a=await O(e),i=await W(a),r=!1;if(i.length>0){if(o<t.i)return;try{let{getHtmlAndCss:d}=await import("./chunks/renderToString-ANXHPSTX.mjs");if(o<t.i)return;let g=await ae(i),{html:y,css:E}=d(g);t.transpiled=i,t.html=y;let l=await oe(i);t.setChild(b=>[...b,l]),t.children=l,r=!y,t.code=a,t.codeNonFormatted=e;let f=a;if(t.css=E,t.i!==o)return;t.saveCode&&await t.saveCode({transpiled:i,code:f,i:o,css:E,html:y});return}catch(d){console.error("EXCEPTION"),console.log({e:d}),r=!0,console.error({restartError:r})}}if(t.i>o)return;let c=await ne(t);if(t.i>o)return;r&&c.push({messageText:"Error while starting the app. Check the console!"}),c.length>0&&console.log({err:c})}catch(a){t.errorText=a.message,console.error(a.message)}}async function G(e,n,t,o){e.saveCode=o,e.children=null;let{renderPreviewWindow:a}=await import("./chunks/renderPreviewWindow-GLYGATQH.mjs");await a(e,n,t),t||await te(e),e.update=i=>N(i,null,e),N(e.code,null,e,-1)}async function oe(e,n="window"){let t=n==="window"?e.replace("body{","#zbody{"):e,o=V(t),a=await import(o);return URL.revokeObjectURL(o),ee(a.default)}function V(e){let n=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(n)}async function ae(e,n="window"){let t=n==="window"?e.replace("body{","#zbody{"):e,o=V(t),a=(await import(o)).default;return URL.revokeObjectURL(o),a}var D=null,H=!1,I=[],ie="spike.land",u={},P="",x="",C="",w="",J=0,v=0,m,L,Q,B=!1,S;var h=null,_=()=>h.session.get("state"),A=null;setInterval(()=>{Date.now()-v>4e4?T():console.log("no_need_to_rejoin")},3e4);L=globalThis.chCode=async(e,n)=>{if(!!e&&!(n<window.sess.i)&&e!==window.sess.code)try{window.sess&&window.sess.editor?window.sess.editor.getModel().setValue(e):window.sess.update(e)}catch(t){console.error({e:t})}};async function T(){if(!B){B=!0,D=null;let e=Date.now()-Q;e<1e4&&await new Promise(n=>setTimeout(n,1e4-e)),k()}}async function X({code:e,transpiled:n,html:t,css:o,i:a}){if(S){let i=Date.now();if(u.i=a,u.lastRtcUpdate){let d=i-u.lastUpdate;if(d<1e3&&(await K(200-d),a!==u.i))return}u.lastRtcUpdate=Date.now();let r=_().toJSON();r.html=t,r.css=o,r.transpiled=n,r.code=e,r.i=a;let c=x?h.createPatchFromHashCode(x,r):h.createPatch(r);c&&c.patch!==""&&S.send(c)}if(D){let i=Date.now();if(u.i=a,u.lastUpdate){let g=i-u.lastUpdate;if(g<1e3&&(await K(1e3-g),a!==u.i))return}u.lastUpdate=Date.now();let r=_().toJSON();r.html=t,r.css=o,r.transpiled=n,r.code=e,r.i=a;let c=P?h.createPatchFromHashCode(P,r):h.createPatch(r);if(!c)return;let d=JSON.stringify({...c,name:w});c.patch!==""&&D.send(d)}}var k=async(e,n,t)=>{C=C||e||"code-main",window.room=e,n&&(w=n);let a=await(await fetch(`https://spike.land/api/room/${C}/session`)).json();if(h=h||await F(C,{name:w,room:C,state:a,events:[]}),window.mySession=h,!t&&!window.sess){let i={..._().toJSON(),setChild:()=>{},changes:[],children:[null],errorText:""},r=(await import("./chunks/throttle-3WFK5HZS.mjs")).default,c=location.pathname.endsWith("public");G(i,C,c,r(X,100)),window.sess=i}H||(H=!0,setTimeout(()=>{H=!1},1e4),m=new WebSocket("wss://"+ie+"/api/room/"+C+"/websocket"),B=!1,Q=Date.now(),m.addEventListener("open",()=>{A?clearInterval(A):A=setInterval(()=>{let i=Date.now(),r=i-v;if(i-v>3e4)try{m.send(JSON.stringify({name:w,time:J+r}))}catch(c){T()}},3e4),D=m,globalThis.broad=X,globalThis.chCode=L,m.send(JSON.stringify({name:w}))}),m.addEventListener("message",i=>$(i,"ws")),m.addEventListener("close",i=>{console.log("WebSocket closed, reconnecting:",i.code,i.reason),T()}),m.addEventListener("error",i=>{console.log("WebSocket error, reconnecting:",i),T()}))},M=window.location.hostname;M||(M="localhost");p("Hostname: "+M);var s={};globalThis.connections=s;function p(e){let n=new Date;console.log("["+n.toLocaleTimeString()+"] "+e)}function re(e){let n=new Date;console.trace("["+n.toLocaleTimeString()+"] "+e)}async function Y(e){p("Setting up a connection...");let n={iceServers:["stun3.l.google.com:19302"].map(l=>({urls:`stun:${l}`}))};n.iceServers=[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}],s[e]=s[e]||new RTCPeerConnection(n),s[e].onicecandidate=d,s[e].oniceconnectionstatechange=g,s[e].onicegatheringstatechange=E,s[e].onsignalingstatechange=y,s[e].onnegotiationneeded=r,s[e].ontrack=c,s[e].addEventListener("datachannel",a);let t={ordered:!0,reliable:!0,maxPacketLifeTime:3e3},o=s[e].createDataChannel(e,t);return o.binaryType="arraybuffer",o.addEventListener("message",l=>{console.log("***********RTC***",{msg:l});let f=JSON.parse(l.data);return f&&f.hashCode&&(x=f.hashCode),f&&f.newHash&&(x=f.newHash),$(l,"rtc")}),o.addEventListener("error",l=>{console.log("xxxxxx-  Data Channel Error:",l)}),o.addEventListener("open",()=>{console.log("@@@@@@@@RTC IS OPEN&&&&&&&&"),o.target=e,I.push(o),s[e].sendChannel=o,window.sendChannel=S={send:l=>{let f=l.target;l.name=l.name||w;let b=JSON.stringify(l);I.map(R=>R.readyState==="open"&&(!f||f&&R.target===f)&&R.send(b))}}}),o.addEventListener("close",()=>{console.log("xxxxxxxx- The Data Channel is Closed")}),s[e];function a(l){console.log("Receive Channel Callback");let f=l.channel;f.binaryType="arraybuffer",f.addEventListener("close",i),f.addEventListener("message",b=>$(b,"rtc")),I.push(f)}function i(){console.log("Receive channel is closed"),s[e].close(),s[e]=null,console.log("Closed remote peer connection")}async function r(){p("*** Negotiation needed");try{p("---> Creating offer");let l=await s[e].createOffer();if(s[e].signalingState!="stable"){p("     -- The connection isn't stable yet; postponing...");return}p("---> Setting local description to the offer"),await s[e].setLocalDescription(l),p("---> Sending the offer to the remote peer"),m.send(JSON.stringify({target:e,name:w,type:"video-offer",sdp:s[e].localDescription}))}catch(l){p("*** The following error occurred while handling the negotiationneeded event:")}}function c(l){p("*** Track event"),document.querySelector("#received_video").srcObject=l.streams[0],document.querySelector("#hangup-button").disabled=!1}function d(l){l.candidate&&(p("*** Outgoing ICE candidate: "+l.candidate),m.send(JSON.stringify({type:"new-ice-candidate",target:e,name:w,candidate:l.candidate})))}function g(){switch(p("*** ICE connection state changed to "+s[e].iceConnectionState),s[e].iceConnectionState){case"closed":case"failed":case"disconnected":break}}function y(){switch(p("*** connections[target].signalingState  changed to: "+s[e].signalingState),s[e].signalingState){case"closed":break}}function E(){p("*** connections[target].iceGatheringState changed to: "+s[e].iceGatheringState)}}async function se(e,n){p("*** Adding received ICE candidate: "+JSON.stringify(e.candidate));let t=new RTCIceCandidate(e.candidate);console.log(s[n]),await s[n].addIceCandidate(t)}async function ce(e,n){p("*** Call recipient has accepted our call");let t=new RTCSessionDescription(e.sdp);await s[n].setRemoteDescription(t).catch(console.error)}async function le(e,n){s[n]||await Y(n);let t=new RTCSessionDescription(e.sdp);if(s[n].signalingState!="stable"){p("  - But the signaling state isn't stable, so triggering rollback"),await Promise.all([s[n].setLocalDescription({type:"rollback"}),s[n].setRemoteDescription(t)]);return}p("  - Setting remote description"),await s[n].setRemoteDescription(t),p("---> Creating and sending answer to caller"),await s[n].setLocalDescription(await s[n].createAnswer()),m.send(JSON.stringify({target:n,name:w,type:"video-answer",sdp:s[n].localDescription}))}async function $(e,n){v=Date.now();let t=JSON.parse(e.data);if(t.name&&t.name!==w&&!s[t.name])try{await Y(t.name)}catch(o){console.log({e:o}),re("Error with p2p")}if(console.log(n,t.name),t.type==="new-ice-candidate"){await se(t,t.name);return}if(t.type==="video-offer"){await le(t,t.name);return}if(t.type==="video-answer"){await ce(t,t.name);return}if(n===m&&t.hashCode&&(P=t.hashCode),t.patch&&n==="ws"||t.name!==w){if(t.newHash===h.hashCode())return;if(t.oldHash===h.hashCode()){h.applyPatch(t),L(h.session.get("state").code,h.session.get("state").i),S&&S.send({hashCode:t.newHash});return}if(t.newHash===h.hashCode())return;if(t.code&&t.transpiled){let o=h.createPatch(t);h.applyPatch(o),L(t.code),S&&S.send({hashCode:o.newHash});return}return}t.timestamp&&(v=Date.now(),J=t.timestamp),t.name!==w&&(J=t.timestamp)}function K(e){return new Promise(n=>{setTimeout(()=>{n()},e)})}import de,{hydrateRoot as z,render as pe}from"https://spike.land/dist/react.mjs";function Z(e){let n=new Uint8Array(e.length);for(let a=0;a<n.length;a++)n[a]=e.charCodeAt(a);let t=new Uint16Array(n.buffer),o="";for(let a=0;a<t.length;a++)o+=String.fromCharCode(t[a]);return o}import{jsx as q}from"https://unpkg.com/@spike.land/esm@0.6.220/dist/emotion-react.mjs";window.React=de;var ve=async e=>{let n=await import(objectUrl),t=(await import(i(Z(e)))).default,o=document.querySelector("#zbody"),a=z(o,q(t));function i(r){let c=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(c)}},fe=async e=>{let n=location.pathname.split("/");window.aniStart=Date.now();let t=e||(n[1]==="api"&&n[2]==="room"?n[3]:(n.pop()||n.pop()).slice(-12))||"code-main",o=(self&&self.crypto&&self.crypto.randomUUID&&self.crypto.randomUUID()||(await import("./chunks/uidV4-5C2NDIGC.mjs")).default()).slice(0,8);if(location.pathname.includes("hydrate")){let a=(await import(`https://spike.land/api/room/${t}/js`)).default,i=(await import("./chunks/textdiff-create-ZT4L63UO.mjs")).default,r=document.querySelector("#zbody");window.aniStart=Date.now();let c=z(r,q(a));k(t,o);return}else(async()=>{let a=(await import(`https://spike.land/api/room/${t}/js`)).default,i=document.getElementById("zbody");if(pe(q(a),i),i){let r=(await import(`https://spike.land/api/room/${t}/js`)).default,{jsx:c}=await import("https://unpkg.com/@spike.land/esm@0.6.220/dist/emotion-react.mjs"),d=document.querySelector("#zbody");if(!d){if(d=document.getElementById("root"),!d)throw new Error;let y=await(await fetch(`https://spike.land/api/room/${t}/session`)).json();d.innerHTML=`<style>${y.css}</style><div id="zbody">${y.html}</div>`,d=document.querySelector("#zbody")}if(!d)throw new Error;z(d,c(r))}else{let c=await(await fetch(`https://spike.land/api/room/${t}/session`)).json();i=document.getElementById("root"),i.innerHTML=`<style>${c.css}</style><div id="zbody">${c.html}</div>`,i=document.getElementById("zbody")}})();k(t,o)};fe();export{ve as hydrateBinary,fe as run};
