import"./chunks/chunk-UT4UBVWW.mjs";import{jsx as Y}from"https://unpkg.com/@spike.land/esm@0.6.220/dist/emotion-react.mjs";var O,W,I;var j,q=async(e,n)=>(j=j||(await import("./chunks/session-KKRBFQ23.mjs")).default,j(e,n));async function Z(e){let n=document.querySelector("#monacoEditor"),{startMonaco:t}=await import("./chunks/editor-WJR5UIST.mjs"),a=(await import("./chunks/throttle-3WFK5HZS.mjs")).default,r=c=>H(o.getModel().getValue(),c.changes,e,++e.i),{editor:o,monaco:i}=await t({language:"typescript",container:n,code:e.code});o.onDidChangeModelContent(a(r,100)),window.monaco=i,e.editor=o,window.sess=e}async function ee({monaco:e,editor:n}){if(!e)return[{messageText:"Error with the error checking. Try to reload!"}];let t=n.getModel(),r=await(await e.languages.typescript.getTypeScriptWorker())(t),o=t.uri.toString(),i=r.getSemanticDiagnostics(o),c=r.getCompilerOptionsDiagnostics(o),d=r.getSyntacticDiagnostics(o),m=await Promise.race([i,c,d]);return console.log(m),[]}async function H(e,n=null,t,a){t.changes.push(n),O=O||(await import("./chunks/prettierEsm-KTD3QDBM.mjs")).formatter,I=I||(await import("./chunks/babelEsm-KXY4A2AB.mjs")).babelTransform,W=I,t.errorText="";try{let r=await O(e),o=await W(r),i=!1;if(o.length>0){if(a<t.i)return;try{let{getHtmlAndCss:d}=await import("./chunks/renderToString-ANXHPSTX.mjs");if(a<t.i)return;let m=await ne(o),{html:y,css:C}=d(m);t.transpiled=o,t.html=y;let l=await te(o);t.setChild(S=>[...S,l]),t.children=l,i=!y,t.code=r,t.codeNonFormatted=e;let p=r;if(t.css=C,t.i!==a)return;t.saveCode&&await t.saveCode({transpiled:o,code:p,i:a,css:C,html:y});return}catch(d){console.error("EXCEPTION"),console.log({e:d}),i=!0,console.error({restartError:i})}}if(t.i>a)return;let c=await ee(t);if(t.i>a)return;i&&c.push({messageText:"Error while starting the app. Check the console!"}),c.length>0&&console.log({err:c})}catch(r){t.errorText=r.message,console.error(r.message)}}async function B(e,n,t,a){e.saveCode=a,e.children=null;let{renderPreviewWindow:r}=await import("./chunks/renderPreviewWindow-4P3GBVLV.mjs");await r(e,n,t),t||await Z(e),e.update=o=>H(o,null,e),H(e.code,null,e,-1)}async function te(e,n="window"){let t=n==="window"?e.replace("body{","#zbody{"):e,a=F(t),r=await import(a);return URL.revokeObjectURL(a),Y(r.default)}function F(e){let n=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(n)}async function ne(e,n="window"){let t=n==="window"?e.replace("body{","#zbody{"):e,a=F(t),r=(await import(a)).default;return URL.revokeObjectURL(a),r}var D=null,N=!1,U=[],oe="spike.land",g={},J="",x="",b="",u="",M=0,T=0,f,L,X,A=!1,v;var w=null,_=()=>w.session.get("state"),P=null;setInterval(()=>{Date.now()-T>4e4?E():console.log("no_need_to_rejoin")},3e4);L=globalThis.chCode=async(e,n)=>{if(!!e&&!(n<window.sess.i)&&e!==window.sess.code)try{window.sess&&window.sess.editor?window.sess.editor.getModel().setValue(e):window.sess.update(e)}catch(t){console.error({e:t})}};async function E(){if(!A){A=!0,D=null;let e=Date.now()-X;e<1e4&&await new Promise(n=>setTimeout(n,1e4-e)),k()}}async function G({code:e,transpiled:n,html:t,css:a,i:r}){if(v){let o=Date.now();if(g.i=r,g.lastRtcUpdate){let d=o-g.lastUpdate;if(d<1e3&&(await V(200-d),r!==g.i))return}g.lastRtcUpdate=Date.now();let i=_().toJSON();i.html=t,i.css=a,i.transpiled=n,i.code=e,i.i=r;let c=x?w.createPatchFromHashCode(x,i):w.createPatch(i);c&&c.patch!==""&&v.send(c)}if(D){let o=Date.now();if(g.i=r,g.lastUpdate){let m=o-g.lastUpdate;if(m<1e3&&(await V(1e3-m),r!==g.i))return}g.lastUpdate=Date.now();let i=_().toJSON();i.html=t,i.css=a,i.transpiled=n,i.code=e,i.i=r;let c=J?w.createPatchFromHashCode(J,i):w.createPatch(i);if(!c)return;let d=JSON.stringify({...c,name:u});c.patch!==""&&D.send(d)}}var k=async(e,n,t)=>{b=b||e||"code-main",window.room=e,n&&(u=n);let r=await(await fetch(`https://spike.land/api/room/${b}/session`)).json();if(w=w||await q(b,{name:u,room:b,state:r,events:[]}),window.mySession=w,!t&&!window.sess){let o={..._().toJSON(),setChild:()=>{},changes:[],children:[null],errorText:""},i=(await import("./chunks/throttle-3WFK5HZS.mjs")).default,c=location.pathname.endsWith("public");B(o,b,c,i(G,100)),window.sess=o}N||(N=!0,setTimeout(()=>{N=!1},1e4),f=new WebSocket("wss://"+oe+"/api/room/"+b+"/websocket"),A=!1,X=Date.now(),f.addEventListener("open",()=>{P?clearInterval(P):P=setInterval(()=>{let o=Date.now(),i=o-T;if(o-T>3e4)try{f.send(JSON.stringify({name:u,time:M+i}))}catch(c){E()}},3e4),D=f,globalThis.broad=G,globalThis.chCode=L,f.send(JSON.stringify({name:u}))}),f.addEventListener("message",o=>z(o,"ws")),f.addEventListener("close",o=>{console.log("WebSocket closed, reconnecting:",o.code,o.reason),E()}),f.addEventListener("error",o=>{console.log("WebSocket error, reconnecting:",o),E()}))},$=window.location.hostname;$||($="localhost");h("Hostname: "+$);var s={};globalThis.connections=s;function h(e){let n=new Date;console.log("["+n.toLocaleTimeString()+"] "+e)}function ae(e){let n=new Date;console.trace("["+n.toLocaleTimeString()+"] "+e)}async function K(e){h("Setting up a connection...");let n={iceServers:["stun3.l.google.com:19302"].map(l=>({urls:`stun:${l}`}))};n.iceServers=[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}],s[e]=s[e]||new RTCPeerConnection(n),s[e].onicecandidate=d,s[e].oniceconnectionstatechange=m,s[e].onicegatheringstatechange=C,s[e].onsignalingstatechange=y,s[e].onnegotiationneeded=i,s[e].ontrack=c,s[e].addEventListener("datachannel",r);let t={ordered:!0,reliable:!0,maxPacketLifeTime:3e3},a=s[e].createDataChannel(e,t);return a.binaryType="arraybuffer",a.addEventListener("message",l=>{console.log("***********RTC***",{msg:l});let p=JSON.parse(l.data);return p&&p.hashCode&&(x=p.hashCode),p&&p.newHash&&(x=p.newHash),z(l,"rtc")}),a.addEventListener("error",l=>{console.log("xxxxxx-  Data Channel Error:",l)}),a.addEventListener("open",()=>{console.log("@@@@@@@@RTC IS OPEN&&&&&&&&"),a.target=e,U.push(a),s[e].sendChannel=a,window.sendChannel=v={send:l=>{let p=l.target;l.name=l.name||u;let S=JSON.stringify(l);U.map(R=>R.readyState==="open"&&(!p||p&&R.target===p)&&R.send(S))}}}),a.addEventListener("close",()=>{console.log("xxxxxxxx- The Data Channel is Closed")}),s[e];function r(l){console.log("Receive Channel Callback");let p=l.channel;p.binaryType="arraybuffer",p.addEventListener("close",o),p.addEventListener("message",S=>z(S,"rtc")),U.push(p)}function o(){console.log("Receive channel is closed"),s[e].close(),s[e]=null,console.log("Closed remote peer connection")}async function i(){h("*** Negotiation needed");try{h("---> Creating offer");let l=await s[e].createOffer();if(s[e].signalingState!="stable"){h("     -- The connection isn't stable yet; postponing...");return}h("---> Setting local description to the offer"),await s[e].setLocalDescription(l),h("---> Sending the offer to the remote peer"),f.send(JSON.stringify({target:e,name:u,type:"video-offer",sdp:s[e].localDescription}))}catch(l){h("*** The following error occurred while handling the negotiationneeded event:")}}function c(l){h("*** Track event"),document.querySelector("#received_video").srcObject=l.streams[0],document.querySelector("#hangup-button").disabled=!1}function d(l){l.candidate&&(h("*** Outgoing ICE candidate: "+l.candidate),f.send(JSON.stringify({type:"new-ice-candidate",target:e,name:u,candidate:l.candidate})))}function m(){switch(h("*** ICE connection state changed to "+s[e].iceConnectionState),s[e].iceConnectionState){case"closed":case"failed":case"disconnected":break}}function y(){switch(h("*** connections[target].signalingState  changed to: "+s[e].signalingState),s[e].signalingState){case"closed":break}}function C(){h("*** connections[target].iceGatheringState changed to: "+s[e].iceGatheringState)}}async function ie(e,n){h("*** Adding received ICE candidate: "+JSON.stringify(e.candidate));let t=new RTCIceCandidate(e.candidate);console.log(s[n]),await s[n].addIceCandidate(t)}async function se(e,n){h("*** Call recipient has accepted our call");let t=new RTCSessionDescription(e.sdp);await s[n].setRemoteDescription(t).catch(console.error)}async function re(e,n){s[n]||await K(n);let t=new RTCSessionDescription(e.sdp);if(s[n].signalingState!="stable"){h("  - But the signaling state isn't stable, so triggering rollback"),await Promise.all([s[n].setLocalDescription({type:"rollback"}),s[n].setRemoteDescription(t)]);return}h("  - Setting remote description"),await s[n].setRemoteDescription(t),h("---> Creating and sending answer to caller"),await s[n].setLocalDescription(await s[n].createAnswer()),f.send(JSON.stringify({target:n,name:u,type:"video-answer",sdp:s[n].localDescription}))}async function z(e,n){T=Date.now();let t=JSON.parse(e.data);if(t.name&&t.name!==u&&!s[t.name])try{await K(t.name)}catch(a){console.log({e:a}),ae("Error with p2p")}if(console.log(n,t.name),t.type==="new-ice-candidate"){await ie(t,t.name);return}if(t.type==="video-offer"){await re(t,t.name);return}if(t.type==="video-answer"){await se(t,t.name);return}if(n===f&&t.hashCode&&(J=t.hashCode),t.patch&&n==="ws"||t.name!==u){if(t.newHash===w.hashCode())return;if(t.oldHash===w.hashCode()){w.applyPatch(t),L(w.session.get("state").code,w.session.get("state").i),v&&v.send({hashCode:t.newHash});return}if(t.newHash===w.hashCode())return;if(t.code&&t.transpiled){let a=w.createPatch(t);w.applyPatch(a),L(t.code),v&&v.send({hashCode:a.newHash});return}return}t.timestamp&&(T=Date.now(),M=t.timestamp),t.name!==u&&(M=t.timestamp)}function V(e){return new Promise(n=>{setTimeout(()=>{n()},e)})}import Q,{hydrateRoot as ce,render as le}from"https://spike.land/dist/react.mjs";import{jsx as de}from"https://unpkg.com/@spike.land/esm@0.6.220/dist/emotion-react.mjs";window.React=Q;var ye=async e=>{let n=location.pathname.split("/");window.aniStart=Date.now();let t=e||(n[1]==="api"&&n[2]==="room"?n[3]:(n.pop()||n.pop()).slice(-12))||"code-main",a=(self&&self.crypto&&self.crypto.randomUUID&&self.crypto.randomUUID()||(await import("./chunks/uidV4-5C2NDIGC.mjs")).default()).slice(0,8);if(location.pathname.includes("hydrate")){let r=(await import(`https://spike.land/api/room/${t}/js`)).default,o=(await import("./chunks/textdiff-create-ZT4L63UO.mjs")).default,{jsx:i}=await import("https://unpkg.com/@spike.land/esm@0.6.220/dist/emotion-react.mjs"),c=document.querySelector("#zbody");window.aniStart=Date.now();let d=ce(c,i(r));k(t,a,deltas);return}else(async()=>{let r=(await import(`https://spike.land/api/room/${t}/js`)).default,o=document.getElementById("zbody");if(le(de(r),o),!o){let c=await(await fetch(`https://spike.land/api/room/${t}/session`)).json();o=document.getElementById("root"),o.innerHTML=`<style>${c.css}</style><div id="zbody">${c.html}</div>`,o=document.getElementById("zbody")}if(deltas&&deltas.length){let i=o.innerHTML,c=0,d=i,m=deltas.length,y=(2e3-(Date.now()-window.aniStart))/deltas.length;console.log({animationLength:y});let C=setInterval(()=>{if(c>=deltas.length){clearInterval(C);return}let l=c%m;l===0&&(d=i),c++;let p=deltas[l];if(!p)return;let S=applyDelta(d,p);d=S,o.innerHTML=S},y)}else{let i=(await import(`https://spike.land/api/room/${t}/js`)).default,{jsx:c}=await import("https://unpkg.com/@spike.land/esm@0.6.220/dist/emotion-react.mjs"),d=document.querySelector("#zbody");if(!d){if(d=document.getElementById("root"),!d)throw new Error;let C=await(await fetch(`https://spike.land/api/room/${t}/session`)).json();d.innerHTML=`<style>${C.css}</style><div id="zbody">${C.html}</div>`,d=document.querySelector("#zbody")}if(!d)throw new Error;let{hydrateRoot:m}=Q;m(d,i)}})();k(t,a)};export{ye as run};
