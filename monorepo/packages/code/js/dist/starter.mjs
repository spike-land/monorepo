import"./chunks/chunk-UT4UBVWW.mjs";import{jsx as ie}from"https://spike.land/dist/emotion.mjs";var A,F,H;var j,z=async(e,n)=>(j=j||(await import("./chunks/session-CCASTQL4.mjs")).default,j(e,n));async function re(e){let n=document.querySelector("#monacoEditor"),{startMonaco:t}=await import("./chunks/editor-FTGNJWFW.mjs"),o=(await import("./chunks/throttle-3WFK5HZS.mjs")).default,a=l=>I(r.getModel().getValue(),l.changes,e,++e.i),{editor:r,monaco:s}=await t({language:"typescript",container:n,code:e.code});r.onDidChangeModelContent(o(a,100)),window.monaco=s,e.editor=r,window.sess=e}async function se({monaco:e,editor:n}){if(!e)return[{messageText:"Error with the error checking. Try to reload!"}];let t=n.getModel(),a=await(await e.languages.typescript.getTypeScriptWorker())(t),r=t.uri.toString(),s=a.getSemanticDiagnostics(r),l=a.getCompilerOptionsDiagnostics(r),u=a.getSyntacticDiagnostics(r),y=await Promise.race([s,l,u]);return console.log(y),[]}async function I(e,n=null,t,o){t.changes.push(n),A=A||(await import("./chunks/prettierEsm-KTD3QDBM.mjs")).formatter,H=H||(await import("./chunks/babelEsm-YWR7I5FV.mjs")).babelTransform,F=H,t.errorText="";try{let a=await A(e),r=await F(a),s=!1;if(r.length>0){if(o<t.i)return;try{let{getHtmlAndCss:u}=await import("./chunks/renderToString-I5QETCLJ.mjs");if(o<t.i)return;let y=await le(r),{html:b,css:D}=u(y);t.transpiled=r,t.html=b;let c=await ce(r);t.setChild(v=>[...v,c]),t.children=c,s=!b,t.code=a,t.codeNonFormatted=e;let f=a;if(t.css=D,t.i!==o)return;t.saveCode&&await t.saveCode({transpiled:r,code:f,i:o,css:D,html:b});return}catch(u){console.error("EXCEPTION"),console.log({e:u}),s=!0,console.error({restartError:s})}}if(t.i>o)return;let l=await se(t);if(t.i>o)return;s&&l.push({messageText:"Error while starting the app. Check the console!"}),l.length>0&&console.log({err:l})}catch(a){t.errorText=a.message,console.error(a.message)}}async function G(e,n,t,o){e.saveCode=o,e.children=null;let{renderPreviewWindow:a}=await import("./chunks/renderPreviewWindow-ADK5LPS6.mjs");await a(e,n,t),t||await re(e),e.update=r=>I(r,null,e),I(e.code,null,e,-1)}async function ce(e,n="window"){let t=n==="window"?e.replace("body{","#zbody{"):e,o=X(t),a=await import(o);return URL.revokeObjectURL(o),ie(a.default)}function X(e){let n=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(n)}async function le(e,n="window"){let t=n==="window"?e.replace("body{","#zbody{"):e,o=X(t),a=(await import(o)).default;return URL.revokeObjectURL(o),a}var L=null,P=!1,J=[],de="spike.land",g={},B="",U="",C="",w="",M=0,E=0,m,k,Y,T=!1,S;var h=null,V=()=>h.session.get("state"),_=null;setInterval(()=>{Date.now()-E>4e4?R():console.log("no_need_to_rejoin")},3e4);k=globalThis.chCode=async(e,n)=>{if(!!e&&!(n<window.sess.i)&&e!==window.sess.code)try{window.sess&&window.sess.editor?window.sess.editor.getModel().setValue(e):window.sess.update(e)}catch(t){console.error({e:t})}};async function R(){if(!T){T=!0,L=null;let e=Date.now()-Y;e<1e4&&await new Promise(n=>setTimeout(n,1e4-e)),$()}}async function K({code:e,transpiled:n,html:t,css:o,i:a}){if(S){let r=Date.now();if(g.i=a,g.lastRtcUpdate){let u=r-g.lastUpdate;if(u<1e3&&(await Q(200-u),a!==g.i))return}g.lastRtcUpdate=Date.now();let s=V().toJSON();s.html=t,s.css=o,s.transpiled=n,s.code=e,s.i=a;let l=U?h.createPatchFromHashCode(U,s):h.createPatch(s);l&&l.patch!==""&&S.send(l)}if(L){let r=Date.now();if(g.i=a,g.lastUpdate){let y=r-g.lastUpdate;if(y<1e3&&(await Q(1e3-y),a!==g.i))return}g.lastUpdate=Date.now();let s=V().toJSON();s.html=t,s.css=o,s.transpiled=n,s.code=e,s.i=a;let l=B?h.createPatchFromHashCode(B,s):h.createPatch(s);if(!l)return;let u=JSON.stringify({...l,name:w});l.patch!==""&&L.send(u)}}var $=async(e,n,t)=>{if(C=C||e||"code-main",window.room=e,n&&(w=n),T)return;T=!0;let a=await(await fetch(`https://spike.land/api/room/${C}/session`)).json();if(h=h||await z(C,{name:w,room:C,state:a,events:[]}),window.mySession=h,!t&&!window.sess){let r={...V().toJSON(),setChild:()=>{},changes:[],children:[globalThis.App],errorText:""},s=(await import("./chunks/throttle-3WFK5HZS.mjs")).default,l=location.pathname.endsWith("public");G(r,C,l,s(K,100)),window.sess=r}P||(P=!0,setTimeout(()=>{P=!1},1e4),m=new WebSocket("wss://"+de+"/api/room/"+C+"/websocket"),T=!1,Y=Date.now(),m.addEventListener("open",()=>{_?clearInterval(_):_=setInterval(()=>{let r=Date.now(),s=r-E;if(r-E>3e4)try{m.send(JSON.stringify({name:w,time:M+s}))}catch(l){R()}},3e4),L=m,globalThis.broad=K,globalThis.chCode=k,m.send(JSON.stringify({name:w}))}),m.addEventListener("message",r=>q(r,"ws")),m.addEventListener("close",r=>{console.log("WebSocket closed, reconnecting:",r.code,r.reason),R()}),m.addEventListener("error",r=>{console.log("WebSocket error, reconnecting:",r),R()}))},W=window.location.hostname;W||(W="localhost");d("Hostname: "+W);var i={};globalThis.connections=i;function d(e){let n=new Date;console.log("["+n.toLocaleTimeString()+"] "+e)}function fe(e){let n=new Date;console.trace("["+n.toLocaleTimeString()+"] "+e)}async function Z(e){d("Setting up a connection...");let n={iceServers:["stun3.l.google.com:19302"].map(c=>({urls:`stun:${c}`}))};n.iceServers=[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}],i[e]=i[e]||new RTCPeerConnection(n),i[e].onicecandidate=u,i[e].oniceconnectionstatechange=y,i[e].onicegatheringstatechange=D,i[e].onsignalingstatechange=b,i[e].onnegotiationneeded=s,i[e].ontrack=l,i[e].addEventListener("datachannel",a);let t={ordered:!0,reliable:!0,maxPacketLifeTime:3e3},o=i[e].createDataChannel(e,t);return o.binaryType="arraybuffer",o.addEventListener("message",c=>{console.log("***********RTC***",{msg:c});let f=JSON.parse(c.data);return f&&f.hashCode&&(U=f.hashCode),f&&f.newHash&&(U=f.newHash),q(c,"rtc")}),o.addEventListener("error",c=>{console.log("xxxxxx-  Data Channel Error:",c)}),o.addEventListener("open",()=>{console.log("@@@@@@@@RTC IS OPEN&&&&&&&&"),o.target=e,J.push(o),i[e].sendChannel=o,window.sendChannel=S={send:c=>{let f=c.target;c.name=c.name||w;let v=JSON.stringify(c);J.map(N=>N.readyState==="open"&&(!f||f&&N.target===f)&&N.send(v))}}}),o.addEventListener("close",()=>{console.log("xxxxxxxx- The Data Channel is Closed")}),i[e];function a(c){console.log("Receive Channel Callback");let f=c.channel;f.binaryType="arraybuffer",f.addEventListener("close",r),f.addEventListener("message",v=>q(v,"rtc")),J.push(f)}function r(){console.log("Receive channel is closed"),i[e].close(),i[e]=null,console.log("Closed remote peer connection")}async function s(){d("*** Negotiation needed");try{d("---> Creating offer");let c=await i[e].createOffer();if(i[e].signalingState!="stable"){d("     -- The connection isn't stable yet; postponing...");return}d("---> Setting local description to the offer"),await i[e].setLocalDescription(c),d("---> Sending the offer to the remote peer"),m.send(JSON.stringify({target:e,name:w,type:"video-offer",sdp:i[e].localDescription}))}catch(c){d("*** The following error occurred while handling the negotiationneeded event:")}}function l(c){d("*** Track event"),document.querySelector("#received_video").srcObject=c.streams[0],document.querySelector("#hangup-button").disabled=!1}function u(c){c.candidate&&(d("*** Outgoing ICE candidate: "+c.candidate),m.send(JSON.stringify({type:"new-ice-candidate",target:e,name:w,candidate:c.candidate})))}function y(){switch(d("*** ICE connection state changed to "+i[e].iceConnectionState),i[e].iceConnectionState){case"closed":case"failed":case"disconnected":break}}function b(){switch(d("*** connections[target].signalingState  changed to: "+i[e].signalingState),i[e].signalingState){case"closed":break}}function D(){d("*** connections[target].iceGatheringState changed to: "+i[e].iceGatheringState)}}async function pe(e,n){d("*** Adding received ICE candidate: "+JSON.stringify(e.candidate));let t=new RTCIceCandidate(e.candidate);console.log(i[n]),await i[n].addIceCandidate(t)}async function he(e,n){d("*** Call recipient has accepted our call");let t=new RTCSessionDescription(e.sdp);await i[n].setRemoteDescription(t).catch(console.error)}async function ue(e,n){i[n]||await Z(n);let t=new RTCSessionDescription(e.sdp);if(i[n].signalingState!="stable"){d("  - But the signaling state isn't stable, so triggering rollback"),await Promise.all([i[n].setLocalDescription({type:"rollback"}),i[n].setRemoteDescription(t)]);return}d("  - Setting remote description"),await i[n].setRemoteDescription(t),d("---> Creating and sending answer to caller"),await i[n].setLocalDescription(await i[n].createAnswer()),m.send(JSON.stringify({target:n,name:w,type:"video-answer",sdp:i[n].localDescription}))}async function q(e,n){E=Date.now();let t=JSON.parse(e.data);if(t.name&&t.name!==w&&!i[t.name])try{await Z(t.name)}catch(o){console.log({e:o}),fe("Error with p2p")}if(console.log(n,t.name),t.type==="new-ice-candidate"){await pe(t,t.name);return}if(t.type==="video-offer"){await ue(t,t.name);return}if(t.type==="video-answer"){await he(t,t.name);return}if(n===m&&t.hashCode&&(B=t.hashCode),t.patch&&n==="ws"||t.name!==w){if(t.newHash===h.hashCode())return;if(t.oldHash===h.hashCode()){h.applyPatch(t),k(h.session.get("state").code,h.session.get("state").i),S&&S.send({hashCode:t.newHash});return}if(t.newHash===h.hashCode())return;if(t.code&&t.transpiled){let o=h.createPatch(t);h.applyPatch(o),k(t.code),S&&S.send({hashCode:o.newHash});return}return}t.timestamp&&(E=Date.now(),M=t.timestamp),t.name!==w&&(M=t.timestamp)}function Q(e){return new Promise(n=>{setTimeout(()=>{n()},e)})}import Se,{hydrate as be}from"https://spike.land/dist/react.mjs";function ee(e){let n=new Uint8Array(e.length);for(let a=0;a<n.length;a++)n[a]=e.charCodeAt(a);let t=new Uint16Array(n.buffer),o="";for(let a=0;a<t.length;a++)o+=String.fromCharCode(t[a]);return o}import{jsx as ve}from"https://spike.land/dist/emotion.mjs";var O,me=new Uint8Array(16);function we(){if(!O&&(O=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!O))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return O(me)}var ge=/^(?:[\da-f]{8}-[\da-f]{4}-[1-5][\da-f]{3}-[89ab][\da-f]{3}-[\da-f]{12}|0{8}-(?:0{4}-){3}0{12})$/i;function ye(e){return typeof e=="string"&&ge.test(e)}var p=[];for(let e=0;e<256;++e)p.push((e+256).toString(16).slice(1));function Ce(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,t=(p[e[n+0]]+p[e[n+1]]+p[e[n+2]]+p[e[n+3]]+"-"+p[e[n+4]]+p[e[n+5]]+"-"+p[e[n+6]]+p[e[n+7]]+"-"+p[e[n+8]]+p[e[n+9]]+"-"+p[e[n+10]]+p[e[n+11]]+p[e[n+12]]+p[e[n+13]]+p[e[n+14]]+p[e[n+15]]).toLowerCase();if(!ye(t))throw new TypeError("Stringified UUID is invalid");return t}function te(e,n,t){e=e||{};let o=e.random||(e.rng||we)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,n){t=t||0;for(let a=0;a<16;++a)n[t+a]=o[a];return n}return Ce(o)}window.React=Se;var x=location.pathname.split("/");window.aniStart=Date.now();var ne=(x[1]==="api"&&x[2]==="room"?x[3]:(x.pop()||x.pop()).slice(-12))||"code-main",Te=(self&&self.crypto&&self.crypto.randomUUID&&self.crypto.randomUUID()||te()).slice(0,8),oe=e=>{let n=document.querySelector("#root");be(n,ve(e)),globalThis.App=e,$(ne,Te)},je=async e=>{let n=(await import(ae(ee(e)))).default;oe(n)},Ie=async()=>{if(globalThis.App)return;let n=await(await fetch(`https://spike.land/api/room/${ne}/session`)).json(),t=document.getElementById("root");t.innerHTML=`<style>${n.css}</style><div id="zbody">${n.html}</div>`;let o=(await import(ae(n.transpiled))).default;oe(o)};function ae(e){let n=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(n)}export{je as hydrateBinary,Ie as run};
