import{a as N,b as k}from"./chunk-R25N5FFR.mjs";var T=null,x=!1,R=[],G="spike.land",m={},H="",E="",g="",h="",J=0,b=0,f,D=null,A,y=!1,C=null;var r=null,P=()=>r.session.get("state"),I=null;setInterval(()=>{Date.now()-b>4e4?(y=!1,v()):console.log("no_need_to_rejoin")},3e4);D=globalThis.chCode=async(e,t)=>{if(!!e&&!(t<window.sess.i)&&e!==window.sess.code)try{window.sess&&window.sess.editor?window.sess.editor.getModel().setValue(e):window.sess.update(e)}catch(n){console.error({e:n})}};async function v(){if(!y){T=null;let e=Date.now()-A;e<1e4&&await new Promise(t=>setTimeout(t,1e4-e)),$()}}async function U({code:e,transpiled:t,html:n,css:c,i:w}){if(C){let u=Date.now();if(m.i=w,m.lastRtcUpdate){let p=u-m.lastUpdate;if(p<1e3&&(await W(200-p),w!==m.i))return}m.lastRtcUpdate=Date.now();let s=P().toJSON();s.html=n,s.css=c,s.transpiled=t,s.code=e,s.i=w;let d=E?r.createPatchFromHashCode(E,s):r.createPatch(s);d&&d.patch!==""&&C.send(d)}if(T){let u=Date.now();if(m.i=w,m.lastUpdate){let S=u-m.lastUpdate;if(S<1e3&&(await W(1e3-S),w!==m.i))return}m.lastUpdate=Date.now();let s=P().toJSON();s.html=n,s.css=c,s.transpiled=t,s.code=e,s.i=w;let d=H?r.createPatchFromHashCode(H,s):r.createPatch(s);if(!d)return;let p=JSON.stringify(k(N({},d),{name:h}));d.patch!==""&&T.send(p)}}var $=async(e,t,n)=>{if(g=g||e||"code-main",window.room=e,t&&(h=t),y)return;y=!0;let w=await(await fetch(`https://spike.land/api/room/${g}/session`)).json(),{startSession:u}=await import("./session-FG4MNTSV.mjs");if(r=r||await u(g,{name:h,room:g,state:w,events:[]}),window.mySession=r,!n&&!window.sess){let s=k(N({},P().toJSON()),{setChild:()=>{},changes:[],children:[globalThis.App],errorText:""}),d=(await import("./throttle-3UFZGZBD.mjs")).default,p=location.pathname.endsWith("public"),{quickStart:S}=await import("./quickStart-2T3AD6EW.mjs");S(s,g,p,d(U,100)),window.sess=s}x||(x=!0,setTimeout(()=>{x=!1},1e4),f=new WebSocket("wss://"+G+"/api/room/"+g+"/websocket"),y=!1,A=Date.now(),f.addEventListener("open",()=>{I?clearInterval(I):I=setInterval(()=>{let s=Date.now(),d=s-b;if(s-b>3e4)try{f.send(JSON.stringify({name:h,time:J+d}))}catch(p){v()}},3e4),T=f,globalThis.broad=U,globalThis.chCode=D,f.send(JSON.stringify({name:h}))}),f.addEventListener("message",s=>j(s,"ws")),f.addEventListener("close",s=>{console.log("WebSocket closed, reconnecting:",s.code,s.reason),v()}),f.addEventListener("error",s=>{console.log("WebSocket error, reconnecting:",s),v()}))},_=window.location.hostname;_||(_="localhost");i("Hostname: "+_);var o={};globalThis.connections=o;function i(e){let t=new Date;console.log("["+t.toLocaleTimeString()+"] "+e)}function B(e){let t=new Date;console.trace("["+t.toLocaleTimeString()+"] "+e)}async function M(e){i("Setting up a connection...");let t={iceServers:["stun3.l.google.com:19302"].map(a=>({urls:`stun:${a}`}))};t.iceServers=[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}],o[e]=o[e]||new RTCPeerConnection(t),o[e].onicecandidate=p,o[e].oniceconnectionstatechange=S,o[e].onicegatheringstatechange=F,o[e].onsignalingstatechange=q,o[e].onnegotiationneeded=s,o[e].ontrack=d,o[e].addEventListener("datachannel",w);let n={ordered:!0,reliable:!0,maxPacketLifeTime:3e3},c=o[e].createDataChannel(e,n);return c.binaryType="arraybuffer",c.addEventListener("message",a=>{console.log("***********RTC***",{msg:a});let l=JSON.parse(a.data);return l&&l.hashCode&&(E=l.hashCode),l&&l.newHash&&(E=l.newHash),j(a,"rtc")}),c.addEventListener("error",a=>{console.log("xxxxxx-  Data Channel Error:",a)}),c.addEventListener("open",()=>{console.log("@@@@@@@@RTC IS OPEN&&&&&&&&"),c.target=e,R.push(c),o[e].sendChannel=c,window.sendChannel=C={send:a=>{let l=a.target;a.name=a.name||h;let O=JSON.stringify(a);R.map(L=>L.readyState==="open"&&(!l||l&&L.target===l)&&L.send(O))}}}),c.addEventListener("close",()=>{console.log("xxxxxxxx- The Data Channel is Closed")}),o[e];function w(a){console.log("Receive Channel Callback");let l=a.channel;l.binaryType="arraybuffer",l.addEventListener("close",u),l.addEventListener("message",O=>j(O,"rtc")),R.push(l)}function u(){console.log("Receive channel is closed"),o[e].close(),o[e]=null,console.log("Closed remote peer connection")}async function s(){i("*** Negotiation needed");try{i("---> Creating offer");let a=await o[e].createOffer();if(o[e].signalingState!="stable"){i("     -- The connection isn't stable yet; postponing...");return}i("---> Setting local description to the offer"),await o[e].setLocalDescription(a),i("---> Sending the offer to the remote peer"),f.send(JSON.stringify({target:e,name:h,type:"video-offer",sdp:o[e].localDescription}))}catch(a){i("*** The following error occurred while handling the negotiationneeded event:")}}function d(a){i("*** Track event"),document.querySelector("#received_video").srcObject=a.streams[0],document.querySelector("#hangup-button").disabled=!1}function p(a){a.candidate&&(i("*** Outgoing ICE candidate: "+a.candidate),f.send(JSON.stringify({type:"new-ice-candidate",target:e,name:h,candidate:a.candidate})))}function S(){switch(i("*** ICE connection state changed to "+o[e].iceConnectionState),o[e].iceConnectionState){case"closed":case"failed":case"disconnected":break}}function q(){switch(i("*** connections[target].signalingState  changed to: "+o[e].signalingState),o[e].signalingState){case"closed":break}}function F(){i("*** connections[target].iceGatheringState changed to: "+o[e].iceGatheringState)}}async function V(e,t){i("*** Adding received ICE candidate: "+JSON.stringify(e.candidate));let n=new RTCIceCandidate(e.candidate);console.log(o[t]),await o[t].addIceCandidate(n)}async function z(e,t){i("*** Call recipient has accepted our call");let n=new RTCSessionDescription(e.sdp);await o[t].setRemoteDescription(n).catch(console.error)}async function K(e,t){o[t]||await M(t);let n=new RTCSessionDescription(e.sdp);if(o[t].signalingState!="stable"){i("  - But the signaling state isn't stable, so triggering rollback"),await Promise.all([o[t].setLocalDescription({type:"rollback"}),o[t].setRemoteDescription(n)]);return}i("  - Setting remote description"),await o[t].setRemoteDescription(n),i("---> Creating and sending answer to caller"),await o[t].setLocalDescription(await o[t].createAnswer()),f.send(JSON.stringify({target:t,name:h,type:"video-answer",sdp:o[t].localDescription}))}async function j(e,t){console.log(t,{event:e}),b=Date.now();let n=JSON.parse(e.data);if(n.name&&n.name!==h&&!o[n.name])try{await M(n.name)}catch(c){console.log({e:c}),B("Error with p2p")}if(console.log(t,n.name),n.type==="new-ice-candidate"){await V(n,n.name);return}if(n.type==="video-offer"){await K(n,n.name);return}if(n.type==="video-answer"){await z(n,n.name);return}if(t==="ws"&&n.hashCode&&(H=n.hashCode),n.patch&&t==="ws"||n.name!==h){if(n.newHash===r.hashCode())return;if(n.oldHash===r.hashCode()){r.applyPatch(n),D(r.session.get("state").code,r.session.get("state").i),C&&C.send({hashCode:n.newHash});return}if(n.newHash===r.hashCode())return;if(n.code&&n.transpiled){let c=r.createPatch(n);r.applyPatch(c),D(n.code,n.i),C&&C.send({hashCode:c.newHash});return}return}n.timestamp&&(b=Date.now(),J=n.timestamp),n.name!==h&&(J=n.timestamp)}var W=e=>new Promise(t=>setTimeout(t,e));export{$ as join};
