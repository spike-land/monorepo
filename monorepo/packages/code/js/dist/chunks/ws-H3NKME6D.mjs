import{a as O,b as k}from"./chunk-AH6KKUH7.mjs";var T=null,x=!1,R=[],G="spike.land",p={},J="",E="",g="",f="",P=0,b=0,h,D,A,y=!1,C;var r=null,I=()=>r.session.get("state"),H=null;setInterval(()=>{Date.now()-b>4e4?v():console.log("no_need_to_rejoin")},3e4);D=globalThis.chCode=async(e,t)=>{if(!!e&&!(t<window.sess.i)&&e!==window.sess.code)try{window.sess&&window.sess.editor?window.sess.editor.getModel().setValue(e):window.sess.update(e)}catch(n){console.error({e:n})}};async function v(){if(!y){y=!0,T=null;let e=Date.now()-A;e<1e4&&await new Promise(t=>setTimeout(t,1e4-e)),$()}}async function U({code:e,transpiled:t,html:n,css:c,i:w}){if(C){let u=Date.now();if(p.i=w,p.lastRtcUpdate){let m=u-p.lastUpdate;if(m<1e3&&(await W(200-m),w!==p.i))return}p.lastRtcUpdate=Date.now();let o=I().toJSON();o.html=n,o.css=c,o.transpiled=t,o.code=e,o.i=w;let d=E?r.createPatchFromHashCode(E,o):r.createPatch(o);d&&d.patch!==""&&C.send(d)}if(T){let u=Date.now();if(p.i=w,p.lastUpdate){let S=u-p.lastUpdate;if(S<1e3&&(await W(1e3-S),w!==p.i))return}p.lastUpdate=Date.now();let o=I().toJSON();o.html=n,o.css=c,o.transpiled=t,o.code=e,o.i=w;let d=J?r.createPatchFromHashCode(J,o):r.createPatch(o);if(!d)return;let m=JSON.stringify(k(O({},d),{name:f}));d.patch!==""&&T.send(m)}}var $=async(e,t,n)=>{if(g=g||e||"code-main",window.room=e,t&&(f=t),y)return;y=!0;let w=await(await fetch(`https://spike.land/api/room/${g}/session`)).json(),{startSession:u}=await import("./session-4RPROM47.mjs");if(r=r||await u(g,{name:f,room:g,state:w,events:[]}),window.mySession=r,!n&&!window.sess){let o=k(O({},I().toJSON()),{setChild:()=>{},changes:[],children:[globalThis.App],errorText:""}),d=(await import("./throttle-Z6JZ56VC.mjs")).default,m=location.pathname.endsWith("public"),{quickStart:S}=await import("./quickStart-5LZIGEV4.mjs");S(o,g,m,d(U,100)),window.sess=o}x||(x=!0,setTimeout(()=>{x=!1},1e4),h=new WebSocket("wss://"+G+"/api/room/"+g+"/websocket"),y=!1,A=Date.now(),h.addEventListener("open",()=>{H?clearInterval(H):H=setInterval(()=>{let o=Date.now(),d=o-b;if(o-b>3e4)try{h.send(JSON.stringify({name:f,time:P+d}))}catch(m){v()}},3e4),T=h,globalThis.broad=U,globalThis.chCode=D,h.send(JSON.stringify({name:f}))}),h.addEventListener("message",o=>j(o,"ws")),h.addEventListener("close",o=>{console.log("WebSocket closed, reconnecting:",o.code,o.reason),v()}),h.addEventListener("error",o=>{console.log("WebSocket error, reconnecting:",o),v()}))},_=window.location.hostname;_||(_="localhost");i("Hostname: "+_);var a={};globalThis.connections=a;function i(e){let t=new Date;console.log("["+t.toLocaleTimeString()+"] "+e)}function B(e){let t=new Date;console.trace("["+t.toLocaleTimeString()+"] "+e)}async function M(e){i("Setting up a connection...");let t={iceServers:["stun3.l.google.com:19302"].map(s=>({urls:`stun:${s}`}))};t.iceServers=[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}],a[e]=a[e]||new RTCPeerConnection(t),a[e].onicecandidate=m,a[e].oniceconnectionstatechange=S,a[e].onicegatheringstatechange=F,a[e].onsignalingstatechange=q,a[e].onnegotiationneeded=o,a[e].ontrack=d,a[e].addEventListener("datachannel",w);let n={ordered:!0,reliable:!0,maxPacketLifeTime:3e3},c=a[e].createDataChannel(e,n);return c.binaryType="arraybuffer",c.addEventListener("message",s=>{console.log("***********RTC***",{msg:s});let l=JSON.parse(s.data);return l&&l.hashCode&&(E=l.hashCode),l&&l.newHash&&(E=l.newHash),j(s,"rtc")}),c.addEventListener("error",s=>{console.log("xxxxxx-  Data Channel Error:",s)}),c.addEventListener("open",()=>{console.log("@@@@@@@@RTC IS OPEN&&&&&&&&"),c.target=e,R.push(c),a[e].sendChannel=c,window.sendChannel=C={send:s=>{let l=s.target;s.name=s.name||f;let L=JSON.stringify(s);R.map(N=>N.readyState==="open"&&(!l||l&&N.target===l)&&N.send(L))}}}),c.addEventListener("close",()=>{console.log("xxxxxxxx- The Data Channel is Closed")}),a[e];function w(s){console.log("Receive Channel Callback");let l=s.channel;l.binaryType="arraybuffer",l.addEventListener("close",u),l.addEventListener("message",L=>j(L,"rtc")),R.push(l)}function u(){console.log("Receive channel is closed"),a[e].close(),a[e]=null,console.log("Closed remote peer connection")}async function o(){i("*** Negotiation needed");try{i("---> Creating offer");let s=await a[e].createOffer();if(a[e].signalingState!="stable"){i("     -- The connection isn't stable yet; postponing...");return}i("---> Setting local description to the offer"),await a[e].setLocalDescription(s),i("---> Sending the offer to the remote peer"),h.send(JSON.stringify({target:e,name:f,type:"video-offer",sdp:a[e].localDescription}))}catch(s){i("*** The following error occurred while handling the negotiationneeded event:")}}function d(s){i("*** Track event"),document.querySelector("#received_video").srcObject=s.streams[0],document.querySelector("#hangup-button").disabled=!1}function m(s){s.candidate&&(i("*** Outgoing ICE candidate: "+s.candidate),h.send(JSON.stringify({type:"new-ice-candidate",target:e,name:f,candidate:s.candidate})))}function S(){switch(i("*** ICE connection state changed to "+a[e].iceConnectionState),a[e].iceConnectionState){case"closed":case"failed":case"disconnected":break}}function q(){switch(i("*** connections[target].signalingState  changed to: "+a[e].signalingState),a[e].signalingState){case"closed":break}}function F(){i("*** connections[target].iceGatheringState changed to: "+a[e].iceGatheringState)}}async function V(e,t){i("*** Adding received ICE candidate: "+JSON.stringify(e.candidate));let n=new RTCIceCandidate(e.candidate);console.log(a[t]),await a[t].addIceCandidate(n)}async function z(e,t){i("*** Call recipient has accepted our call");let n=new RTCSessionDescription(e.sdp);await a[t].setRemoteDescription(n).catch(console.error)}async function K(e,t){a[t]||await M(t);let n=new RTCSessionDescription(e.sdp);if(a[t].signalingState!="stable"){i("  - But the signaling state isn't stable, so triggering rollback"),await Promise.all([a[t].setLocalDescription({type:"rollback"}),a[t].setRemoteDescription(n)]);return}i("  - Setting remote description"),await a[t].setRemoteDescription(n),i("---> Creating and sending answer to caller"),await a[t].setLocalDescription(await a[t].createAnswer()),h.send(JSON.stringify({target:t,name:f,type:"video-answer",sdp:a[t].localDescription}))}async function j(e,t){console.log(t,{event:e}),b=Date.now();let n=JSON.parse(e.data);if(n.name&&n.name!==f&&!a[n.name])try{await M(n.name)}catch(c){console.log({e:c}),B("Error with p2p")}if(console.log(t,n.name),n.type==="new-ice-candidate"){await V(n,n.name);return}if(n.type==="video-offer"){await K(n,n.name);return}if(n.type==="video-answer"){await z(n,n.name);return}if(t===h&&n.hashCode&&(J=n.hashCode),n.patch&&t==="ws"||n.name!==f){if(n.newHash===r.hashCode())return;if(n.oldHash===r.hashCode()){r.applyPatch(n),D(r.session.get("state").code,r.session.get("state").i),C&&C.send({hashCode:n.newHash});return}if(n.newHash===r.hashCode())return;if(n.code&&n.transpiled){let c=r.createPatch(n);r.applyPatch(c),D(n.code),C&&C.send({hashCode:c.newHash});return}return}n.timestamp&&(b=Date.now(),P=n.timestamp),n.name!==f&&(P=n.timestamp)}function W(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}export{$ as join};
