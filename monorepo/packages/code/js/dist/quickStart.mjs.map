{
  "version": 3,
  "sources": ["../quickStart.mjs"],
  "sourcesContent": ["import { jsx } from \"@emotion/react\";\n\nlet formatter;\nlet transform;\n\nlet esbuildEsmTransform;\n// Let esbuildTransform;\n// let babelTransform;\nlet getHtmlAndCss;\nlet initSess;\n\nexport const initSession = async (room, initData) => {\n  initSess = initSess || (await import(\"./dist/session.mjs\")).default;\n\n  return initSess(room, initData);\n};\n\nexport const prettier = async (code) => {\n  formatter = formatter || (await import(\"./formatter.mjs\")).formatter;\n  return await formatter(code);\n};\n\n// //\n\nexport async function startMonacoWithSession(session) {\n  const shadDom = document.querySelector(\"#shadowEditor\");\n\n  const startMonaco = (await import(\"./dist/startMonaco.mjs\")).default;\n  const throttle = (await import(\"lodash/throttle\")).default;\n  const onchangeCode = (code, changes) =>\n    runner(code, changes, session, ++session.i);\n  const getEditor = await startMonaco(\n    /**\n     * @param {any} code\n     */\n    {\n      language: \"typescript\",\n      container: shadDom,\n      code: session.code,\n      /**\n       * @param {string} code\n       */\n      onChange: throttle(onchangeCode, 100),\n    },\n  );\n\n  session.editor = getEditor();\n\n  const monaco = window.monaco;\n\n  monaco.languages.registerOnTypeFormattingEditProvider(\"typescript\", {\n    autoFormatTriggerCharacters: [\"}\", \"{\", \")\", \"(\", \";\"],\n\n    async provideOnTypeFormattingEdits(model) {\n      const text = await formatter(model.getValue());\n\n      return [\n        {\n          range: model.getFullModelRange(),\n\n          text,\n        },\n      ];\n    },\n  });\n\n  window.sess = session;\n  session.monaco = window.monaco;\n}\n\nasync function getErrors({ monaco, editor }) {\n  if (!monaco) {\n    return [{ messageText: \"Error with the error checking. Try to reload!\" }];\n  }\n\n  const model = editor.getModel();\n  const worker = await monaco.languages.typescript.getTypeScriptWorker();\n  const client = await worker(model);\n\n  const filename = model.uri.toString();\n  const diag = client.getSemanticDiagnostics(filename);\n  const comp = client.getCompilerOptionsDiagnostics(filename);\n  const syntax = client.getSyntacticDiagnostics(filename);\n  const fastError = await Promise.race([diag, comp, syntax]);\n\n  // Model.dispose();\n  console.log(fastError);\n  return [];\n}\n\n// Let getHtmlAndCss;\n\nasync function runner(c, changes = null, session, counter) {\n  // If (!esbuildEsmTransform || !formatter ) session.broad({...session, code: c, errorText: \"PRE\" })\n\n  session.changes.push(changes);\n  formatter = formatter || (await import(\"./formatter.mjs\")).formatter;\n  esbuildEsmTransform = esbuildEsmTransform ||\n    (await import(\"./esbuildEsm.mjs\")).transform;\n\n  transform = esbuildEsmTransform;\n\n  session.errorText = \"\";\n\n  const { monaco } = session;\n\n  try {\n    const cd = await formatter(c);\n\n    const transpiled = await transform(cd);\n\n    let restartError = false;\n    /// yellow\n    if (transpiled.length > 0) {\n      if (counter < session.i) {\n        return;\n      }\n\n      try {\n        getHtmlAndCss = getHtmlAndCss ||\n          (await import(\"./vendor/renderToString.mjs\")).getHtmlAndCss;\n\n        if (counter < session.i) {\n          return;\n        }\n\n        const App = await getApp(transpiled);\n        const { html, css } = getHtmlAndCss(App);\n\n        session.transpiled = transpiled;\n        session.html = html;\n\n        const children = await getReactChild(transpiled);\n\n        // Session.html = zbody.innerHTML;\n\n        session.setChild((c) => [...c, children]);\n        session.children = children;\n        restartError = !html;\n        session.code = cd;\n        session.codeNonFormatted = c;\n        // GetCss = getCss || (await import(\"./templates.ts\")).getCss;\n        // setTimeout(async () => {\n        //     session.html = document.getElementById(\"zbody\").innerHTML;\n        // const css = getCss(session);\n        const code = cd;\n        session.css = css;\n        if (session.i !== counter) {\n          return;\n        }\n\n        session.saveCode &&\n          await session.saveCode({ transpiled, code, i: counter, css, html });\n        monaco.editor.setTheme(\"vs-dark\");\n        // }, 10);\n\n        return;\n      } catch (error) {\n        console.error(\"EXCEPTION\");\n        console.log({ e: error });\n        restartError = true;\n        console.error({ restartError });\n      }\n    }\n\n    if (session.i > counter) {\n      return;\n    }\n\n    const error = await getErrors(session);\n    if (session.i > counter) {\n      return;\n    }\n\n    if (restartError) {\n      error.push(\n        { messageText: \"Error while starting the app. Check the console!\" },\n      );\n    }\n\n    if (error.length > 0) {\n      console.log({ err: error });\n    }\n\n    monaco.editor.setTheme(\"vs-dark\");\n  } catch (error) {\n    monaco.editor.setTheme(\"vs-light\");\n    setTimeout(() => {\n      monaco.editor.setTheme(\"hc-black\");\n    }, 50);\n    session.errorText = error.message;\n    console.error(error.message);\n  }\n}\n\nexport const startFromCode = async ({ code }) => {\n  const session = {\n    code,\n    i: 0,\n    changes: [],\n    saveCode: () => {},\n    setChild: () => {},\n  };\n  await runner(code, null, session);\n  await quickStart(session);\n};\n\nexport async function quickStart(session, room, keepFullScreen, saveCode) {\n  session.saveCode = saveCode;\n  // Session.children = await getReactChild(session.transpiled);\n  session.children = null;\n  const { renderPreviewWindow } = await import(\n    \"./dist/renderPreviewWindow.mjs\"\n  );\n\n  await renderPreviewWindow(session, room, keepFullScreen);\n\n  // If (localStorage && session) {\n  //   const { code, transpiled, html, css, i } = session;\n  //   localStorage.setItem(\n  //     `state-${session.room}`,\n  //     JSON.stringify({ code, transpiled, html, css, i }),\n  //   );\n  // }\n  // // document.getElementById(\"root\").remove();\n\n  if (!keepFullScreen) {\n    await startMonacoWithSession(session);\n  }\n\n  session.update = (c) => runner(c, null, session);\n  runner(session.code, null, session, -1);\n}\n\nasync function getReactChild(transpiled, mode = \"window\") {\n  const codeToHydrate = mode === \"window\"\n    ? transpiled.replace(\"body{\", \"#zbody{\")\n    : transpiled;\n\n  const objectUrl = createJsBlob(\n    codeToHydrate,\n  );\n\n  const mod = (await import(objectUrl));\n  URL.revokeObjectURL(objectUrl);\n\n  return jsx(mod.default);\n}\n\n// Function createPatch(oldCode, newCode, createDelta) {\n//   return JSON.stringify(createDelta(oldCode, newCode));\n// }\n\n/**\n * @param {BlobPart} code\n */\nfunction createJsBlob(code) {\n  const blob = new Blob([code], { type: \"application/javascript\" });\n\n  return URL.createObjectURL(blob);\n}\n\nasync function getApp(transpiled, mode = \"window\") {\n  const codeToHydrate = mode === \"window\"\n    ? transpiled.replace(\"body{\", \"#zbody{\")\n    : transpiled;\n\n  const objectUrl = createJsBlob(\n    codeToHydrate,\n  );\n\n  const App = (await import(objectUrl)).default;\n\n  URL.revokeObjectURL(objectUrl);\n\n  return App;\n}\n"],
  "mappings": "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",
  "names": []
}
