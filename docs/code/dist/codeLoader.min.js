import{importScript as E}from"../dist/importScript.js";import{starter as f}from"./starterNoFramerMotion.js";const i={firstLoad:!0,errorCode:"",code:""};function L(c="zbody",d){try{const m=document.getElementById(c),j=m.innerHTML;j.length>0&&(ReactDOM.unmountComponentAtNode(d),m.innerHTML=j)}catch(m){console.error("Error in un-mount",m)}}export async function run(c="window"){const{transpileCode:d}=await import("./transpile.js");if(i.code=await B(),c==="editor"){const{renderDraggableEditor:t}=await import("./DraggableEditor.js");await t()}if(c==="window"){const{renderDraggableWindow:t}=await import("./DraggableWindow.js"),{shareItAsHtml:e}=await import("./share.js");await t({onShare:async()=>{const a=await e({code:await d(i.code)});window.open(a)}})}const{getDB:m}=await import("../dist/shaDB.min.js"),{getUserId:j,getProjects:H,saveCode:b}=await import("./data.js"),S=await d(i.code);D(S);const{startMonaco:C}=await import("../dist/editor.min.js"),r=await C({language:"typescript",code:i.code,onChange:k});async function M(t){try{const e=await d(t);e.length&&D(e);const a=await v(t),n=document.getElementById("error");if(a.length===0)i.code=t,await b(t);else{i.error=t;const{diff:o}=await import("../dist/diff.min.js"),l=await o(i.code,t);if(l.c.length<=3){r.monaco.editor.setTheme("hc-black");return}n.innerHTML=a[0].messageText.toString(),n.style.display="block";return}n.style.display="none",r.monaco.editor.setTheme("vs-dark")}catch(e){r.monaco.editor.setTheme("vs-light"),setTimeout(()=>{r.monaco.editor.setTheme("hc-black")},50),console.error(e)}}function k(t){if(!r)return;window.requestAnimationFrame(()=>M(t))}async function v(t){if(!r||!r.monaco)return;const{monaco:e}=r,{sha256:a}=await import("./sha256.js"),n=await a(t),o=`file:///${n}.tsx`,l=e.Uri.parse(o),u=e.editor.getModel(l)||await e.editor.createModel(t,"typescript",l),g=await e.languages.typescript.getTypeScriptWorker(),w=await g(u.uri),s=w.getSemanticDiagnostics(o),p=w.getCompilerOptionsDiagnostics(o),h=w.getSyntacticDiagnostics(o),y=await Promise.race([s,p,h]);return u.dispose(),[...y]}await E("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js");function D(t){if(typeof t!="string"||t==="")return;let e=!1;const a=()=>{const n=c==="window"?t.replace("body{","#root{"):t;e&&L("zbody",e);const o=new Function("importScript",`return function(){  
          let DefaultElement;
          ${n}

          const root = document.createElement("div");
          
          root.innerHTML = ReactDOMServer.renderToString(jsx(DefaultElement));
          if(document.getElementById("zbody").children.length) {
            document.getElementById("zbody").children[0].remove();
          }
          document.getElementById("zbody").appendChild(root);

          hydrated = DefaultElement;
          setTimeout(async()=>{
            if (hydrated === DefaultElement){
              ReactDOM.hydrate(jsx(DefaultElement), root);
            }

          }, 500);

      }`)(E);setTimeout(()=>o())};a()}async function B(){const{getUserId:t,getProjects:e,saveCode:a}=await import("./data.js"),{getDB:n}=await import("../dist/shaDB.min.js"),o=await n(),l=await t(),u=await e(),g=u[0],w=new URLSearchParams(window.location.search),s=w.get("h")||await o.get(g);if(s){let p;try{p=await o.get(s)}catch{console.error("error load key: "+s)}if(p)return p;let h;try{const y=await fetch("https://code.zed.vision/?h="+s);h=await y.json()}catch(y){const{sha256:I}=await import("./sha256.js"),T=await I(f);return o.put(T,f),await o.put(g,T),f}return h}return f}function x(t,e){const a=new URLSearchParams(window.location.search);a.set(t,e),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${a}`))}}
