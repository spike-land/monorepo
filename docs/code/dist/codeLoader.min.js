import{openWindows as x}from"./openWindows.js";import{renderPreviewWindow as S}from"./renderPreviewWindow.js";import{sendSignalToQrCode as W}from"./sendSignalToQrCode.js";import{v as l}from"./versions.js";import{getCodeToLoad as z,saveCode as B}from"./data.js";async function u(s){const{transpileCode:m}=await import("./transpile.js");return m(s,!1)}function D(){return{unmount:()=>{},hydrated:!1,preRendered:!1,lastErrors:0,rootElement:null,div:window.document.createElement("div"),HTML:"",devtoolHash:"",ipfs:0,transpiled:"",code:""}}export async function run(s="window",m){await W();const{formatter:h}=await import("./formatter.js");await x(l);const{open:y}=m,t=D();try{const{code:e,transpiled:n,html:o,versions:i}=await z();t.code=e,t.transpiled=await u(e)||e,t.div.innerHTML=o}catch(e){console.error({e,message:"couldn't start"});return}t.transpiled=t.transpiled||await u(t.code);const{renderEmotion:g,jsx:T,DraggableWindow:v}=await import(l.emotionRenderer);await S(s,t,y,l,g,T,v),await P(w,t);const E=(await import(l.editor)).default,b=window.document.getElementById("editor"),a=await E({language:"typescript",container:b,code:t.code,onChange:e=>j(e)});async function j(e){const n=await h(e);try{const o=await u(n);if(t.transpiled===o&&o!=="")return;let i=!1;o.length&&t.lastErrors===0&&(i=await w(o));const r=await C(n);if(i&&r.push({messageText:"Error while starting the app. Check the console!"}),r.length&&console.log({err:r}),t.lastErrors&&r.length===0&&w(o),t.lastErrors=r.length,r.length===0&&o.length)t.code=await h(n),t.transpiled!==o&&(t.transpiled=o,B({code:t.code,transpiled:t.transpiled,html:t.HTML,versions:t.devtoolHash}));else{const{diff:c}=await import(`https://unpkg.com/@zedvision/shadb@${l.shadb}/src/diff.js`),d=await c(t.code,n);if(d.c.length<=3){t.lastErrors=0;return}if(d.c.length==4){t.lastErrors=0,a.monaco.editor.setTheme("hc-black");return}console.error(r[0].messageText.toString());return}a.monaco.editor.setTheme("vs-dark")}catch(o){a.monaco.editor.setTheme("vs-light"),setTimeout(()=>{a.monaco.editor.setTheme("hc-black")},50),console.error(o)}}async function C(e){if(!a||!a.monaco)return[{messageText:"Error with the error checking. Try to reload!"}];const{monaco:n}=a,{sha256:o}=await import(`https://unpkg.com/@zedvision/shadb@${l.shadb}/src/sha256.js`),r=`file:///${await o(e)}.tsx`,c=n.Uri.parse(r),d=n.editor.getModel(c)||await n.editor.createModel(e,"typescript",c),p=await(await n.languages.typescript.getTypeScriptWorker())(d.uri),k=p.getSemanticDiagnostics(r),H=p.getCompilerOptionsDiagnostics(r),L=p.getSyntacticDiagnostics(r),M=await Promise.race([k,H,L]);return d.dispose(),[...M]}async function w(e){t.HTML="";let n=!1;if(typeof e!="string"||e==="")return n=!0,n;const o=s==="window"?e.replace("body{","#zbody{"):e,i=window.document.createElement("div"),r=(await import(d(o))).default;t.unmount(),t.unmount=g(r(),i);const c=window.document.getElementById("zbody");return c&&c.children[0].replaceWith(i),t.HTML=t.div.innerHTML,!!t.HTML;function d(f){const p=new Blob([f],{type:"application/javascript"});return URL.createObjectURL(p)}}}async function P(s,m){await s(m.transpiled)}
