import{openWindows as M}from"./openWindows.js";import{renderPreviewWindow as x}from"./renderPreviewWindow.js";import{sendSignalToQrCode as S}from"./sendSignalToQrCode.js";import{v as l}from"./versions.js";async function u(i){const{transpileCode:m}=await import("./transpile.js");return m(i,!1)}function W(){return{unmount:()=>{},hydrated:!1,preRendered:!1,lastErrors:0,rootElement:null,div:window.document.createElement("div"),HTML:"",devtoolHash:"",ipfs:0,transpiled:"",code:""}}export async function run(i="window",m){await S();const{formatter:h}=await import("./formatter.js");await M(l);const{open:y}=m,t=W();try{const{getCodeToLoad:o}=await import("./data.js"),{code:r,transpiled:e,html:a,versions:n}=await o();t.code=r,t.transpiled=e||await u(r),t.div.innerHTML=a}catch(o){console.error({e:o,message:"couldn't start"});return}t.transpiled=t.transpiled||await u(t.code);const{renderEmotion:f,jsx:T}=await import(l.emotionRenderer);await x(i,t,y,l,f,T),await z(w,t);const v=(await import(l.editor)).default,E=window.document.getElementById("editor"),c=await v({language:"typescript",container:E,code:t.code,onChange:o=>b(o)});async function b(o){const r=await h(o);try{const e=await u(r);if(t.transpiled===e&&e!=="")return;let a=!1;e.length&&t.lastErrors===0&&(a=await w(e));const n=await j(r);if(a&&n.push({messageText:"Error while starting the app. Check the console!"}),n.length&&console.log({err:n}),t.lastErrors&&n.length===0&&w(e),t.lastErrors=n.length,n.length===0&&e.length){if(t.code=await h(r),t.transpiled!==e){t.transpiled=e;const{saveCode:s}=await import("./data.js");await s({code:t.code,transpiled:t.transpiled,html:t.HTML,versions:t.devtoolHash})}}else{const{diff:s}=await import(`https://unpkg.com/@zedvision/shadb@${l.shadb}/src/diff.js`),d=await s(t.code,r);if(d.c.length<=3){t.lastErrors=0;return}if(d.c.length==4){t.lastErrors=0,c.monaco.editor.setTheme("hc-black");return}console.error(n[0].messageText.toString());return}c.monaco.editor.setTheme("vs-dark")}catch(e){c.monaco.editor.setTheme("vs-light"),setTimeout(()=>{c.monaco.editor.setTheme("hc-black")},50),console.error(e)}}async function j(o){if(!c||!c.monaco)return[{messageText:"Error with the error checking. Try to reload!"}];const{monaco:r}=c,{sha256:e}=await import(`https://unpkg.com/@zedvision/shadb@${l.shadb}/src/sha256.js`),n=`file:///${await e(o)}.tsx`,s=r.Uri.parse(n),d=r.editor.getModel(s)||await r.editor.createModel(o,"typescript",s),p=await(await r.languages.typescript.getTypeScriptWorker())(d.uri),C=p.getSemanticDiagnostics(n),k=p.getCompilerOptionsDiagnostics(n),H=p.getSyntacticDiagnostics(n),L=await Promise.race([C,k,H]);return d.dispose(),[...L]}async function w(o){t.HTML="";let r=!1;if(typeof o!="string"||o==="")return r=!0,r;const e=i==="window"?o.replace("body{","#zbody{"):o,a=window.document.createElement("div"),n=(await import(d(e))).default;t.unmount(),t.unmount=f(n(),a);const s=window.document.getElementById("zbody");return s&&s.children[0].replaceWith(a),t.HTML=t.div.innerHTML,!!t.HTML;function d(g){const p=new Blob([g],{type:"application/javascript"});return URL.createObjectURL(p)}}}async function z(i,m){await i(m.transpiled)}
