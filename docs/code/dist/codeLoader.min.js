import{importScript as S}from"../dist/importScript.js";import{starter as y}from"./starterNoFramerMotion.js";const i={firstLoad:!0,errorCode:"",code:""};function x(c="root"){const s=document.createElement("div"),l=document.getElementById(c);try{ReactDOM.unmountComponentAtNode(l)}catch(j){console.error("Error in un-mount",j)}l?l.replaceWith(s):document.body.appendChild(s),s.id=c}export async function run(c="window"){const{transpileCode:s}=await import("./transpile.js");if(i.code=await B(),c==="editor"){const{renderDraggableEditor:t}=await import("./DraggableEditor.js");await t()}if(c==="window"){const{renderDraggableWindow:t}=await import("./DraggableWindow.js"),{shareItAsHtml:e}=await import("./share.js");await t({onShare:async()=>{const o=await e({code:await s(i.code)});window.open(o)}})}const{getDB:l}=await import("../dist/shaDB.min.js"),{getUserId:j,getProjects:I,saveCode:T}=await import("./data.js"),C=await s(i.code);D(C);const{startMonaco:b}=await import("../dist/editor.min.js"),n=await b({language:"typescript",code:i.code,onChange:M});async function k(t){try{const e=await s(t);e.length&&D(e);const o=await v(t),r=document.getElementById("error");if(o.length===0)i.code=t,await T(t);else{i.error=t;const{diff:a}=await import("../dist/diff.min.js"),m=await a(i.code,t);if(m.c.length<=3){n.monaco.editor.setTheme("hc-black");return}r.innerHTML=o[0].messageText.toString(),r.style.display="block";return}r.style.display="none",n.monaco.editor.setTheme("vs-dark")}catch(e){n.monaco.editor.setTheme("vs-light"),setTimeout(()=>{n.monaco.editor.setTheme("hc-black")},50),console.error(e)}}function M(t){if(!n)return;window.requestAnimationFrame(()=>k(t))}async function v(t){if(!n||!n.monaco)return;const{monaco:e}=n,{sha256:o}=await import("./sha256.js"),r=await o(t),a=`file:///${r}.tsx`,m=e.Uri.parse(a),u=e.editor.getModel(m)||await e.editor.createModel(t,"typescript",m),g=await e.languages.typescript.getTypeScriptWorker(),p=await g(u.uri),d=p.getSemanticDiagnostics(a),w=p.getCompilerOptionsDiagnostics(a),h=p.getSyntacticDiagnostics(a),f=await Promise.race([d,w,h]);return u.dispose(),[...f]}function D(t){if(typeof t!="string"||t==="")return;i.firstLoad||x("root");const e=()=>{const o=c==="window"?t.replace("body{","#root{"):t;S;const r=new Function("importScript",`return function(){  
          let DefaultElement;
          ${o}
          
          document.getElementById("root").innerHTML = ReactDOMServer.renderToString(jsx(DefaultElement));

          setTimeout(async()=>{
              await importScript("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js")          
              ReactDOM.hydrate(jsx(DefaultElement), document.getElementById("root"));
          }, 500);

      }`)(S);setTimeout(()=>r())};e()}async function B(){const{getUserId:t,getProjects:e,saveCode:o}=await import("./data.js"),{getDB:r}=await import("../dist/shaDB.min.js"),a=await r(),m=await t(),u=await e(),g=u[0],p=new URLSearchParams(window.location.search),d=p.get("h")||await a.get(g);if(d){let w;try{w=await a.get(d)}catch{console.error("error load key: "+d)}if(w)return w;let h;try{const f=await fetch("https://code.zed.vision/?h="+d);h=await f.json()}catch(f){const{sha256:L}=await import("./sha256.js"),E=await L(y);return a.put(E,y),await a.put(g,E),y}return h}return y}function R(t,e){const o=new URLSearchParams(window.location.search);o.set(t,e),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${o}`))}}
