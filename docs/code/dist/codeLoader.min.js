const _=(n,e)=>{const t=()=>jsx(React.Fragment,null,jsx(n.div,{css:`
            z-index:900;
            background: white;
            border: 2px solid white;
            border-radius: 0px 0px 12px 12px;
          `,animate:{scale:1,top:1,left:600},dragElastic:.5,dragMomentum:!1,initial:{top:1,left:0,scale:.7},transition:{duration:.5},drag:!0,dragConstraints:{left:-200,right:window.innerWidth-200,bottom:window.innerHeight+200,top:0}},jsx("div",{css:`
      display: block;
      with: 100%;
      height: 30px;
      background: burlywood;
    `},jsx("button",{css:`
              backgound: blue;
            `,onClick:()=>e()},"SHARE")),jsx("div",{css:`  
      display: inline-block;
      min-width: 200px;
      padding: 30px;
      max-width: 600px;
      max-height: 800px;
      overflow-y: scroll;
    `,id:"root"})));ReactDOM.render(jsx(t),document.getElementById("dragabbleWindow"))};function v(n){return new Promise(function(e,t){var s;s=window.document.createElement("script"),s.src=n,s.onload=()=>e(window),s.onerror=t,window.document.head.appendChild(s)})}const G=async n=>document.querySelector(`script[src="${n}"]`)||new Promise(function(e,t){const s=window.document.createElement("script");s.src=n,s.onload=e,s.onerror=t,window.document.head.appendChild(s)}),J=`import { useState } from "react";
import {css, Global} from "@emotion/react";;

const Counter = () => {
  const [clicks, setClicks] = useState(0);

  return <>
      <h1>Counter example</h1>
      <button css={buttonStyles("green")} onClick={() => setClicks(clicks - 1)}>
        -
     </button>
      {clicks}
      <button css={buttonStyles("red")} onClick={() => setClicks(clicks + 1)}>
        +
    </button>
  </>
}

const buttonStyles = (color: string) => css\`
  border-radius: 6px;
  padding: 0.5rem 0;
  margin: 0.5rem 2rem;
  width: 4rem;
  background: \${color};
  color: white;
  border: none;
  :focus{
    outline: none;
  }
  \`;

export default () => <>
  <Global styles={css\`
      body{
          margin: 0;
        }  
    \`}
  />
  <Counter />
</>
`,O=()=>window.location.href.includes("zed.dev")?"https://code.zed.dev":"https://code.zed.vision",L=window.document;let H=!0;const{motion:Q}=Motion;let j="",E=0,X=0,W="",$="",M="",z;function K(n,e){const t=new URLSearchParams(window.location.search);t.set(n,e),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${t}`))}function Y(n){const e=new Blob([n],{type:"text/html"});return e}async function Z(n){const e=new Request(O(),{body:n,method:"POST",headers:{"content-type":"text/html;charset=UTF-8",SHARE:"true","Service-Worker-Allowed":"/code/"}}),t=await fetch(e),{hash:s}=await t.json();return O()+`/?r=${s}`}function F(n){const{transform:e}=window.Babel;return e(`/** @jsx jsx */

  Object.assign(window, React);
  `+n,{plugins:[],presets:["react",["typescript",{isTSX:!0,allExtensions:!0}]]}).code}const S=-1;function U(n){return n>=55296&&n<=56319}function q(n){return n>=56320&&n<=57343}function tt(n){return q(n.charCodeAt(0))}function et(n){return U(n.charCodeAt(n.length-1))}function nt(n){const e=[];for(let t=0;t<n.length;t++)n[t][1].length>0&&e.push(n[t]);return e}function R(n,e,t,s){return et(n)||tt(s)?null:nt([[0,n],[S,e],[1,t],[0,s]])}function ot(n,e,t){const s=typeof t=="number"?{index:t,length:0}:t.oldRange,c=typeof t=="number"?null:t.newRange,r=n.length,i=e.length;if(s.length===0&&(c===null||c.length===0)){const o=s.index,a=n.slice(0,o),l=n.slice(o),d=c?c.index:null;t:{const m=o+i-r;if(d!==null&&d!==m)break t;if(m<0||m>i)break t;const y=e.slice(0,m),h=e.slice(m);if(h!==l)break t;const g=Math.min(o,m),p=a.slice(0,g),b=y.slice(0,g);if(p!==b)break t;const u=a.slice(g),f=y.slice(g);return R(p,u,f,l)}t:{if(d!==null&&d!==o)break t;const m=o,y=e.slice(0,o),h=e.slice(o);if(y!==a)break t;const g=Math.min(r-o,i-o),p=l.slice(l.length-g),b=h.slice(h.length-g);if(p!==b)break t;const u=l.slice(0,l.length-g),f=h.slice(0,h.length-g);return R(a,u,f,p)}}if(s.length>0&&c&&c.length===0){t:{const o=n.slice(0,s.index),a=n.slice(s.index+s.length),l=o.length,d=a.length;if(i<l+d)break t;const m=e.slice(0,l),y=e.slice(i-d);if(o!==m||a!==y)break t;const h=n.slice(l,r-d),g=e.slice(l,i-d);return R(o,h,g,a)}}return null}I.INSERT=1,I.DELETE=S,I.EQUAL=0;function B(n,e){if(!n||!e||n.charAt(0)!==e.charAt(0))return 0;let t=0,s=Math.min(n.length,e.length),c=s,r=0;for(;t<c;)n.substring(r,c)==e.substring(r,c)?(t=c,r=t):s=c,c=Math.floor((s-t)/2+t);return U(n.charCodeAt(c-1))&&c--,c}function P(n,e){if(!n||!e||n.slice(-1)!==e.slice(-1))return 0;let t=0,s=Math.min(n.length,e.length),c=s,r=0;for(;t<c;)n.substring(n.length-c,n.length-r)==e.substring(e.length-c,e.length-r)?(t=c,r=t):s=c,c=Math.floor((s-t)/2+t);return q(n.charCodeAt(n.length-c))&&c--,c}function st(n,e){const t=n.length>e.length?n:e,s=n.length>e.length?e:n;if(t.length<4||s.length*2<t.length)return null;function c(h,g,p){const b=h.substring(p,p+Math.floor(h.length/4));let u=-1,f="",w,x,k,C;for(;(u=g.indexOf(b,u+1))!==-1;){const A=B(h.substring(p),g.substring(u)),D=P(h.substring(0,p),g.substring(0,u));f.length<D+A&&(f=g.substring(u-D,u)+g.substring(u,u+A),w=h.substring(0,p-D),x=h.substring(p+A),k=g.substring(0,u-D),C=g.substring(u+A))}return f.length*2>=h.length?[w,x,k,C,f]:null}const r=c(t,s,Math.ceil(t.length/4)),i=c(t,s,Math.ceil(t.length/2));let o;if(i===null&&r===null)return null;if(i===null){if(r===null)return null;o=r}else if(r===null){if(i===null)return null;o=i}else o=r[4].length>i[4].length?r:i;let a,l,d,m;n.length>e.length?(a=o[0],l=o[1],d=o[2],m=o[3]):(d=o[0],m=o[1],a=o[2],l=o[3]);const y=o[4];return[a,l,d,m,y]}function N(n){const e=[...n];e.push([0,""]);let t=0,s=0,c=0,r="",i="",o,a;for(;t<e.length;){if(t<e.length-1&&!e[t][1]){e.splice(t,1);continue}switch(e[t][0]){case 1:c++,i+=e[t][1],t++;break;case S:s++,r+=e[t][1],t++;break;case 0:if(a=t-c-s-1,t<e.length-1&&!e[t][1]){e.splice(t,1);break}if(r.length>0||i.length>0){r.length>0&&i.length>0&&(o=B(i,r),o!==0&&(a>=0?e[a][1]+=i.substring(0,o):(e.splice(0,0,[0,i.substring(0,o)]),t++),i=i.substring(o),r=r.substring(o)),o=P(i,r),o!==0&&(e[t][1]=i.substring(i.length-o)+e[t][1],i=i.substring(0,i.length-o),r=r.substring(0,r.length-o)));const d=c+s;r.length===0&&i.length===0?(e.splice(t-d,d),t=t-d):r.length===0?(e.splice(t-d,d,[1,i]),t=t-d+1):i.length===0?(e.splice(t-d,d,[S,r]),t=t-d+1):(e.splice(t-d,d,[S,r],[1,i]),t=t-d+2)}t!==0&&e[t-1][0]===0?(e[t-1][1]+=e[t][1],e.splice(t,1)):t++,c=0,s=0,r="",i="";break}}e[e.length-1][1]===""&&e.pop();let l=!1;for(t=1;t<e.length-1;)e[t-1][0]===0&&e[t+1][0]===0&&(e[t][1].substring(e[t][1].length-e[t-1][1].length)===e[t-1][1]?(e[t][1]=e[t-1][1]+e[t][1].substring(0,e[t][1].length-e[t-1][1].length),e[t+1][1]=e[t-1][1]+e[t+1][1],e.splice(t-1,1),l=!0):e[t][1].substring(0,e[t+1][1].length)==e[t+1][1]&&(e[t-1][1]+=e[t+1][1],e[t][1]=e[t][1].substring(e[t+1][1].length)+e[t+1][1],e.splice(t+1,1),l=!0)),t++;return l?N(e):e}const rt=async({onChange:n,code:e,language:t})=>{const s=window.document.getElementById("container");if(!s){const a=document.getElementById("container");a.id="container",document.body.appendChild(a)}const c=t==="typescript"?"file:///main.tsx":"file:///main.html";let r;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)){const a=window.document.createElement("div");a.id="ace",window.document.body.appendChild(a),await v("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"),t==="typescript"?await v("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-typescript.min.js"):await v("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-html.min.js"),await v("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.js"),window.document.getElementById("ace").style.setProperty("display","block"),s.style.setProperty("display","none"),r=window.ace.edit("ace"),r.getSession().setMode("ace/mode/typescript");const l=d=>setTimeout(()=>{let m=window.ace.edit("ace"),y=m.getTheme();y!=="ace/theme/monokai "&&(m.setOptions({fontSize:"14pt"}),m.setTheme("ace/theme/monokai"),l(2*d))},d);l(100),r.setValue(e),r.blur()}if(window.monaco===void 0){const a="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs",{require:l}=await v(`${a}/loader.min.js`);l.config({paths:{vs:a}}),await new Promise(d=>l(["vs/editor/editor.main"],m=>{d(m)}))}const i=window.monaco,o={monaco:i,editor:i.editor.create(window.document.getElementById("container"),{formatOnType:!0,scrollbar:{horizontal:"hidden",verticalHasArrows:!0,verticalScrollbarSize:20},minimap:{enabled:!1},folding:!1,multiCursorModifier:"alt",wordWrap:"on",wordWrapBreakAfterCharacters:">([{]))],;}",mouseWheelZoom:!1,wordWrapColumn:80,automaticLayout:!0,scrollBeyondLastLine:!1,autoIndent:"brackets",autoClosingQuotes:"always",padding:{bottom:300},lineNumbers:"on",autoClosingBrackets:"always",autoClosingOvertype:"always",suggest:{},codeLens:!0,autoSurround:"languageDefined",trimAutoWhitespace:!0,codeActionsOnSaveTimeout:100,model:i.editor.getModel(c)||i.editor.createModel(e,t,i.Uri.parse(c)),value:e,language:t,theme:"vs-dark"})};if(o.editor.onDidChangeModelContent(()=>n(o.editor.getValue())),r&&r.session.on("change",function(){const a=r.getValue();o.editor.setValue(a),n(a)}),r&&document.getElementById("container").replaceWith(document.getElementById("ace")),o.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!0,noSemanticValidation:!0,noSyntaxValidation:!0}),t==="typescript"){const a=[{name:"react",url:"https://unpkg.com/@types/react@17.0.0/index.d.ts",depend:["global","csstype","react-dom","prop-types"]},{name:"global",url:"https://unpkg.com/@types/react@17.0.0/global.d.ts",depend:[]},{name:"prop-types",url:"https://unpkg.com/@types/prop-types@15.7.3/index.d.ts",depend:[]},{name:"react-dom",url:"https://unpkg.com/@types/react-dom@17.0.0/index.d.ts",depend:[]},{name:"csstype",url:"https://unpkg.com/csstype@3.0.5/index.d.ts",depend:[]},{name:"@emotion/styled/base.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/base.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/styled/index.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/index.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/cache/index.d.ts",url:"https://unpkg.com/@emotion/cache@11.0.0/types/index.d.ts",depend:["@emotion/utils"]},{name:"@emotion/react/index.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/index.d.ts",depend:["@emotion/cache"]},{name:"@emotion/react/jsx-namespace.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/jsx-namespace.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/css-prop.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/css-prop.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/helper.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/helper.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/theming.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/theming.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/serialize/index.d.ts",url:"https://unpkg.com/@emotion/serialize@1.0.0/types/index.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/utils/index.d.ts",url:"https://unpkg.com/@emotion/utils@1.0.0/types/index.d.ts",depend:[]},{name:"framer-motion",url:"https://unpkg.com/framer-motion@2.9.4/dist/framer-motion.d.ts",depend:[]},{name:"popmotion",url:"https://unpkg.com/browse/popmotion@9.0.0/lib/index.d.ts"}],l=a.map(({name:d,url:m})=>(async()=>o.monaco.languages.typescript.typescriptDefaults.addExtraLib(await(await fetch(m)).text(),d.includes("@emotion")?`file:///node_modules/${d}`:`file:///node_modules/@types/${d}/index.d.ts`))());return o.monaco.languages.typescript.typescriptDefaults.setCompilerOptions({target:o.monaco.languages.typescript.ScriptTarget.ESNext,allowNonTsExtensions:!0,allowUmdGlobalAccess:!0,strict:!0,allowJs:!0,noEmitOnError:!0,allowSyntheticDefaultImports:!0,moduleResolution:o.monaco.languages.typescript.ModuleResolutionKind.Nodejs,module:o.monaco.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"],jsx:o.monaco.languages.typescript.JsxEmit.React,jsxFactory:"React.createElement",jsxFragmentFactory:"React.Fragment",esModuleInterop:!0}),await Promise.all(l),o.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!1,noSemanticValidation:!1,noSyntaxValidation:!1}),o}};export async function run(){_(Q,async()=>{const t=await z();window.open(t)}),await G("https://unpkg.com/@babel/standalone@7.12.8/babel.min.js"),(async()=>{const t=e();M=t;const s=await rt({language:"typescript",code:t,onChange:c});function c(o){if(!s)return;if(j=o,!E)i(j);else{const a=o,l=setInterval(()=>{(o!==j||!E)&&clearInterval(l),E||i(j)},100)}}async function r(){if(!s||!s.monaco)return;const o=s.monaco.Uri.parse("file:///main.tsx"),a=await s.monaco.languages.typescript.getTypeScriptWorker(),l=await(await a(o)).getSemanticDiagnostics("file:///main.tsx"),d=await(await a(o)).getCompilerOptionsDiagnostics("file:///main.tsx"),m=await(await a(o)).getSyntacticDiagnostics("file:///main.tsx");return[...l,...d,...m]}async function i(o){const{diff:a}=await import("../dist/diff.min.js");if(E===1)return;try{E=1;const l=await r(),d=L.getElementById("error");if(E=0,o!==j)return;if(l&&l.length){if(j!=o)return;if(W===o)return;const m=a(M,o,0);if(m.length<=3){s.monaco.editor.setTheme("hc-black");return}d.innerHTML=l[0].messageText.toString(),d.style.display="block",W=o;return}M=o,d.style.display="none",s.monaco.editor.setTheme("vs-dark"),X=0,E=0,n(F(o))}catch(l){if(E=0,o!==j)return;s.monaco.editor.setTheme("vs-light"),setTimeout(()=>{s.monaco.editor.setTheme("hc-black")},50),console.error(l)}}})(),n(F(e()));async function n(t){const s=/import/gi,c="///",r=`
    Object.assign(window, React);
    if (window.Motion) {
        Object.assign(window, window.Motion);
    }
    if (window.emotionStyled){
      window.styled= window.emotionStyled;
    }
    ;
    `+t.replaceAll(s,c).replace("export default","DefaultElement = "),i=async()=>{const o=new Function("code",`return function(){  
          let DefaultElement;
        
        ${r}

                return ReactDOM.render(jsx(DefaultElement), document.getElementById("root"));
      }`)();o(),z=async()=>{const a=new Function("code",`return function(){
            let DefaultElement;
  
          ${r}
  
                  return ReactDOMServer.renderToString(jsx(DefaultElement));
        }`)(),l=a(),d=Array.from(L.querySelector("head > style[data-emotion=css]").sheet.cssRules).map(u=>u.cssText).filter(u=>l.includes(u.substring(3,8))).join(`
  `);let m;if(r.includes("body{")){const u=r.indexOf("body{"),f=r.slice(u),w=f.indexOf("}");m=f.slice(0,w+1)}let y="",h="";r.includes("Motion")&&(y='<script crossorigin src="https://unpkg.com/framer-motion@2.9.4/dist/framer-motion.js"></script>',h="const {motion} = Motion");const g=`<!DOCTYPE html>
        <html lang="en">
        <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <head profile="http://www.w3.org/2005/10/profile">
        <link rel="icon" 
              type="image/png" 
              href="https://zed.vision/favicon.ico">
        <style>
        ${m}
        ${d}
        </style>
        </head>
        <body>
        <div id="root">
        ${l}
        </div>
        <script crossorigin src="https://unpkg.com/react@17.0.1/umd/react.production.min.js"></script>
        ${y}
        <script crossorigin src="https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/@emotion/react@11.1.1/dist/emotion-react.umd.min.js"></script>
        <script crossorigin src="https://unpkg.com/@emotion/styled@11.0.0/dist/emotion-styled.umd.min.js"></script>
        <script type="module">
        Object.assign(window, emotionReact);

       const styled = window["emotionStyled"];

        let DefaultElement;

        ${r}

        ReactDOM.hydrate(jsx(DefaultElement), document.body.children[0]);
        </script>
        </body>
        </html>
        `,p=await Y(g),b=await Z(p);return b}};if(!H){const o=async a=>{if(!location.origin.includes("zed."))return;if(a!==M)return;if($===a)return;$=a;const l={codeTranspiled:t,code:M},d=JSON.stringify(l),m=new Request(O(),{body:d,method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}}),y=await fetch(m),{hash:h}=await y.json();try{const g=window.localStorage,p=g.getItem("codeBoXHash2");p!==h&&(g.setItem("codeBoXHash2",h),g.setItem(h,M),K("h",h))}catch(g){}};setTimeout(()=>o(j),500)}H=!1,i()}async function e(){const t=new URLSearchParams(window.location.search),s=t.get("h");if(s){const c=window.localStorage.getItem(s);if(c)return c;const r=await window.OLD_SHATEST.get(s);if(r)return r;const i=await fetch(O()+"/?h="+s),o=await i.text();return o}return J}}function T({text1:n,text2:e,cursorPos:t}){if(n===e)return n?[[0,n]]:[];if(t){const o=ot(n,e,t);if(o)return o}let s=B(n,e);const c=n.substring(0,s);n=n.substring(s),e=e.substring(s),s=P(n,e);const r=n.substring(n.length-s);n=n.substring(0,n.length-s),e=e.substring(0,e.length-s);const i=it(n,e);return c&&i.unshift([0,c]),r&&i.push([0,r]),N(i),i}function it(n,e){let t;if(!n)return[[1,e]];if(!e)return[[S,n]];const s=n.length>e.length?n:e,c=n.length>e.length?e:n,r=s.indexOf(c);if(r!==-1)return t=[[1,s.substring(0,r)],[0,c],[1,s.substring(r+c.length)]],n.length>e.length&&(t[0][0]=t[2][0]=S),t;if(c.length===1)return[[S,n],[1,e]];const i=st(n,e);if(i){const o=i[0]||"",a=i[1]||"",l=i[2]||"",d=i[3]||"",m=i[4]||"",y=T({text1:o,text2:l,cursorPos:0}),h=T({text1:a,text2:d,cursorPos:0});return y.concat([[0,m[1]]],h)}return ct(n,e)}function ct(n,e){const t=n.length,s=e.length,c=Math.ceil((t+s)/2),r=c,i=2*c,o=new Array(i),a=new Array(i);for(let p=0;p<i;p++)o[p]=-1,a[p]=-1;o[c+1]=0,a[c+1]=0;const l=t-s,d=l%2!==0;let m=0,y=0,h=0,g=0;for(let p=0;p<c;p++){for(let u=-p+m;u<=p-y;u+=2){const f=c+u;let w;u===-p||u!==p&&o[f-1]<o[f+1]?w=o[f+1]:w=o[f-1]+1;let x=w-u;for(;w<t&&x<s&&n.charAt(w)===e.charAt(x);)w++,x++;if(o[f]=w,w>t)y+=2;else if(x>s)m+=2;else if(d){const k=c+l-u;if(k>=0&&k<i&&a[k]!==-1){const C=t-a[k];if(w>=C)return V(n,e,w,x)}}}let b;for(let u=-p+h;u<=p-g;u+=2){const f=c+u;u===-p||u!==p&&a[f-1]<a[f+1]?b=a[f+1]:b=a[f-1]+1;let w=b-u;for(;b<t&&w<s&&n.charAt(t-b-1)===e.charAt(s-w-1);)b++,w++;if(a[f]=b,b>t)g+=2;else if(w>s)h+=2;else if(!d){const x=c+l-u;if(x>=0&&x<i&&o[x]!==-1){const k=o[x],C=c+k-x;if(b=t-b,k>=b)return V(n,e,k,C)}}}}return[[S,n],[1,e]]}function V(n,e,t,s){const c=n.substring(0,t),r=e.substring(0,s),i=n.substring(t),o=e.substring(s),a=T({text1:c,text2:r,cursorPos:0}),l=T({text1:i,text2:o,cursorPos:0});return a.concat(l)}function I(n,e,t){return T({text1:n,text2:e,cursorPos:t})}
