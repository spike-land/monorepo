import{importScript as b}from"../dist/importScript.js";import{starter as y}from"./starterNoFramerMotion.js";const i={firstLoad:!0,errorCode:"",code:""};function I(d="zbody",m){try{const l=window.document.getElementById(d),j=l.innerHTML;j.length>0&&(ReactDOM.unmountComponentAtNode(m),l.innerHTML=j)}catch(l){console.error("Error in un-mount",l)}}export async function run(d="window"){const{transpileCode:m}=await import("./transpile.js");if(i.code=await B(),d==="editor"){const{renderDraggableEditor:t}=await import("./DraggableEditor.js");await t()}if(d==="window"){const{renderDraggableWindow:t}=await import("./DraggableWindow.js"),{shareItAsHtml:e}=await import("./share.js");await t({onShare:async()=>{const r=await e({code:await m(i.code)});window.open(r)}})}const{getDB:l}=await import("../dist/shaDB.min.js"),{getUserId:j,getProjects:x,saveCode:S}=await import("./data.js"),C=await m(i.code);E(C);const{startMonaco:M}=await import("../dist/editor.min.js"),n=await M({language:"typescript",code:i.code,onChange:L});let D=0;async function k(t){try{const e=await m(t);let r=!1;e.length&&D===0&&(r=await E(e));const a=[...r?[r]:[],...await v(t)];D&&a.length===0&&E(e),D=a.length;const o=window.document.getElementById("error");if(a.length===0&&e.length)i.code=t,await S(t);else{i.error=t;const{diff:w}=await import("../dist/diff.min.js"),s=await w(i.code,t);if(s.c.length<=3){n.monaco.editor.setTheme("hc-black");return}o.innerHTML=a[0].messageText.toString(),o.style.display="block";return}o.style.display="none",n.monaco.editor.setTheme("vs-dark")}catch(e){n.monaco.editor.setTheme("vs-light"),setTimeout(()=>{n.monaco.editor.setTheme("hc-black")},50),console.error(e)}}function L(t){if(!n)return;window.requestAnimationFrame(()=>k(t))}async function v(t){if(!n||!n.monaco)return;const{monaco:e}=n,{sha256:r}=await import("./sha256.js"),a=await r(t),o=`file:///${a}.tsx`,w=e.Uri.parse(o),s=e.editor.getModel(w)||await e.editor.createModel(t,"typescript",w),g=await e.languages.typescript.getTypeScriptWorker(),p=await g(s.uri),c=p.getSemanticDiagnostics(o),u=p.getCompilerOptionsDiagnostics(o),h=p.getSyntacticDiagnostics(o),f=await Promise.race([c,u,h]);return s.dispose(),[...f]}await b("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js");function E(t){if(typeof t!="string"||t==="")return;let e=!1;const r=()=>{const a=d==="window"?t.replace("body{","#root{"):t;e&&(I("zbody",e),e=!1);const o=new Function("importScript",`return function(){  
          let DefaultElement;
          const root = document.createElement("div");

          try{

                ${a}

                
                root.innerHTML = ReactDOMServer.renderToString(jsx(DefaultElement));

                hydrated = DefaultElement;
                setTimeout(async()=>{
                  if (hydrated === DefaultElement){
                    ReactDOM.hydrate(jsx(DefaultElement), root);
                  }
                }, 500);

          } catch (e){
            root.innerHTML = e.message;
          }

          if(document.getElementById("zbody").children.length) {
            document.getElementById("zbody").children[0].remove();
          }
          
          document.getElementById("zbody").appendChild(root);
      }`)(b);setTimeout(()=>o())};r()}async function B(){const{getUserId:t,getProjects:e,saveCode:r}=await import("./data.js"),{getDB:a}=await import("../dist/shaDB.min.js"),o=await a(),w=await t(),s=await e(),g=s[0],p=new URLSearchParams(window.location.search),c=p.get("h")||await o.get(g);if(c){let u;try{u=await o.get(c)}catch{console.error("error load key: "+c)}if(u)return u;let h;try{const f=await fetch("https://code.zed.vision/?h="+c);h=await f.json()}catch(f){const{sha256:H}=await import("./sha256.js"),T=await H(y);return o.put(T,y),await o.put(g,T),y}return h}return y}function z(t,e){const r=new URLSearchParams(window.location.search);r.set(t,e),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${r}`))}}
