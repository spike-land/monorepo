async function C(e,t){try{const n=`https://code.zed.vision/keys/?prefix=${t}`,o=await fetch(n,{headers:{"content-type":"application/json;charset=UTF-8",API_KEY:e}}),i=await o.json();return i.keys}catch(n){return console.log(n),[]}}const Se=C,oe=e=>{const t=()=>jsx(React.Fragment,null,jsx(motion.div,{css:`
            background: red;
            border: 4px solid red;
            border-radius: 8px;
          `,animate:{scale:1,top:1,left:600},dragElastic:.5,dragMomentum:!1,initial:{top:1,left:0,scale:.7},transition:{duration:.5},drag:!0,dragConstraints:{left:-window.innerWidth+200,right:0,bottom:window.innerHeight-200,top:0}},jsx("div",{css:`
      display: block;
      with: 100%;
      text-align: right;
      background: linear-gradient(0deg, darkred, red);
    `},jsx("button",{css:`
              background: darkred;
              margin-top: -4px;
              color: white;
              cursor: pointer;
              font-weight: bold;
              font-family: Roboto;
              padding: 8px 16px;
              outline: none;
              border: none;
              border-radius: 0px 8px 0px 0px;
            `,onClick:()=>e()},"\u{1F30E} SHARE")),jsx("div",{css:`  
      min-width: 200px;
      padding: 30px;
      max-width: 600px;
      background: white;
      max-height: 800px;
      border-radius: 0px 0px 8px 8px;
      overflow-y: overlay;
    `,id:"root"})));W.render(jsx(t),document.getElementById("dragabbleWindow"))};function re(){const e=new JSFrame,t=e.create({name:"Win",title:"",width:window.innerWidth/2-40,height:600,minWidth:300,minHeight:300,appearanceName:"material",appearanceParam:{titleBar:{color:"white",height:40,background:"#1e1e1e"}},style:{backgroundColor:"rgba(255,255,255,0.8)",overflow:"auto"},style:{backgroundColor:"rgba(0,0,0,0.8)",overflow:"hidden",width:"100%"},html:'<div id="container"></div>'});t.setPosition(window.innerWidth-32,32,"RIGHT_TOP"),t.setControl({maximizeButton:"maximizeButton",demaximizeButton:"restoreButton",minimizeButton:"minimizeButton",deminimizeButton:"deminimizeButton",hideButton:"closeButton",animation:!0,animationDuration:150}),t.control.on("hid",(n,o)=>{n.closeFrame()}),t.control.on("maximized",(n,o)=>{e.showToast({text:"Maximized"})}),t.control.on("demaximized",(n,o)=>{}),t.control.on("minimized",(n,o)=>{}),t.control.on("dminimized",(n,o)=>{}),t.show(),console.log(t)}function T(e){return new Promise(function(t,n){var o;o=window.document.createElement("script"),o.src=e,o.onload=()=>t(window),o.onerror=n,window.document.head.appendChild(o)})}const V=async e=>document.querySelector(`script[src="${e}"]`)||new Promise(function(t,n){const o=window.document.createElement("script");o.src=e,o.onload=t,o.onerror=n,window.document.head.appendChild(o)}),F=`import { useState } from "react";
import { motion } from "framer-motion";
import { css, Global } from "@emotion/react";;

const Slider = () => {
  const [sliderValue, setSlider] = useState(64);

  return <>
  <Global styles={css\`
      body{
          margin: 0;
          background: rgb(\${sliderValue},\${255-sliderValue},255);
          overflow: overlay;
        }  
    \`}/>
    <input max="128"
      css={\`
        appearance: none;
        width: 100%;
        height: 40px; 
        background: rgb(\${sliderValue*2},\${255-2*sliderValue},0); 
        outline: none; 
    \`} type="range"
      value={sliderValue} step="1"
      onChangeCapture={(e) => setSlider(Number(e.currentTarget.value))}>
    </input>
    <motion.p
      animate={{ fontSize: sliderValue + \`px\` }}>
      Example when the text gets bigger...
    </motion.p>
      <motion.p animate={{fontSize:128-sliderValue+"px"}}>
        ...or smaller
    </motion.p>
  </>
}

export default () => <>
  <Slider />
</>
`;async function ie(e){const t=await crypto.subtle.digest("SHA-256",e),n=Array.from(new Uint8Array(t)),o=n.map(i=>("00"+i.toString(16)).slice(-2)).join("");return o}const M=async()=>{const{openDB:e}=await import("https://unpkg.com/idb@5.0.8/build/esm/index.js"),t=e("localZedCodeStore",1,{blocked(){},blocking(){},terminated(){},upgrade(n){n.createObjectStore("codeStore")}});return{async get(n,o="string"){const i=(await t).get("codeStore",n);if(!i)return null;if(o==="json")return JSON.parse(i);if(o==="string"){const c=await i;if(typeof c===o)return c;const l=new TextDecoder,u=l.decode(c);return u}return i},async put(n,o){let i;return typeof o!="string"?i=new TextDecoder().decode(o):i=o,(await t).put("codeStore",i,n)},async delete(n){return(await t).delete("codeStore",n)},async clear(){return(await t).clear("codeStore")},async keys(){return(await t).getAllKeys("codeStore")}}},se=(e,t)=>t.some(n=>e instanceof n);let U,N;function ae(){return U||(U=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ce(){return N||(N=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const K=new WeakMap,O=new WeakMap,q=new WeakMap,A=new WeakMap,z=new WeakMap;function de(e){if(O.has(e))return;const t=new Promise((n,o)=>{const i=()=>{e.removeEventListener("complete",c),e.removeEventListener("error",l),e.removeEventListener("abort",l)},c=()=>{n(),i()},l=()=>{o(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",c),e.addEventListener("error",l),e.addEventListener("abort",l)});O.set(e,t)}const P=e=>z.get(e),le=["get","getKey","getAll","getAllKeys","count"],ue=["put","add","delete","clear"],R=new Map;function J(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(R.get(t))return R.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,i=ue.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(i||le.includes(n)))return;const c=async function(l,...u){const m=this.transaction(l,i?"readwrite":"readonly");let h=m.store;o&&(h=h.index(u.shift()));const s=await h[n](...u);return i&&await m.done,s};return R.set(t,c),c}var W=window.ReactDOM;const L=()=>document.location.href.includes("zed.dev")?"https://code.zed.dev":"https://code.zed.vision";let _=!0,S="",j=0,me=0,G="",X="",E="",Y;async function pe(e,t){try{const n=`https://code.zed.vision/keys/delete/?hash=${t}`,o=await fetch(n,{headers:{"content-type":"application/json;charset=UTF-8",API_KEY:e}});return!0}catch(n){return console.log(n),!1}}async function Q(e){try{const t=`https://code.zed.vision/?h=${e}`,n=await fetch(t,{headers:{"content-type":"application/json;charset=UTF-8"}}),o=await n.json();return o.code?o.code:""}catch(t){return console.log(t),""}}async function fe(e){try{const t=`https://code.zed.vision/?h=${e}`,n=await fetch(t,{headers:{"content-type":"application/json;charset=UTF-8"}}),o=await n.json();return o.codeTranspiled?o.codeTranspiled:""}catch(t){return console.log(t),""}}async function Z(){const e=await M(),t=await e.get("uuid");if(!t)if(window.location.href.includes("zed.dev"))e.put("uuid","1234");else{const n=await fetch("https://code.zed.vision/register"),o=await n.json();return e.put("uuid",o.uuid),o.uuid}return t}function ee(e="root"){const t=document.createElement("div"),n=document.getElementById(e);try{W.unmountComponentAtNode(n)}catch(o){console.error("Error in un-mount",o)}n?n.replaceWith(t):document.body.appendChild(t),t.id=e}const he=async({onChange:e,code:t,language:n})=>{const o=window.document.getElementById("container");if(!o){const m=document.getElementById("container");m.id="container",document.body.appendChild(m)}const i=n==="typescript"?"file:///main.tsx":"file:///main.html";let c;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)){const m=window.document.createElement("div");m.id="ace",window.document.body.appendChild(m),await T("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"),n==="typescript"?await T("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-typescript.min.js"):await T("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-html.min.js"),await T("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.js"),window.document.getElementById("ace").style.setProperty("display","block"),o.style.setProperty("display","none"),c=window.ace.edit("ace"),c.getSession().setMode("ace/mode/typescript");const h=s=>setTimeout(()=>{let r=window.ace.edit("ace"),g=r.getTheme();g!=="ace/theme/monokai "&&(r.setOptions({fontSize:"14pt"}),r.setTheme("ace/theme/monokai"),h(2*s))},s);h(100),c.setValue(t),c.blur()}if(window.monaco===void 0){const m="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs",{require:h}=await T(`${m}/loader.min.js`);h.config({paths:{vs:m}}),await new Promise(s=>h(["vs/editor/editor.main"],r=>{s(r)}))}const l=window.monaco,u={monaco:l,editor:l.editor.create(window.document.getElementById("container"),{formatOnType:!0,scrollbar:{horizontal:"hidden",verticalHasArrows:!0,verticalScrollbarSize:20},minimap:{enabled:!1},folding:!1,multiCursorModifier:"alt",wordWrap:"on",wordWrapBreakAfterCharacters:">([{]))],;} ",mouseWheelZoom:!1,wordWrapColumn:80,automaticLayout:!0,scrollBeyondLastLine:!1,autoIndent:"brackets",autoClosingQuotes:"always",padding:{bottom:300},lineNumbers:"on",autoClosingBrackets:"always",autoClosingOvertype:"always",suggest:{},codeLens:!0,autoSurround:"languageDefined",trimAutoWhitespace:!0,codeActionsOnSaveTimeout:100,model:l.editor.getModel(i)||l.editor.createModel(t,n,l.Uri.parse(i)),value:t,language:n,theme:"vs-dark"})};if(u.editor.onDidChangeModelContent(()=>e(u.editor.getValue())),c&&c.session.on("change",function(){const m=c.getValue();u.editor.setValue(m),e(m)}),c&&document.getElementById("container").replaceWith(document.getElementById("ace")),u.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!0,noSemanticValidation:!0,noSyntaxValidation:!0}),n==="typescript"){const m=[{name:"react",url:"https://unpkg.com/@types/react@17.0.0/index.d.ts",depend:["global","csstype","react-dom","prop-types"]},{name:"global",url:"https://unpkg.com/@types/react@17.0.0/global.d.ts",depend:[]},{name:"prop-types",url:"https://unpkg.com/@types/prop-types@15.7.3/index.d.ts",depend:[]},{name:"react-dom",url:"https://unpkg.com/@types/react-dom@17.0.0/index.d.ts",depend:[]},{name:"csstype",url:"https://unpkg.com/csstype@3.0.5/index.d.ts",depend:[]},{name:"@emotion/styled/base.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/base.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/styled/index.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/index.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/cache/index.d.ts",url:"https://unpkg.com/@emotion/cache@11.0.0/types/index.d.ts",depend:["@emotion/utils"]},{name:"@emotion/react/index.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/index.d.ts",depend:["@emotion/cache"]},{name:"@emotion/react/jsx-namespace.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/jsx-namespace.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/css-prop.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/css-prop.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/helper.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/helper.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/theming.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/theming.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/serialize/index.d.ts",url:"https://unpkg.com/@emotion/serialize@1.0.0/types/index.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/utils/index.d.ts",url:"https://unpkg.com/@emotion/utils@1.0.0/types/index.d.ts",depend:[]},{name:"framer-motion",url:"https://unpkg.com/framer-motion@2.9.5/dist/framer-motion.d.ts",depend:[]},{name:"popmotion",url:"https://unpkg.com/browse/popmotion@9.0.1/lib/index.d.ts"}],h=m.map(({name:s,url:r})=>(async()=>u.monaco.languages.typescript.typescriptDefaults.addExtraLib(await(await fetch(r)).text(),s.includes("@emotion")?`file:///node_modules/${s}`:`file:///node_modules/@types/${s}/index.d.ts`))());return u.monaco.languages.typescript.typescriptDefaults.setCompilerOptions({target:u.monaco.languages.typescript.ScriptTarget.ESNext,allowNonTsExtensions:!0,allowUmdGlobalAccess:!0,strict:!0,allowJs:!0,noEmitOnError:!0,allowSyntheticDefaultImports:!0,moduleResolution:u.monaco.languages.typescript.ModuleResolutionKind.Nodejs,module:u.monaco.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"],jsx:"react-jsx",esModuleInterop:!0}),await Promise.all(h),u.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!1,noSemanticValidation:!1,noSyntaxValidation:!1}),u}};async function ye(e){const t=new TextEncoder().encode(e),n=await ie(t);return n.substr(0,8)}export const getProjects=async()=>{const e=await Z(),t=await M(),n=await t.get(e,"json");return n||(await t.put(e,JSON.stringify([])),[])};export async function run(e="window"){const t=await M(),n=await Z();async function o(s,r,g=!1){const y=await C(s,r);y.map(p=>p.name).map(async p=>{const a=await Q(p);if(!a)return"";const d=await fe(p);ee("root");let f;try{if(f=h(a),f!==d){const w=/setInterval/gi,b="///",k=/debugger/gi,x="///";W.unmountComponentAtNode(document.getElementById("root")),i(f.replaceAll(w,b).replaceAll(k,x));const D=document.getElementById("root").innerHTML;ee("root"),i(d.replaceAll(w,b).replaceAll(k,x));const I=document.getElementById("root").innerHTML;I!==D&&(console.log({hash:p,code:a,html1:I,html2:D,transpiled1:d,transpiled2:f}),g&&await pe(s,p))}}catch(w){console.error({hash:p,code:a,transpiled:f})}})}Object.assign(window,{getKeys:C,getCode:Q,restartCode:i,regenerate:o}),V("diffLoader.js"),e==="editor"&&re(),e=="window"&&oe(async()=>{const s=await Y();window.open(s)}),await V("https://unpkg.com/@babel/standalone@7.12.9/babel.min.js"),(async()=>{const s=await c();E=s;const r=await he({language:"typescript",code:s,onChange:g});function g(a){if(!r)return;if(S=a,!j)p(S);else{const d=a,f=setInterval(()=>{(a!==S||!j)&&clearInterval(f),j||p(S)},100)}}async function y(){if(!r||!r.monaco)return;const a=r.monaco.Uri.parse("file:///main.tsx"),d=await r.monaco.languages.typescript.getTypeScriptWorker(),f=await(await d(a)).getSemanticDiagnostics("file:///main.tsx"),w=await(await d(a)).getCompilerOptionsDiagnostics("file:///main.tsx"),b=await(await d(a)).getSyntacticDiagnostics("file:///main.tsx");return[...f,...w,...b]}async function p(a){if(j===1)return;try{j=1;const d=await y(),f=document.getElementById("error");if(j=0,a!==S)return;if(d&&d.length){if(S!=a)return;if(G===a)return;const w=diff(E,a,0);if(w.length<=3){r.monaco.editor.setTheme("hc-black");return}f.innerHTML=d[0].messageText.toString(),f.style.display="block",G=a;return}E=a,f.style.display="none",r.monaco.editor.setTheme("vs-dark"),me=0,j=0,i(h(a))}catch(d){if(j=0,a!==S)return;r.monaco.editor.setTheme("vs-light"),setTimeout(()=>{r.monaco.editor.setTheme("hc-black")},50),console.error(d)}}})(),i(h(await c()));async function i(s){const r=/import/gi,g="///",y=`
    Object.assign(window, React);
    if (window.Motion) {
        Object.assign(window, window.Motion);
    }
    if (window.emotionStyled){
      window.styled= window.emotionStyled;
    }
    ;
    `+s.replaceAll(r,g).replace("export default","DefaultElement = "),p=async()=>{const a=new Function("code",`return function(){  
          let DefaultElement;
        
        ${y}

                return ReactDOM.render(jsx(DefaultElement), document.getElementById("root"));
      }`)();a(),Y=async()=>{const d=new Function("code",`return function(){
            let DefaultElement;
  
          ${y}
  
                  return ReactDOMServer.renderToString(jsx(DefaultElement));
        }`)(),f=d(),w=Array.from(document.querySelector("head > style[data-emotion=css]").sheet.cssRules).map(B=>B.cssText).filter(B=>f.includes(B.substring(3,8))).join(`
  `);let b;if(y.includes("body{")){const B=y.indexOf("body{"),H=y.slice(B),ne=H.indexOf("}");b=H.slice(0,ne+1)}let k="",x="";y.includes("Motion")&&(k='<script crossorigin src="https://unpkg.com/framer-motion@2.9.5/dist/framer-motion.js"></script>',x="const {motion} = Motion");const D=`<!DOCTYPE html>
        <html lang="en">
        <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <head profile="http://www.w3.org/2005/10/profile">
        <link rel="icon" 
              type="image/png"
              href="https://zed.vision/favicon.ico">
        <style>
        ${b}
        ${w}
        </style>
        </head>
        <body>
        <div id="root">
        ${f}
        </div>
        <script crossorigin src="https://unpkg.com/react@17.0.1/umd/react.production.min.js"></script>
        ${k}
        <script crossorigin src="https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/@emotion/react@11.1.1/dist/emotion-react.umd.min.js"></script>
        <script crossorigin src="https://unpkg.com/@emotion/styled@11.0.0/dist/emotion-styled.umd.min.js"></script>
        <script type="module">
        Object.assign(window, emotionReact);

       const styled = window["emotionStyled"];

        let DefaultElement;

        ${y}

        ReactDOM.hydrate(jsx(DefaultElement), document.body.children[0]);
        </script>
        </body>
        </html>
        `,I=await u(D),te=await m(I);return te}};if(!_){const a=async d=>{if(!location.origin.includes("zed."))return;if(d!==E)return;if(X===d)return;X=d;const f={codeTranspiled:h(E),code:E},w=JSON.stringify(f),b=new Request(L(),{body:w,method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}}),k=fetch(b),x=await ye(w);try{const D=await t.get("codeBoXHash2");D!==x&&(await t.put("codeBoXHash2",x),await t.put(x,E),l("h",x))}catch(D){}await k};a(S)}_=!1,p()}async function c(){const s=new URLSearchParams(window.location.search),r=s.get("h")||await t.get("codeBoXHash2");if(r){const g=await t.get(r);if(g)return g;let y;try{const p=await fetch(L()+"/?h="+r);y=await p.json()}catch(p){return console.error(p),F}return y.code}return F}function l(s,r){const g=new URLSearchParams(window.location.search);g.set(s,r),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${g}`))}function u(s){const r=new Blob([s],{type:"text/html"});return r}async function m(s){const r=L(),g=new Request(r,{body:s,method:"POST",headers:{"content-type":"text/html;charset=UTF-8",SHARE:"true"}}),y=await fetch(g),{hash:p}=await y.json();return`${r}/${p}`}function h(s){const{transform:r}=window.Babel;return r(`/** @jsx jsx */

  Object.assign(window, React);
  `+s,{plugins:[],presets:["react",["typescript",{isTSX:!0,allExtensions:!0}]]}).code}}function ge(e){const t=new Promise((n,o)=>{const i=()=>{e.removeEventListener("success",c),e.removeEventListener("error",l)},c=()=>{n(v(e.result)),i()},l=()=>{o(e.error),i()};e.addEventListener("success",c),e.addEventListener("error",l)});return t.then(n=>{n instanceof IDBCursor&&K.set(n,e)}).catch(()=>{}),z.set(t,e),t}let $={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return O.get(e);if(t==="objectStoreNames")return e.objectStoreNames||q.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return v(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function we(e){$=e($)}function be(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const o=e.call(P(this),t,...n);return q.set(o,t.sort?t.sort():[t]),v(o)}:ce().includes(e)?function(...t){return e.apply(P(this),t),v(K.get(this))}:function(...t){return v(e.apply(P(this),t))}}function xe(e){return typeof e=="function"?be(e):(e instanceof IDBTransaction&&de(e),se(e,ae())?new Proxy(e,$):e)}function v(e){if(e instanceof IDBRequest)return ge(e);if(A.has(e))return A.get(e);const t=xe(e);return t!==e&&(A.set(e,t),z.set(t,e)),t}we(e=>({...e,get:(t,n,o)=>J(t,n)||e.get(t,n,o),has:(t,n)=>!!J(t,n)||e.has(t,n)}));
