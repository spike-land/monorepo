import{renderPreviewWindow as S}from"./renderPreviewWindow.js";import{sendSignalToQrCode as W}from"./sendSignalToQrCode.js";import{v as m}from"./versions.js";import{getCodeToLoad as z,saveCode as B}from"./data.js";import{transpileCode as p}from"./transpile.js";function D(){return{unmount:()=>{},hydrated:!1,preRendered:!1,lastErrors:0,rootElement:null,div:window.document.createElement("div"),HTML:"",devtoolHash:"",ipfs:0,transpiled:"",code:""}}export async function run(d="window",w,u=""){await W();const{formatter:h}=await import("./formatter.js");if(d==="window"){const{openWindows:e}=await import("./openWindows.js");await e(m)}const{open:T}=w,t=D();if(t.code=await h(u),!u)try{const{code:e,transpiled:o,html:r,versions:a}=await z();t.code=e,t.transpiled=await p(e)||o,t.div.innerHTML=r}catch(e){console.error({e,message:"couldn't start"});return}if(t.transpiled===""){const e=await p("export default ()=><h1>Hello</h1>");console.log(e);const o=await p(t.code);console.log(o),t.transpiled=o}const{renderEmotion:f,jsx:v,DraggableWindow:E}=await import(m.emotionRenderer);await S(d,t,T,f,v,E),await P(g,t);const b=(await import(m.editor)).default,j=window.document.getElementById("editor"),s=await b({language:"typescript",container:j,code:t.code,onChange:e=>C(e)});async function C(e){const o=await h(e);try{const r=await p(o);if(t.transpiled===r&&r!=="")return;let a=!1;r.length&&t.lastErrors===0&&(a=await g(r));const n=await H(o);if(a&&n.push({messageText:"Error while starting the app. Check the console!"}),n.length&&console.log({err:n}),t.lastErrors&&n.length===0&&g(r),t.lastErrors=n.length,n.length===0&&r.length)t.code=await h(o),t.transpiled!==r&&(t.transpiled=r,B({code:t.code,transpiled:t.transpiled,html:t.HTML,versions:t.devtoolHash}));else{const{diff:i}=await import(`https://unpkg.com/@zedvision/shadb@${m.shadb}/src/diff.js`),c=await i(t.code,o);if(c.c.length<=3){t.lastErrors=0;return}if(c.c.length==4){t.lastErrors=0,s.monaco.editor.setTheme("hc-black");return}console.error(n[0].messageText.toString());return}s.monaco.editor.setTheme("vs-dark")}catch(r){s.monaco.editor.setTheme("vs-light"),setTimeout(()=>{s.monaco.editor.setTheme("hc-black")},50),console.error(r)}}async function H(e){if(!s||!s.monaco)return[{messageText:"Error with the error checking. Try to reload!"}];const{monaco:o}=s,{sha256:r}=await import(`https://unpkg.com/@zedvision/shadb@${m.shadb}/src/sha256.js`),n=`file:///${await r(e)}.tsx`,i=o.Uri.parse(n),c=o.editor.getModel(i)||await o.editor.createModel(e,"typescript",i),l=await(await o.languages.typescript.getTypeScriptWorker())(c.uri),k=l.getSemanticDiagnostics(n),L=l.getCompilerOptionsDiagnostics(n),M=l.getSyntacticDiagnostics(n),x=await Promise.race([k,L,M]);return c.dispose(),[...x]}async function g(e){t.HTML="";let o=!1;if(typeof e!="string"||e==="")return o=!0,o;const r=d==="window"?e.replace("body{","#zbody{"):e,a=window.document.createElement("div"),n=(await import(c(r))).default;t.unmount(),t.unmount=f(n(),a);const i=window.document.getElementById("zbody");return i&&i.children[0].replaceWith(a),t.HTML=t.div.innerHTML,!!t.HTML;function c(y){const l=new Blob([y],{type:"application/javascript"});return URL.createObjectURL(l)}}}async function P(d,w){await d(w.transpiled)}
