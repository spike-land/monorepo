const C=async m=>new Promise(d=>{const s=window.JSFrame,o=new s({horizontalAlign:"left",verticalAlign:"top"}),r=o.create({name:"Win2",title:"Z",left:(window.innerWidth-window.innerWidth*.7)/2,top:20,width:window.innerWidth*.7,height:320,minWidth:300,minHeight:200,appearanceName:"material",appearanceParam:{border:{shadow:"2px 2px 10px  rgba(0, 0, 0, 0.5)",width:0,radius:6},titleBar:{color:"white",background:"#b22",leftMargin:40,height:30,fontSize:20,buttonWidth:36,buttonHeight:16,buttonColor:"white",fontWeight:"bolder",buttons:[{fa:"fas fa-times",name:"closeButton",visible:!0},{fa:"fas fa-expand-arrows-alt",name:"maximizeButton",visible:!0},{fa:"fas fa-compress-arrows-alt",name:"minimizedButton",visible:!1}],buttonsOnLeft:[{fa:"fas fa-bars",name:"menu",visible:!0,childMenuHTML:'<div class="list-group">  <div name="menu1" class="list-group-item list-group-item-action py-2">Menu Item 01</div>  <div name="menu2" class="list-group-item list-group-item-action py-2">Menu Item 02</div>  <div name="menu3" class="list-group-item list-group-item-action py-2">Menu Item 03</div></div>',childMenuWidth:300}]}},style:{overflowY:"scroll",width:"100%"},url:m}).show();r.setControl({maximizeButton:"maximizeButton",demaximizeButton:"restoreButton",minimizeButton:"minimizeButton",deminimizeButton:"deminimizeButton",hideButton:"closeButton",animation:!0,animationDuration:150,maximizeWithoutTitleBar:!0,restoreKey:"Escape"}),r.control.on("hid",(e,l)=>{e.closeFrame()}),r.control.on("maximized",(e,l)=>{o.showToast({text:'Press "ESC" to minimize.',align:"center"})}),r.control.on("demaximized",(e,l)=>{}),r.on("menu","click",(e,l,c)=>{const i=l.target.getAttribute("name");i&&i.startsWith("menu")&&alert(i+" clicked")}),d()}),M=async({onChange:m,code:d,language:s})=>{const o=window.document.getElementById("container");if(!o){const i=h.getElementById("container");i.id="container",h.body.appendChild(i)}const r=s==="typescript"?"file:///main.tsx":"file:///main.html";let e;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)){const i=window.document.createElement("div");i.id="ace",window.document.body.appendChild(i),await A("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"),s==="typescript"?await A("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-typescript.min.js"):await A("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-html.min.js"),await A("https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.js"),window.document.getElementById("ace").style.setProperty("display","block"),o.style.setProperty("display","none"),e=window.ace.edit("ace"),e.getSession().setMode("ace/mode/typescript");const t=a=>setTimeout(()=>{let n=window.ace.edit("ace"),u=n.getTheme();u!=="ace/theme/monokai "&&(n.setOptions({fontSize:"14pt"}),n.setTheme("ace/theme/monokai"),t(2*a))},a);t(100),e.setValue(d),e.blur()}if(window.monaco===void 0){const i="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs",{require:t}=await A("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs/loader.min.js");t.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs"}}),await new Promise(a=>t(["vs/editor/editor.main"],n=>{a(n)}))}const l=window.monaco,c={monaco:l,editor:l.editor.create(window.document.getElementById("container"),{formatOnType:!0,scrollbar:{horizontal:"hidden",verticalHasArrows:!0,verticalScrollbarSize:20},minimap:{enabled:!1},folding:!1,multiCursorModifier:"alt",wordWrap:"on",wordWrapBreakAfterCharacters:">([{]))],;}",mouseWheelZoom:!1,wordWrapColumn:80,automaticLayout:!0,scrollBeyondLastLine:!1,autoIndent:"brackets",autoClosingQuotes:"always",padding:{bottom:300},lineNumbers:"on",autoClosingBrackets:"always",autoClosingOvertype:"always",suggest:{},codeLens:!0,autoSurround:"languageDefined",trimAutoWhitespace:!0,codeActionsOnSaveTimeout:100,model:l.editor.getModel(r)||l.editor.createModel(d,s,l.Uri.parse(r)),value:d,language:s,theme:"vs-dark"})};if(c.editor.onDidChangeModelContent(()=>m(c.editor.getValue())),e&&e.session.on("change",function(){const i=e.getValue();c.editor.setValue(i),m(i)}),e&&h.getElementById("container").replaceWith(h.getElementById("ace")),c.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!0,noSemanticValidation:!0,noSyntaxValidation:!0}),s==="typescript"){const i=[{name:"react",url:"https://unpkg.com/@types/react@16.14.0/index.d.ts",depend:["global","csstype","react-dom","prop-types"]},{name:"global",url:"https://unpkg.com/@types/react@16.14.0/global.d.ts",depend:[]},{name:"prop-types",url:"https://unpkg.com/@types/prop-types@15.7.3/index.d.ts",depend:[]},{name:"react-dom",url:"https://unpkg.com/@types/react-dom@16.9.9/index.d.ts",depend:[]},{name:"csstype",url:"https://unpkg.com/csstype@3.0.5/index.d.ts",depend:[]},{name:"@emotion/styled/base.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/base.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/styled/index.d.ts",url:"https://unpkg.com/@emotion/styled@11.0.0/types/index.d.ts",depend:["@emotion/react","@emotion/serialize","react"]},{name:"@emotion/cache/index.d.ts",url:"https://unpkg.com/@emotion/cache@11.0.0/types/index.d.ts",depend:["@emotion/utils"]},{name:"@emotion/react/index.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/index.d.ts",depend:["@emotion/cache"]},{name:"@emotion/react/jsx-namespace.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/jsx-namespace.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/css-prop.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/css-prop.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/helper.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/helper.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/react/theming.d.ts",url:"https://unpkg.com/@emotion/react@11.1.1/types/theming.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/serialize/index.d.ts",url:"https://unpkg.com/@emotion/serialize@1.0.0/types/index.d.ts",depend:["@emotion/utils","csstype"]},{name:"@emotion/utils/index.d.ts",url:"https://unpkg.com/@emotion/utils@1.0.0/types/index.d.ts",depend:[]}],t=i.map(({name:a,url:n})=>(async()=>c.monaco.languages.typescript.typescriptDefaults.addExtraLib(await(await fetch(n)).text(),a.includes("@emotion")?`file:///node_modules/${a}`:`file:///node_modules/@types/${a}/index.d.ts`))());return c.monaco.languages.typescript.typescriptDefaults.setCompilerOptions({target:c.monaco.languages.typescript.ScriptTarget.ESNext,allowNonTsExtensions:!0,allowUmdGlobalAccess:!0,strict:!0,allowJs:!0,noEmitOnError:!0,allowSyntheticDefaultImports:!0,moduleResolution:c.monaco.languages.typescript.ModuleResolutionKind.NodeJs,module:c.monaco.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"],jsx:c.monaco.languages.typescript.JsxEmit.React,jsxFactory:"React.createElement",jsxFragmentFactory:"React.Fragment",esModuleInterop:!0}),await Promise.all(t),c.monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSuggestionDiagnostics:!1,noSemanticValidation:!1,noSyntaxValidation:!1}),c}};function A(m){return new Promise(function(d,s){var o;o=window.document.createElement("script"),o.src=m,o.onload=()=>d(window),o.onerror=s,window.document.head.appendChild(o)})}const b=async m=>h.querySelector(`script[src="${m}"]`)||new Promise(function(d,s){const o=window.document.createElement("script");o.src=m,o.onload=d,o.onerror=s,window.document.head.appendChild(o)}),D=`/** @jsx jsx */

import {
  css, jsx, Global
} from "@emotion/react";

const Counter = () => {
  const [clicks, setClicks] = React.useState(0);

  return <>
    <Global styles={css\`
    body{
        margin: 0;
        height: 100vh;
        background: khaki	;
      }  
    \`} />
    <div css={\`
        margin: 2rem;
        display: inline-block;
        min-width: 200px;
        background: white;
        border: 4px dotted red;
        border-radius: 30px;
        padding: 2rem;
      \`}>
      <h1>Counter example</h1>
      <button css={buttonStyles("green")} onClick={() => setClicks(clicks - 1)}>
        -
    </button>
      {clicks}
      <button css={buttonStyles("red")} onClick={() => setClicks(clicks + 1)}>
        +
    </button>
    </div>
  </>;
};



const buttonStyles = (color: string) => css\`
  border-radius: 6px;
  padding: 0.5rem 0;
  margin: 0.5rem 2rem;
  width: 4rem;
  background: \${color};
  color: white;
  border: none;
  :focus{
    outline: none;
  }
  \`;

export default Counter;
`,h=window.document;let v=!0,w=0,S=0,y="",T="",j="",f="";export async function run(){await b("https://unpkg.com/react-dom@17.0.1/umd/react-dom-server.browser.production.min.js"),await b("https://unpkg.com/@emotion/react@11.1.1/dist/emotion-react.umd.min.js"),await b("https://unpkg.com/@emotion/styled@11.0.0/dist/emotion-styled.umd.min.js");const m=b("https://unpkg.com/@ampproject/worker-dom@0.27.4/dist/main.js");await b("https://unpkg.com/@babel/standalone@7.12.6/babel.min.js"),(async()=>{const r=s();f=r;const e=await M({language:"typescript",code:r,onChange:l});function l(t){if(!e)return;if(y=t,!w)i(y);else{const a=t,n=setInterval(()=>{(t!==y||!w)&&clearInterval(n),w||i(y)},100)}}async function c(){if(!e||!e.monaco)return;const t=e.monaco.Uri.parse("file:///main.tsx"),a=await e.monaco.languages.typescript.getTypeScriptWorker(),n=await(await a(t)).getSemanticDiagnostics("file:///main.tsx"),u=await(await a(t)).getCompilerOptionsDiagnostics("file:///main.tsx"),p=await(await a(t)).getSyntacticDiagnostics("file:///main.tsx");return[...n,...u,...p]}async function i(t){const{diff:a}=await import("../dist/diff.min.js");if(w===1)return;try{w=1;const n=await c(),u=h.getElementById("error");if(w=0,t!==y)return;if(n&&n.length){if(y!=t)return;if(T===t)return;const p=a(f,t,0);if(p.length<=3){e.monaco.editor.setTheme("hc-black");return}u.innerHTML=n[0].messageText.toString(),u.style.display="block",T=t,e.monaco.editor.setTheme("vs-light"),setTimeout(()=>{e.monaco.editor.setTheme("hc-black")},S++);return}f=t,u.style.display="none",e.monaco.editor.setTheme("vs-dark"),S=0,w=0,d(o(t))}catch(n){if(w=0,t!==y)return;e.monaco.editor.setTheme("vs-light"),setTimeout(()=>{e.monaco.editor.setTheme("hc-black")},10),console.error(n)}}})(),d(o(s())),await m;async function d(r){const e=/import/gi,l="///",c=r.replaceAll(/import/gi,"///").replace("export default","DefaultElement = "),i=async()=>{const t=new Function("code",`return function(){  
          let DefaultElement;
        
        ${c}
        console.log(DefaultElement);
                return ReactDOMServer.renderToString(jsx(DefaultElement));
      }`)(),a=t(),n=Array.from(h.querySelector("head > style[data-emotion=css]").sheet.cssRules).map(g=>g.cssText).filter(g=>a.includes(g.substring(3,8))).join(`
  `);console.log(n);const u=`<!DOCTYPE html>
      <html lang="en">
      <head>
      <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABFFBMVEX/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/Bwf/ZGT/l5f/lpb/WFj/AwP/Li7/6ur/////3d3/Hx//Nzf/8vL/5+f/Jyf/zMz/9/f/9vb/9fX/+fn/39//IiL/QED/Pj7/Vlb/1dX/n5//Bgb/FRX/pKT//f3/ubn/ICD/Fxf/qan//v7/trb/GBj/qqr/srL/HR3/GRn/q6v/rq7/Gxv/Ghr/ra3/r6//paX/Fhb/sLD/oaH/FBT/HBz/sbH/nZ3/EhL//Pz/mJj/EBD/+vr/kZH/DQ3/g4P/vb3/QUH/MzP/NTX/ysr/9PT/7+//8fH/8PD/ycn/1tb/PT3/ERH/zc3/AQH/U1P/o6P/oqL/dHT/CwsnXuIzAAAAB3RSTlMRie2K+ev+okjQYAAAAAFiS0dEEJWyDSwAAAAHdElNRQfkCw8HNStlcP8AAAABA0lEQVQ4y42T11ICQRBFhziIoLiiSBCVjEjOIqCikiSoRP3//7Cma6mix+odz+s9s1vdt5oxk5mTmE2MWazcAKuF2bghNmY3FuyMK/iv4DhwHmJcbiQcHXskTjQknHpl4ewcCZrvwq8TCIIQwl/gl2Gdq+sbECJRYopYPCHyZIoYM32bEfndLpeFbA7yfIFYVLEE/y9XiE1WayLO5LLEqqt1yBtNoovKvcgTrQeirHYH8u4j0WY7L/Kn5x5Rdxrev7y+EXXzPsw3GI7GOgUs9N5BmExnc2Dm/Ughofkp1z35QsJiKQvTMRJW69Zmu8/m+0cacyVBtPkX9eEoT095vKrz/wWYHD/qOZ0BPQAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMC0xMS0xNVQwNzo1Mzo0MyswMTowMKnrqaIAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjAtMTEtMTVUMDc6NTM6NDMrMDE6MDDYthEeAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC" />
    
      <style>
      ${n}
      </style>
      </head>
      <body>
      <div id="root">
      ${a}
      </div>
      <script crossorigin src="https://unpkg.com/react@17.0.1/umd/react.production.min.js"></script>
      <script crossorigin src="https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js"></script>
      <script crossorigin src="https://unpkg.com/@emotion/react@11.1.1/dist/emotion-react.umd.min.js"></script>
      <script crossorigin src="https://unpkg.com/@emotion/styled@11.0.0/dist/emotion-styled.umd.min.js"></script>
      <script type="module">
      Object.assign(window, emotionReact);

     const styled = window["emotionStyled"];

      let DefaultElement;
        
      ${c}

      ReactDOM.hydrate(jsx(DefaultElement), document.body.children[0]);
      </script>
      </body>
      </html>
      `,p=await z(u),x=h.getElementsByTagName("iframe").item(0);if(x){const g=h.createElement("iframe");g.setAttribute("src",p),g.onload=()=>console.log("Loooooooaaaded"),setTimeout(()=>{window.requestAnimationFrame(()=>{x.setAttribute("src",p),g.remove()})},30)}else await C(p)};if(!v){const t=async n=>{if(n!==f)return;if(j===n)return;j=n;const u={codeTranspiled:r,code:f},p=JSON.stringify(u),x=new Request("https://code.zed.vision",{body:p,method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}}),g=await fetch(x),{hash:k}=await g.json();try{const E=window.localStorage,B=E.getItem("codeBoXHash");B!==k&&(E.setItem("codeBoXHash",k),E.setItem(k,f),I("h",k))}catch(E){console.log("no localStorage")}},a=y;setTimeout(()=>t(y),500)}v=!1,i()}function s(){const r=new URLSearchParams(window.location.search),e=r.get("h")||localStorage.getItem("codeBoXHash");return e&&window.localStorage.getItem(e)||window.localStorage.getItem("STARTER")||D}function o(r){return Babel.transform(r,{plugins:[],presets:["react",["typescript",{isTSX:!0,allExtensions:!0}]]}).code}}function I(m,d){const s=new URLSearchParams(window.location.search);s.set(m,d),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${s}`))}async function z(m){const d=new Request("https://code.zed.vision",{body:m,method:"POST",headers:{"content-type":"text/html;charset=UTF-8"}}),s=await fetch(d),{hash:o}=await s.json();return`https://code.zed.vision/?r=${o}`}
