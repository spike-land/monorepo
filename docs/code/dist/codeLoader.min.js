import{renderPreviewWindow as z}from"./renderPreviewWindow.js";import{sendSignalToQrCode as L}from"./sendSignalToQrCode.js";import{v as d}from"./versions.js";import{getCodeToLoad as M,saveCode as B}from"./data.js";import{transpileCode as f}from"./transpile.js";function D(){return{unmount:()=>{},hydrated:!1,preRendered:!1,lastErrors:0,rootElement:null,div:window.document.createElement("div"),html:"",versions:{},ipfs:0,transpiled:"",code:""}}export async function run(l="window",p,w=""){await L();const{formatter:g}=await import("./formatter.js");if(l==="window"){const{openWindows:e}=await import("./openWindows.js");await e(d)}const{open:v}=p,t=D();if(t.code=w?await g(w):"",!w)try{const{code:e,transpiled:r,html:o,versions:s}=await M();t.code=e,t.transpiled=await f(e)||r,t.div.innerHTML=o,t.versions=s?JSON.parse(s):Object.assign({},d)}catch(e){console.error({e,message:"couldn't start"});return}if(t.versions=t.versions||Object.assign({},d),t.transpiled===""){const e=await f(t.code);console.log(e),t.transpiled=e}const{renderEmotion:u,jsx:E,DraggableWindow:b}=await import(d.emotionRenderer);await z(l,t,v,u,E,b),await P(h,t);const T=(await import(d.editor)).default,j=window.document.getElementById("editor"),i=await T({language:"typescript",container:j,code:t.code,onChange:e=>C(e)});async function C(e){const r=await g(e);try{const o=await f(r);if(t.transpiled===o&&o!=="")return;let s=!1;o.length&&t.lastErrors===0&&(s=await h(o));const n=await k(r);if(s&&n.push({messageText:"Error while starting the app. Check the console!"}),n.length&&console.log({err:n}),t.lastErrors&&n.length===0&&h(o),t.lastErrors=n.length,n.length===0&&o.length)t.code=await g(r),t.transpiled!==o&&(t.transpiled=o,B({code:t.code,transpiled:t.transpiled,html:t.html,versions:JSON.stringify(t.versions)}));else{const{diff:a}=await import(`https://unpkg.com/@zedvision/shadb@${d.shadb}/src/diff.js`),c=await a(t.code,r);if(c.c.length<=3){t.lastErrors=0;return}if(c.c.length==4){t.lastErrors=0,i.monaco.editor.setTheme("hc-black");return}console.error(n[0].messageText.toString());return}i.monaco.editor.setTheme("vs-dark")}catch(o){i.monaco.editor.setTheme("vs-light"),setTimeout(()=>{i.monaco.editor.setTheme("hc-black")},50),console.error(o)}}async function k(e){if(!i||!i.monaco)return[{messageText:"Error with the error checking. Try to reload!"}];const{monaco:r}=i,{sha256:o}=await import(`https://unpkg.com/@zedvision/shadb@${d.shadb}/src/sha256.js`),n=`file:///${await o(e)}.tsx`,a=r.Uri.parse(n),c=r.editor.getModel(a)||await r.editor.createModel(e,"typescript",a),m=await(await r.languages.typescript.getTypeScriptWorker())(c.uri),S=m.getSemanticDiagnostics(n),x=m.getCompilerOptionsDiagnostics(n),W=m.getSyntacticDiagnostics(n),O=await Promise.race([S,x,W]);return c.dispose(),[...O]}async function h(e){t.html="";let r=!1;if(typeof e!="string"||e==="")return r=!0,r;const o=l==="window"?e.replace("body{","#zbody{"):e,s=window.document.createElement("div"),n=(await import(c(o))).default;t.unmount(),t.unmount=u(n(),s);const a=window.document.getElementById("zbody");return a&&a.children[0].replaceWith(s),t.html=t.div.innerHTML,!!t.html;function c(y){const m=new Blob([y],{type:"application/javascript"});return URL.createObjectURL(m)}}}async function P(l,p){await l(p.transpiled)}
