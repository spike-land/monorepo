import{importScript as w}from"../dist/importScript.js";import{starter as y}from"./starterNoFramerMotion.js";const r={hydrated:!1,preRendered:!1,lastErrors:0,transpiled:"",code:""};function j(c){try{return window.prettier.format(c,{arrowParens:"always",bracketSpacing:!0,embeddedLanguageFormatting:"auto",htmlWhitespaceSensitivity:"css",insertPragma:!1,jsxBracketSameLine:!0,jsxSingleQuote:!1,printWidth:80,proseWrap:"preserve",quoteProps:"as-needed",requirePragma:!1,semi:!0,singleQuote:!0,tabWidth:2,trailingComma:"all",useTabs:!1,parser:"babel-ts",plugins:window.prettierPlugins})}catch{return c}}export async function run(c="window"){const{transpileCode:u}=await import("./transpile.js");if(await w("https://unpkg.com/prettier@2.2.1/standalone.js"),await w("https://unpkg.com/prettier@2.2.1/parser-babel.js"),await w("https://unpkg.com/prettier@2.2.1/parser-html.js"),r.code=j(await M()),c==="editor"){const{renderDraggableEditor:t}=await import("./DraggableEditor.js");await t()}if(c==="window"){const{renderDraggableWindow:t}=await import("./DraggableWindow.js"),{shareItAsHtml:e}=await import("./share.js");await t({onShare:async()=>{const n=await e({code:await u(r.code)});window.open(n)}})}const{getDB:v}=await import("../dist/shaDB.min.js"),{getUserId:P,getProjects:R,saveCode:b}=await import("./data.js"),T=await u(r.code);E(T);const{startMonaco:S}=await import("../dist/editor.min.js"),s=await S({language:"typescript",code:j(r.code),onChange:t=>k(j(t))});async function k(t){try{const e=await u(t,r.lastErrors);if(r.transPiled===e)return;let n=!1;e.length&&r.lastErrors===0&&(n=E(e));const a=[...n?[{messageText:"Error while starting the app. Check the console!"}]:[],...await C(t)];r.lastErrors&&a.length===0&&E(e),r.lastErrors=a.length;const o=window.document.getElementById("error");if(a.length===0&&e.length)r.code=t,r.transPiled!==e&&(r.transPiled=e,await b(j(t),u)),await b(t);else{r.error=t;const{diff:l}=await import("../dist/diff.min.js"),i=await l(r.code,t);if(i.c.length<=3){r.lastErrors=0;return}if(i.c.length==4){r.lastErrors=0,s.monaco.editor.setTheme("hc-black");return}o.innerHTML=a[0].messageText.toString(),o.style.display="block";return}o.style.display="none",s.monaco.editor.setTheme("vs-dark")}catch(e){s.monaco.editor.setTheme("vs-light"),setTimeout(()=>{s.monaco.editor.setTheme("hc-black")},50),console.error(e)}}async function C(t){if(!s||!s.monaco)return;const{monaco:e}=s,{sha256:n}=await import("./sha256.js"),a=await n(t),o=`file:///${a}.tsx`,l=e.Uri.parse(o),i=e.editor.getModel(l)||await e.editor.createModel(t,"typescript",l),g=await e.languages.typescript.getTypeScriptWorker(),m=await g(i.uri),d=m.getSemanticDiagnostics(o),p=m.getCompilerOptionsDiagnostics(o),h=m.getSyntacticDiagnostics(o),f=await Promise.race([d,p,h]);return i.dispose(),[...f]}await w("https://unpkg.com/react-dom@17.0.1/umd/react-dom.production.min.js");function E(t){if(typeof t!="string"||t==="")return 1;const e=c==="window"?t.replace("body{","#zroot{"):t;if(r.hydrated)try{const a=window.document.getElementById("zbody"),o=a.innerHTML;o.length>0&&(ReactDOM.unmountComponentAtNode(r.hydrated),r.hydrated=!1,a.innerHTML=o)}catch(a){console.error("Error in un-mount",a)}const n=new Function("importScript","session",`return function(){  
          let DefaultElement;


          try{
                ${e}

                const innerHTML = ReactDOMServer.renderToString(jsx(DefaultElement));

                session.preRendered = DefaultElement;

                const root = document.createElement("div");
                root.innerHTML = innerHTML;
                
                if(document.getElementById("zbody").children.length) {
                  document.getElementById("zbody").children[0].remove();
                }
      
                document.getElementById("zbody").appendChild(root);

                setTimeout(async()=>{
                  if (session.preRendered === DefaultElement){
                    session.hydrated = root;
                    ReactDOM.hydrate(jsx(DefaultElement), root);
                  }
                }, 500);

          } catch (e) {
            if (session.lastError!==0) console.error({e});
            session.preRendered=false;
          }

         
      }`)(w,r);return n(),!r.preRendered}async function M(){const{getUserId:t,getProjects:e,saveCode:n}=await import("./data.js"),{getDB:a}=await import("../dist/shaDB.min.js"),o=await a(),l=await t(),i=await e(),g=i[0],m=new URLSearchParams(window.location.search),d=m.get("h")||await o.get(g);if(d){let p;try{p=await o.get(d)}catch{console.error("error load key: "+d)}if(p)return p;let h;try{const f=await fetch("https://code.zed.vision/?h="+d);h=await f.json()}catch(f){const{sha256:L}=await import("./sha256.js"),D=await L(y);return o.put(D,y),await o.put(g,D),y}return h}return y}function x(t,e){const n=new URLSearchParams(window.location.search);n.set(t,e),window.history.replaceState({},"",decodeURIComponent(`${window.location.pathname}?${n}`))}}
