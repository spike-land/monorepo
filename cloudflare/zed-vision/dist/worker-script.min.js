function h(){}h.prototype={diff:function(t,e){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},s=n.callback;typeof n=="function"&&(s=n,n={}),this.options=n;var o=this;function r(g){return s?(setTimeout(function(){s(void 0,g)},0),!0):g}t=this.castInput(t),e=this.castInput(e),t=this.removeEmpty(this.tokenize(t)),e=this.removeEmpty(this.tokenize(e));var c=e.length,p=t.length,f=1,a=c+p,u=[{newPos:-1,components:[]}],y=this.extractCommon(u[0],e,t,0);if(u[0].newPos+1>=c&&y+1>=p)return r([{value:this.join(e),count:e.length}]);function d(){for(var g=-1*f;g<=f;g+=2){var l=void 0,v=u[g-1],S=u[g+1],k=(S?S.newPos:0)-g;v&&(u[g-1]=void 0);var b=v&&v.newPos+1<c,j=S&&0<=k&&k<p;if(!b&&!j){u[g]=void 0;continue}if(!b||j&&v.newPos<S.newPos?(l=N(S),o.pushComponent(l.components,void 0,!0)):(l=v,l.newPos++,o.pushComponent(l.components,!0,void 0)),k=o.extractCommon(l,e,t,g),l.newPos+1>=c&&k+1>=p)return r(F(o,l.components,e,t,o.useLongestToken));u[g]=l}f++}if(s)(function g(){setTimeout(function(){if(f>a)return s();d()||g()},0)})();else for(;f<=a;){var w=d();if(w)return w}},pushComponent:function(t,e,n){var s=t[t.length-1];s&&s.added===e&&s.removed===n?t[t.length-1]={count:s.count+1,added:e,removed:n}:t.push({count:1,added:e,removed:n})},extractCommon:function(t,e,n,s){for(var o=e.length,r=n.length,c=t.newPos,p=c-s,f=0;c+1<o&&p+1<r&&this.equals(e[c+1],n[p+1]);)c++,p++,f++;return f&&t.components.push({count:f}),t.newPos=c,p},equals:function(t,e){return this.options.comparator?this.options.comparator(t,e):t===e||this.options.ignoreCase&&t.toLowerCase()===e.toLowerCase()},removeEmpty:function(t){for(var e=[],n=0;n<t.length;n++)t[n]&&e.push(t[n]);return e},castInput:function(t){return t},tokenize:function(t){return t.split("")},join:function(t){return t.join("")}};function F(t,e,n,s,o){for(var r=0,c=e.length,p=0,f=0;r<c;r++){var a=e[r];if(a.removed){if(a.value=t.join(s.slice(f,f+a.count)),f+=a.count,r&&e[r-1].added){var u=e[r-1];e[r-1]=e[r],e[r]=u}}else{if(!a.added&&o){var y=n.slice(p,p+a.count);y=y.map(function(w,g){var l=s[f+g];return l.length>w.length?l:w}),a.value=t.join(y)}else a.value=t.join(n.slice(p,p+a.count));p+=a.count,a.added||(f+=a.count)}}var d=e[c-1];return c>1&&typeof d.value=="string"&&(d.added||d.removed)&&t.equals("",d.value)&&(e[c-2].value+=d.value,e.pop()),e}function N(t){return{newPos:t.newPos,components:t.components.slice(0)}}var W=new h;function A(t,e,n){return W.diff(t,e,n)}var $=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,I=/\S/,O=new h;O.equals=function(t,e){return this.options.ignoreCase&&(t=t.toLowerCase(),e=e.toLowerCase()),t===e||this.options.ignoreWhitespace&&!I.test(t)&&!I.test(e)},O.tokenize=function(t){for(var e=t.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),n=0;n<e.length-1;n++)!e[n+1]&&e[n+2]&&$.test(e[n])&&$.test(e[n+2])&&(e[n]+=e[n+2],e.splice(n+1,2),n--);return e};var T=new h;T.tokenize=function(t){var e=[],n=t.split(/(\n|\r\n)/);n[n.length-1]||n.pop();for(var s=0;s<n.length;s++){var o=n[s];s%2&&!this.options.newlineIsToken?e[e.length-1]+=o:(this.options.ignoreWhitespace&&(o=o.trim()),e.push(o))}return e};var J=new h;J.tokenize=function(t){return t.split(/(\S.+?[.!?])(?=\s+|$)/)};var R=new h;R.tokenize=function(t){return t.split(/([{}:;,]|\s+)/)};function x(t){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?x=function(e){return typeof e}:x=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},x(t)}var V=Object.prototype.toString,m=new h;m.useLongestToken=!0,m.tokenize=T.tokenize,m.castInput=function(t){var e=this.options,n=e.undefinedReplacement,s=e.stringifyReplacer,o=s===void 0?function(r,c){return typeof c=="undefined"?n:c}:s;return typeof t=="string"?t:JSON.stringify(D(t,null,null,o),o,"  ")},m.equals=function(t,e){return h.prototype.equals.call(m,t.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function D(t,e,n,s,o){e=e||[],n=n||[],s&&(t=s(o,t));var r;for(r=0;r<e.length;r+=1)if(e[r]===t)return n[r];var c;if(V.call(t)==="[object Array]"){for(e.push(t),c=new Array(t.length),n.push(c),r=0;r<t.length;r+=1)c[r]=D(t[r],e,n,s,o);return e.pop(),n.pop(),c}if(t&&t.toJSON&&(t=t.toJSON()),x(t)==="object"&&t!==null){e.push(t),c={},n.push(c);var p=[],f;for(f in t)t.hasOwnProperty(f)&&p.push(f);for(p.sort(),r=0;r<p.length;r+=1)f=p[r],c[f]=D(t[f],e,n,s,f);e.pop(),n.pop()}else c=t;return c}var E=new h;E.tokenize=function(t){return t.slice()},E.join=E.removeEmpty=function(t){return t};const sha256=async t=>Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",typeof t=="string"?new TextEncoder().encode(t):t)).slice(0,4)).map(e=>("00"+e.toString(16)).slice(-2)).join(""),diff=async(t,e)=>{const n=sha256(t),s=A(t,e);return{b:await n,c:s.map(o=>o.added?o.value:o.removed?-o.count:o.count)}},isDiff=t=>{if(t.length<10)return!1;const e=[...t.slice(0,8)].filter(s=>s<"0"||s>"f").length===0,n=t.slice(8);if(e&&n[0]==="["&&n[n.length-1]==="]")try{return JSON.parse(n).length>1}catch(s){return!1}return!1},assemble=(t,e)=>{const n=JSON.parse(e);let s=t.slice(),o="";return n.forEach(r=>{if(Number(r)===r){const c=Math.abs(r),p=s.slice(0,c);s=s.slice(c),r>0&&(o+=String(p))}else o+=String(r)}),o},getDbObj=t=>{const e={async get(n,s="string"){let o;try{if(o=await t.get(n),!o)return null}catch(c){return null}if(s==="json")try{return JSON.parse(o)}catch(c){return o}const r=await o;if(s==="string"){if(typeof r=="string"&&s==="string"){const c=r;if(isDiff(c)){const p=c.slice(0,8),f=c.slice(8),a=await e.get(p);return assemble(a,f)}return r}return new TextDecoder().decode(r)}return o},async put(n,s){let o;try{const c=await e.get(n);if(typeof c=="string"&&typeof s=="string"&&c.length===8&&c!==s){const p=await e.get(s),f=await e.get(c);if(typeof f=="string"){const a=await sha256(f);if(a===c){const u=await diff(p,f),y=u.b+JSON.stringify(u.c);await e.put(a,y)}}}}catch(c){o=""}if(o!==""&&s===o)return s;let r;return typeof s!="string"?r=new TextDecoder().decode(s):r=s,await t.put(n,r)},async delete(n){return await t.delete(n)},async clear(){return await t.clear()},async keys(){return await t.getAllKeys()}};return e},corsHeaders={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,HEAD,POST,OPTIONS","Access-Control-Max-Age":"86400"};function json(t){return new Response(JSON.stringify(t),{headers:{...corsHeaders,"Content-Type":"application/json;charset=UTF-8"}})}function text(t){return new Response(t,{headers:{...corsHeaders,"Content-Type":"text/html;charset=UTF-8"}})}function handleOptions(t){const e=t.headers;if(e.get("Origin")!==null&&e.get("Access-Control-Request-Method")!==null&&e.get("Access-Control-Request-Headers")!==null){const n={...corsHeaders,"Access-Control-Allow-Headers":t.headers.get("Access-Control-Request-Headers")};return new Response(null,{headers:n})}else return new Response(null,{headers:{Allow:corsHeaders["Access-Control-Allow-Methods"]}})}async function handleAdmin(t,e,n,s){if(n==="/keys/"){const o=e.get("prefix"),r=await s.list({prefix:o});return json(r)}if(n==="/keys/delete/"){const o=e.get("hash"),r=await s.delete(o);return json(r)}return json({error:"not implemented"})}var getRandomValues,rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&(getRandomValues=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!getRandomValues))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}const __default=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate(t){return typeof t=="string"&&__default.test(t)}for(var byteToHex=[],i=0;i<256;++i)byteToHex.push((i+256).toString(16).substr(1));function stringify(t){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(byteToHex[t[e+0]]+byteToHex[t[e+1]]+byteToHex[t[e+2]]+byteToHex[t[e+3]]+"-"+byteToHex[t[e+4]]+byteToHex[t[e+5]]+"-"+byteToHex[t[e+6]]+byteToHex[t[e+7]]+"-"+byteToHex[t[e+8]]+byteToHex[t[e+9]]+"-"+byteToHex[t[e+10]]+byteToHex[t[e+11]]+byteToHex[t[e+12]]+byteToHex[t[e+13]]+byteToHex[t[e+14]]+byteToHex[t[e+15]]).toLowerCase();if(!validate(n))throw TypeError("Stringified UUID is invalid");return n}function v4(t,e,n){t=t||{};var s=t.random||(t.rng||rng)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){n=n||0;for(var o=0;o<16;++o)e[n+o]=s[o];return e}return stringify(s)}const v41=()=>v4(),publicIpfsGateways=["https://ipfs.io/ipfs/:hash","https://dweb.link/ipfs/:hash","https://gateway.ipfs.io/ipfs/:hash","https://ipfs.infura.io/ipfs/:hash","https://ninetailed.ninja/ipfs/:hash","https://10.via0.com/ipfs/:hash","https://ipfs.eternum.io/ipfs/:hash","https://hardbin.com/ipfs/:hash","https://cloudflare-ipfs.com/ipfs/:hash","https://cf-ipfs.com/ipfs/:hash","https://gateway.pinata.cloud/ipfs/:hash","https://ipfs.sloppyta.co/ipfs/:hash","https://ipfs.greyh.at/ipfs/:hash","https://jorropo.ovh/ipfs/:hash","https://jorropo.net/ipfs/:hash","https://gateway.temporal.cloud/ipfs/:hash","https://ipfs.runfission.com/ipfs/:hash","https://trusti.id/ipfs/:hash","https://ipfs.overpi.com/ipfs/:hash","https://ipfs.ink/ipfs/:hash","https://gateway.ravenland.org/ipfs/:hash","https://ipfs.smartsignature.io/ipfs/:hash","https://ipfs.telos.miami/ipfs/:hash","https://robotizing.net/ipfs/:hash","https://ipfs.mttk.net/ipfs/:hash","https://ipfs.fleek.co/ipfs/:hash","https://ipfs.jbb.one/ipfs/:hash","https://jacl.tech/ipfs/:hash","https://ipfs.k1ic.com/ipfs/:hash","https://ipfs.drink.cafe/ipfs/:hash","https://ipfs.azurewebsites.net/ipfs/:hash","https://gw.ipfspin.com/ipfs/:hash","https://ipfs.denarius.io/ipfs/:hash"];function raceToSuccess(t){let e=0;return new Promise((n,s)=>t.forEach(o=>o.then(n).catch(()=>{++e===t.length&&s()})))}var SHAKV,USERS,LOGS,SIGNALS,USERKEYS,API_KEY;let now=0;function log(t,e={}){now=now||Date.now();const[n,s]=new Date().toLocaleTimeString("en-US").split(/:| /);return LOGS.put(String(2e12-now++),JSON.stringify({message:t,time:`${n}:${s}`,data:e}),{expirationTtl:86400*7})}async function handleCloudRequest(t){const{country:e,colo:n}=t.cf||{country:"",colo:""},s=new URL(t.url),{searchParams:o,pathname:r}=s,c=String(t.headers.get("API_KEY")||"");if(await log("request",{searchParams:o,pathname:r,country:e,colo:n}),t.method==="GET"&&c&&c==API_KEY)return handleAdmin(t,o,r,SHAKV);if(t.method==="GET"){if(r==="/robots.txt")return text("User-agent: * Disallow: /");if(r.slice(0,7)==="/signal"){const a=o.get("cid")||"",u=o.get("signal")||"",y=o.get("key")||"";if(a.length===46&&u.length===8)return await SIGNALS.put(u,a,{expirationTtl:86400*7}),json({success:!0});if(u.length===8){const d=await SIGNALS.get(u);return text(d===null?"404":d)}return text("error....")}if(r==="/connect"&&o.get("key")){const a=o.get("key"),u=a.slice(0,8),y=a.slice(8,16),d=a.slice(16,24),w=a.slice(24,32),g=await sha256(u+y);if(!u||!y||!d||g!==w)return json({error:"auth error"});const l=await USERKEYS.get(y);if(l===null)return json({error:401});const v=await USERKEYS.get(u);if(v===null)return json({error:404,message:"token not found"});const S=await sha256(u+l),k=await sha256(v+l);return S===d?(await USERS.put(v,JSON.stringify({uuid:l,connected:y}),{expirationTtl:60}),json({success:!0})):json(k===d?{success:!0}:{error:401})}if(r==="/check"){const a=o.get("key");if(a===null)return new Response("500");const y=await(async()=>{const d=await USERKEYS.get(a);if(!d)return null;const w=await USERS.get(d,"json");return!w||w.connected?w:new Promise(g=>{const l=setInterval(async()=>{const v=await USERS.get(d,"json");(!v||v.connected)&&(clearInterval(l),g(v))},1e3)})})();return json({expired:y===null})}if(r==="/register"){const a=v41(),u=await sha256(a);return await USERS.put(a,JSON.stringify({uuid:a,uuidHash:u,registered:Date.now(),country:e,colo:n})),await log("register",{uuidHash:u}),await USERKEYS.put(u,a),json({uuid:a})}if(r==="/token"){const a=v41(),u=await sha256(a);return await USERS.put(a,JSON.stringify({uuid:a,registered:Date.now(),country:e,colo:n}),{expirationTtl:60}),await USERKEYS.put(u,a,{expirationTtl:60}),json({uuid:a,key:u})}if(r==="/create-project"){const a=t.headers.get("TOKEN"),u=v41();return await USERS.put(u,JSON.stringify({uuid:u,registered:Date.now(),country:e,colo:n})),json({uuid:u})}const p=r.substr(1),f=[...p].filter(a=>a<"0"||a>"f").length===0&&p.length===8;if(p&&f)return Response.redirect(`https://code.spike.land/?signalToQr=${p}`,307);if(r.slice(0,6)==="/ipfs/"){const a=caches.default;let u=await a.match(t);if(!u){const y=publicIpfsGateways.sort(()=>.5-Math.random()).slice(0,8).map(d=>d.replace("/ipfs/:hash",r)).map(d=>fetch(d).then(w=>w.status===200?w:(()=>{throw new Error("Not found")})()));try{if(u=await raceToSuccess(y),typeof u=="undefined")return text("Please try again");await a.put(t,u.clone())}catch{return text("please try again")}}return u.status>399&&(u=new Response(u.statusText,{status:u.status})),u}return r==="/"?Response.redirect("https://code.spike.land/ipfs/QmZHkLVcsmBrrEuYjNUNDSmcNjZcjZPnkyLwLjk5oa9wF5/",302):r==="/code"||r==="/code/"?Response.redirect("https://code.spike.land",302):text(r)}else if(t.method==="POST"){const p=String(t.headers.get("ZKEY")||""),f=p.slice(0,8),a=p.slice(8,16),u=p.slice(16,24),y=p.slice(24,32);if(!f||!a||!u||!y)return json({error:401,message:"not matching keys"});if(await sha256(f+a)!==u)return json({error:401,message:"content and userkeys are not a pain"});const w=await t.arrayBuffer(),l=(await sha256(w)).substring(0,8);if(l!==f)return json({error:401,message:`body hash not matching with the sent hash: ${l} -- ${p}`});const v=await USERKEYS.get(a);if(!v)return json({error:500,message:"user not found"});if(await sha256(f+v)!==y)return json({error:401,message:"user not verified"});await log("new html",{sha:f,uKey:a});const k=r.substr(1);if(await SHAKV.put(l,w),k){const j=await getDbObj(SHAKV).put(k,l)}return json({hash:l})}return new Response("404")}addEventListener("fetch",t=>{t.request.method==="OPTIONS"?t.respondWith(handleOptions(t.request)):t.respondWith(handleCloudRequest(t.request))});
