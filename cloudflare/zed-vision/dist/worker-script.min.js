function b(){}b.prototype={diff:function(t,e){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},s=n.callback;typeof n=="function"&&(s=n,n={}),this.options=n;var r=this;function o(d){return s?(setTimeout(function(){s(void 0,d)},0),!0):d}t=this.castInput(t),e=this.castInput(e),t=this.removeEmpty(this.tokenize(t)),e=this.removeEmpty(this.tokenize(e));var c=e.length,p=t.length,f=1,a=c+p,u=[{newPos:-1,components:[]}],g=this.extractCommon(u[0],e,t,0);if(u[0].newPos+1>=c&&g+1>=p)return o([{value:this.join(e),count:e.length}]);function l(){for(var d=-1*f;d<=f;d+=2){var h=void 0,w=u[d-1],v=u[d+1],m=(v?v.newPos:0)-d;w&&(u[d-1]=void 0);var k=w&&w.newPos+1<c,S=v&&0<=m&&m<p;if(!k&&!S){u[d]=void 0;continue}if(!k||S&&w.newPos<v.newPos?(h=le(v),r.pushComponent(h.components,void 0,!0)):(h=w,h.newPos++,r.pushComponent(h.components,!0,void 0)),m=r.extractCommon(h,e,t,d),h.newPos+1>=c&&m+1>=p)return o(se(r,h.components,e,t,r.useLongestToken));u[d]=h}f++}if(s)(function d(){setTimeout(function(){if(f>a)return s();l()||d()},0)})();else for(;f<=a;){var y=l();if(y)return y}},pushComponent:function(t,e,n){var s=t[t.length-1];s&&s.added===e&&s.removed===n?t[t.length-1]={count:s.count+1,added:e,removed:n}:t.push({count:1,added:e,removed:n})},extractCommon:function(t,e,n,s){for(var r=e.length,o=n.length,c=t.newPos,p=c-s,f=0;c+1<r&&p+1<o&&this.equals(e[c+1],n[p+1]);)c++,p++,f++;return f&&t.components.push({count:f}),t.newPos=c,p},equals:function(t,e){return this.options.comparator?this.options.comparator(t,e):t===e||this.options.ignoreCase&&t.toLowerCase()===e.toLowerCase()},removeEmpty:function(t){for(var e=[],n=0;n<t.length;n++)t[n]&&e.push(t[n]);return e},castInput:function(t){return t},tokenize:function(t){return t.split("")},join:function(t){return t.join("")}};function se(t,e,n,s,r){for(var o=0,c=e.length,p=0,f=0;o<c;o++){var a=e[o];if(a.removed){if(a.value=t.join(s.slice(f,f+a.count)),f+=a.count,o&&e[o-1].added){var u=e[o-1];e[o-1]=e[o],e[o]=u}}else{if(!a.added&&r){var g=n.slice(p,p+a.count);g=g.map(function(y,d){var h=s[f+d];return h.length>y.length?h:y}),a.value=t.join(g)}else a.value=t.join(n.slice(p,p+a.count));p+=a.count,a.added||(f+=a.count)}}var l=e[c-1];return c>1&&typeof l.value=="string"&&(l.added||l.removed)&&t.equals("",l.value)&&(e[c-2].value+=l.value,e.pop()),e}function le(t){return{newPos:t.newPos,components:t.components.slice(0)}}var fe=new b;function oe(t,e,n){return fe.diff(t,e,n)}var Y=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,K=/\S/,j=new b;j.equals=function(t,e){return this.options.ignoreCase&&(t=t.toLowerCase(),e=e.toLowerCase()),t===e||this.options.ignoreWhitespace&&!K.test(t)&&!K.test(e)},j.tokenize=function(t){for(var e=t.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),n=0;n<e.length-1;n++)!e[n+1]&&e[n+2]&&Y.test(e[n])&&Y.test(e[n+2])&&(e[n]+=e[n+2],e.splice(n+1,2),n--);return e};var U=new b;U.tokenize=function(t){var e=[],n=t.split(/(\n|\r\n)/);n[n.length-1]||n.pop();for(var s=0;s<n.length;s++){var r=n[s];s%2&&!this.options.newlineIsToken?e[e.length-1]+=r:(this.options.ignoreWhitespace&&(r=r.trim()),e.push(r))}return e};var ae=new b;ae.tokenize=function(t){return t.split(/(\S.+?[.!?])(?=\s+|$)/)};var de=new b;de.tokenize=function(t){return t.split(/([{}:;,]|\s+)/)};function W(t){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?W=function(e){return typeof e}:W=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},W(t)}var ge=Object.prototype.toString,q=new b;q.useLongestToken=!0,q.tokenize=U.tokenize,q.castInput=function(t){var e=this.options,n=e.undefinedReplacement,s=e.stringifyReplacer,r=s===void 0?function(o,c){return typeof c=="undefined"?n:c}:s;return typeof t=="string"?t:JSON.stringify(Z(t,null,null,r),r,"  ")},q.equals=function(t,e){return b.prototype.equals.call(q,t.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function Z(t,e,n,s,r){e=e||[],n=n||[],s&&(t=s(r,t));var o;for(o=0;o<e.length;o+=1)if(e[o]===t)return n[o];var c;if(ge.call(t)==="[object Array]"){for(e.push(t),c=new Array(t.length),n.push(c),o=0;o<t.length;o+=1)c[o]=Z(t[o],e,n,s,r);return e.pop(),n.pop(),c}if(t&&t.toJSON&&(t=t.toJSON()),W(t)==="object"&&t!==null){e.push(t),c={},n.push(c);var p=[],f;for(f in t)t.hasOwnProperty(f)&&p.push(f);for(p.sort(),o=0;o<p.length;o+=1)f=p[o],c[f]=Z(t[f],e,n,s,f);e.pop(),n.pop()}else c=t;return c}var B=new b;B.tokenize=function(t){return t.slice()},B.join=B.removeEmpty=function(t){return t};const sha256=async t=>Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",typeof t=="string"?new TextEncoder().encode(t):t)).slice(0,4)).map(e=>("00"+e.toString(16)).slice(-2)).join(""),diff=async(t,e)=>{const n=sha256(t),s=oe(t,e);return{b:await n,c:s.map(r=>r.added?r.value:r.removed?-r.count:r.count)}},isDiff=t=>{if(t.length<10)return!1;const e=[...t.slice(0,8)].filter(s=>s<"0"||s>"f").length===0,n=t.slice(8);if(e&&n[0]==="["&&n[n.length-1]==="]")try{return JSON.parse(n).length>1}catch(s){return!1}return!1},assemble=(t,e)=>{const n=JSON.parse(e);let s=t.slice(),r="";return n.forEach(o=>{if(Number(o)===o){const c=Math.abs(o),p=s.slice(0,c);s=s.slice(c),o>0&&(r+=String(p))}else r+=String(o)}),r},getDbObj=t=>{const e={async get(n,s="string"){let r;try{if(r=await t.get(n),!r)return null}catch(c){return null}if(s==="json")try{return JSON.parse(r)}catch(c){return r}const o=await r;if(s==="string"){if(typeof o=="string"&&s==="string"){const c=o;if(isDiff(c)){const p=c.slice(0,8),f=c.slice(8),a=await e.get(p);return assemble(a,f)}return o}return new TextDecoder().decode(o)}return r},async put(n,s){let r;try{const c=await e.get(n);if(typeof c=="string"&&typeof s=="string"&&c.length===8&&c!==s){const p=await e.get(s),f=await e.get(c);if(typeof f=="string"){const a=await sha256(f);if(a===c){const u=await diff(p,f),g=u.b+JSON.stringify(u.c);await e.put(a,g)}}}}catch(c){r=""}if(r!==""&&s===r)return s;let o;return typeof s!="string"?o=new TextDecoder().decode(s):o=s,await t.put(n,o)},async delete(n){return await t.delete(n)},async clear(){return await t.clear()},async keys(){return await t.getAllKeys()}};return e},corsHeaders={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,HEAD,POST,OPTIONS","Access-Control-Max-Age":"86400"};function json(t){return new Response(JSON.stringify(t),{headers:{...corsHeaders,"Content-Type":"application/json;charset=UTF-8"}})}function text(t){return new Response(t,{headers:{...corsHeaders,"Content-Type":"text/html;charset=UTF-8"}})}function handleOptions(t){const e=t.headers;if(e.get("Origin")!==null&&e.get("Access-Control-Request-Method")!==null&&e.get("Access-Control-Request-Headers")!==null){const n={...corsHeaders,"Access-Control-Allow-Headers":t.headers.get("Access-Control-Request-Headers")};return new Response(null,{headers:n})}else return new Response(null,{headers:{Allow:corsHeaders["Access-Control-Allow-Methods"]}})}async function handleAdmin(t,e,n,s){if(n==="/keys/"){const r=e.get("prefix"),o=await s.list({prefix:r});return json(o)}if(n==="/keys/delete/"){const r=e.get("hash"),o=await s.delete(r);return json(o)}return json({error:"not implemented"})}var getRandomValues,rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&(getRandomValues=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!getRandomValues))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}const __default=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate(t){return typeof t=="string"&&__default.test(t)}for(var byteToHex=[],i=0;i<256;++i)byteToHex.push((i+256).toString(16).substr(1));function stringify(t){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(byteToHex[t[e+0]]+byteToHex[t[e+1]]+byteToHex[t[e+2]]+byteToHex[t[e+3]]+"-"+byteToHex[t[e+4]]+byteToHex[t[e+5]]+"-"+byteToHex[t[e+6]]+byteToHex[t[e+7]]+"-"+byteToHex[t[e+8]]+byteToHex[t[e+9]]+"-"+byteToHex[t[e+10]]+byteToHex[t[e+11]]+byteToHex[t[e+12]]+byteToHex[t[e+13]]+byteToHex[t[e+14]]+byteToHex[t[e+15]]).toLowerCase();if(!validate(n))throw TypeError("Stringified UUID is invalid");return n}function v4(t,e,n){t=t||{};var s=t.random||(t.rng||rng)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){n=n||0;for(var r=0;r<16;++r)e[n+r]=s[r];return e}return stringify(s)}const v41=()=>v4(),publicIpfsGateways=["https://ipfs.io/ipfs/:hash","https://dweb.link/ipfs/:hash","https://gateway.ipfs.io/ipfs/:hash","https://ipfs.infura.io/ipfs/:hash","https://ninetailed.ninja/ipfs/:hash","https://10.via0.com/ipfs/:hash","https://ipfs.eternum.io/ipfs/:hash","https://hardbin.com/ipfs/:hash","https://cloudflare-ipfs.com/ipfs/:hash","https://cf-ipfs.com/ipfs/:hash","https://gateway.pinata.cloud/ipfs/:hash","https://ipfs.sloppyta.co/ipfs/:hash","https://ipfs.greyh.at/ipfs/:hash","https://jorropo.ovh/ipfs/:hash","https://jorropo.net/ipfs/:hash","https://gateway.temporal.cloud/ipfs/:hash","https://ipfs.runfission.com/ipfs/:hash","https://trusti.id/ipfs/:hash","https://ipfs.overpi.com/ipfs/:hash","https://ipfs.ink/ipfs/:hash","https://gateway.ravenland.org/ipfs/:hash","https://ipfs.smartsignature.io/ipfs/:hash","https://ipfs.telos.miami/ipfs/:hash","https://robotizing.net/ipfs/:hash","https://ipfs.mttk.net/ipfs/:hash","https://ipfs.fleek.co/ipfs/:hash","https://ipfs.jbb.one/ipfs/:hash","https://jacl.tech/ipfs/:hash","https://ipfs.k1ic.com/ipfs/:hash","https://ipfs.drink.cafe/ipfs/:hash","https://ipfs.azurewebsites.net/ipfs/:hash","https://gw.ipfspin.com/ipfs/:hash","https://ipfs.denarius.io/ipfs/:hash"];function raceToSuccess(t){let e=0;return new Promise((n,s)=>t.forEach(r=>r.then(n).catch(()=>{++e===t.length&&s()})))}var SHAKV,USERS,LOGS,SIGNALS,USERKEYS,API_KEY;let now=0;function log(t,e={}){now=now||Date.now();const[n,s]=new Date().toLocaleTimeString("en-US").split(/:| /);return LOGS.put(String(2e12-now++),JSON.stringify({message:t,time:`${n}:${s}`,data:e}),{expirationTtl:86400*7})}async function handleCloudRequest(t){const{country:e,colo:n}=t.cf||{country:"",colo:""},s=new URL(t.url),{searchParams:r,pathname:o}=s,c=String(t.headers.get("API_KEY")||"");if(await log("request",{searchParams:r,pathname:o,country:e,colo:n}),t.method==="GET"&&c&&c==API_KEY)return handleAdmin(t,r,o,SHAKV);if(t.method==="GET"){if(o==="/robots.txt")return text("User-agent: * Disallow: /");if(o.slice(0,7)==="/signal"){const a=r.get("cid")||"",u=r.get("signal")||"",g=r.get("key")||"";if(a.length===46&&u.length===8)return await SIGNALS.put(u,a,{expirationTtl:86400*7}),json({success:!0});if(u.length===8){const l=await SIGNALS.get(u);return text(l===null?"404":l)}return text("error....")}if(o==="/connect"&&r.get("key")){const a=r.get("key"),u=a.slice(0,8),g=a.slice(8,16),l=a.slice(16,24),y=a.slice(24,32),d=await sha256(u+g);if(!u||!g||!l||d!==y)return json({error:"auth error"});const h=await USERKEYS.get(g);if(h===null)return json({error:401});const w=await USERKEYS.get(u);if(w===null)return json({error:404,message:"token not found"});const v=await sha256(u+h),m=await sha256(w+h);return v===l?(await USERS.put(w,JSON.stringify({uuid:h,connected:g}),{expirationTtl:60}),json({success:!0})):json(m===l?{success:!0}:{error:401})}if(o==="/check"){const a=r.get("key");if(a===null)return new Response("500");const g=await(async()=>{const l=await USERKEYS.get(a);if(!l)return null;const y=await USERS.get(l,"json");return!y||y.connected?y:new Promise(d=>{const h=setInterval(async()=>{const w=await USERS.get(l,"json");(!w||w.connected)&&(clearInterval(h),d(w))},1e3)})})();return json({expired:g===null})}if(o==="/register"){const a=v41(),u=await sha256(a);return await USERS.put(a,JSON.stringify({uuid:a,uuidHash:u,registered:Date.now(),country:e,colo:n})),await log("register",{uuidHash:u}),await USERKEYS.put(u,a),json({uuid:a})}if(o==="/token"){const a=v41(),u=await sha256(a);return await USERS.put(a,JSON.stringify({uuid:a,registered:Date.now(),country:e,colo:n}),{expirationTtl:60}),await USERKEYS.put(u,a,{expirationTtl:60}),json({uuid:a,key:u})}if(o==="/create-project"){const a=t.headers.get("TOKEN"),u=v41();return await USERS.put(u,JSON.stringify({uuid:u,registered:Date.now(),country:e,colo:n})),json({uuid:u})}const p=o.substr(1),f=[...p].filter(a=>a<"0"||a>"f").length===0&&p.length===8;if(p&&f)return Response.redirect(`https://code.zed.vision/?signalToQr=${p}`,307);if(o.slice(0,6)==="/ipfs/"){const a=caches.default;let u=await a.match(t);if(!u){const g=publicIpfsGateways.sort(()=>.5-Math.random()).slice(0,8).map(l=>l.replace("/ipfs/:hash",o)).map(l=>fetch(l).then(y=>y.status===200?y:(()=>{throw new Error("Not found")})()));try{if(u=await raceToSuccess(g),typeof u=="undefined")return text("Please try again");await a.put(t,u.clone())}catch{return text("please try again")}}return u.status>399&&(u=new Response(u.statusText,{status:u.status})),u}return o==="/"?Response.redirect("https://code.zed.vision/ipfs/QmZdmHygMZhq5p3TGaEJuorE4bYCecLPNHno2YVKQMK4iv/",302):o==="/code"||o==="/code/"?Response.redirect("https://code.zed.vision",302):text(o)}else if(t.method==="POST"){const p=String(t.headers.get("ZKEY")||""),f=p.slice(0,8),a=p.slice(8,16),u=p.slice(16,24),g=p.slice(24,32);if(!f||!a||!u||!g)return json({error:401,message:"not matching keys"});if(await sha256(f+a)!==u)return json({error:401,message:"content and userkeys are not a pain"});const y=await t.arrayBuffer(),h=(await sha256(y)).substring(0,8);if(h!==f)return json({error:401,message:`body hash not matching with the sent hash: ${h} -- ${p}`});const w=await USERKEYS.get(a);if(!w)return json({error:500,message:"user not found"});if(await sha256(f+w)!==g)return json({error:401,message:"user not verified"});await log("new html",{sha:f,uKey:a});const m=o.substr(1);if(await SHAKV.put(h,y),m){const S=await getDbObj(SHAKV).put(m,h)}return json({hash:h})}return new Response("404")}addEventListener("fetch",t=>{t.request.method==="OPTIONS"?t.respondWith(handleOptions(t.request)):t.respondWith(handleCloudRequest(t.request))});
