const sha256=async e=>Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",typeof e=="string"?new TextEncoder().encode(e):e)).slice(0,4)).map(t=>("00"+t.toString(16)).slice(-2)).join("");function b(){}b.prototype={diff:function(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},s=n.callback;typeof n=="function"&&(s=n,n={}),this.options=n;var o=this;function r(y){return s?(setTimeout(function(){s(void 0,y)},0),!0):y}e=this.castInput(e),t=this.castInput(t),e=this.removeEmpty(this.tokenize(e)),t=this.removeEmpty(this.tokenize(t));var a=t.length,l=e.length,h=1,u=a+l,c=[{newPos:-1,components:[]}],p=this.extractCommon(c[0],t,e,0);if(c[0].newPos+1>=a&&p+1>=l)return r([{value:this.join(t),count:t.length}]);function f(){for(var y=-1*h;y<=h;y+=2){var d=void 0,w=c[y-1],S=c[y+1],m=(S?S.newPos:0)-y;w&&(c[y-1]=void 0);var v=w&&w.newPos+1<a,x=S&&0<=m&&m<l;if(!v&&!x){c[y]=void 0;continue}if(!v||x&&w.newPos<S.newPos?(d=le(S),o.pushComponent(d.components,void 0,!0)):(d=w,d.newPos++,o.pushComponent(d.components,!0,void 0)),m=o.extractCommon(d,t,e,y),d.newPos+1>=a&&m+1>=l)return r(se(o,d.components,t,e,o.useLongestToken));c[y]=d}h++}if(s)(function y(){setTimeout(function(){if(h>u)return s();f()||y()},0)})();else for(;h<=u;){var g=f();if(g)return g}},pushComponent:function(e,t,n){var s=e[e.length-1];s&&s.added===t&&s.removed===n?e[e.length-1]={count:s.count+1,added:t,removed:n}:e.push({count:1,added:t,removed:n})},extractCommon:function(e,t,n,s){for(var o=t.length,r=n.length,a=e.newPos,l=a-s,h=0;a+1<o&&l+1<r&&this.equals(t[a+1],n[l+1]);)a++,l++,h++;return h&&e.components.push({count:h}),e.newPos=a,l},equals:function(e,t){return this.options.comparator?this.options.comparator(e,t):e===t||this.options.ignoreCase&&e.toLowerCase()===t.toLowerCase()},removeEmpty:function(e){for(var t=[],n=0;n<e.length;n++)e[n]&&t.push(e[n]);return t},castInput:function(e){return e},tokenize:function(e){return e.split("")},join:function(e){return e.join("")}};function se(e,t,n,s,o){for(var r=0,a=t.length,l=0,h=0;r<a;r++){var u=t[r];if(u.removed){if(u.value=e.join(s.slice(h,h+u.count)),h+=u.count,r&&t[r-1].added){var c=t[r-1];t[r-1]=t[r],t[r]=c}}else{if(!u.added&&o){var p=n.slice(l,l+u.count);p=p.map(function(g,y){var d=s[h+y];return d.length>g.length?d:g}),u.value=e.join(p)}else u.value=e.join(n.slice(l,l+u.count));l+=u.count,u.added||(h+=u.count)}}var f=t[a-1];return a>1&&typeof f.value=="string"&&(f.added||f.removed)&&e.equals("",f.value)&&(t[a-2].value+=f.value,t.pop()),t}function le(e){return{newPos:e.newPos,components:e.components.slice(0)}}var fe=new b;function oe(e,t,n){return fe.diff(e,t,n)}var Y=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,K=/\S/,j=new b;j.equals=function(e,t){return this.options.ignoreCase&&(e=e.toLowerCase(),t=t.toLowerCase()),e===t||this.options.ignoreWhitespace&&!K.test(e)&&!K.test(t)},j.tokenize=function(e){for(var t=e.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),n=0;n<t.length-1;n++)!t[n+1]&&t[n+2]&&Y.test(t[n])&&Y.test(t[n+2])&&(t[n]+=t[n+2],t.splice(n+1,2),n--);return t};var U=new b;U.tokenize=function(e){var t=[],n=e.split(/(\n|\r\n)/);n[n.length-1]||n.pop();for(var s=0;s<n.length;s++){var o=n[s];s%2&&!this.options.newlineIsToken?t[t.length-1]+=o:(this.options.ignoreWhitespace&&(o=o.trim()),t.push(o))}return t};function ue(e,t,n){return U.diff(e,t,n)}var ae=new b;ae.tokenize=function(e){return e.split(/(\S.+?[.!?])(?=\s+|$)/)};var de=new b;de.tokenize=function(e){return e.split(/([{}:;,]|\s+)/)};function W(e){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?W=function(t){return typeof t}:W=function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},W(e)}function C(e){return ce(e)||pe(e)||ve(e)||he()}function ce(e){if(Array.isArray(e))return V(e)}function pe(e){if(typeof Symbol!="undefined"&&Symbol.iterator in Object(e))return Array.from(e)}function ve(e,t){if(e){if(typeof e=="string")return V(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor&&(n=e.constructor.name),n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return V(e,t)}}function V(e,t){(t==null||t>e.length)&&(t=e.length);for(var n=0,s=new Array(t);n<t;n++)s[n]=e[n];return s}function he(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var ge=Object.prototype.toString,q=new b;q.useLongestToken=!0,q.tokenize=U.tokenize,q.castInput=function(e){var t=this.options,n=t.undefinedReplacement,s=t.stringifyReplacer,o=s===void 0?function(r,a){return typeof a=="undefined"?n:a}:s;return typeof e=="string"?e:JSON.stringify(Z(e,null,null,o),o,"  ")},q.equals=function(e,t){return b.prototype.equals.call(q,e.replace(/,([\r\n])/g,"$1"),t.replace(/,([\r\n])/g,"$1"))};function Z(e,t,n,s,o){t=t||[],n=n||[],s&&(e=s(o,e));var r;for(r=0;r<t.length;r+=1)if(t[r]===e)return n[r];var a;if(ge.call(e)==="[object Array]"){for(t.push(e),a=new Array(e.length),n.push(a),r=0;r<e.length;r+=1)a[r]=Z(e[r],t,n,s,o);return t.pop(),n.pop(),a}if(e&&e.toJSON&&(e=e.toJSON()),W(e)==="object"&&e!==null){t.push(e),a={},n.push(a);var l=[],h;for(h in e)e.hasOwnProperty(h)&&l.push(h);for(l.sort(),r=0;r<l.length;r+=1)h=l[r],a[h]=Z(e[h],t,n,s,h);t.pop(),n.pop()}else a=e;return a}var B=new b;B.tokenize=function(e){return e.slice()},B.join=B.removeEmpty=function(e){return e};function P(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=e.split(/\r\n|[\n\v\f\r\x85]/),s=e.match(/\r\n|[\n\v\f\r\x85]/g)||[],o=[],r=0;function a(){var u={};for(o.push(u);r<n.length;){var c=n[r];if(/^(\-\-\-|\+\+\+|@@)\s/.test(c))break;var p=/^(?:Index:|diff(?: -r \w+)+)\s+(.+?)\s*$/.exec(c);p&&(u.index=p[1]),r++}for(l(u),l(u),u.hunks=[];r<n.length;){var f=n[r];if(/^(Index:|diff|\-\-\-|\+\+\+)\s/.test(f))break;if(/^@@/.test(f))u.hunks.push(h());else{if(f&&t.strict)throw new Error("Unknown line "+(r+1)+" "+JSON.stringify(f));r++}}}function l(u){var c=/^(---|\+\+\+)\s+(.*)$/.exec(n[r]);if(c){var p=c[1]==="---"?"old":"new",f=c[2].split("	",2),g=f[0].replace(/\\\\/g,"\\");/^".*"$/.test(g)&&(g=g.substr(1,g.length-2)),u[p+"FileName"]=g,u[p+"Header"]=(f[1]||"").trim(),r++}}function h(){var u=r,c=n[r++],p=c.split(/@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@/),f={oldStart:+p[1],oldLines:typeof p[2]=="undefined"?1:+p[2],newStart:+p[3],newLines:typeof p[4]=="undefined"?1:+p[4],lines:[],linedelimiters:[]};f.oldLines===0&&(f.oldStart+=1),f.newLines===0&&(f.newStart+=1);for(var g=0,y=0;r<n.length&&!(n[r].indexOf("--- ")===0&&r+2<n.length&&n[r+1].indexOf("+++ ")===0&&n[r+2].indexOf("@@")===0);r++){var d=n[r].length==0&&r!=n.length-1?" ":n[r][0];if(d==="+"||d==="-"||d===" "||d==="\\")f.lines.push(n[r]),f.linedelimiters.push(s[r]||`
`),d==="+"?g++:d==="-"?y++:d===" "&&(g++,y++);else break}if(!g&&f.newLines===1&&(f.newLines=0),!y&&f.oldLines===1&&(f.oldLines=0),t.strict){if(g!==f.newLines)throw new Error("Added line count did not match for hunk at line "+(u+1));if(y!==f.oldLines)throw new Error("Removed line count did not match for hunk at line "+(u+1))}return f}for(;r<n.length;)a();return o}function we(e,t,n){var s=!0,o=!1,r=!1,a=1;return function l(){if(s&&!r){if(o?a++:s=!1,e+a<=n)return a;r=!0}if(!o)return r||(s=!0),t<=e-a?-a++:(o=!0,l())}}function _(e,t,n,s,o,r,a){a||(a={}),typeof a.context=="undefined"&&(a.context=4);var l=ue(n,s,a);l.push({value:"",lines:[]});function h(S){return S.map(function(m){return" "+m})}for(var u=[],c=0,p=0,f=[],g=1,y=1,d=function(S){var m=l[S],v=m.lines||m.value.replace(/\n$/,"").split(`
`);if(m.lines=v,m.added||m.removed){var x;if(!c){var T=l[S-1];c=g,p=y,T&&(f=a.context>0?h(T.lines.slice(-a.context)):[],c-=f.length,p-=f.length)}(x=f).push.apply(x,C(v.map(function(H){return(m.added?"+":"-")+H}))),m.added?y+=v.length:g+=v.length}else{if(c)if(v.length<=a.context*2&&S<l.length-2){var R;(R=f).push.apply(R,C(h(v)))}else{var E,L=Math.min(v.length,a.context);(E=f).push.apply(E,C(h(v.slice(0,L))));var A={oldStart:c,oldLines:g-c+L,newStart:p,newLines:y-p+L,lines:f};if(S>=l.length-2&&v.length<=a.context){var N=/\n$/.test(n),D=/\n$/.test(s),I=v.length==0&&f.length>A.oldLines;!N&&I&&n.length>0&&f.splice(A.oldLines,0,"\\ No newline at end of file"),(!N&&!I||!D)&&f.push("\\ No newline at end of file")}u.push(A),c=0,p=0,f=[]}g+=v.length,y+=v.length}},w=0;w<l.length;w++)d(w);return{oldFileName:e,newFileName:t,oldHeader:o,newHeader:r,hunks:u}}function Le(e){var t=[];e.oldFileName==e.newFileName&&t.push("Index: "+e.oldFileName),t.push("==================================================================="),t.push("--- "+e.oldFileName+(typeof e.oldHeader=="undefined"?"":"	"+e.oldHeader)),t.push("+++ "+e.newFileName+(typeof e.newHeader=="undefined"?"":"	"+e.newHeader));for(var n=0;n<e.hunks.length;n++){var s=e.hunks[n];s.oldLines===0&&(s.oldStart-=1),s.newLines===0&&(s.newStart-=1),t.push("@@ -"+s.oldStart+","+s.oldLines+" +"+s.newStart+","+s.newLines+" @@"),t.push.apply(t,s.lines)}return t.join(`
`)+`
`}function ye(e,t){return e.length!==t.length?!1:G(e,t)}function G(e,t){if(t.length>e.length)return!1;for(var n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}function xe(e){var t=X(e.lines),n=t.oldLines,s=t.newLines;n!==void 0?e.oldLines=n:delete e.oldLines,s!==void 0?e.newLines=s:delete e.newLines}function me(e,t,n){var s=O(t),o=O(n);if(re(s)&&re(o)){if(G(s,o)&&te(n,s,s.length-o.length)){var r;(r=e.lines).push.apply(r,C(s));return}else if(G(o,s)&&te(t,o,o.length-s.length)){var a;(a=e.lines).push.apply(a,C(o));return}}else if(ye(s,o)){var l;(l=e.lines).push.apply(l,C(s));return}Q(e,s,o)}function k(e,t,n,s){var o=O(t),r=Fe(n,o);if(r.merged){var a;(a=e.lines).push.apply(a,C(r.merged))}else Q(e,s?r:o,s?o:r)}function Q(e,t,n){e.conflict=!0,e.lines.push({conflict:!0,mine:t,theirs:n})}function ee(e,t,n){for(;t.offset<n.offset&&t.index<t.lines.length;){var s=t.lines[t.index++];e.lines.push(s),t.offset++}}function ne(e,t){for(;t.index<t.lines.length;){var n=t.lines[t.index++];e.lines.push(n)}}function O(e){for(var t=[],n=e.lines[e.index][0];e.index<e.lines.length;){var s=e.lines[e.index];if(n==="-"&&s[0]==="+"&&(n="+"),n===s[0])t.push(s),e.index++;else break}return t}function Fe(e,t){for(var n=[],s=[],o=0,r=!1,a=!1;o<t.length&&e.index<e.lines.length;){var l=e.lines[e.index],h=t[o];if(h[0]==="+")break;if(r=r||l[0]!==" ",s.push(h),o++,l[0]==="+")for(a=!0;l[0]==="+";)n.push(l),l=e.lines[++e.index];h.substr(1)===l.substr(1)?(n.push(l),e.index++):a=!0}if((t[o]||"")[0]==="+"&&r&&(a=!0),a)return n;for(;o<t.length;)s.push(t[o++]);return{merged:s,changes:n}}function re(e){return e.reduce(function(t,n){return t&&n[0]==="-"},!0)}function te(e,t,n){for(var s=0;s<n;s++){var o=t[t.length-n+s].substr(1);if(e.lines[e.index+s]!==" "+o)return!1}return e.index+=n,!0}function X(e){var t=0,n=0;return e.forEach(function(s){if(typeof s!="string"){var o=X(s.mine),r=X(s.theirs);t!==void 0&&(o.oldLines===r.oldLines?t+=o.oldLines:t=void 0),n!==void 0&&(o.newLines===r.newLines?n+=o.newLines:n=void 0)}else n!==void 0&&(s[0]==="+"||s[0]===" ")&&n++,t!==void 0&&(s[0]==="-"||s[0]===" ")&&t++}),{oldLines:t,newLines:n}}const diff=async(e,t)=>{const n=sha256(e),s=oe(e,t);return{b:await n,c:s.map(o=>o.added?o.value:o.removed?-o.count:o.count)}},isDiff=e=>{if(e.length<10)return!1;const t=[...e.slice(0,8)].filter(s=>s<"0"||s>"f").length===0,n=e.slice(8);if(t&&n[0]==="["&&n[n.length-1]==="]")try{return JSON.parse(n).length>1}catch(s){return!1}return!1},assemble=(e,t)=>{const n=JSON.parse(t);let s=e.slice(),o="";return n.forEach(r=>{if(Number(r)===r){const a=Math.abs(r),l=s.slice(0,a);s=s.slice(a),r>0&&(o+=String(l))}else o+=String(r)}),o},getDbObj=e=>{const t={async get(n,s="string"){let o;try{if(o=await e.get(n),!o)return null}catch(a){return null}if(s==="json")try{return JSON.parse(o)}catch(a){return o}const r=await o;if(s==="string"){if(typeof r=="string"&&s==="string"){const a=r;if(isDiff(a)){const l=a.slice(0,8),h=a.slice(8),u=await t.get(l);return assemble(u,h)}return r}return new TextDecoder().decode(r)}return o},async put(n,s){let o;try{const a=await t.get(n);if(typeof a=="string"&&typeof s=="string"&&a.length===8&&a!==s){const l=await t.get(s),h=await t.get(a);if(typeof h=="string"){const u=await sha256(h);if(u===a){const c=await diff(l,h),p=c.b+JSON.stringify(c.c);await t.put(u,p)}}}}catch(a){o=""}if(o!==""&&s===o)return s;let r;return typeof s!="string"?r=new TextDecoder().decode(s):r=s,await e.put(n,r)},async delete(n){return await e.delete(n)},async clear(){return await e.clear()},async keys(){return await e.getAllKeys()}};return t},corsHeaders={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,HEAD,POST,OPTIONS","Access-Control-Max-Age":"86400"};function json(e){return new Response(JSON.stringify(e),{headers:{...corsHeaders,"Content-Type":"application/json;charset=UTF-8"}})}function text(e){return new Response(e,{headers:{...corsHeaders,"Content-Type":"text/html;charset=UTF-8"}})}function handleOptions(e){const t=e.headers;if(t.get("Origin")!==null&&t.get("Access-Control-Request-Method")!==null&&t.get("Access-Control-Request-Headers")!==null){const n={...corsHeaders,"Access-Control-Allow-Headers":e.headers.get("Access-Control-Request-Headers")};return new Response(null,{headers:n})}else return new Response(null,{headers:{Allow:corsHeaders["Access-Control-Allow-Methods"]}})}async function handleAdmin(e,t,n,s){if(n==="/keys/"){const o=t.get("prefix"),r=await s.list({prefix:o});return json(r)}if(n==="/keys/delete/"){const o=t.get("hash"),r=await s.delete(o);return json(r)}return json({error:"not implemented"})}var getRandomValues,rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&(getRandomValues=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!getRandomValues))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}const __default=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate(e){return typeof e=="string"&&__default.test(e)}for(var byteToHex=[],i=0;i<256;++i)byteToHex.push((i+256).toString(16).substr(1));function stringify(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(byteToHex[e[t+0]]+byteToHex[e[t+1]]+byteToHex[e[t+2]]+byteToHex[e[t+3]]+"-"+byteToHex[e[t+4]]+byteToHex[e[t+5]]+"-"+byteToHex[e[t+6]]+byteToHex[e[t+7]]+"-"+byteToHex[e[t+8]]+byteToHex[e[t+9]]+"-"+byteToHex[e[t+10]]+byteToHex[e[t+11]]+byteToHex[e[t+12]]+byteToHex[e[t+13]]+byteToHex[e[t+14]]+byteToHex[e[t+15]]).toLowerCase();if(!validate(n))throw TypeError("Stringified UUID is invalid");return n}function v4(e,t,n){e=e||{};var s=e.random||(e.rng||rng)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,t){n=n||0;for(var o=0;o<16;++o)t[n+o]=s[o];return t}return stringify(s)}const v41=()=>v4(),publicIpfsGateways=["https://ipfs.io/ipfs/:hash","https://dweb.link/ipfs/:hash","https://gateway.ipfs.io/ipfs/:hash","https://ipfs.infura.io/ipfs/:hash","https://ninetailed.ninja/ipfs/:hash","https://10.via0.com/ipfs/:hash","https://ipfs.eternum.io/ipfs/:hash","https://hardbin.com/ipfs/:hash","https://cloudflare-ipfs.com/ipfs/:hash","https://cf-ipfs.com/ipfs/:hash","https://gateway.pinata.cloud/ipfs/:hash","https://ipfs.sloppyta.co/ipfs/:hash","https://ipfs.greyh.at/ipfs/:hash","https://jorropo.ovh/ipfs/:hash","https://jorropo.net/ipfs/:hash","https://gateway.temporal.cloud/ipfs/:hash","https://ipfs.runfission.com/ipfs/:hash","https://trusti.id/ipfs/:hash","https://ipfs.overpi.com/ipfs/:hash","https://ipfs.ink/ipfs/:hash","https://gateway.ravenland.org/ipfs/:hash","https://ipfs.smartsignature.io/ipfs/:hash","https://ipfs.telos.miami/ipfs/:hash","https://robotizing.net/ipfs/:hash","https://ipfs.mttk.net/ipfs/:hash","https://ipfs.fleek.co/ipfs/:hash","https://ipfs.jbb.one/ipfs/:hash","https://jacl.tech/ipfs/:hash","https://ipfs.k1ic.com/ipfs/:hash","https://ipfs.drink.cafe/ipfs/:hash","https://ipfs.azurewebsites.net/ipfs/:hash","https://gw.ipfspin.com/ipfs/:hash","https://ipfs.denarius.io/ipfs/:hash"];function raceToSuccess(e){let t=0;return new Promise((n,s)=>e.forEach(o=>o.then(n).catch(()=>{++t===e.length&&s()})))}const raceToSuccess1=raceToSuccess;var SHAKV,USERS,LOGS,SIGNALS,USERKEYS,API_KEY;let now=0;function log(e,t={}){now=now||Date.now();const[n,s]=new Date().toLocaleTimeString("en-US").split(/:| /);return LOGS.put(String(2e12-now++),JSON.stringify({message:e,time:`${n}:${s}`,data:t}),{expirationTtl:86400*7})}async function handleCloudRequest(e){const{country:t,colo:n}=e.cf||{country:"",colo:""},s=new URL(e.url),{searchParams:o,pathname:r}=s,a=String(e.headers.get("API_KEY")||"");if(await log("request",{searchParams:o,pathname:r,country:t,colo:n}),e.method==="GET"&&a&&a==API_KEY)return handleAdmin(e,o,r,SHAKV);if(e.method==="GET"){if(r==="/robots.txt")return text("User-agent: * Disallow: /");if(r.slice(0,7)==="/signal"){const u=o.get("cid")||"",c=o.get("signal")||"",p=o.get("key")||"";if(u.length===46&&c.length===8)return await SIGNALS.put(c,u,{expirationTtl:86400*7}),json({success:!0});if(c.length===8){const f=await SIGNALS.get(c);return text(f===null?"404":f)}return text("error....")}if(r==="/connect"&&o.get("key")){const u=o.get("key"),c=u.slice(0,8),p=u.slice(8,16),f=u.slice(16,24),g=u.slice(24,32),y=await sha256(c+p);if(!c||!p||!f||y!==g)return json({error:"auth error"});const d=await USERKEYS.get(p);if(d===null)return json({error:401});const w=await USERKEYS.get(c);if(w===null)return json({error:404,message:"token not found"});const S=await sha256(c+d),m=await sha256(w+d);return S===f?(await USERS.put(w,JSON.stringify({uuid:d,connected:p}),{expirationTtl:60}),json({success:!0})):json(m===f?{success:!0}:{error:401})}if(r==="/check"){const u=o.get("key");if(u===null)return new Response("500");const p=await(async()=>{const f=await USERKEYS.get(u);if(!f)return null;const g=await USERS.get(f,"json");return!g||g.connected?g:new Promise(y=>{const d=setInterval(async()=>{const w=await USERS.get(f,"json");(!w||w.connected)&&(clearInterval(d),y(w))},1e3)})})();return json({expired:p===null})}if(r==="/register"){const u=v41(),c=await sha256(u);return await USERS.put(u,JSON.stringify({uuid:u,uuidHash:c,registered:Date.now(),country:t,colo:n})),await log("register",{uuidHash:c}),await USERKEYS.put(c,u),json({uuid:u})}if(r==="/token"){const u=v41(),c=await sha256(u);return await USERS.put(u,JSON.stringify({uuid:u,registered:Date.now(),country:t,colo:n}),{expirationTtl:60}),await USERKEYS.put(c,u,{expirationTtl:60}),json({uuid:u,key:c})}if(r==="/create-project"){const u=e.headers.get("TOKEN"),c=v41();return await USERS.put(c,JSON.stringify({uuid:c,registered:Date.now(),country:t,colo:n})),json({uuid:c})}const l=r.substr(1),h=[...l].filter(u=>u<"0"||u>"f").length===0&&l.length===8;if(l&&h)return Response.redirect(`https://code.zed.vision/?signalToQr=${l}`,307);if(r.slice(0,6)==="/ipfs/"){const u=caches.default;let c=await u.match(e);if(!c){const p=publicIpfsGateways.sort(()=>.5-Math.random()).slice(0,8).map(f=>f.replace("/ipfs/:hash",r)).map(f=>fetch(f).then(g=>g.status===200?g:(()=>{throw new Error("Not found")})()));try{if(c=await raceToSuccess1(p),typeof c=="undefined")return text("Please try again");await u.put(e,c.clone())}catch{return text("please try again")}}return c.status>399&&(c=new Response(c.statusText,{status:c.status})),c}return r==="/"?Response.redirect("https://code.zed.vision/ipfs/QmauvHh4CRhZDR9zULhSnvguoZP4uashu8AfuMoGUsXKsM/",302):r==="/code"||r==="/code/"?Response.redirect("https://code.zed.vision",302):text(r)}else if(e.method==="POST"){const l=String(e.headers.get("ZKEY")||""),h=l.slice(0,8),u=l.slice(8,16),c=l.slice(16,24),p=l.slice(24,32);if(!h||!u||!c||!p)return json({error:401,message:"not matching keys"});if(await sha256(h+u)!==c)return json({error:401,message:"content and userkeys are not a pain"});const g=await e.arrayBuffer(),d=(await sha256(g)).substring(0,8);if(d!==h)return json({error:401,message:`body hash not matching with the sent hash: ${d} -- ${l}`});const w=await USERKEYS.get(u);if(!w)return json({error:500,message:"user not found"});if(await sha256(h+w)!==p)return json({error:401,message:"user not verified"});await log("new html",{sha:h,uKey:u});const m=r.substr(1);if(await SHAKV.put(d,g),m){const x=await getDbObj(SHAKV).put(m,d)}return json({hash:d})}return new Response("404")}addEventListener("fetch",e=>{e.request.method==="OPTIONS"?e.respondWith(handleOptions(e.request)):e.respondWith(handleCloudRequest(e.request))});
